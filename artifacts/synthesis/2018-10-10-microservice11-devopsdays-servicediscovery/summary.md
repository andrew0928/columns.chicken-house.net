# DevOpsDays 專刊: Service Discovery, 微服務架構的基礎建設

## 摘要提示
- DevOps觀點整合: 以開發者視角理解運維如何管理大量服務，強化 Dev 與 Ops 的整合能力以解鎖新功能。
- Service Discovery核心價值: 以服務註冊與健康檢查取代靜態設定，動態管理大量、頻繁變動的服務實例。
- Client-side Discovery模式: 由呼叫端根據服務註冊中心的狀態與標籤做路由與選擇，提供更彈性的控制。
- DNS+LB侷限: 單一 URL 難以應對多維度選擇（區域、層級、SLA），容易成為瓶頸或單點風險。
- Config不足: 靜態配置無法反映即時可用性，導致逾時、例外與連鎖失敗風險。
- 以標籤驅動選路: 利用服務註冊庫中的 tags（如 PLUS_ONLY）配合請求情境過濾目標節點。
- SLA分級實踐: 不同客戶方案的差異多在可靠度與資源隔離，需 Dev 與 Ops 聯動以架構實現。
- 架構師角色: 做正確技術選型，理解原理以規劃整合與演進路徑（含 sidecar/service mesh）。
- Cloud infra的邊界: 單靠雲端負載平衡或 API 管理不足以滿足細緻的應用端需求。
- 演進目標: 以 Service Discovery 為基礎，逐步走向 sidecar 與 service mesh 的更高階能力。

## 全文重點
文章以 DevOpsDays Taipei 2018 演講為契機，從開發者視角重談 Service Discovery 在微服務中的基礎性角色。作者指出，傳統企業將開發與運維切分，且追求對開發透明的運維技術，已不符 DevOps 精神；在 Cloud Native 時代，許多創新能力仰賴 Dev 與 Ops 的高度整合。Service Discovery 既非純粹的基礎設施（Ops），也非單一應用服務（Dev），而是兩者必須共同理解和運用的中介層。

面對服務數量與實例動態快速成長，單靠 DNS+Load Balancer 與應用程式設定檔難以為繼：靜態配置無法反映服務即時健康狀態，導致呼叫端逾時與失敗；單一 URL 難以支援更精細的選擇（如地區、等級、策略）；過度依賴外部 LB 亦可能形塑新的單點與效能瓶頸。這些痛點凸顯 Service Discovery 的必要：以服務註冊庫（registry）搭配健康檢查形成一致、即時、可查詢的服務狀態資料庫，讓呼叫端能做出更精準的路由與容錯決策，並成為進一步演進到 sidecar/service mesh 的地基。

作者主張採用 Client-side Discovery pattern：呼叫端在執行緒境中（request context）向註冊庫查詢並選擇目標實例，並可憑藉服務標籤（tags）或中繼資料實作更細緻的流量分派與策略控制。以實務案例說明提供不同 SLA 給不同層級客戶的挑戰：差異多半不是功能而是可靠度、資源隔離與效能。僅靠 DNS 與 LB 很難把登入後才知道的會員等級與後端資源池對應起來；而在服務註冊層加上標籤（如 PLUS_ONLY），即可讓客戶方案直接對應到不同的節點群組，實現基於等級的路由與資源配比，從而以架構手段支撐 SLA 承諾。提升 SLA 的方法包括加強程式健壯性、採用更高 SLA 的雲資源、或增加冗餘與備援；無論採取哪種策略，若無法把應用情境（客戶等級）與基礎資源（節點池）接通，就難以落地。

文章最後強調，架構師須理解原理並做出正確技術選型，協助團隊以 Consul 等服務註冊機制定義服務、健康檢查與標籤策略，讓開發者能在程式中運用運維能見度與控制力；當這層基礎完善後，即可自然過渡到 sidecar 與 service mesh 等更先進的流量治理、可觀測性與安全能力。

## 段落重點
### 本文開始
作者以 DevOpsDays Taipei 2018 演講為背景，設定主軸為以開發者更理解運維如何管理大量服務，並在掌握知識後創造過去難以實作的功能。傳統企業將 Dev 與 Ops 分離且追求對開發「透明」的運維做法，與 DevOps 所倡導的協作與回饋背道而馳；在 Cloud Native 的語境中，許多能力（如動態路由、細粒度治理）必須建立在兩端技術的結合上。文章將以三部曲展開：Basic（開發者觀點的 Service Discovery 基礎）、Advanced（實務情境案例）、Next（往 sidecar/service mesh 的演進）。作者強調自己以架構與開發為主，實作細節與技術棧僅作示例（如 Docker、.NET、Consul），更重視原理、設計動機與應用模式，因為理解原理能幫助做出正確選型與整合。並指出 Service Discovery 不是單純的 Baseline Infra 或單一應用服務，而是 Dev 與 Ops 都需共同理解的中間層服務，是邁向微服務架構首要跨越的門檻。

### BASIC: Service Discovery for Developers
微服務帶來服務種類與實例數目的倍增，且變動頻繁，傳統以 DNS+ELB 配合應用設定檔的方式很快遇到瓶頸。對提供者來說，DNS+LB 能遮蔽實例數與變動；對使用者（呼叫端）而言，仍須管理多個外部服務的 URL。問題在於：靜態設定無法呈現即時可用性，當對方失敗時可能造成長時間逾時或例外並連鎖影響；單一 URL 難以支援多層級選擇（如依區域、等級、策略選擇實例）；過度依賴 LB 可能出現單點與效能瓶頸，並遮蔽內部需要的細節。業界觀點亦指出傳統 API 管理模式不足以應對微服務細緻治理需求。解方是建立服務註冊庫與健康檢查，形成動態、可查詢的服務狀態資料庫，讓呼叫端能夠精準地進行發現、選擇與容錯。這是進一步演進到 service mesh 的必要前置條件。針對基礎原理與操作細節，作者亦提供先前文章與大會錄影作補充。

### Advanced Scenario
進入實戰情境，作者聚焦於僅靠雲端基礎設施或僅靠開發都難以獨力完成的需求，必須以高度整合的方式賦能開發者。這些情境的共通點是「應用層理解的業務脈絡」需要驅動「基礎設施層的流量與資源策略」。以服務註冊庫為核心，結合標籤與健康檢查，呼叫端在 request context 中做出動態決策，才能把會員屬性、地理區域、風險級別等業務面向，映射到對應資源池與節點選擇。相較之下，將所有路由決策下放給 DNS 或傳統 LB 難以承載如此細緻且需應用層參與的條件組合。此處也鋪墊往後的演進：當這些決策模式被標準化到 sidecar，並由 mesh 控制面統一下發策略時，將可進一步取得流量治理、可觀測性與安全的一致性。

### 案例: 提供不同 SLA 給不同層級的客戶
以常見的雲端訂閱分級為例（免費、付費、企業/Plus），差異多在可靠度、效能與資源隔離，而非單純功能。提高 SLA 的手段包括：提升程式健壯性、採用更高 SLA 的雲資源、與增加冗餘備援；但真正的挑戰是如何把「會員等級」這種應用層資訊，與「節點資源池」這種基礎設施對齊。若僅依賴 DNS+LB，可能需要多組網域與負載平衡器，且登入後才能得知的會員方案難以在基礎設施層即時路由，導致治理複雜與維運負擔。採用 Client-side Discovery 後，可在服務註冊庫中為實例標記標籤（如 PLUS_ONLY），呼叫端於執行緒境依會員等級過濾可用節點群並做負載分配；由此實現以標籤驅動的精準選路，讓資源配比對應 SLA 承諾，並避免僅靠外部 LB 的單點與不可觀測性。這種設計也為後續把策略下放到 sidecar、統一由 mesh 管控打下基礎。

## 資訊整理

### 知識架構圖
1. 前置知識：
- 微服務與單體拆分的基本觀念
- DNS、Load Balancer 基礎運作
- 健康檢查與可用性/故障容忍的概念（SLA、SLO、故障模式）
- DevOps 基礎：Dev 與 Ops 分工與協作
- 基本容器化與動態伸縮（如 Docker、Kubernetes 概念）

2. 核心概念：
- Service Discovery：在動態環境中定位服務實例的能力；是 Dev 與 Ops 的中間層
- Service Registry + Health Check：以可用性為核心的服務定義資料庫，替代靜態 config
- Client-side Discovery pattern：由呼叫端基於 registry 與上下文做路由/過濾/負載分攤
- 標籤/屬性驅動的路由：透過 tags/metadata（如方案等級、區域）選擇對應實例
- 演進路徑：從基本 Service Discovery → sidecar → service mesh（更強的可觀測/治理）
關係：Registry 是基礎；Health check 驅動可用性；Client-side Discovery 利用 registry 與標籤做精準路由；sidecar/mesh 將這些能力下沉為基礎設施並強化治理與可觀測。

3. 技術依賴：
- 底層網路與名稱解析：DNS、LB（但存在單點/資訊遮蔽等限制）
- Service Registry/Discovery 解決方案：如 Consul（文中關注）、亦可類推至其他主流
- 健康檢查機制：active/passive health checks、心跳與狀態同步
- 容器與編排環境：容器化、多副本、動態擴縮（影響實例生命週期）
- Sidecar/Service Mesh：在應用外掛載網路/治理平面（為進階階段的依賴）

4. 應用場景：
- 多層級客戶 SLA 提供：以標籤區隔資源池（如 PLUS_ONLY）並在 client 端依上下文選擇
- 動態拓撲與高頻變更：快速加入/下線實例時維持可用與正確路由
- 內部服務調用最佳化：避免過度依賴外部 LB、降低單點與延遲
- 基於屬性的精準路由：按區域、服務層級、版本（金絲雀/灰度）做選擇
- 從 API 管理到服務網格的治理升級：更細緻的流量控制、韌性與可觀測性

### 學習路徑建議
1. 入門者路徑：
- 了解微服務拆分與傳統 DNS+LB 的侷限
- 掌握 Service Discovery 的目的與基本元件（registry、health check、心跳）
- 用一個最小案例把服務註冊/發現/健康檢查跑起來（可用 Consul 或等價工具）
- 練習以標籤/metadata 查詢服務並做簡單的 client-side 負載分攤

2. 進階者路徑：
- 設計 client-side discovery 流程：服務選擇策略、重試/逾時/熔斷
- 規劃服務定義模型：標籤設計（SLA 等級、區域、版本、租戶隔離）
- 將 discovery 與應用設定管理解耦，導入健康狀態驅動的路由
- 導入觀測：註冊表狀態、健康度、流量路由決策與失敗樣式監控

3. 實戰路徑：
- 實作多層級 SLA：以標籤區隔資源池並在應用層依使用者/租戶上下文選路
- 去 LB 化的內部調用：在內網以 client-side discovery 替代部分 LB 路徑
- 漸進式演進到 sidecar/service mesh：先抽離網路與韌性邏輯到 sidecar，再導入 mesh
- 制定 Dev+Ops 協作流程：Dev 定義路由語意與標籤，Ops 管理資源池與健康策略

### 關鍵要點清單
- Service Discovery 的定位: 介於 Dev 與 Ops 的中間層服務，兩邊都需理解與共管 (優先級: 高)
- Service Registry: 動態、可查詢、含健康狀態與標籤的服務定義資料庫，取代靜態 config (優先級: 高)
- Health Check 策略: 主動/被動健康檢查維持可用實例集合，是正確路由的前提 (優先級: 高)
- Client-side Discovery: 由呼叫端基於 registry 決策路由，支援更細緻的選擇與回退 (優先級: 高)
- DNS+LB 的侷限: 單點/遮蔽細節/路由粒度不足，難以因應高頻變更與精準選擇 (優先級: 高)
- 標籤/屬性驅動路由: 以 tags（如方案、區域、版本）做條件過濾與資源池切分 (優先級: 高)
- 多層級 SLA 實作: 以資源池分割與路由策略為核心，不是功能差異即可辦到 (優先級: 高)
- 逾時/重試/熔斷: 與發現/路由配合的韌性機制，避免長等待與級聯失敗 (優先級: 高)
- 內部服務的去 LB 化: 在內網以 discovery 直連實例，降低延遲與單點風險 (優先級: 中)
- 可觀測性: 監控註冊表、健康度、路由決策與失敗率，是治理與排障關鍵 (優先級: 中)
- DevOps 協作模型: Dev 設計語意與上下文，Ops 管理資源與健康，協同定義標籤 (優先級: 高)
- 演進到 sidecar/mesh: 將網路與治理下沉基礎設施，擴充流量控制與策略管理 (優先級: 中)
- 動態拓撲支持: 高頻增減實例與自動化註冊/下線流程設計 (優先級: 中)
- 與配置管理解耦: 以 runtime 查詢與狀態驅動替代部署時靜態綁定 (優先級: 中)
- 工具選型與原理: 熟悉如 Consul 等工具，但決策重點在原理與使用模式 (優先級: 低)