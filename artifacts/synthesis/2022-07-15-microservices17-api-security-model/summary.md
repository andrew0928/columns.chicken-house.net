# 微服務架構 - API 的安全管控模型

## 摘要提示
- 安全設計即需求: API 安全不是單純運維課題，必須在系統設計階段與功能需求並列思考與建模。
- 內外一致的治理: 對外公開 API 與微服務內部互調都需要安全治理，不能只顧外部 KEY/TOKEN。
- 多維度控管: 控管對象、資源類型、功能範圍、呼叫環境與授權管理者等多維度交織，需建立模型梳理。
- 模型優先於工具: 先定義安全模型與協定，再選擇 OIDC/OAuth2、JWT、API Gateway 等落地方案。
- 以領域驅動安全: 以 Domain API 對應「功能／資料／指令」細粒度授權，避免商業規則層面的資安風險。
- 典型風險場景: 同租戶越權、跨租戶存取、委外第三方濫權與批次資料外洩需有對策。
- 擴展與卸載: 小規模可在應用層中介實作，大流量可在 API Gateway/Reverse Proxy 前移自定判斷。
- 系統規模演進: 從單一服務、微服務、對外服務到多租戶，安全治理複雜度呈倍數成長。
- 授權管理方式: 可依權限、角色、意圖(委託)與設計/授權階段決策組合治理。
- 生態系延伸: 當安全模型健全，可支援 marketplace、客製整合與自動化情境。

## 全文重點
本文聚焦微服務架構下的 API 安全治理，強調安全是設計題而非純基礎設施題。隨著系統整合程度與 API 重要性提升，單靠頁面與網路層防護已不足，必須將安全模型納入架構與需求分析的第一線。作者以會員服務 MemberService 的公開方法為例，提醒設計者思考需管控的「什麼」(功能、資料、指令、相依關係)、「誰」(內部服務/團隊、外部合作夥伴、最終客戶與其供應鏈)、「誰來管」(開發、PM/PO、IT、客服或客戶自管)，並指出商業規則的授權漏洞往往比基礎建設弱點更易被正當使用者誤傷與濫用。

在工具選型上，應先抽象出安全模型與協定，再挑平台與技術棧，如 OAuth2/OIDC、JWT、Azure AD、API Management、API Gateway/Reverse Proxy 等。小規模時可用框架中介軟體(Middleware)與套件直攻；大流量或跨團隊時，則把驗證與授權前移到 Gateway 作卸載，透過可編程代理(Ocelot、YARP)或雲端 API 管理服務擴展判定邏輯，維持一致策略。

文章建議用多維度來拆解安全：系統規模面，從單一服務到多租戶對外 API，權限邊界、憑證管線與審計需求倍增；領域複雜度面，按 domain 方法、scope、呼叫環境(IP/時間/限流)與角色分層授權；管理模式面，分別探討按權限(key/token)、按角色(client id/cert)、按意圖(委託第三方)、以及哪些決策在設計期鎖定、哪些在授權期動態配置。藉由這些「模型軸線」，團隊可在 PoC/成長期與量產/治理期之間平滑切換實作載體，保持一致的安全語意。

最後，當安全模型成熟，能自然延伸到 marketplace 與自動化：例如讓租戶自助發鍵、細粒度分派 scope/role、委託第三方存取、設定限流與來源限制、審計追蹤與撤銷；也能支援多環境一致策略與日後平台遷移。核心訊息是：挑對模型，工具就能替換；忽略模型，工具再多也難補齊安全邏輯與治理落差。

## 段落重點
### 前言: API 的安全性要管理什麼?
文章指出，隨整合與 API 化普及，安全治理已不再只需關注頁面與網路層，API 可能成為資料外洩與越權的主要通道。以 MemberService 的公開方法清單為例，作者引導讀者思考三大題：要管控的對象(內部服務、外部夥伴、最終客戶及其供應鏈)、要管控的內容(功能、資料、指令，以及方法間相依關係)、與誰來負責管控(開發、PM/PO、IT、客服或客戶)。並以不同場景示警：A 用戶能否讀到 B 的資料、廠商間越權、委外團隊濫權批次撈取資料等，強調商業規則的授權邏輯若設計不當，即便呼叫者「合法」，也會造成嚴重資安風險。

### 前言
本段界定本文範圍：不談基礎建設層(DDoS、防火牆)，專注在 API 設計融入的安全模型。安全層面包含：API Key 驗證、來源 IP 鎖定、資源授權(細到 CRUD)、多租戶資源隔離與授權等。作者主張先選對模型，再選用平台與工具；無論是程式層中介(Middleware)或前置在 API Gateway 的卸載，都應服務同一套安全語意。透過 PoC 驗證模型與可行性，隨規模成長再切換承載實作(框架套件、雲端 API 管理、可程式反向代理)，確保策略一致與治理可持續。

### 系統規模
#### 單一服務 (1)
單體或單一服務中，API 安全多數可用框架提供的驗證/授權中介完成，如 JWT 驗證、角色/權限標註、基本限流與來源限制。治理重點在明確標註每個方法的授權邊界與審計，並確保方法間的相依關係(如能查清單是否必然能查單筆)被策略正確反映，避免授權外溢。

#### 微服務 (N)
服務增多後，服務間呼叫需要機器對機器的身分與授權(如 mTLS、client credentials flow)，並處理跨服務的權限傳遞與最小必要權限。需導入服務網格或 API Gateway 集中處理驗證、信任、觀測與額外策略(限流/熔斷)，減少各服務重複實作與策略不一致。

#### 對外公開服務 (N x M)
當多個服務對多種客戶/合作夥伴開放，需提供註冊、發鍵、scope/role 配置、金鑰輪替、限流、IP 白名單與審計。API 文件與版本管理要支援差異化授權策略；外部事件與批次介面需與同步 API 一致的安全模型，避免旁路。

#### 多租戶對外公開服務 ( N x M x O)
再加入租戶層，核心是嚴格的租戶隔離與跨租戶防護。授權語意需同時帶有「誰」「對哪個租戶」的上下文，支援租戶管理者自助分派與委託第三方。需完善撤銷、審計、配額與峰值控制，以及金鑰/證書與機密管理的生命週期治理。

### 領域複雜度
#### by (domain) method
依據領域方法細到每個 API 控制授權與相依，對「會改變狀態」與「查詢/聚合」方法區分權限，並用狀態機/商業規則限制可執行性，避免僅靠頁面導流。

#### by (domain) scope
抽象成功能域的 scope(如 member.read、member.write、password.reset)，以宣告式方式指派憑證的可用邊界，利於跨服務與多平台一致化與最小授權。

#### by (client) environment
依呼叫環境加上外圍限制：來源 IP/網段、時間窗、速率/併發/配額、地理區域、裝置姿態等，將風險控制在邊界並降低內部服務壓力。

#### by role
面向人/系統角色做授權聚合，如系統間整合使用 machine role、人員使用業務角色，並支援跨租戶的委任管理與最小權限。

### 管理模式
#### by permission (key, token)
以 API Key/JWT/OAuth2 token 驗證請求，藉 claims/scope 承載授權資訊，搭配金鑰輪替、撤銷與短存活期限降低風險。

#### by role (client id, certification)
以 client id/secret、mTLS、憑證綁定建立機器身分與信任鏈，適合服務間或高信任度的 B2B 整合。

#### by intention (client -> 3rd party)
支援委託意圖，如代表租戶或用戶授權第三方(Delegation/On-behalf-of flow)，確保可追溯「誰代表誰對何資源做了什麼」。

#### 設計階段決定 vs 授權階段決定
將不可變的安全原則與領域相依關係在設計期固化；把環境限制、限流、客製 scope/配額等交由授權/營運期動態配置，兼顧一致性與靈活性。

### 大亂鬥, 挑選適合的授權管理模式
綜合系統規模、領域複雜度與治理需求，選擇混合模式：以 scope 為核心語意，輔以角色聚合與委託流，並在 Gateway 前移驗證/限流/來源控制。小規模以應用層中介快速落地，大規模以 API 管理平台統一治理；保持安全語意不變，承載可替換，以支撐從 PoC 到量產的演進。

### 延伸應用: market place, automation
當安全模型與治理完善，即可支援 marketplace 與自助化：租戶自行管理金鑰與 scope、對第三方委託、設定配額與來源限制、存取審計與撤銷自動化；同時支援版本演進與跨環境一致部署，讓商業整合與生態擴張在可控風險下快速推進。

## 資訊整理

### 知識架構圖
1. 前置知識：
   - 基本網路與資安概念（HTTP、TLS、認證 vs 授權）
   - API 設計基礎（REST/GraphQL、狀態與資源）
   - 常見身份與授權協定（OAuth2/OIDC、JWT、API Key）
   - 微服務基本觀念（Service-to-Service、API Gateway/Reverse Proxy）

2. 核心概念：
   - 安全是設計題：安全模型需在系統設計階段與需求並列，不能只交給基礎建設
   - 多維度管控：管控什麼（功能/資料/指令）、管控誰（內部/外部/多方委外）、誰來管（RD/PO/IT/客服/客戶自助）
   - 授權模型選擇：by permission（key/token）、by role（client identity/cert）、by intention（委任/轉授權），設計階段 vs 授權階段決策
   - 架構層次落點：應用內中介軟體 vs API Gateway/反向代理 Offloading
   - 規模與複雜度：單一服務、微服務、對外公開、到多租戶公開的遞進

   其關係：先定義安全模型與授權邊界（多維度管控）→ 依規模與風險選擇實作落點（應用/閘道）→ 選擇合適授權模型與協定（OAuth2/JWT/API Key 等）→ 制定誰負責與治理流程（權限生命週期與自助化）

3. 技術依賴：
   - 身份與授權：OAuth2/OIDC、JWT、Client Credentials、mTLS、API Key
   - 平台服務與框架：Azure AD、Azure API Management、API Gateway（Ocelot、YARP）、ASP.NET Core Middleware
   - 安全策略配套：Rate Limit、IP 白名單、時間窗、角色/範圍（Scopes）、多租戶隔離策略
   - 事件與審計：審計日誌、金鑰/Token 生命週期管理、金絲雀與 PoC 驗證流程

4. 應用場景：
   - 內部微服務間呼叫的服務對服務認證與授權
   - 對外公開 API（合作夥伴/第三方）之金鑰、配額與來源限制
   - 多租戶 SaaS 的租戶邊界與資料隔離
   - 委外/代開發的授權委任（客戶→第三方）的細粒度管控與撤銷
   - 高流量情境下將安全檢查前移至 Gateway 的 Offloading

### 學習路徑建議
1. 入門者路徑：
   - 了解 API 認證與授權差異、常見憑證類型（API Key、JWT）
   - 以單一服務為例，實作簡單的 Middleware 做 API Key 驗證與基本角色授權
   - 加入基本保護：Rate Limit、IP 白名單、審計日誌

2. 進階者路徑：
   - 引入 OAuth2/OIDC，區分機器對機器（Client Credentials）與使用者代理流程
   - 導入 Scope/Role 與資料層面的授權策略（功能/資料/指令維度）
   - 練習在 API Gateway（Ocelot/YARP 或雲端 APIM）進行 Offloading 與自訂策略
   - 建立權限治理流程：金鑰輪替、Token 期限、權限申請/審批/回收

3. 實戰路徑：
   - 多服務/多租戶專案：設計租戶隔離（租戶標識、過濾器/Policy、資料庫層隔離）
   - 設計委任/轉授權模型（by intention）：客戶→第三方可控且可撤銷的最小授權
   - 以 PoC 驗證模型，在低風險環境測試 Gateway 規則、Middleware 策略一致性
   - 建立可觀測性：集中式審計、異常告警、攻擊指標與流量異常偵測

### 關鍵要點清單
- 安全即設計題：安全模型需在系統設計階段確立，不可事後補救 (優先級: 高)
- 多維度管控：同時定義「管什麼」「管誰」「誰來管」，避免單點盲區 (優先級: 高)
- 功能/資料/指令分層：授權不僅是功能，還要限制資料範圍與可執行行為 (優先級: 高)
- 角色與範圍（Role/Scope）：以最小權限原則設計 API 授權邏輯 (優先級: 高)
- 內外部主體辨識：區分內部服務、合作夥伴、客戶、第三方委外的身份與邊界 (優先級: 高)
- 設計階段 vs 授權階段決策：哪些在設計時固定，哪些在發放憑證時可配置 (優先級: 中)
- OAuth2/OIDC 與 JWT：主流身份與授權協定與令牌格式的正確使用 (優先級: 高)
- API Key 的定位：簡單場景可用，但需搭配配額與來源限制以降低風險 (優先級: 中)
- Gateway Offloading：高流量下將驗證/限流/黑白名單前移到 API Gateway (優先級: 高)
- Rate Limit 與 IP 白名單：作為第一道防線的頻控與來源控制 (優先級: 高)
- 多租戶隔離：以租戶標識與資料層策略確保跨租戶不可見與不可操作 (優先級: 高)
- 委任/轉授權（by intention）：支援客戶授權第三方、可監控且可撤銷 (優先級: 中)
- 權限治理與生命周期：金鑰輪替、Token 期限、審批與回收流程制度化 (優先級: 高)
- 審計與可觀測性：完整記錄誰在何時對何資源做了何操作 (優先級: 高)
- PoC 驗證與演進：先以框架內實作，成熟後再搬到基礎設施層以確保一致性 (優先級: 中)