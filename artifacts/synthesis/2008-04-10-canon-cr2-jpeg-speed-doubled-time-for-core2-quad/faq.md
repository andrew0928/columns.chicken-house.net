# Canon CR2 --> .JPEG 速度加倍.. 該換 Core2 Quad 了嘛?

## 問題與答案 (FAQ)

### Q&A 類別 A: 概念理解類

A-Q1: 什麼是 CR2 到 JPEG 的轉檔？
- A簡: 將 Canon 相機 RAW 檔 CR2 藉由編解碼器解碼，再壓縮輸出為 JPEG，便於瀏覽、儲存與分享。
- A詳: CR2 是 Canon 相機的 RAW 檔，保留感光元件的高動態範圍與原始資訊；JPEG 則是有損壓縮的通用影像格式。轉檔流程包含：以 Canon Codec 解碼 CR2、可選擇色彩/白平衡處理、輸出為 JPEG。對大量照片歸檔、快速瀏覽與分發特別重要。本文情境以批次轉檔為主，強調執行效率與併行策略。
- 難度: 初級
- 學習階段: 基礎
- 關聯概念: A-Q2, A-Q9, B-Q4

A-Q2: Canon Codec 是什麼？
- A簡: Canon 提供的 CR2 解碼元件，用來將 RAW 資料轉成標準影像像素，供應用程式使用。
- A詳: Canon Codec 是處理 CR2 檔案的廠商編解碼器，負責解析 RAW 檔的馬賽克、色彩矩陣、白平衡、去噪與基礎色彩還原，輸出可見像素或中介格式。本文觀察此 Codec 在單一行程內存在不可重入限制，導致多執行緒難以同時利用多核心。了解其限制是設計併行策略的前提。
- 難度: 初級
- 學習階段: 基礎
- 關聯概念: A-Q3, B-Q1, B-Q2

A-Q3: 什麼是不可重入（Non-reentrant）與非執行緒安全？
- A簡: 例行在同一行程被同時呼叫會產生錯誤或互斥，無法並行；常見原因是共享狀態未妥善保護。
- A詳: 不可重入表示函式或元件在同一行程中若同時（多執行緒）進入，會出現競爭、資料毀損或內部互斥強制序列化。其常見成因為使用全域狀態、靜態緩衝區或非線程安全資源。本文中的 Canon Codec 展現此特性，限制了單行程內的平行度，促使以多行程（每行程一份獨立狀態）繞過此限制。
- 難度: 初級
- 學習階段: 基礎
- 關聯概念: B-Q1, A-Q5, B-Q9

A-Q4: 為什麼單一行程內無法讓 Canon Codec 同時用到多核心？
- A簡: 因其不可重入或內部鎖序列化，導致多執行緒呼叫被排隊，未形成真正並行。
- A詳: 當元件內部以 process 內部鎖或共享狀態限制同時進入，多執行緒呼叫其實會線性化。即使 CPU 有多核心，工作也須等待內部鎖釋放，CPU 利用率提升有限。本文實證顯示以 ThreadPool 堆疊工作幾無助益，瓶頸仍在 Codec 呼叫段，成為整體效能上限的核心制約。
- 難度: 中級
- 學習階段: 核心
- 關聯概念: A-Q6, B-Q1, B-Q8

A-Q5: 多執行緒與多行程的差異是什麼？
- A簡: 多執行緒共享同一行程記憶體；多行程各自獨立記憶體與狀態，彼此隔離。
- A詳: 多執行緒（同一行程）輕量、共享資源，IPC 輕省，但易被共享狀態與鎖競爭限制；多行程擁有獨立位址空間，各載入各自的 DLL/狀態，容錯佳、隔離強，可繞過 in-process 鎖，但需要 IPC 與行程啟動開銷。本文以雙行程方式，讓每個行程各自使用一份 Codec，達成真正並行。
- 難度: 初級
- 學習階段: 基礎
- 關聯概念: B-Q2, B-Q3, A-Q11

A-Q6: 為什麼使用 ThreadPool 仍無法顯著提升轉檔速度？
- A簡: 真正瓶頸在不可重入的 Codec 呼叫，執行緒再多也被序列化，CPU 無法滿載。
- A詳: ThreadPool 適合拆分可並行的工作；但若核心函式被內部鎖定序列化，外部再多執行緒皆無法同時進入，反增上下文切換負擔。本文實測指出其他可平行的「填空」工作先完成，最終耗時仍卡在 CR2→JPG 段，故需改變並行粒度與邊界，改走多行程。
- 難度: 中級
- 學習階段: 核心
- 關聯概念: B-Q8, A-Q8, B-Q2

A-Q7: 什麼是 CPU 利用率？為何重要？
- A簡: CPU 忙碌比例。高利用率常代表有效併行與資源使用，對吞吐量關鍵。
- A詳: CPU 利用率是觀測計算資源是否被有效驅動的指標。本文情境中，單行程受限造成利用率偏低；雙行程後提升至約 80%，顯示併行度改善。需注意利用率非唯一目標，還要考量 I/O、溫度與功耗；但對 CPU-bound 的影像解碼/壓縮而言，其與吞吐量高度相關。
- 難度: 初級
- 學習階段: 基礎
- 關聯概念: A-Q14, B-Q11, B-Q6

A-Q8: 什麼是效能瓶頸？
- A簡: 限制整體速度的最慢環節。優化應優先針對瓶頸，才有顯著成效。
- A詳: 系統的總時間取決於最耗時段落。本文瓶頸是 Canon Codec 轉檔段，其他工作完成後仍必須等待此段。識別瓶頸可用剖析、計時與併發度觀測。針對瓶頸選擇正確的並行策略（由多執行緒改為多行程），帶來速度加倍的實質改善。
- 難度: 初級
- 學習階段: 基礎
- 關聯概念: B-Q6, A-Q6, B-Q7

A-Q9: 提升轉檔效能的核心價值是什麼？
- A簡: 提高吞吐量、縮短總批次時間，讓歸檔流程更符合實務與使用者體驗。
- A詳: 在批次轉換情境，一張 70 秒、上百張持續數小時。透過設計併行架構，將瓶頸段重排與隔離，能以相同硬體取得更高吞吐量，省時省電並改善工作流。對個人與團隊皆能降低等待、加速後續處理（備份、整理、發佈），提升整體產能與滿意度。
- 難度: 初級
- 學習階段: 基礎
- 關聯概念: A-Q14, B-Q2, B-Q4

A-Q10: 為什麼要把轉檔功能抽成外部可執行檔？
- A簡: 以多行程隔離不可重入限制，讓每行程各自並行，實現吞吐量倍增。
- A詳: 抽成 .exe 後，主程式可同時啟動多個子行程，每個子行程載入自己的 Codec 實例，避開 in-process 鎖。雖有 IPC、啟動與參數解析成本，但相較每張 70 秒的重工作業，這些成本可忽略。此做法亦提升容錯，子行程崩潰不拖垮主程式。
- 難度: 中級
- 學習階段: 核心
- 關聯概念: B-Q4, B-Q18, C-Q1

A-Q11: 什麼是 IPC（行程間通訊）？
- A簡: 多行程之間交換資料或控制訊息的方法，如檔案、命令列、管道、Socket。
- A詳: IPC 包含多種機制：命令列引數、環境變數、暫存檔、標準輸入/輸出、命名管道、共享記憶體與 Socket 等。選擇取決於資料量、雙向性、即時性與實作成本。本文採簡單可行的引數與檔案回報，兼顧低開發風險與足夠效能。
- 難度: 中級
- 學習階段: 核心
- 關聯概念: B-Q3, C-Q3, C-Q4

A-Q12: 跨行程的參數與回傳值如何處理？
- A簡: 以命令列傳入 JSON/路徑，回傳用退出碼、標準輸出或結果檔。
- A詳: 常見模式是：主程式以命令列傳路徑與選項（必要時 JSON 序列化）；子行程完成後以 ExitCode 表示成功/失敗，詳細訊息寫標準輸出或結果檔（含錯誤碼、耗時、輸出檔名）。此法實作簡單，對批次轉換足夠且可記錄審計。
- 難度: 中級
- 學習階段: 核心
- 關聯概念: B-Q3, C-Q3, C-Q4

A-Q13: 為什麼多行程能繞過庫的 in-process 限制？
- A簡: 各行程有獨立位址空間與 DLL 狀態，各執行各的實例，不共享鎖。
- A詳: 內含鎖或全域狀態的庫，通常只保護本行程內的重入與一致性，並不做跨行程全域鎖。將負載分散到多行程，讓每行程擁有一份獨立狀態，即可實現真正並行。除非該庫採用跨行程資源鎖（少見），否則此模式有效。
- 難度: 中級
- 學習階段: 核心
- 關聯概念: B-Q1, B-Q9, A-Q5

A-Q14: 速度加倍如何衡量：吞吐量 vs 延遲？
- A簡: 單張延遲仍約 70 秒，但兩張同時 70 秒完成，吞吐量翻倍。
- A詳: 吞吐量指單位時間完成的工作數；延遲指單一任務耗時。本文透過兩個並行轉檔行程，單張耗時不變，但 70 秒完成兩張，故吞吐量加倍。評估需明辨兩者，批次處理應以吞吐量為首要指標。
- 難度: 初級
- 學習階段: 基礎
- 關聯概念: B-Q6, A-Q7, A-Q9

A-Q15: 鎖（Lock）的範圍：行程內 vs 跨行程有何不同？
- A簡: 多數庫僅在行程內鎖定；跨行程需用命名 Mutex/檔案鎖等額外機制。
- A詳: 行程內鎖（如 .NET lock）僅作用於同一位址空間。跨行程鎖需命名 Mutex、檔案鎖或 OS 資源。本文推論 Canon Codec 僅行程內鎖，故多行程可並行。若資源本身跨行程（同一輸出檔），則仍需明確跨行程協調。
- 難度: 中級
- 學習階段: 核心
- 關聯概念: B-Q9, C-Q6, D-Q7

A-Q16: 什麼是「填空檔」工作的策略？
- A簡: 以其他可並行的小任務填補 CPU 空閒，但無法突破最慢瓶頸。
- A詳: 將流程拆為可平行與不可平行段，嘗試在不可平行段等待時安排 I/O、索引或記錄等輕量工作。此策略可微幅提升整體使用率，但若瓶頸段占比過高（如 CR2→JPG），成效有限。此時需改變瓶頸段的併行方式。
- 難度: 中級
- 學習階段: 核心
- 關聯概念: A-Q8, B-Q6, B-Q15

A-Q17: 什麼是理想的 100% CPU 利用率？為何難達成？
- A簡: 所有核心持續滿載運算；受限於鎖、I/O、排程與熱限制，實務難以長期維持。
- A詳: 理想狀態是每核心無空轉，工作無等待。但現實包含：不可重入限制、I/O 抽換、記憶體頻寬、作業系統排程、散熱降頻等。本文實測雙行程約 80%，已反映多因素約束；追求更高需從削減同步、提升 I/O 與散熱等多面佈局。
- 難度: 中級
- 學習階段: 核心
- 關聯概念: B-Q11, B-Q16, D-Q10

A-Q18: 什麼時候值得升級到四核心（如 Q9450）？
- A簡: 當瓶頸段能隨並行度近線性擴展且其他資源不成限速時，升級更有效。
- A詳: 若經多行程驗證工作能隨並行數增加而提升吞吐量（如每行程一份 Codec），且磁碟、記憶體與散熱尚未飽和，升級到更多核心可進一步受益。反之若瓶頸不可並行或受 I/O 限制，硬體升級的邊際效益會遞減。
- 難度: 中級
- 學習階段: 進階
- 關聯概念: B-Q14, A-Q14, B-Q25

A-Q19: 什麼是 Amdahl 定律？對本案例有何啟示？
- A簡: 加速比受不可並行部分比例限制；瓶頸越大，平行化回報越小。
- A詳: Amdahl 定律指出：總加速比 = 1 / (S + (1 − S)/P)，S 為不可並行比例，P 為處理器數。本文透過多行程降低「不可並行」的有效比例，使兩條轉檔並行，吞吐量近倍增。擴展到四核時，仍需檢視 S 是否進一步降低，否則加速上限受限。
- 難度: 高級
- 學習階段: 進階
- 關聯概念: B-Q14, A-Q18, B-Q6

A-Q20: 什麼是工作單元粒度？為何影響併行效率？
- A簡: 任務切分大小。顆粒太細增加開銷，太粗則降低並行與負載平衡。
- A詳: 本案將「一張圖的轉檔」定義為工作單元，粒度足夠大以攤提行程啟動與 IPC 成本，且易於排程與重試。若切分過細（每步驟一行程）會嚴重增加同步與交握成本；過粗（一次整批）則並行度不足。選擇適中粒度是關鍵。
- 難度: 中級
- 學習階段: 核心
- 關聯概念: B-Q6, B-Q18, C-Q6

---

### Q&A 類別 B: 技術原理類

B-Q1: Canon Codec 在單行程的不可重入機制如何運作？
- A簡: 透過行程內鎖或共享狀態限制同時呼叫，避免資料競爭但導致序列化。
- A詳: 技術原理說明：許多編解碼器使用靜態緩衝與全域上下文，透過互斥鎖保護一致性。關鍵流程：呼叫進入→取得內部鎖→解碼→釋放鎖。核心組件：行程內互斥、共享快取。此導致多執行緒呼叫仍被排隊，無法同時利用多核心。多行程可讓每行程持有一份獨立上下文以並行。
- 難度: 中級
- 學習階段: 核心
- 關聯概念: A-Q3, A-Q4, A-Q13

B-Q2: 多行程並行如何提升 CPU 利用率的原理？
- A簡: 各行程載入獨立庫實例並行執行，消除行程內鎖競爭，使核心同時工作。
- A詳: 原理說明：作業系統將行程排程至不同核心，各行程擁有獨立位址空間。流程：主程式建立兩子行程→各自處理任務→並行完成。核心組件：OS 排程器、Process、各行程獨立 DLL 實例。此法有效將不可重入問題轉化為可平行工作，提升 CPU 忙碌度與吞吐量。
- 難度: 中級
- 學習階段: 核心
- 關聯概念: A-Q5, A-Q10, B-Q18

B-Q3: IPC 機制比較：檔案、命令列、標準輸出、命名管道的取捨？
- A簡: 小量單向用命令列與退出碼；中量雙向用標準 IO；大吞吐低延遲用命名管道。
- A詳: 原理說明：命令列易用、零常駐連線；標準輸出入適合回報結果；檔案適用批次結果與審計；命名管道提供低延遲雙向通道。流程：主程式封裝參數→傳遞→子行程讀取→計算→回報。核心組件：ProcessStartInfo、StdIn/Out、PipeServer。依資料量與複雜度選擇即可。
- 難度: 中級
- 學習階段: 核心
- 關聯概念: A-Q11, A-Q12, C-Q4

B-Q4: 將轉檔抽成可執行檔的架構怎麼設計？
- A簡: 主程式負責排程與監控，子行程專注轉檔，透過 IPC 交握任務與結果。
- A詳: 技術原理：分離關注點，主控進度與併發度，子行程負責單張轉換。流程：主程式建任務隊列→按度量啟動兩子行程→傳參→等待完成→記錄結果。核心組件：任務管理器、Process 管理、結果匯總器。此架構擴展容易、容錯良好。
- 難度: 中級
- 學習階段: 核心
- 關聯概念: C-Q1, C-Q2, B-Q18

B-Q5: 如何控制同時轉檔「兩個」的度量（Degree of Parallelism）？
- A簡: 以工作佇列與計數器限制同時啟動的子行程數，完成一個再補一個。
- A詳: 原理：限流確保資源平衡。流程：維護佇列→若執行中<2則啟動→監聽退出→取回結果→補上新工作。核心組件：佇列、計數器、Process 事件（Exited）。此法避免過度啟動造成 I/O 爭用，實作簡單且可擴展至 N 並行。
- 難度: 中級
- 學習階段: 核心
- 關聯概念: C-Q2, A-Q20, B-Q6

B-Q6: 吞吐量度量與排程模型怎麼建立？
- A簡: 以每分鐘完成張數衡量，建立先入先出佇列與固定並行度排程。
- A詳: 原理：穩態吞吐 = 併行度 / 單張平均時間。流程：量測單張耗時→設定併行度→以 FIFO 發派→記錄完成時間→動態調整。核心組件：計時器、統計器、排程器。本文案例兩行程、70 秒/張，穩態約每 70 秒完成 2 張。
- 難度: 中級
- 學習階段: 核心
- 關聯概念: A-Q14, B-Q5, B-Q7

B-Q7: 如何設計實驗驗證多行程帶來的效能提升？
- A簡: 控制變因、重複測量，單行程與雙行程比對 CPU 利用率與完成時間。
- A詳: 原理：科學對照。流程：準備相同資料集→量測單行程批次時間與 CPU→改為雙行程→重複 N 次→統計均值與變異。核心組件：基準資料、效能監測（PerfMon/計時器）、統計報表。本文觀察 CPU 由低提升至約 80%，吞吐量倍增。
- 難度: 中級
- 學習階段: 核心
- 關聯概念: A-Q7, A-Q8, B-Q6

B-Q8: ThreadPool 的適用情境與限制是什麼？
- A簡: 適合可並行、無重度同步的工作；遇到內部序列化的庫時收益有限。
- A詳: 原理：ThreadPool 管理執行緒生命週期，降低建立成本。流程：提交工作→佇列→執行→回收。核心組件：工作佇列、工作竊取。限制：若工作內部有全域鎖或 I/O 阻塞，易形成爭用與效益遞減。本案即為典型限制案例。
- 難度: 初級
- 學習階段: 基礎
- 關聯概念: A-Q6, B-Q1, A-Q5

B-Q9: 行程內鎖與跨行程鎖的差異與代價？
- A簡: 行程內鎖輕巧快速；跨行程鎖需 OS 支援，延遲與複雜度較高。
- A詳: 原理：行程內鎖基於記憶體同步原語；跨行程鎖需命名 Mutex、檔案鎖或記憶體映射。流程：創建/打開命名資源→爭用→釋放。核心組件：OS 內核物件。本文受益於僅有行程內鎖，因而可平行。若跨行程資源衝突，需設計協調層。
- 難度: 中級
- 學習階段: 核心
- 關聯概念: A-Q15, D-Q7, C-Q6

B-Q10: 如何避免核心間爭用：行程到核心的映射策略？
- A簡: 控制併行數與作業系統排程，必要時以處理序親和性固定分派。
- A詳: 原理：避免過度競爭同一核心與快取。流程：限制同時子行程數為核心數→可選擇設定 ProcessorAffinity→監看負載。核心組件：Process 優先序、親和性。本文雙核心情境兩行程已足夠，四核心可上調至四行程評估。
- 難度: 高級
- 學習階段: 進階
- 關聯概念: B-Q14, A-Q17, D-Q10

B-Q11: 如何判斷轉檔是 CPU-bound 還是 I/O-bound？
- A簡: 觀測 CPU 滿載而磁碟低壓即為 CPU-bound；反之則 I/O-bound。
- A詳: 原理：資源占用特徵。流程：量測 CPU、磁碟、記憶體、溫度→分析關聯→定位瓶頸。核心組件：效能計數器（% Processor Time、Disk Queue Length）。本文 CPU 利用率是關鍵指標，I/O 並非主因，故增加併行能直接提升吞吐。
- 難度: 中級
- 學習階段: 核心
- 關聯概念: A-Q7, A-Q8, D-Q6

B-Q12: 參數序列化格式該如何選擇？
- A簡: 簡單選命令列與 key=value；複雜選 JSON；大量清單用檔案路徑傳遞。
- A詳: 原理：權衡易用與彈性。流程：設計參數模式→實作解析→驗證合法→錯誤回報。核心組件：解析器、Schema 驗證。本文建議：單檔/少量選命令列；大量批次以路徑清單檔傳遞；回傳以 JSON/純文字紀錄結果。
- 難度: 初級
- 學習階段: 基礎
- 關聯概念: A-Q12, C-Q3, C-Q4

B-Q13: 回傳碼與錯誤處理如何設計？
- A簡: ExitCode 表示成敗，詳細錯誤與診斷寫標準輸出與日誌，主程式集中匯整。
- A詳: 原理：清晰且機器可讀。流程：子行程捕捉例外→映射錯誤碼→輸出訊息→設定 ExitCode→結束。核心組件：錯誤碼表、日誌器、重試策略。可加上校驗與輸出檔完整性檢查，提升可靠性與可維運性。
- 難度: 中級
- 學習階段: 核心
- 關聯概念: C-Q4, D-Q1, D-Q8

B-Q14: 擴展到四核心或更多時，效能如何預估？
- A簡: 依 Amdahl/Gustafson 定律估算上限，再用實測校正 I/O 與熱限速。
- A詳: 原理：平行加速上限由不可並行比例界定。流程：測單張耗時與並行下吞吐→估計 S→推導 P=4 的加速→實測驗證→調整併行度與 I/O 參數。核心組件：度量模型、實驗框架。本文提示可望近線性提升，但需防 I/O 與散熱瓶頸。
- 難度: 高級
- 學習階段: 進階
- 關聯概念: A-Q18, A-Q19, B-Q10

B-Q15: 管線式（Pipeline）與批次式流程有何差異？
- A簡: 管線式可在不同階段並行；批次式一次做完。視依賴性與成本選擇。
- A詳: 原理：分階段併行與緩衝。流程：解碼→處理→壓縮可分不同工作線並行；批次則一氣呵成。核心組件：佇列、背壓、緩衝區。本文將工作單元定義為單張轉檔，屬批次式；若後續還有縮圖/上傳，可採管線化提升整體吞吐。
- 難度: 中級
- 學習階段: 核心
- 關聯概念: A-Q16, B-Q6, C-Q6

B-Q16: 長時間轉檔的溫控與降頻對效能的影響？
- A簡: 高溫會導致 CPU 降頻，降低吞吐；需注意散熱與環境溫度。
- A詳: 原理：處理器為保護機制在高溫時降低頻率。流程：監控溫度→觀測頻率變化→修正並行度或改善散熱。核心組件：硬體監測、風扇/散熱器。本文觀測 80% 利用率穩定，若升核心數需同步提升散熱以避免降頻造成反效果。
- 難度: 中級
- 學習階段: 進階
- 關聯概念: A-Q17, D-Q10, B-Q14

B-Q17: 記憶體與 I/O 如何避免成為新瓶頸？
- A簡: 控制並行度、使用快 SSD、序列化 I/O，避免同時爭用同一磁碟。
- A詳: 原理：I/O 隨並行度上升可能飽和。流程：測磁碟佇列→調整同時寫入數→分離輸入輸出磁碟→啟用寫入快取。核心組件：I/O 排程、快取策略。本文 CPU-bound，但擴展至多行程時，必須同步設計 I/O 策略。
- 難度: 中級
- 學習階段: 核心
- 關聯概念: B-Q11, D-Q6, C-Q6

B-Q18: 行程啟動開銷如何攤提與最小化？
- A簡: 以大粒度任務（單張/多張）攤提，重用子行程與懶啟動降低成本。
- A詳: 原理：啟動成本固定，任務越大越不顯著。流程：一次啟動處理多筆→或維持長駐子行程循環接單→批次提交→集中回報。核心組件：工作拉取模型、Keep-alive 子行程。本文任務耗時 70 秒，啟動成本可忽略，但仍可考慮重用以提升穩定性。
- 難度: 中級
- 學習階段: 核心
- 關聯概念: A-Q20, C-Q2, C-Q6

B-Q19: WPF UI 與背景工作如何隔離？
- A簡: 轉檔放背景 Task/Process，UI 維持單執行緒，透過 Dispatcher 更新狀態。
- A詳: 原理：避免 UI 凍結與跨執行緒存取錯誤。流程：UI 發派任務→背景執行（Task/Process）→回報進度→Dispatcher.Invoke 更新 UI。核心組件：Dispatcher、SynchronizationContext。本文主程式可視為 WPF 殼，負責觸發與監控。
- 難度: 初級
- 學習階段: 基礎
- 關聯概念: C-Q9, D-Q4, B-Q4

B-Q20: 容錯性：子行程崩潰時如何保持系統穩定？
- A簡: 行程隔離讓主程式不受影響，透過退出碼與重試機制恢復。
- A詳: 原理：行程邊界天然隔離錯誤。流程：監聽 Exited→檢查 ExitCode→記錄失敗→按策略重試/略過→繼續排程。核心組件：Process 事件、重試與斷路器模式。相較於單行程，崩潰不會拖垮整體，提高可用性。
- 難度: 中級
- 學習階段: 核心
- 關聯概念: D-Q1, C-Q7, B-Q13

B-Q21: 資料一致性：輸入/輸出檔名與原子性如何保障？
- A簡: 採暫存檔後再原子更名，並規範路徑與命名，避免覆寫與衝突。
- A詳: 原理：避免半成品與同名競爭。流程：輸出到 temp 路徑→完成校驗→File.Move 原子替換→寫結果記錄。核心組件：臨時目錄、校驗碼、檔案鎖（必要時）。多行程時更需一致性設計以防跨行程干擾。
- 難度: 中級
- 學習階段: 核心
- 關聯概念: D-Q7, C-Q6, B-Q9

B-Q22: 工作重試與檢查點如何設計？
- A簡: 以可重入的任務清單記錄進度，失敗項重試 N 次並保留最終失敗清單。
- A詳: 原理：冪等與持久化進度。流程：任務出佇列即標記處理中→成功打勾→失敗寫原因→達次數上限轉入失敗清單。核心組件：持久化狀態表、重試策略。大批次處理特別需要，以避免中斷重工。
- 難度: 中級
- 學習階段: 核心
- 關聯概念: C-Q7, D-Q1, B-Q13

B-Q23: 度量與日誌應記錄哪些關鍵欄位？
- A簡: 檔名、開始/結束時間、耗時、ExitCode、錯誤訊息、CPU/溫度快照。
- A詳: 原理：可追溯、可診斷、可優化。流程：子行程回報→主程式匯總→定期匯出報表。核心組件：統一日誌格式、結構化輸出（JSON/CSV）。據此調整併行度、散熱、I/O 策略，形成持續改進迴路。
- 難度: 初級
- 學習階段: 核心
- 關聯概念: B-Q6, D-Q2, C-Q8

B-Q24: 安全性考量：路徑與權限如何設計？
- A簡: 使用絕對路徑、驗證輸入、最小權限執行與目錄 ACL 控制。
- A詳: 原理：防止路徑注入與未授權存取。流程：白名單目錄→清理與正規化路徑→以低權限帳號執行→輸出目錄授權最小化。核心組件：路徑驗證器、權限設定。尤其當以命令列接收路徑時，需嚴格檢查避免安全風險。
- 難度: 中級
- 學習階段: 核心
- 關聯概念: C-Q3, D-Q4, B-Q21

B-Q25: 升級硬體（如 Q9450）可能遇到的非線性因素？
- A簡: I/O、Codec 內部限制、熱降頻與 OS 排程可能使加速低於核心數。
- A詳: 原理：系統效能由最慢部件決定。流程：升級前後做基準→定位新瓶頸→調整併行與 I/O→改善散熱。核心組件：效能模型、監測工具。雖然多核心帶來潛在提升，仍須端到端優化才能接近線性擴展。
- 難度: 高級
- 學習階段: 進階
- 關聯概念: A-Q18, B-Q14, B-Q16

---

### Q&A 類別 C: 實作應用類（10題）

C-Q1: 如何把 CR2→JPEG 轉檔抽成外部 .exe？
- A簡: 建立轉檔專用主控台程式，接收路徑參數，輸出檔與 ExitCode 回報狀態。
- A詳: 步驟：1) 建立 Console 專案 Convert.exe；2) 解析 args（輸入/輸出/品質）；3) 呼叫 Codec 轉檔；4) 寫日誌與 ExitCode。程式碼片段：Main(string[] args){ /* parse */ Convert(in,out); return 0; } 注意：參數驗證、例外處理、輸出原子更名。最佳實踐：單一職責、結構化輸出。
- 難度: 中級
- 學習階段: 核心
- 關聯概念: B-Q4, A-Q10, C-Q4

C-Q2: 主程式如何同時啟動兩個轉檔子行程？
- A簡: 使用 Process 啟動兩個 Convert.exe，監聽 Exited 事件並從佇列補工作。
- A詳: 步驟：1) 準備待轉清單 Queue；2) 若執行中<2→Start 子行程；3) 綁定 p.EnableRaisingEvents=true；4) Exited 時取回結果再補新任務。程式碼：ProcessStartInfo psi=...; var p=Process.Start(psi); p.Exited+=... 注意：控制並行度、錯誤重試、結束等待。最佳實踐：可配置 DOP。
- 難度: 中級
- 學習階段: 核心
- 關聯概念: B-Q5, B-Q18, C-Q7

C-Q3: 如何安全地用命令列傳遞多個檔案參數？
- A簡: 使用清單檔路徑參數或以 JSON 壓一個參數，處理空白與引號轉義。
- A詳: 步驟：1) 建立 tasks.json 或 list.txt；2) 主程式以 --task=path 傳遞；3) 子行程讀取清單逐一處理；4) 回報逐筆結果。程式碼：ProcessStartInfo.Arguments=$"--task \"{path}\""; 注意：路徑正規化、權限驗證、大小限制。最佳實踐：使用 UTF-8、避免環境相依。
- 難度: 中級
- 學習階段: 核心
- 關聯概念: B-Q3, B-Q12, B-Q24

C-Q4: 如何以標準輸出/退出碼回傳結果與錯誤？
- A簡: ExitCode=0 成功，非零錯誤；標準輸出列印 JSON 結果與錯誤訊息。
- A詳: 步驟：1) 設定 RedirectStandardOutput=true；2) 子行程 Console.WriteLine(JSON)；3) 主程式讀取 p.StandardOutput；4) 解析與紀錄。程式碼：var json=p.StandardOutput.ReadToEnd(); 注意：避免輸出過大阻塞、設定編碼。最佳實踐：定義錯誤碼表與結構化訊息。
- 難度: 中級
- 學習階段: 核心
- 關聯概念: B-Q13, B-Q3, C-Q8

C-Q5: 如何用命名管道提升 IPC 效率？
- A簡: 主程式開 PipeServer，子行程連線傳任務與結果，降低啟動/解析成本。
- A詳: 步驟：1) 主程式建立 NamedPipeServerStream；2) 子行程以 NamedPipeClientStream 連線；3) 以 JSON/MessagePack 傳遞；4) 保持長連線處理多筆。程式碼：using(var pipe=new NamedPipeServerStream("cr2")){...} 注意：協定版本、逾時與重連。最佳實踐：心跳保活、背壓控制。
- 難度: 高級
- 學習階段: 進階
- 關聯概念: B-Q3, B-Q18, C-Q2

C-Q6: 如何控管並行度與避免 I/O 爭用？
- A簡: 設定最大同時子行程數，序列化寫入或分離輸入/輸出磁碟。
- A詳: 步驟：1) 以 SemaphoreSlim 限流；2) 寫入改為 temp+原子更名；3) 分配不同磁碟路徑；4) 監控磁碟佇列動態調整。程式碼：await semaphore.WaitAsync(); try{...} finally{semaphore.Release();} 注意：避免跨行程同檔衝突。最佳實踐：度量驅動調整。
- 難度: 中級
- 學習階段: 核心
- 關聯概念: B-Q17, B-Q21, D-Q6

C-Q7: 如何實作重試機制與失敗清單？
- A簡: 設錯誤碼白名單重試 N 次，超過記錄到 fail.log 供後續人工檢視。
- A詳: 步驟：1) 定義可重試錯誤碼（暫時性）與不可重試（格式錯誤）；2) 計次重試；3) 最終失敗寫入清單；4) 支援續跑。程式碼：if(retry<max && retriable) enqueue again; 注意：冪等性與部分輸出清理。最佳實踐：指紋檔檢查避免重工。
- 難度: 中級
- 學習階段: 核心
- 關聯概念: B-Q22, D-Q1, B-Q13

C-Q8: 如何量測 CPU 利用率與轉檔時間？
- A簡: 使用計時器量單張耗時，PerfCounter/OS API 量整體 CPU 與磁碟指標。
- A詳: 步驟：1) Stopwatch 計單張/批次；2) 讀 % Processor Time、Disk Queue；3) 寫入 metrics.csv；4) 可視化分析。程式碼：var sw=Stopwatch.StartNew(); ... sw.Elapsed; 注意：同步時鐘源、避免測試污染。最佳實踐：固定資料集，重複測量。
- 難度: 初級
- 學習階段: 基礎
- 關聯概念: B-Q7, B-Q23, A-Q7

C-Q9: WPF 如何避免 UI 凍結並安全更新進度？
- A簡: 背景 Task/Process 執行轉檔，透過 Dispatcher.Invoke 更新 UI 控制項。
- A詳: 步驟：1) 按鈕觸發建立任務；2) 在 Task.Run 中啟動子行程；3) 收到結果後 Application.Current.Dispatcher.Invoke 更新進度列；4) 錯誤以對話框提示。程式碼：Dispatcher.Invoke(()=>progress.Value++); 注意：避免跨執行緒存取控件。最佳實踐：MVVM 綁定進度。
- 難度: 中級
- 學習階段: 核心
- 關聯概念: B-Q19, D-Q4, B-Q4

C-Q10: 如何部署雙行程轉檔架構與設定路徑？
- A簡: 將主程式與 Convert.exe 同版控與安裝，使用相對路徑或設定檔指定位置。
- A詳: 步驟：1) 安裝打包兩執行檔；2) 設定 appsettings.json 指定 converter 路徑與 DOP；3) 啟動時驗證檔案存在與版本；4) 記錄環境資訊。程式碼：var path=Config["converterPath"]; 注意：權限、相依 DLL 一併部署。最佳實踐：版本相容檢查與自我診斷。
- 難度: 初級
- 學習階段: 基礎
- 關聯概念: B-Q24, D-Q4, C-Q2

---

### Q&A 類別 D: 問題解決類（10題）

D-Q1: 遇到 Canon Codec 報錯或子行程當機怎麼辦？
- A簡: 先辨識錯誤碼與可重試性，記錄日誌，重試限定次數，仍失敗移至清單。
- A詳: 症狀：ExitCode 非零、崩潰、標準輸出含例外。原因：損壞檔、版本不相容、資源不足。解法：檢視日誌→更新 Codec/相依→重試 N 次→隔離問題檔。預防：固定版本、驗證輸入、壓力測前測後。與多行程隔離結合，避免拖累整體。
- 難度: 中級
- 學習階段: 核心
- 關聯概念: B-Q13, B-Q20, C-Q7

D-Q2: 啟動雙行程後 CPU 未達 80%，如何排查？
- A簡: 檢查 I/O、溫度降頻、親和性設定與內部等待，逐一消除瓶頸。
- A詳: 症狀：CPU 利用率低、磁碟佇列高或溫度高。原因：I/O 飽和、熱降頻、行程互等。解法：分離磁碟、改善散熱、調整並行度、關閉省電、檢查親和性。預防：度量基線、動態調整策略。必要時改良 IPC 降低等待。
- 難度: 中級
- 學習階段: 核心
- 關聯概念: B-Q11, B-Q16, B-Q10

D-Q3: 轉完的 JPEG 出現損毀或色偏怎麼辦？
- A簡: 檢查輸出流程與 Codec 版本，驗證色彩設定與寫入原子性，必要重試。
- A詳: 症狀：檔案無法開啟、顏色異常。原因：寫入中斷、色彩空間設定錯誤、壓縮參數不當、版本不相容。解法：採用 temp→原子更名、固定色彩配置、對照單行程輸出。預防：一致性測試、版本鎖定、CRC 校驗。
- 難度: 中級
- 學習階段: 核心
- 關聯概念: B-Q21, C-Q6, B-Q24

D-Q4: 子行程無法啟動或找不到 Convert.exe？
- A簡: 確認部署路徑、權限與相依 DLL，使用絕對路徑與存在性檢查。
- A詳: 症狀：啟動例外、檔案不存在。原因：部署缺漏、路徑相對錯誤、權限不足。解法：設定檔指定路徑、啟動前 File.Exists、加入相依庫、以適當權限執行。預防：安裝腳本驗證、開機自檢。
- 難度: 初級
- 學習階段: 基礎
- 關聯概念: C-Q10, B-Q24, B-Q19

D-Q5: 參數含空白或特殊字元導致解析錯誤？
- A簡: 正確引用與轉義，或改用清單檔/JSON 傳遞，避免命令列長度限制。
- A詳: 症狀：路徑截斷、引號錯位。原因：未加引號、Shell 轉義錯誤。解法：Arguments 使用引號包裹、Path 正規化、或以檔案/JSON 參數。預防：統一參數規範與測試樣本庫，避免手動拼接。
- 難度: 初級
- 學習階段: 基礎
- 關聯概念: C-Q3, C-Q4, B-Q12

D-Q6: 磁碟 I/O 打滿，速度不升反降怎麼辦？
- A簡: 降低同時寫入、分離輸入輸出磁碟、使用 SSD 與最佳化快取。
- A詳: 症狀：Disk Queue 高、CPU 低。原因：並行度過高、單碟讀寫爭用。解法：限流、將輸入/輸出置於不同磁碟、啟用寫入合併、調整緩衝大小。預防：基準測 I/O 能力、動態調整 DOP，避免超載。
- 難度: 中級
- 學習階段: 核心
- 關聯概念: B-Q17, C-Q6, B-Q11

D-Q7: 出現跨行程檔案鎖死或覆寫衝突？
- A簡: 嚴格的檔名規約、temp 檔原子更名與必要時命名 Mutex 協調。
- A詳: 症狀：檔案使用中、輸出被覆寫。原因：多行程寫同檔、未原子更名。解法：每任務唯一輸出名、temp→Move、需要共享資源時用命名 Mutex。預防：在工作排程層面避免重複分派同源檔。
- 難度: 中級
- 學習階段: 核心
- 關聯概念: B-Q21, B-Q9, C-Q6

D-Q8: 回傳碼遺失或標準輸出阻塞造成卡住？
- A簡: 啟用非同步讀取標準輸出、設定緩衝與逾時，定義心跳訊號。
- A詳: 症狀：子行程不結束、主程式等不到結果。原因：StdOut 緩衝滿、未讀取、子行程掛住。解法：BeginOutputReadLine 非同步讀取、設定逾時、心跳協定；必要時殺行程重啟。預防：輸出量控制、分段回報。
- 難度: 高級
- 學習階段: 進階
- 關聯概念: C-Q4, B-Q3, B-Q20

D-Q9: 記憶體不足或 GC 壓力影響效能？
- A簡: 降低同時處理張數、流式處理影像、釋放非受控資源與調整 GC 模式。
- A詳: 症狀：記憶體飆高、頻繁 GC、效能波動。原因：大圖片緩衝、未釋放、同時併發過多。解法：控制 DOP、使用 using 釋放、LargeObject 避免碎片、Server GC。預防：容量壓力測試與監控。
- 難度: 中級
- 學習階段: 核心
- 關聯概念: B-Q5, B-Q18, D-Q2

D-Q10: 長時間批次轉檔導致溫度過高降頻怎麼處理？
- A簡: 改善散熱、降低併行度、設定功耗曲線與監控，維持穩態吞吐。
- A詳: 症狀：初期快後期慢、CPU 頻率下降。原因：散熱不足、環境溫高。解法：清潔散熱、提升風流、調整 DOP、設定高效能電源。預防：持續監控溫度與頻率，在基準測中納入熱因素評估。
- 難度: 中級
- 學習階段: 進階
- 關聯概念: B-Q16, B-Q10, A-Q17

---

### 學習路徑索引
- 初學者：建議先學習哪 15 題
    - A-Q1: 什麼是 CR2 到 JPEG 的轉檔？
    - A-Q2: Canon Codec 是什麼？
    - A-Q5: 多執行緒與多行程的差異是什麼？
    - A-Q7: 什麼是 CPU 利用率？為何重要？
    - A-Q8: 什麼是效能瓶頸？
    - A-Q9: 提升轉檔效能的核心價值是什麼？
    - A-Q14: 速度加倍如何衡量：吞吐量 vs 延遲？
    - B-Q8: ThreadPool 的適用情境與限制是什麼？
    - B-Q11: 如何判斷轉檔是 CPU-bound 還是 I/O-bound？
    - B-Q3: IPC 機制比較：檔案、命令列、標準輸出、命名管道的取捨？
    - B-Q4: 將轉檔抽成可執行檔的架構怎麼設計？
    - C-Q1: 如何把 CR2→JPEG 轉檔抽成外部 .exe？
    - C-Q2: 主程式如何同時啟動兩個轉檔子行程？
    - C-Q4: 如何以標準輸出/退出碼回傳結果與錯誤？
    - D-Q4: 子行程無法啟動或找不到 Convert.exe？

- 中級者：建議學習哪 20 題
    - A-Q3: 什麼是不可重入（Non-reentrant）與非執行緒安全？
    - A-Q4: 為什麼單一行程內無法讓 Canon Codec 同時用到多核心？
    - A-Q10: 為什麼要把轉檔功能抽成外部可執行檔？
    - A-Q11: 什麼是 IPC（行程間通訊）？
    - A-Q12: 跨行程的參數與回傳值如何處理？
    - A-Q15: 鎖（Lock）的範圍：行程內 vs 跨行程有何不同？
    - A-Q16: 什麼是「填空檔」工作的策略？
    - A-Q20: 什麼是工作單元粒度？為何影響併行效率？
    - B-Q1: Canon Codec 在單行程的不可重入機制如何運作？
    - B-Q2: 多行程並行如何提升 CPU 利用率的原理？
    - B-Q5: 如何控制同時轉檔「兩個」的度量（Degree of Parallelism）？
    - B-Q6: 吞吐量度量與排程模型怎麼建立？
    - B-Q7: 如何設計實驗驗證多行程帶來的效能提升？
    - B-Q13: 回傳碼與錯誤處理如何設計？
    - B-Q17: 記憶體與 I/O 如何避免成為新瓶頸？
    - B-Q21: 資料一致性：輸入/輸出檔名與原子性如何保障？
    - C-Q3: 如何安全地用命令列傳遞多個檔案參數？
    - C-Q6: 如何控管並行度與避免 I/O 爭用？
    - C-Q7: 如何實作重試機制與失敗清單？
    - C-Q8: 如何量測 CPU 利用率與轉檔時間？

- 高級者：建議關注哪 15 題
    - A-Q18: 什麼時候值得升級到四核心（如 Q9450）？
    - A-Q19: 什麼是 Amdahl 定律？對本案例有何啟示？
    - B-Q9: 行程內鎖與跨行程鎖的差異與代價？
    - B-Q10: 如何避免核心間爭用：行程到核心的映射策略？
    - B-Q14: 擴展到四核心或更多時，效能如何預估？
    - B-Q15: 管線式（Pipeline）與批次式流程有何差異？
    - B-Q16: 長時間轉檔的溫控與降頻對效能的影響？
    - B-Q18: 行程啟動開銷如何攤提與最小化？
    - B-Q20: 容錯性：子行程崩潰時如何保持系統穩定？
    - B-Q22: 工作重試與檢查點如何設計？
    - B-Q23: 度量與日誌應記錄哪些關鍵欄位？
    - B-Q24: 安全性考量：路徑與權限如何設計？
    - B-Q25: 升級硬體（如 Q9450）可能遇到的非線性因素？
    - C-Q5: 如何用命名管道提升 IPC 效率？
    - D-Q8: 回傳碼遺失或標準輸出阻塞造成卡住？