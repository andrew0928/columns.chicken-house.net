---
layout: synthesis
title: "微服務架構設計 - 資料庫的選擇, RDBMS or NOSQL?"
synthesis_type: faq
source_post: /2020/07/01/microservice14-database/
redirect_from:
  - /2020/07/01/microservice14-database/faq/
---

# 微服務架構設計 - 資料庫的選擇, RDBMS or NoSQL? 常見問答集

## 問題與答案 (FAQ)

### Q&A 類別 A: 概念理解類

A-Q1: 什麼是微服務架構下的資料庫選擇問題？
- A簡: 在微服務情境，資料分散且難以跨庫，選擇RDBMS或NoSQL需從業務與架構出發，避免單純二選一。
- A詳: 在微服務中，服務被切分、資料分散，跨庫Join不可行，分散式交易與一致性轉為核心挑戰。因此資料庫不應簡化為RDBMS或NoSQL二選一，而是先定義業務需求與服務邊界，再決定資料模型與一致性策略，最後選擇或組合適合的存儲技術。正確順序是：業務目標→架構方案→存儲選型→產品比對。
- 難度: 初級
- 學習階段: 基礎
- 關聯概念: A-Q5, A-Q10, B-Q3

A-Q2: 什麼是RDBMS？
- A簡: 關聯式資料庫，以表格、正規化、索引與SQL查詢為核心，擅長ACID交易與複雜關聯。
- A詳: RDBMS基於關聯模型，使用表格與關聯描述資料，透過索引與查詢計畫優化檢索，典型索引結構如B/B+樹，查詢複雜度多為O(log n)等級。其強項為ACID交易、關聯一致性、複雜查詢與報表。缺點是水平擴展與跨庫Join受限，對微服務與海量K/V高頻操作的適配需謹慎規劃。
- 難度: 初級
- 學習階段: 基礎
- 關聯概念: A-Q7, B-Q1, B-Q14

A-Q3: 什麼是NoSQL？
- A簡: 非關聯資料庫總稱，重視可擴展與彈性Schema，常見K/V、文件、寬欄與圖形類型。
- A詳: NoSQL聚焦在大規模資料的可擴展性與模式彈性。文件庫以JSON/XML存放物件狀態；K/V以哈希定位實現近O(1)存取；寬欄適合時序/大表；圖庫擅長關聯遍歷。優勢在彈性Schema與水平擴展，弱項是跨集合關聯查詢、強一致交易能力有限，需要以架構層策略補足。
- 難度: 初級
- 學習階段: 基礎
- 關聯概念: A-Q17, B-Q2, B-Q18

A-Q4: RDBMS與NoSQL的本質差異是什麼？
- A簡: RDBMS抽象查詢與索引；NoSQL抽象資料結構（物件/文件），強調擴展性與K/V效能。
- A詳: RDBMS將資料結構與查詢演算法高度封裝在索引與SQL中，強項是ACID與複雜Join；NoSQL將資料定義與物件狀態抽象化，偏重K/V、文件與分片擴展，支援彈性Schema與低延遲存取。選擇取決於關聯複雜度、交易強度與擴展需求，而非孰優孰劣。
- 難度: 初級
- 學習階段: 基礎
- 關聯概念: B-Q1, B-Q2, A-Q20

A-Q5: 為什麼在微服務不應該只問RDBMS或NoSQL擇一？
- A簡: 微服務需同時滿足交易、一致性與擴展，多用混合方案整合各庫優勢，而非簡單選邊站。
- A詳: 微服務拆分導致跨服務資料與交易協調問題，單一資料庫難以同時滿足強交易、一致性與高擴展等衝突需求。常見策略是將RDBMS用於交易核心，NoSQL用於高併發讀、快取或非結構化資料，並以事件驅動、CQRS、Saga整合，取得整體效能與一致性平衡。
- 難度: 初級
- 學習階段: 基礎
- 關聯概念: A-Q13, A-Q20, B-Q15

A-Q6: 為何技術選型要先有架構方案而非直接選庫？
- A簡: 無架構即無方向；先定義需求、邊界與一致性，再選擇與組合資料庫才有效。
- A詳: 技術選型若未先釐清業務流、資料流、邊界與一致性策略，易落入產品比較迷思。正確流程：辨識最難的瓶頸→擬訂架構（服務拆分、交易策略、讀寫路徑）→選擇適配的資料模型與庫型→產品比較與POC。以架構驅動選型，避免治標不治本。
- 難度: 初級
- 學習階段: 基礎
- 關聯概念: B-Q3, B-Q16, C-Q10

A-Q7: 什麼是正規化？在RDBMS中的角色為何？
- A簡: 正規化消除重複與異常，靠關聯與約束保一致，利於維護但讀取需Join。
- A詳: 正規化透過分解表與關聯約束，消除重複、更新/刪除異常，提升資料一致性與完整性。優點是結構清晰、交易安全；缺點是跨表Join多、讀取成本高，對高併發讀與水平擴展不友善。微服務下常以反正規化或讀模型取代跨服務Join。
- 難度: 初級
- 學習階段: 基礎
- 關聯概念: A-Q8, B-Q16, D-Q5

A-Q8: 什麼是反正規化？何時適合？
- A簡: 為優化讀取而重複存資料，降低查詢成本；用於讀多、跨邊界查詢情境。
- A詳: 反正規化刻意存放重複欄位或嵌入子文件，換取讀取性能與簡化查詢。適用於報表、列表、跨服務聚合與高頻讀。代價是寫入與一致性管理更複雜，需以事件、補償與重建投影確保最終一致，典型在CQRS讀側、NoSQL文件建模中實施。
- 難度: 中級
- 學習階段: 核心
- 關聯概念: B-Q16, B-Q19, C-Q4

A-Q9: 為什麼微服務下跨庫JOIN不可行？
- A簡: 服務自治與獨立部署使跨庫Join失去原子性與性能，應改以API或讀模型。
- A詳: 每服務一庫強化自治，跨庫Join無法享有單庫ACID保證，且網路延遲與失敗風險高，導致性能不穩與一致性問題。替代方案：聚合API、預計算讀模型、事件驅動同步、搜索引擎或圖庫支持跨邊界關聯查詢。
- 難度: 中級
- 學習階段: 核心
- 關聯概念: C-Q4, B-Q19, D-Q5

A-Q10: 什麼是「每服務一資料庫」(Database per Service)？
- A簡: 每個微服務擁有獨立資料庫與模式，強化邊界與自治，避免共享耦合。
- A詳: 該模式將資料所有權與服務邊界綁定，服務負責自身資料的模式演進、交易與備援，不共享資料庫以避免耦合與跨團隊衝突。跨服務資料需求以API、事件與讀模型解決，代價是分散式一致性與報表需另設計。
- 難度: 中級
- 學習階段: 核心
- 關聯概念: B-Q3, C-Q10, D-Q5

A-Q11: 為什麼需要把SQL查詢降級為API存取？
- A簡: API可限制查詢型態、控一致性與安全，避免隨意Join破壞邊界與性能。
- A詳: 直接SQL查詢雖靈活，但會打破邊界、難以控制負載與安全。API可將查詢行為收斂為有限且可度量的操作，內部以索引、投影或搜索實現最佳化，並可結合RBAC/ABAC、速率限制與審計，確保服務穩定與資料治理。
- 難度: 中級
- 學習階段: 核心
- 關聯概念: B-Q8, B-Q20, C-Q4

A-Q12: 為何要以狀態機而非CRUD設計API？
- A簡: 狀態機API限制合法轉換，強化業務規則與一致性，便於審計與補償。
- A詳: CRUD著重資料表操作，容易遺漏業務不變式。狀態機將業務事件映射為有限轉換（如下單→付款→出貨），API即命令，配合事件與補償動作，可落實流程治理與可追溯性，特別適合Saga與CQRS架構。
- 難度: 中級
- 學習階段: 核心
- 關聯概念: A-Q14, B-Q6, C-Q3

A-Q13: 微服務下資料一致性有哪些選項？
- A簡: 強一致ACID、最終一致（事件/重試/補償）、讀己之寫等局部一致策略。
- A詳: 一致性包含強一致（單庫交易）、最終一致（事件驅動、重試、補償）、讀己之寫（會話粘性/版本檢核）等。選擇依據使用者體驗、延遲容忍與成本。多用ACID處理核心變更，用事件確保週邊讀模型同步。
- 難度: 中級
- 學習階段: 核心
- 關聯概念: B-Q4, B-Q15, D-Q7

A-Q14: 什麼是CQRS？核心價值是什麼？
- A簡: 讀寫分離，寫端聚焦命令一致性，讀端為查詢優化與反正規化投影。
- A詳: CQRS將寫入（命令）與讀取（查詢）模型分離。寫端維持業務不變式與交易邏輯；讀端以事件投影生成多個面向查詢的視圖（可反正規化）。好處是讀寫各自優化、水平擴展、報表不拖累交易，代價是最終一致與重建成本。
- 難度: 中級
- 學習階段: 核心
- 關聯概念: B-Q6, C-Q2, D-Q3

A-Q15: 什麼是事件驅動資料治理？
- A簡: 以事件傳遞資料變更，驅動讀模型、快取與其他服務同步，實現鬆耦合一致。
- A詳: 事件驅動將變更記錄為事件，透過Pub/Sub傳遞，消費者更新自身資料或投影。它解耦服務、提升可擴展性，並以重試、冪等、順序保證等手段實現最終一致。常與Outbox、事件溯源、CQRS搭配使用。
- 難度: 中級
- 學習階段: 核心
- 關聯概念: B-Q15, C-Q2, D-Q6

A-Q16: 什麼是Saga？與2PC差異？
- A簡: Saga以本地交易加補償達成最終一致；2PC以協調者鎖定資源求強一致。
- A詳: 2PC透過協調者兩階段提交保障跨資源原子性，但鎖資源、延遲高、失敗處理複雜。Saga將長交易拆為一系列本地交易與補償，採編排或編舞模式，追求最終一致與高可用，適合微服務與雲原生環境。
- 難度: 中級
- 學習階段: 核心
- 關聯概念: B-Q4, B-Q5, C-Q3

A-Q17: 為什麼NoSQL常見K/V可達O(1)？帶來什麼？
- A簡: 透過哈希與分片定位鍵，存取時間與資料量無關，適合高併發低延遲。
- A詳: K/V使用哈希表或一致性哈希分佈鍵，讀寫在均勻分佈下近似O(1)，並搭配複製與壓縮日誌保障可靠。它提供穩定低延遲與水平擴展，適用快取、會話、設定、排名與去重等場景，但不擅長複雜關聯查詢。
- 難度: 初級
- 學習階段: 基礎
- 關聯概念: B-Q2, C-Q8, D-Q2

A-Q18: 何謂不可變資料（Immutable）？何時用於快取？
- A簡: 不可變資料一經寫入不再變更，利於長時間安全快取與CDN分發。
- A詳: 將資料設計為不可變（如版本化、內容位址化），使其可被大膽快取與長TTL分發，避免失效難題。常見於媒體檔、歷史快照、發佈版本等，搭配內容雜湊鍵、ETag與CDN，顯著提升命中率與降低原庫壓力。
- 難度: 中級
- 學習階段: 核心
- 關聯概念: B-Q11, C-Q6, D-Q2

A-Q19: 什麼是多版本與寫時複製（COW）？
- A簡: 以版本鏈與引用計數保存歷史，寫入時複製修改部位，支援快照與回溯。
- A詳: COW在修改時複製受影響節點，舊版本仍指向未改段落，配合引用計數管理共享區塊。適合文檔/設定/內容管理的版本控制與快照回溯，降低存儲成本並提升審計與重建能力，類似Git等結構。
- 難度: 中級
- 學習階段: 進階
- 關聯概念: B-Q12, C-Q7, D-Q10

A-Q20: 何時應同時使用RDBMS與NoSQL？
- A簡: 當需強交易又要高讀取與彈性時，採交易用RDBMS、讀與快取用NoSQL。
- A詳: 常見搭配：RDBMS處理核心交易與結算；NoSQL提供列表、個人化與快取；搜尋引擎支持全文/聚合；資料倉儲負責報表分析。透過事件與Outbox同步，讀寫分離與最終一致，達到整體性能與可靠性最優。
- 難度: 中級
- 學習階段: 核心
- 關聯概念: B-Q15, C-Q1, D-Q3


### Q&A 類別 B: 技術原理類

B-Q1: RDBMS索引與查詢計畫如何運作？
- A簡: 透過索引結構（B/B+樹等）與統計選擇最佳路徑，降低查詢成本至O(log n)。
- A詳: 原理說明：RDBMS維護統計與索引（B/B+樹、Hash、GiST），優化器評估代價選擇計畫。關鍵步驟：解析SQL→生成候選計畫→估價→執行→回傳。核心組件：優化器、執行器、緩衝池與WAL。正確索引與寫法決定性能與一致性負擔。
- 難度: 中級
- 學習階段: 核心
- 關聯概念: A-Q2, B-Q14, D-Q3

B-Q2: NoSQL K/V如何達到O(1)效能？
- A簡: 以哈希表與一致性哈希分片定位鍵位，並行存取，保持近常數時間延遲。
- A詳: 原理說明：K/V以哈希映射鍵到槽位/節點；一致性哈希分散鍵空間，節點變更重映射少。流程：計算哈希→定位分片→讀寫副本→複寫確認。核心組件：分片路由、複製集、容錯與壓縮日誌。優勢是低延遲與水平擴展，限制是複雜查詢能力弱。
- 難度: 中級
- 學習階段: 核心
- 關聯概念: A-Q17, C-Q8, D-Q2

B-Q3: 服務邊界如何依據資料模型切割？
- A簡: 以業務能力與資料所有權為界，確保資料與行為一致收斂於同域。
- A詳: 原理說明：依DDD界定限界上下文，將強一致需求與關鍵不變式放入同服務。流程：分析業務能力→識別不變式→對齊資料所有權→定義API與事件。核心組件：上下文圖、語彙表、契約。良好邊界降低跨庫交易與查詢耦合。
- 難度: 中級
- 學習階段: 核心
- 關聯概念: A-Q10, C-Q10, D-Q5

B-Q4: 分散式交易的2PC機制原理與限制？
- A簡: 兩階段預備與提交，協調者確保原子性；但鎖資源、延遲高、抗故障差。
- A詳: 原理說明：預備階段鎖定資源並寫預提交，提交階段統一提交/回滾。流程：協調者發起→參與者預備→協調者決策→所有節點執行。核心組件：協調者、預備日誌、鎖機制。限制：單點、阻塞、腦裂風險，雲原生多採替代方案如Saga。
- 難度: 高級
- 學習階段: 進階
- 關聯概念: A-Q16, C-Q3, D-Q1

B-Q5: Saga編排式與編舞式如何運作？
- A簡: 編排由指揮服務驅動步驟；編舞靠事件互通知，服務各自響應。
- A詳: 原理說明：編排集中式流程控制，便於觀測；編舞去中心，藉事件傳遞擴展性好。流程：命令觸發→步驟執行→成功事件→下一步/補償。核心組件：流程管理器、事件匯流排、冪等與補償邏輯。選擇依複雜度、可觀察性與自治需求。
- 難度: 高級
- 學習階段: 進階
- 關聯概念: A-Q16, C-Q3, D-Q1

B-Q6: CQRS寫入/讀取模型與事件儲存如何運作？
- A簡: 寫入端處理命令與事件，讀端訂閱事件建立投影，支持多視圖查詢。
- A詳: 原理說明：寫端驗證不變式並寫事件（可事件溯源），讀端消費事件，構建反正規化投影。流程：命令→聚合變更→產生事件→Outbox/Bus→讀端更新投影。核心組件：聚合根、事件儲存、投影器、查詢API。優勢是彈性讀、解耦與可回放。
- 難度: 高級
- 學習階段: 進階
- 關聯概念: A-Q14, C-Q2, D-Q3

B-Q7: 事件溯源如何重播建立讀模型？
- A簡: 以事件作為真相來源，重播歷史事件重建投影或狀態，支持回溯與審計。
- A詳: 原理說明：將狀態變更持久化為事件流，狀態可由重播事件得出。流程：讀取事件→順序應用→生成投影→校驗版本。核心組件：事件存儲、偏移量、快照、冪等處理。優勢是審計與重建方便，代價是存儲膨脹與回放成本。
- 難度: 高級
- 學習階段: 進階
- 關聯概念: A-Q15, C-Q2, D-Q6

B-Q8: API優先設計如何限制查詢多樣性？
- A簡: 將查詢收斂為明確用例，透過投影與索引支持，避免任意SQL造成風險。
- A詳: 原理說明：以用例驅動設計API，對應專用讀模型或索引。流程：識別查詢場景→定義API契約→設計投影→容量與SLA。核心組件：契約、查詢模式、投影儲存、快取。好處是可預測負載與治理成本，符合每服務一庫原則。
- 難度: 中級
- 學習階段: 核心
- 關聯概念: A-Q11, C-Q4, D-Q5

B-Q9: 以GraphQL聚合跨服務資料的機制是什麼？
- A簡: Gateway解析查詢樹，向多個後端服務取數並匯整回應，統一出入口。
- A詳: 原理說明：GraphQL以型別與解析器定義資料圖，查詢按需取欄位。流程：客戶端送查詢→Gateway解析→呼叫Resolver→聚合結果→回傳。核心組件：Schema、Resolver、資料載入器（防N+1）、快取層。適合跨服務讀聚合，不適合長交易。
- 難度: 中級
- 學習階段: 核心
- 關聯概念: A-Q9, C-Q9, D-Q5

B-Q10: 快取一致性策略：Cache-aside、寫穿、寫回有何差異？
- A簡: Cache-aside由應用控制；寫穿同步寫庫；寫回先寫快取後回寫，延遲一致。
- A詳: 原理說明：Cache-aside讀先查快取不命中回源並填充；寫穿同時寫DB與快取；寫回寫入快取後異步持久化。流程與組件：驅逐策略、TTL、版本鍵、重試隊列。權衡在一致性、延遲與丟失風險。常用Cache-aside配版本或失效事件。
- 難度: 中級
- 學習階段: 核心
- 關聯概念: A-Q18, C-Q8, D-Q2

B-Q11: 使用版本/ETag確保快取正確性的原理？
- A簡: 以版本號或內容雜湊作為校驗，變更即換鍵或比對失效，避免髒讀。
- A詳: 原理說明：版本鍵（如v1、時間戳、雜湊）關聯資料版本；ETag以內容雜湊檢測變化。流程：讀取攜帶If-None-Match→伺服器比對→回304或新內容。核心組件：內容位址化、條件請求、CDN支援。適合不可變與少量變更場景。
- 難度: 中級
- 學習階段: 核心
- 關聯概念: A-Q18, C-Q6, C-Q8

B-Q12: 多版本與COW的資料結構與機制？
- A簡: 以樹結構和引用計數共享未變更節點，改動時僅複製必要路徑。
- A詳: 原理說明：持久化資料結構（如Merkle/指標樹）在寫入時複製自根至葉的路徑，其他節點共享。流程：檢出基準→寫時分叉→更新引用計數→生成新根。核心組件：引用計數、節點存儲、垃圾回收。提供快照、回滾與審計能力。
- 難度: 高級
- 學習階段: 進階
- 關聯概念: A-Q19, C-Q7, D-Q10

B-Q13: 舊資料封存的分層儲存與生命週期管理？
- A簡: 熱/溫/冷分層與TTL策略，批次下沉低頻資料至廉價存儲，保留查詢通路。
- A詳: 原理說明：依訪問頻率與合規設定生命週期策略（ILM）。流程：分區/日期表→到期轉冷→索引同步→按需回溯。核心組件：分區表、歸檔庫、對象存儲、索引目錄。效益是成本下降與主庫瘦身，需保證檢索與恢復流程。
- 難度: 中級
- 學習階段: 核心
- 關聯概念: C-Q5, D-Q10, B-Q14

B-Q14: RDBMS水平擴展：分片、讀寫分離、分區表如何設計？
- A簡: 以分片切數據、複本分離讀寫、分區表管理冷熱，兼顧吞吐與維護。
- A詳: 原理說明：分片按範圍/哈希/目錄切分；讀寫分離以主從複製分攤讀負載；分區表按時間/鍵管理冷熱。流程：鍵設計→路由→同步與延遲控制→故障切換。核心組件：路由層、複製與一致性、監控。需注意跨片交易與熱鍵。
- 難度: 高級
- 學習階段: 進階
- 關聯概念: D-Q8, C-Q5, B-Q1

B-Q15: Outbox與可靠事件發布如何保證最終一致？
- A簡: 在本地交易內寫出箱表，之後可靠發布到總線，避免雙寫不一致。
- A詳: 原理說明：將業務變更與事件落同庫Outbox表同交易提交，獨立發佈器讀Outbox發送，成功後標記。流程：命令→本地交易寫主表+Outbox→發佈器投遞→重試與去重。核心組件：Outbox表、消息總線、冪等鍵。解決雙寫順序與丟失問題。
- 難度: 中級
- 學習階段: 核心
- 關聯概念: A-Q15, C-Q2, D-Q6

B-Q16: 反正規化的讀取模式導向建模步驟？
- A簡: 以查詢用例先行，為列表/詳情等構建專用投影，權衡重複與同步。
- A詳: 原理說明：從查詢需求逆推資料形狀。流程：盤點查詢→定義投影結構→事件映射→一致性策略（重建/補償）。核心組件：投影存儲、索引、同步程式。適用NoSQL與CQRS讀側，顯著降低查詢成本。
- 難度: 中級
- 學習階段: 核心
- 關聯概念: A-Q8, C-Q2, D-Q4

B-Q17: 為何報表/分析應脫離線上交易庫？
- A簡: 重查詢會影響交易延遲與鎖競爭，應ETL至倉儲或BigQuery類系統。
- A詳: 原理說明：OLTP與OLAP負載特性衝突。流程：事件/CDC抽取→清洗轉換→載入倉儲→建模與查詢。核心組件：資料管道、倉儲、查詢引擎。將重聚合與跨域分析移至專用系統，避免拖垮交易庫並提升決策效率。
- 難度: 中級
- 學習階段: 核心
- 關聯概念: C-Q2, D-Q3, A-Q20

B-Q18: NoSQL模式演進（Schema-on-read）如何治理？
- A簡: 以版本欄位與相容格式演進，讀時轉換，配線上漸進遷移。
- A詳: 原理說明：模式外移到應用層，靠版本控制與解碼容忍。流程：新增欄位→升級消費者→雙寫/轉換→移除舊模式。核心組件：模式登錄、版本轉換器、灰度發布。避免硬性遷移造成中斷與資料不一致。
- 難度: 中級
- 學習階段: 核心
- 關聯概念: D-Q9, C-Q7, B-Q6

B-Q19: 跨服務關聯查詢的替代方案有哪些？
- A簡: 預計算視圖、搜尋引擎、圖資料庫與聚合API，避免直接跨庫Join。
- A詳: 原理說明：將關聯查詢外部化為可擴展組件。流程：事件驅動更新視圖→索引搜尋→Graph遍歷。核心組件：投影存儲、搜尋引擎、Graph、Gateway。以讀側承擔關聯成本，保持寫側自治與穩定。
- 難度: 中級
- 學習階段: 核心
- 關聯概念: A-Q9, C-Q4, C-Q9

B-Q20: 安全模型RBAC/ABAC如何落在API層而非SQL？
- A簡: 以API封裝資料存取，套用角色/屬性規則與審計，避免繞過治理。
- A詳: 原理說明：權控在API層實施，SQL僅為內部細節。流程：OAuth/OIDC認證→授權決策（RBAC/ABAC）→稽核記錄→最小權限。核心組件：API Gateway、PDP/PEP、審計。確保 跨服務一致策略與可觀測性。
- 難度: 中級
- 學習階段: 核心
- 關聯概念: A-Q11, C-Q9, D-Q5


### Q&A 類別 C: 實作應用類

C-Q1: 如何在訂單服務同時用RDBMS與Redis？
- A簡: 交易落RDBMS、查詢用Redis快取，事件同步快取與讀模型，提升讀性能。
- A詳: 步驟：1) 訂單寫入RDBMS（交易）2) 以Outbox記錄事件3) 發布事件更新Redis與列表投影4) 查詢先讀Redis，未命中回源。程式碼片段（示意）：SaveOrder(tx); SaveOutbox(evt); publisher.Publish(evt); 注意：快取鍵含版本/TTL；避免雙寫；用冪等與重試確保一致。
- 難度: 中級
- 學習階段: 核心
- 關聯概念: B-Q15, B-Q10, D-Q2

C-Q2: 如何以CQRS重構讀寫並建立只讀投影？
- A簡: 寫端產生事件，讀端消費建投影表/索引，提供API查詢，讀寫分離。
- A詳: 步驟：1) 定義命令/事件 2) 寫端聚合處理→事件 3) Outbox發布 4) 讀端投影器更新反正規化表/索引 5) 提供查詢API。程式碼：on OrderCreated => projections.Upsert(orderListView). 注意：事件順序、冪等鍵、投影可重播與回填。最佳實踐：將重查詢移至讀側。
- 難度: 中級
- 學習階段: 核心
- 關聯概念: B-Q6, B-Q16, D-Q3

C-Q3: 如何實作付款-庫存的Saga流程？
- A簡: 將下單→扣款→扣庫存拆成本地交易，失敗觸發補償，最終一致。
- A詳: 步驟（編排式）：1) CreateOrder 2) ReservePayment 3) ReserveInventory 4) Confirm 失敗路徑：CancelOrder/Refund/ReleaseStock。示例偽碼：try ReservePayment(); ReserveStock(); Confirm(); catch {Compensate();} 注意：冪等、重試、時限；狀態機與審計事件。可用事件編舞式替代。
- 難度: 高級
- 學習階段: 進階
- 關聯概念: B-Q5, A-Q12, D-Q1

C-Q4: 如何把跨服務JOIN改為聚合API與預計算視圖？
- A簡: 以事件同步讀模型，Gateway聚合多服務API輸出一份整合視圖。
- A詳: 步驟：1) 定義所需整合欄位 2) 設計讀模型（含反正規化）3) 消費事件更新讀模型 4) API Gateway聚合子查詢 5) 加快取與分頁。注意：避免N+1，使用批量Loader；視圖有版本；失敗回源策略。最佳實踐：讀由視圖提供，寫回各自服務。
- 難度: 中級
- 學習階段: 核心
- 關聯概念: B-Q9, B-Q19, D-Q5

C-Q5: 如何制定舊資料封存策略與自動化？
- A簡: 以分區與生命週期規則轉冷；批次搬遷與索引保留，降低主庫負載。
- A詳: 步驟：1) 依時間切分分區表 2) 設定TTL/ILM 3) 每日批次轉移至歸檔庫或對象存儲 4) 建立查詢索引與目錄 5) 提供回溯API。SQL例：CREATE TABLE ... PARTITION BY RANGE(date)。注意：合規、壓縮、校驗與回復演練；避免長交易。
- 難度: 中級
- 學習階段: 核心
- 關聯概念: B-Q13, D-Q10, B-Q14

C-Q6: 如何建立不可變檔案儲存與CDN快取？
- A簡: 以內容雜湊命名、只追加不覆寫；標註長TTL與ETag，提升命中率。
- A詳: 步驟：1) 計算內容Hash作鍵 2) 上傳對象存儲（immutable flag）3) 設定Cache-Control: max-age/immutable 4) 透過CDN分發 5) 新版本生成新鍵。範例：key=sha256(content)。注意：原子發布、回滾保留舊鍵；避免覆寫導致快取污染。
- 難度: 中級
- 學習階段: 核心
- 關聯概念: B-Q11, A-Q18, D-Q2

C-Q7: 如何在文檔庫實作多版本COW與引用計數？
- A簡: 以樹節點共享與引用計數實作版本鏈，寫入僅複製變動路徑。
- A詳: 步驟：1) 文檔分塊/節點化 2) 寫入時複製路徑 3) 更新新根指標 4) 舊節點ref--，為0回收 5) 建索引記錄版本。示例字段：docId、version、rootPtr、refCount。注意：垃圾回收、快照一致、事務邊界與審計。最佳實踐：只追加事件記錄。
- 難度: 高級
- 學習階段: 進階
- 關聯概念: B-Q12, A-Q19, D-Q10

C-Q8: 如何實作Cache-aside並用版本鍵避免髒讀？
- A簡: 讀：先快取後回源；寫：先DB再刪鍵或換版本，確保讀到最新。
- A詳: 步驟：讀 miss→DB→SET key:vN；寫→DB成功→DEL key:vN或SET key:vN+1。程式碼：var key=$"order:{id}:v{ver}". 注意：TTL與雪崩防護、熱鍵、併發穿透；事件通知驅逐。最佳實踐：鍵含版本戳、短TTL+後台刷新。
- 難度: 中級
- 學習階段: 核心
- 關聯概念: B-Q10, B-Q11, D-Q2

C-Q9: 如何部署GraphQL Gateway聚合多服務資料？
- A簡: 定義Schema與Resolver，使用資料載入器批量取數，前端按需查欄位。
- A詳: 步驟：1) 設計型別與欄位 2) 為每欄位撰寫Resolver 3) 使用DataLoader批量鍵取 4) 設定快取與權控 5) 部署Gateway。程式片段：const user=loaders.user.load(id)。注意：避免深度遞迴、限制查詢複雜度、觀測延遲與失敗。
- 難度: 中級
- 學習階段: 核心
- 關聯概念: B-Q9, D-Q5, A-Q11

C-Q10: 如何安全地從單體DB遷移到每服務一庫？
- A簡: 以絞殺者模式分段切流；新服務擁庫，事件同步，灰度與回滾預案。
- A詳: 步驟：1) 劃分邊界與擁有權 2) 為新服務建庫與API 3) 寫入雙寫（Outbox）4) 讀側轉向新視圖 5) 逐步關閉舊路徑 6) 漸進切量與回滾鍊。注意：資料校驗、觀測、限流、回放能力。最佳實踐：從讀多場景先行。
- 難度: 高級
- 學習階段: 進階
- 關聯概念: B-Q3, B-Q15, D-Q6


### Q&A 類別 D: 問題解決類

D-Q1: 訂單已扣款但狀態未更新怎麼辦？
- A簡: 檢查分散式交易，落實Saga補償與Outbox，查漏事件投遞與冪等。
- A詳: 症狀：付款成功但訂單仍待付款。原因：雙寫競賽、事件丟失、跨服務失敗。解法：引入Saga編排，先預留支付、庫存；Outbox確保事件發布；消費冪等與重試；對賬修復。預防：端到端觀測、時限與補償策略、演練失敗場景。
- 難度: 中級
- 學習階段: 核心
- 關聯概念: B-Q5, B-Q15, C-Q3

D-Q2: 快取命中高但資料過舊如何處理？
- A簡: 使用版本鍵/ETag與短TTL，採Cache-aside並事件驅逐，避免髒讀。
- A詳: 症狀：列表或詳情與真實庫不同步。原因：長TTL、未驅逐、寫回延遲。解法：版本鍵或雜湊、Cache-aside寫後刪鍵、事件通知失效、關鍵資料讀己之寫。預防：熱點監控、過期分散、後台刷新、CDN配置合理化。
- 難度: 中級
- 學習階段: 核心
- 關聯概念: B-Q10, B-Q11, C-Q8

D-Q3: 報表查詢拖垮線上庫怎麼辦？
- A簡: 將分析負載遷出，建資料管道與倉儲，讀側投影承擔聚合。
- A詳: 症狀：高峰期慢查與鎖競爭。原因：OLAP與OLTP混跑。解法：事件/CDC抽取至倉儲或BigQuery類型；建立CQRS讀側視圖；使用只讀副本與限流。預防：分離環境、SLA區隔、報表API另層。
- 難度: 中級
- 學習階段: 核心
- 關聯概念: B-Q17, C-Q2, A-Q20

D-Q4: NoSQL查詢掃描全表很慢的原因？
- A簡: 模式未按查詢設計、缺索引；需重構文件形狀與建立二級索引。
- A詳: 症狀：查詢延遲與CPU飆高。原因：濫用過濾、未命中索引、鍵設計不當。解法：讀模式導向建模、反正規化、建立二級索引或移至搜尋引擎。預防：先盤點查詢，再定模式；容量與寫入放大評估。
- 難度: 中級
- 學習階段: 核心
- 關聯概念: B-Q16, B-Q19, C-Q4

D-Q5: 跨服務查詢造成N+1與高延遲怎麼辦？
- A簡: 建聚合API與批量載入器，改以預計算視圖或GraphQL解決。
- A詳: 症狀：頁面查一次，後端發多次子查詢。原因：逐條查詢耦合。解法：聚合API、批量查（DataLoader）、預計算讀模型、GraphQL Gateway。預防：API契約以集合為單位、限制深度/複雜度、快取策略到位。
- 難度: 中級
- 學習階段: 核心
- 關聯概念: B-Q9, C-Q4, C-Q9

D-Q6: 雙寫導致資料丟失或順序錯亂如何避免？
- A簡: 採Outbox與冪等消費；單來源提交順序，避免直接雙寫兩套系統。
- A詳: 症狀：讀模型與主庫出現差異。原因：應用層雙寫無原子性、網路抖動。解法：本地交易更新主庫與Outbox；專用發佈器投遞；消費端以事件ID去重與排序。預防：壓測與失敗注入、監控滯後。
- 難度: 中級
- 學習階段: 核心
- 關聯概念: B-Q15, C-Q2, C-Q10

D-Q7: 使用者抱怨剛下單查不到資料怎麼辦？
- A簡: 建立讀己之寫策略：會話黏著、版本等待、優雅提示與重試。
- A詳: 症狀：提交後頁面短暫看不到更新。原因：最終一致延遲。解法：同請求路徑走主庫、寫後讀版本比對、UI提示「正在更新」、短時間重試。預防：縮短事件滯後、P99延遲SLO、業務接受最終一致的UX設計。
- 難度: 初級
- 學習階段: 基礎
- 關聯概念: A-Q13, B-Q10, C-Q8

D-Q8: RDBMS熱點與寫入瓶頸如何水平擴展？
- A簡: 識別熱鍵與分片重劃，分區表、批量寫入、隊列解峰與讀寫分離。
- A詳: 症狀：特定表/分區鎖競爭、延遲高。原因：單點熱鍵、併發插入。解法：哈希分片/範圍重分片、分區策略、批量/延時寫入、引入隊列解峰、只讀副本承接查詢。預防：鍵設計與容量規劃、熱鍵監控。
- 難度: 高級
- 學習階段: 進階
- 關聯概念: B-Q14, C-Q5, B-Q1

D-Q9: NoSQL模式變更造成反序列化錯誤怎處理？
- A簡: 引入版本欄位與相容解碼，灰度遷移與背景修復，避免硬性切換。
- A詳: 症狀：新舊服務讀取文件報錯。原因：不相容模式變更。解法：Schema版本欄位、可選欄位容忍、讀時轉換器、背景遷移腳本。預防：模式登錄、雙寫期、契約測試與金絲雀發布。
- 難度: 中級
- 學習階段: 核心
- 關聯概念: B-Q18, C-Q7, B-Q6

D-Q10: 封存資料查回很慢怎麼優化？
- A簡: 建索引目錄與摘要表，提供分頁回溯API；避免掃描冷存全量。
- A詳: 症狀：合規查回需長時間。原因：冷存未索引、資料量大。解法：建立查詢目錄（如日期/客戶鍵）、摘要表；分段取回與快照；必要時預熱索引。預防：設計ILM時同步生成目錄、定期健康檢查與回溯演練。
- 難度: 中級
- 學習階段: 核心
- 關聯概念: B-Q13, C-Q5, A-Q19


### 學習路徑索引
- 初學者：建議先學習哪 15 題
    - A-Q1: 什麼是微服務架構下的資料庫選擇問題？
    - A-Q2: 什麼是RDBMS？
    - A-Q3: 什麼是NoSQL？
    - A-Q4: RDBMS與NoSQL的本質差異是什麼？
    - A-Q5: 為什麼在微服務不應該只問RDBMS或NoSQL擇一？
    - A-Q7: 什麼是正規化？在RDBMS中的角色為何？
    - A-Q8: 什麼是反正規化？何時適合？
    - A-Q9: 為什麼微服務下跨庫JOIN不可行？
    - A-Q10: 什麼是「每服務一資料庫」？
    - A-Q11: 為什麼需要把SQL查詢降級為API存取？
    - A-Q14: 什麼是CQRS？核心價值是什麼？
    - A-Q17: 為什麼NoSQL常見K/V可達O(1)？
    - A-Q18: 何謂不可變資料？何時用於快取？
    - D-Q7: 使用者抱怨剛下單查不到資料怎麼辦？
    - D-Q2: 快取命中高但資料過舊如何處理？

- 中級者：建議學習哪 20 題
    - B-Q1: RDBMS索引與查詢計畫如何運作？
    - B-Q2: NoSQL K/V如何達到O(1)效能？
    - B-Q3: 服務邊界如何依據資料模型切割？
    - B-Q6: CQRS寫入/讀取模型與事件儲存如何運作？
    - B-Q9: 以GraphQL聚合跨服務資料的機制是什麼？
    - B-Q10: 快取一致性策略差異？
    - B-Q11: 使用版本/ETag確保快取正確性原理？
    - B-Q13: 舊資料封存的分層儲存與生命週期管理？
    - B-Q15: Outbox與可靠事件發布如何保證最終一致？
    - B-Q16: 反正規化的讀取模式導向建模步驟？
    - B-Q17: 為何報表/分析應脫離線上交易庫？
    - B-Q19: 跨服務關聯查詢的替代方案有哪些？
    - C-Q1: 訂單服務同時用RDBMS與Redis
    - C-Q2: 以CQRS重構讀寫並建立投影
    - C-Q4: 用聚合API與預計算視圖替代跨庫JOIN
    - C-Q5: 舊資料封存策略與自動化
    - C-Q8: Cache-aside並用版本鍵避免髒讀
    - D-Q3: 報表查詢拖垮線上庫怎麼辦？
    - D-Q4: NoSQL查詢掃描全表很慢的原因？
    - D-Q5: 跨服務查詢造成N+1與高延遲怎麼辦？

- 高級者：建議關注哪 15 題
    - A-Q12: 為何要以狀態機而非CRUD設計API？
    - A-Q16: 什麼是Saga？與2PC差異？
    - A-Q19: 什麼是多版本與寫時複製（COW）？
    - B-Q4: 分散式交易的2PC機制原理與限制？
    - B-Q5: Saga編排式與編舞式如何運作？
    - B-Q7: 事件溯源如何重播建立讀模型？
    - B-Q12: 多版本與COW的資料結構與機制？
    - B-Q14: RDBMS水平擴展：分片、讀寫分離、分區表
    - B-Q18: NoSQL模式演進如何治理？
    - C-Q3: 實作付款-庫存的Saga流程
    - C-Q6: 建立不可變檔案儲存與CDN快取
    - C-Q7: 文檔庫多版本COW與引用計數
    - C-Q10: 從單體DB遷移到每服務一庫
    - D-Q1: 訂單已扣款但狀態未更新怎麼辦？
    - D-Q8: RDBMS熱點與寫入瓶頸如何水平擴展？