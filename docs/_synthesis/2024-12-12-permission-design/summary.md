---
layout: synthesis
title: "(TBD) 權限管理機制的設計"
synthesis_type: summary
source_post: /2024/12/12/permission-design/
redirect_from:
  - /2024/12/12/permission-design/summary/
---

# (TBD) 權限管理機制的設計

## 摘要提示
- RAG 與安全性: 在 RAG 架構中，向量資料庫多不支援 record-level 授權，需以外部機制補足。
- Tags + Filter: 以標籤與過濾條件在檢索階段實作授權邏輯，是實務可行的解法。
- Kernel Memory 建議: 微軟 Kernel Memory 官方建議用使用者 ID 等標籤進行檢索過濾。
- 需求場景: 文件有部門、角色、指定使用者等閱讀限制，且搜尋結果不得外洩任何片段。
- 個人化與預先處理矛盾: 重度索引與統計優化加速檢索，但不利於依使用者差異化的授權控制。
- RBAC 降維法: 以角色與分類降低組合複雜度，從人×文件的爆炸級配對降至有限配置。
- 資料結構設計: 將授權規則落到可索引的有限標籤欄位或 tags 結構，支援高效過濾。
- 查詢實作: 以 category 或自訂 tags 作為可組合的 filter，於 runtime 精準排除未授權資料。
- ABAC/PBAC 展望: 將進一步討論以屬性或政策為核心的授權模型與如何落地為 tags。
- 向量檢索實務: 在 RAG 的檢索階段加入 metadata filter，避免結果、摘要、清單洩漏敏感片段。

## 全文重點
本文以 RAG（Retrieval-Augmented Generation）在企業情境的安全需求切入，指出多數向量資料庫不提供 record-level 授權能力，即使是傳統關聯式資料庫在此用法也少見。微軟的 Kernel Memory 提供了務實的建議：在文件與記憶體紀錄上附加 metadata（例如使用者 ID、部門、角色、分類等）並於檢索時套用邏輯過濾，讓不同使用者得到不同且合規的結果。作者從實務經驗出發，說明敏感資料檢索的核心挑戰：搜尋引擎為追求延遲與相關性，會大量進行事前索引與統計，但這種「先算好」的策略往往難以滿足「個人化授權」的差異要求，一不小心就可能在搜尋結果、摘要或清單階段洩漏片段內容，因此需要在資料結構與查詢流程中嵌入可被索引與高效過濾的權限標記。

為降低授權的組合複雜度，文中以 RBAC（Role-Based Access Control）示範「降維」設計：若公司 100 人、5,000 份文件在無規則下需管理 50 萬組布林關係，幾不可行；改以 5 角色與 20 文件分類描述需求，則可把授權組合收斂成有限表格，並把「人」表加上 Role 欄位、「文件」表加上 Category 欄位，再以一張小型授權對照表管理 (角色×分類) 的可讀關係。如此在查詢時，只需根據使用者角色將 category 過濾條件加入原查詢即可；在 NoSQL 或向量庫元資料中，則可用 tags/categorical metadata 實作同樣的過濾。此法與 Kernel Memory 的作法一致：在索引與檢索階段不改動向量相似度邏輯本身，而是透過 metadata filter 先排除未授權集合，再於候選集合中做相似度排名，從而在性能與安全之間取得平衡。

後續，作者預告將延伸至 ABAC（以屬性為基礎）與 PBAC（以政策為基礎）的更進階模型，並說明如何把複雜規則進一步「降級」為可索引、可快取、可組合的 tags 集合，以支撐高併發、低延遲的檢索應用；同時也會從三個面向梳理如何貼標：資料本身、使用者或操作情境，以及查詢時該採用的標籤組合。總結來看，關鍵思路是將授權規則前置為有限標記，於 runtime 以標準化 filter 快速裁剪候選集，避免敏感片段在任何中介結果中外洩，並確保在 RAG 的 Retrieval 階段就落實最小揭露原則。

## 段落重點
### 前言：以 Kernel Memory 談 RAG 與授權
作者以 .NET Conf 的 RAG 主題分享為引子，說明 Kernel Memory 如何把 Retrieval 操作封裝成服務並公開最佳實務。重點在於多數向量資料庫不提供 record-level 權限，因此建議在文件記錄上附加 metadata（如使用者 ID、部門、角色、分類）並於搜尋時運用 tags + filter 限縮結果集合。這呼應作者長期在敏感資料檢索中的實務：授權雖然「硬」，卻必須從資料結構與檢索流程設計之初就納入，否則容易在搜尋結果、摘要或清單階段洩漏片段內容。本文目標是闡述授權設計的原理與在資料庫層級的實作，並以 Kernel Memory 的 RAG 檢索為案例示範。

### 1, 需求
企業要儲存上萬份文件，每份文件可分配至特定部門、角色、甚至個別使用者才能閱讀；且安全要求不限於 READ 操作，搜尋結果、摘要、清單中也不得暴露任何內容片段。這與搜尋系統的預先索引、分析、統計等加速手段天然衝突：預處理越多，越難在 runtime 依不同使用者動態調整結果；一旦出錯，將造成敏感資訊外洩風險與法務責任。因此，必須在資料結構與查詢機制中，實作可被索引、可快取、可過濾的授權標記，讓系統能在 100ms 級別的延遲內完成「先授權、後相似」的檢索流程。

### 2, 個人授權
本節預告將討論以個人為粒度的授權處理，涵蓋以使用者 ID 為核心的標記策略與過濾方式，並對應到搜尋階段如何避免片段洩漏。此類模型在實務上常與角色、部門規則疊加，需兼顧效能與設定維護成本。雖正文未展開細節，脈絡指向：以個人標籤為主、角色/部門為輔的多層過濾，並在 metadata 中標準化表示，於檢索時快速裁剪候選集合。

### 2, 最常見的授權模型: RBAC
作者以複雜度估算切入：若 100 人 × 5,000 文件在無規則下需 50 萬組布林關係，幾乎無法維運。透過 RBAC 作降維：將人歸入 5 角色、文件歸入 20 分類，只需維護角色×分類的可讀對照表。實作上，在使用者表加入 Role 欄位、文件表加入 Category 欄位，再以小型表格維護允許關係。查詢時依使用者角色把允許的 category 清單帶入 where in 過濾；在 NoSQL/向量庫中，將分類等資訊放入 tags，檢索 API 則在 filters 附上 catalog 或自訂標籤即可。此法可把授權判斷前置為「有限標籤」，於 runtime 高效過濾，避免未授權文件進入相似度排序候選集。

### 3, ABAC
本節預計介紹基於屬性（Attribute-Based Access Control）的模型，將主體、客體、環境的屬性（如部門、地點、時間、資料敏感等級）組合成政策規則。雖內容未展開，但延續前述思路，關鍵在於如何把多維屬性降級為可索引的有限 tags 集合，並在檢索時以 filters 表達複合條件（邏輯與/或、區間、集合包含），在不犧牲性能下維持精準授權。

### 4, PBAC
本節預計討論以政策為核心（Policy-Based Access Control）的治理方式，將規則以可維護、可審計的政策語言管理，並於執行時轉譯為可執行的過濾條件。重點在於如何把高階政策映射為低階 metadata 與 tags，並結合快取與索引策略，使政策變更能快速反映於檢索流程，同時不影響延遲與吞吐。

### 5, 降級成 Tag 的操作
本節總結如何將複雜授權規則「降維」為可運算的標籤集合，以支撐高效檢索。核心原則是：把授權所需的最小充分資訊，盡量前置到資料與使用者側，並在查詢環節決定採用哪些標籤組合進行過濾，確保未授權內容不會進入候選集或任何中介結果。

### 5-1, 在 "資料" 上面貼標
針對文件與其切片（chunk）附加標籤，如分類、部門、敏感等級、允許角色、允許使用者等，並確保這些標籤同步到搜尋索引或向量庫的 metadata 中。目標是讓檢索時能以 tags 先行過濾候選集合，再進行相似度計算，避免片段在摘要或清單階段外洩。

### 5-2, 在 "人" 或是 "操作" 上面貼標
為使用者與請求環境貼標，如角色、部門、地點、裝置風險、時間區段、請求場景（讀、匯出、摘要）等。查詢前將這些標籤映射為可機器執行的 filter 條件，並與資料標籤對齊，形成精準的交集過濾，支持「同人不同場景」的差異化授權。

### 5-3, 查詢當下要用甚麼標籤過濾?
在 runtime 依據使用者與操作上下文，組合最小充分且可索引的標籤條件（如 catalog、sensitivity、allowedRoles、allowedUsers），先以 metadata filter 裁剪候選集，再做相似度排名與後處理。對於小型對照表（如 角色×分類），可放入記憶體加速；對於頻繁變動的政策，需設計快取失效與版本控管，確保安全與性能的平衡。

## 資訊整理

### 知識架構圖
1. 前置知識：
   - 基本授權模型概念：使用者、角色、資源、操作的關係
   - 資料庫基礎：關聯式與 NoSQL 的 schema 設計、索引與查詢
   - 向量檢索與 RAG 基礎：embedding、向量資料庫、檢索與過濾
   - 資安與合規：最小權限原則、資料外洩風險、結果去識別與遮罩

2. 核心概念：
   - 向量資料庫不提供 record-level 權限：需在應用層以 metadata + filter 補足
   - 以 tags + filters 實作授權：將「人/資源/情境」映射為可索引的標籤集合，於查詢時過濾
   - 授權模型降維：把 RBAC/ABAC/PBAC 的組合，映射為有限的標記集合，避免組合爆炸
   - 查詢時個人化過濾：在 runtime 根據使用者上下文套用過濾，避免預先處理造成洩漏
   - Schema 設計原則：以標準化 metadata 欄位或 tags 結構，支援快速過濾與索引

3. 技術依賴：
   - RAG/Kernel Memory：提供向量檢索與 metadata filters 的能力
   - 向量資料庫/搜尋服務：Azure AI Search、Qdrant、Pinecone 等之 metadata filter 能力
   - 資料標註與同步：文件入庫流程需貼標、維持授權標籤的正確性與即時性
   - 快取與記憶體查表：角色×分類的允許矩陣可常駐 RAM 提升效能
   - 安全控制面：API 層的身份驗證、授權決策與審計

4. 應用場景：
   - 企業內部文件檢索（部門/角色/個人敏感文件）
   - 多租戶 SaaS 文件與知識庫檢索
   - 需要「結果不洩漏」的搜尋/摘要/清單（SERP/摘要/片段均需授權過濾）
   - 需混合多種授權條件（角色、屬性、情境/政策）的檢索

### 學習路徑建議
1. 入門者路徑：
   - 了解 RBAC 基本概念與最小權限原則
   - 認識向量檢索與 metadata filter 基礎（以一個欄位的簡單過濾開始）
   - 練習在文件入庫流程中加上固定分類標籤（例如 catalog/tag 欄位）

2. 進階者路徑：
   - 學習 ABAC 與 PBAC，將使用者屬性、資源屬性、政策條件映射為標籤
   - 設計角色×分類的允許矩陣，並在查詢時轉譯為 filter 條件
   - 處理邊界情境：個人授權（例外名單）、多分類文件、動態政策切換、審計與追蹤

3. 實戰路徑：
   - 使用 Microsoft Kernel Memory 或向量 DB，實作「tags + filter」查詢
   - 建立入庫標註管線：以服務為界為文件貼標（部門/角色/使用者/租戶/政策）
   - 在 API 層組合授權上下文→產生 filters→向量檢索→再做二次過濾→安全渲染（去片段化/遮罩）
   - 建置壓力測試與安全測試：驗證 100ms SLA 與嚴格不洩漏

### 關鍵要點清單
- 向量 DB 無 record-level 權限：需用 metadata filters 補上應用層授權（優先級: 高）
- Tags+Filters 降維策略：把複雜授權以有限標記集合表示，便於索引與高效過濾（優先級: 高）
- 預先處理與個人化衝突：大量預計算提升效能但不知「誰」查詢，需 runtime 過濾（優先級: 高）
- RBAC 基礎與矩陣設計：角色×分類允許矩陣可常駐記憶體快速生成查詢條件（優先級: 高）
- ABAC 擴展：以使用者/資源屬性（部門、地區、資安等級）動態組合授權（優先級: 中）
- PBAC/政策導向：以明文政策規則（時間、情境、風險等）驅動標籤與過濾（優先級: 中）
- 個人授權例外處理：支援 per-user 允許/拒絕標籤覆寫角色規則（優先級: 高）
- 入庫貼標管線：在資料產生/匯入時即貼標，避免 runtime 成本與錯漏（優先級: 高）
- 結果不洩漏原則：搜尋結果/摘要/片段/清單都須經授權過濾與必要遮罩（優先級: 高）
- Schema 與索引設計：標準化 metadata 欄位（如 catalog, tenant, roles）並建立索引（優先級: 高）
- 查詢轉譯器：把使用者上下文→映射標籤集合→生成過濾表達式（優先級: 中）
- 二段式過濾：先以 metadata filter 限縮，再對候選集合做精細授權/遮罩（優先級: 中）
- 多租戶隔離：tenantId 作為硬性過濾的一級標籤，先於其餘授權條件（優先級: 高）
- 稽核與可追溯性：記錄授權決策依據（使用的標籤與政策版本）以利合規（優先級: 中）
- 效能與一致性：標籤更新與索引刷新策略，確保低延遲與授權一致性（優先級: 中）