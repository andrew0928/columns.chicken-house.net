---
layout: post
title: "微服務架構設計 - 資料庫的選擇, RDBMS or NOSQL?"
categories:
- "系列文章: .NET + Windows Container, 微服務架構設計"
- "系列文章: 架構師觀點"
tags: ["microservice", "系列文章", "架構師", ]
published: false
comments: true
redirect_from:
logo: 
---


// RDB: index O(log(n)), NOSQL: k-v, hash O(1)
// balance, RDB + NOSQL, use code to keep sync (saga, cqrs, event, api first)

// case: archive mass data

// case: immutable data ( if key is immutable, can do precious cache control)

// case: multi-version (ref-count + copy on write, ref: git / svn / vss structure)






這幾年我的觀察，打算轉進微服務架構的團隊，搭配成熟的 cloud native / cloud platform / container orchestration 環境，開發上都不大會是問題了。不過最明顯的開發工具門檻漸漸降低後，開始浮現出來的是背後資料處理的門檻。會面對微服務架構的課題，通常都不是技術驅動 (例如: 客戶直接指明需要採用微服務架構)，而是商業驅動居多 (例如: 既有架構已經無法負荷日益成長的流量，必須靠架構改變才能解決)。除了開發與服務治理的議題之外，也開始浮現出資料治理能力的問題了。

微服務下很講求水平擴展的能力，先天不適合水平擴展的 RDBMS，與完全不同取向的 NOSQL 就很容易被擺在一起比較。不過，如果你的問題是 "我該選用 RDBMS 還是 NOSQL ?" 這類技術決策問題的話，通常都代表你沒有挖掘出核心問題。技術決策不是這樣選的啊，這樣你很容易掉到 2 選一這種選邊站的答案，就算有人跟你講選哪邊，你應該也無法 100% 確認是否能解決你商業上的需求。因為在技術選型與商業需求中間，你缺乏了架構規劃這層的思考。

也因此我才有寫這篇文章的打算。我真正想談的，是 "微服務架構" 下的資料庫 / 資料儲存的技術選擇，你到底該考量什麼? 這篇我絕對不是要戰 RDBMS vs NoSQL 哪一個好的問題, 那只是一種選擇而已；甚至你有可能兩種同時使用才對。每種技術存在世界上，一定有他擅長的地方，否則這技術就會被自然淘汰，消失在你的選擇清單內。RDBMS / NoSQL 是兩種技術特色很鮮明的技術，其實並不難選啊 (真正難選的是你要從一堆同類型的 RDBMS 之中挑一個，或是同類型的 NoSQL 之間挑一個)，通常你的架構 solution 確定後，該用哪種資料儲存技術都很明確了，你不知如何選擇，真正問題在於你的 solution 還沒想清楚，而不是來比較 RDBMS / NoSQL 哪個比較好的問題。

至於你該如何選擇? 我會分這幾個面向來討論:

1. 了解各種技術的適用情境。 (你對資料結構的選擇能力夠精準嗎?)
1. 了解你如何面對交易與一致性的問題。 (你對分散式交易的掌握能力夠到位嗎?)
1. 微服務架構下，你對儲存的需求有什麼變化? (你對服務的邊界切割的夠精準嗎?)
1. 真的選擇了不同的技術，你有能力並在一起並且正確到位的使用他嗎? (你對整合性質的技術掌握度足夠嗎?)

這些大的架構以及策略方向底定之後，剩下來的你才是在同性質的幾種類型資料庫內，挑選一個功能，價格，以及跟你既有的技術堆疊是否符合的資料庫來使用才對。不過這部分，訪間文章就談論很多了，我就點到為止即可。從架構 (師) 的角度來看，前面這些才是重點啊! 我的運氣不錯，過去求學及工作的經驗，都讓我在各種領域略有涉獵，比較能夠客觀的評斷這些選擇。

<!--more-->

# 前言: 我用什麼樣的經歷來談這議題?

先前在公司舉辦的線上技術分享會裡面，有人問了我 "架構的經驗跟能力該如何養成?" 這是個難題啊，我自己雖然有這能力，不過我不見得複製的出來第二位啊... 架構最難的地方在於，你得尋找商業應用 + 開發 + 基礎建設 這三方面的平衡才行，缺一不可。我只能聊聊我自己如何逐步培養這樣的經歷，比起你欠缺甚麼能力，更重要的是你應該把每個你有機會接觸的領域好好的弄懂他，因為你不知道將來何時這經歷會幫上忙，做好你負責的每件事才是最重要的。在你繼續往下看之前，我自己就先厚臉皮的對自己葉配一下吧 XDD, 我寫這篇文章，是仰賴我過去累積的這些經驗才寫出來的:

* 大學 - 電機系:  
大學時代，我念的是電機，其實對軟體開發或是資料庫沒有什麼太深的認識，電機系大概就是懂 asm / c 等控制用的基礎而已，有寫 code 的能力, 但是對於軟體工程就沒有太多著墨。但是在那時打下了還不錯的 OOP 的基礎，也對硬體 (例如 CPU 運作)，網路通訊等等基礎有點幫助。

* 研究所 - 資工所:  
當年仗著一股傻勁，就捨棄電機所，改考資工所了。為了補上基礎科目的落差，我也很天真的選擇大三大四修了一堆資工的必修課，而沒有直接報名考研究所的補習班惡補一番。雖然過程驚險，不過事後我也很慶幸，因為這段過程，我把幾門很重要的基礎課程都從頭札實的念過一遍 (包括: 作業系統；資料結構；系統程式；演算法... etc)。幸好最後運氣也不錯，還有考上理想的系所，以物件導向技術 & 資料庫系統為主要研究方向。

除了延續 OOP 的理論鑽研之外，對於 DBMS 的設計，交易的處理也有涉略。OOP + DBMS 就是當年還很 "神奇" 的領域: OODBMS, 多年後出現的 NoSQL DB 很多特性都在 OODB 上面看的到，也剛好讓我現在能很充分掌握 NoSQL 到底該怎麼用。研究所的過程中，語言也更精通 C++ 的掌握了。其他像是分散式系統，演算法等等，也對現在幫助很大。分散式系統的概念，完全就是現在雲端服務的基礎，很多像是分散式交易等等問題，都在裡面能學得道。至於物件導向技術的掌握，最關鍵的就是抽象化跟繼承了，抽象化的基礎，也對未來的 API 該如何制訂，以及服務邊界的劃分都有很直接的幫助。研究所兩年的經驗，等於幫我把所有雲端服務要面對的問題的基礎知識都準備好了，當時不覺得，現在回想才知道課本上講的每一件事其實都是關鍵啊~

* 重新造輪的經驗 - XML database / XML ORM design:  
過去重新造輪的經驗，最有代表性的就這個了。出來工作後，開始接觸到 pure xml database, 你可以想像現今的 json 換成 xml, 那麼當年的 xml database 就類似現在的 no sql database 了。在那時研究數位學習技術，業界制定了大量的 xml 規範，除了 xml database 之外, 我也被迫研究如何在 RDBMS (MS-SQL) 上面想辦法讓 table / xml 能夠和平共存，也發展出一套 XML ORM (object -> xml -> database mapping). 由於自己刻過這樣的體系，也處理過 RDBMS / XMLDB 共存的場景，我被迫需要很清楚的定義兩者的區別，否則整個團隊的技術走向就會偏掉了。

* 領域的轉移 - From Enterprise System to Cloud Services with E-Commerce:  
工作面臨的領域也開始轉向有大量交易必須面對的電子商務及雲端服務等等有大流量要面對的場景了，公司研發團隊的規模也更大了，開始面臨更大規模的技術決策時，過去累積的基礎知識就變得越來越重要了。所幸有過去累積的這些基礎知識的支持，現在我可以真正好好地從各個層面來評估系統架構，也能很快地找出架構設計上的盲點。

* 職務的轉移 - From CTO to Architect:  
最後，一直到最近幾年，身分從 CTO 以管理職為主的任務，開始轉型成我最想嘗試的架構師，以技術決策為主的領域。

* 開始面向社群 - Blog, MVP, Sharing:
開始寫文章，也是幫助很大的一件事。其他不說，光是為了顧好我自己的部落格，我就多了不少工作上得不到的經歷。第一版部落格其實是我自己拿來參加比賽用的 project, 後來逐步升級, 一路到現在的 github pages... 




好，老王賣完瓜之後，可以開始來談正題了... 我直接從我的觀點，來看看 RDBMS / NoSQL 兩者之間最大的差異吧! 不過我不打算用一堆指標來評比兩者的優劣，在我眼裡這兩種都是成熟可靠的技術，關鍵在於你怎麼應用它。因此我只會先簡單的介紹一下這兩者的特色，後面就直接用幾種不大容易處理的難題，回頭來告訴大家你應該如何治理你的 data ?

因此這篇文章，會分成這幾部分探討。一篇塞不下的話，我就拆成多篇來說明了。大綱如下:

1. RDBMS / NoSQL 的技術特色
1. 難題: 資料一致姓與交易處理
1. 難題: 舊資料封存
1. 難題: 異動紀錄與快照的管理問題
1. 難題: Cache 的命中率與資料正確性的平衡

在你繼續往下看的同時，我先破題，點一下核心的想法吧! 面對不同特性的技術決策，有時候你該做的不是 "選擇"，而是 "整合"。舉個最明顯的例子好了，HDD 可靠，容量大，但是受限於機械的物理限制，效能有天花板；對應的 SSD 則相反，純電子的解決方案很容易提升效能，但是卻有可靠度與成本等等問題。當你要面對的資料規模夠大，你可以看看 NAS 或是資料中心的做法，他們會同時合併使用這些儲存技術，但是在儲存管理服務上，系統架構的設計會做好妥善的管理，盡可能的讓整個系統的對外表現，能夠兩者兼顧。例如你可以有 SSD 的速度表現，也可以有 HDD 的儲存成本與可靠性。

開始理解我這篇文章想探討的內容了嗎? 如果你看懂我上面舉的例子，那我後面要講的就很容易理解了，你只要把 HDD 跟 SSD 換成這篇的主角: RDBMS / NoSQL 就好了。劇透結束，開始來看文章內容了。
















# RDBMS / NoSQL 的技術特色

這段我不打算比較太多技術上的差異，這篇不是某 XX 資料庫系統的葉佩雯啊 XDD, 我一直覺的兩者不是拿來比較的 (根本完全不一樣的東西好嗎?)，反而是你有多了解你面對的問題，你自然而然就知道該選擇甚麼了。

以我的觀點來說，RDBMS / NoSQL 本質上的不同，就是:

> RDBMS 是將表格式資料抽象化到極致的產品；而 NoSQL 則是常識抽象化物件的狀態 (或是稱: 結構化資料) 的產品


先來看看 RDBMS:

如果你把 RDBMS 想像成一個巨大的 Excel, 多達幾百個 sheet (table), 每個 sheet 也有幾百幾千萬筆資料 (rows), 然後他有很強的索引與查詢能力，現今的 RDBMS 用起來大概就像那個樣子。為了有效處理這些巨量的表格資料，SQL 這種查詢語言自然而然就被發展出來了。SQL 以查詢與一次操作一整批資料為主要目的，很自然地就把背後的搜尋與排序等等演算法封裝起來了。演變至今，開發人員只要決定你該如何下查詢就夠了 (其實下對 index 基本上就大致選定了可用的演算法了)；背後的資料結構及演算法，只要情況不算複雜，你都還有機會在最佳化的過程中再來調教 (調整 index 與調整查詢語法)。

對於搜尋的彈性，完全就表現在 SQL 語法及背後的 parser 了，而對於資料結構的選用，也都被包含在 index 的選擇了。資料結構 (data structure) 最在意的查詢與更新的時間複雜度 ( time complexity ), 都藉由 RDBMS 巧妙的跟你的程式碼隔離開了。你只要下對 index, RDBMS 背後就會選用合適的資料結構來儲存資料 (例如 btree 等等)，你只要下對查詢的 SQL 語法，RDBMS 背後自然會搭配 index ，將你的查詢轉譯成合適的演算法，用最有效率的方式來查詢你的資料。

有了 RDBMS 這樣高度抽象化背後複雜的索引與查詢的處理，開發人員會更專注在 table schema 的規劃上，也因此正規化 (DBMS normalization) 也變成使用 RDBMS 必要的技能之一了。正規化的目的是: 同樣意義的資料不要放兩個地方。只放一個，除了可以節省儲存空間之外，更重要的式資料異動時只要改一個地方啊! 因此 RDBMS 非常依賴 join 的操作。Table schema 允許你把資料拆到最細，再用 relation 來維持資料的一致姓，最終你可以靠 SQL 靈活的 join 能力，把資料重新組合成你要的樣子，這就是典型的 RDBMS 應用方式。

RDBMS 將資料結構高度抽象化，帶來很多優點，同時也伴隨著一些限制。優點是 RDBMS 很有效的把資料結構隔離開了，你的 application 初期如果資料量很低的話，說實在的你 index 亂下都可以跑得出來...。你可以更有彈性的調配開發人力，在真正需要的時候才來調整 index... 你要從循序查詢轉移成 B+ tree 搜尋，根本不用改程式碼，只要調整一下 index 就結束。但是抽象化的缺點也在這邊，資料的處理能力都被 RDBMS 隔離了，在現在雲端年代的資料，有些情況的最佳化，已經無法只靠 RDBMS 來處理了，必須在更源頭，資料產生的當下，就搭配 application 的規劃做好處理。這時 RDBMS 反而不利更大規模的資料操作...。

資料的處理開始逐步脫離 RDBMS 轉到 application 的過程，RDBMS 另一個很關鍵的能力: 交易處理 (transaction control) 的探討也開始浮現檯面了。這幾年我最常被問到的就是微服務怎麼做好分散式交易，大概也跟這趨勢有點關聯。不論是因為巨量資料，或是因為微服務的原因，邏輯上單一一個 "交易"，實際上開始有可能被拆成好幾個不同的 storage / database 之間的協作，過去 30 年這類問題大部分的開發人員都直接丟給 RDBMS，當現在開始要脫離 RDBMS 時這就變成最困難的一個選擇了。不過，不開始嘗試脫離 RDBMS 約束的話，你的資料處理能力也得開始面臨 RDBMS 的天花板。



RDBMS 有它先不易以突破的限制，這也是為何這幾年會有這麼多 NoSQL 體系的儲存技術出現。接著來看看 NoSQL:

NoSQL 的存在，就完全是另一回事了 (只是最後都發展成資料庫，自然有些應用上的重疊)。如果前面說的 RDBMS 是 table 極度抽象化之後的產品，那個 NoSQL 是?

我認為，NoSQL 是為了處理大量物件資料 (狀態) 而衍生出來的儲存服務。嚴格的來說，與其說它是資料庫，我認為 NoSQL 其實更像有著不錯查詢能力的 storage ...。在 2000 以前，NoSQL 類型的資料庫並不普及，甚至當時根本沒有 "NoSQL" 這種說法... 至少我沒聽說過 (當時連個影都還沒有好嗎?)。不過，在當時，OOP 已經是顯學了，當時 Java 正要大紅大紫，C# 也即將現身，在那之前 VB (這實在不能算是 OOP，當年有另個說法是 Object Based, 不是 Object Oriented) 至少也是大量物件的應用語言，雖然少了很多 OO 的特性；C++ 等的發展，也都已經證明 OOP 解決問題的能力。

不過，OOP 的三大特色 (封裝；繼承；多型) 完全在 RDBMS 看不到啊! OOP 的物件分別是 "行為" 與 "資料" 包裝在一起組合起來的，行為可以由 code 來處理，但是資料呢? 我的程式如果有上千萬個物件要處理，我該怎麼丟到 RDBMS 呢? 當年語言也不構成熟，根本沒有像樣的 ORM 可以用 (就算你用了 ORM, 大概也少了 OOP 完整物件的特色了)，這些落差開始困擾整個資訊界的發展，於是 OODBMS 的研究就開始了，但是一直到真正商業化產品問世，則是另一個契機: 結構化資料處理方式的標準化 --> XML。

XML 我就不多說了，在 HTML 風行後，XML 隨著誕生了，他用同樣的標籤結構，來描述自訂的資料。結構化 (巢狀結構) 資料開始有標準的處理方式，於是先前的 OODB 研究就開始有廠商願意商業化了。當年我第一個用過的 NoSQL, 其實是 XML based 的 database: 德國 Software AG 的產品 - Tamino XML database.

其實除了把現在 NoSQL 普遍採用的 Json 換成 XML 之外，Tamino 跟現今的 NoSQL 沒甚麼不同。由於底層資料的處理方式已經被 XML 標準化了，table 就被改成 document / collection 這類名詞，正規化也不再是 NoSQL 講究的設計方式了。好處是資料描述方式跟 OOP 的物件越來越能一致的對應。缺點則是少了正規化跟表格化，原本 RDBMS 擅長的索引與查詢，NoSQL 這條線就遠遠跟不上了，這邊還沒有講到另一個 RDBMS 的強項: 交易處理的能力...。

雖然在 index / transaction / query 等等領域, RDBMS 有難以取代的優勢, 但是 NoSQL 還是有他的強項的。最大的差別就是，資料開始有 object (或是 document) 的觀念了。你看大部分的 NoSQL 都是拿 Json 或是 XML 這類當作原生的儲存格式就知道了。你可以更聚焦在 "物件" 身上，不需要為了單一概念的資料，就一下子建立十幾個 table .. 如果照前面我的說法，RDBMS 高度抽象化資料結構的查詢跟儲存演算法，那 NoSQL 就是高度抽象化資料的定義 (schema) 了。NoSQL 相較於 RDBMS 來說，對於 data schema 的約束力降低了很多，相對的也給 application 更大的彈性。

由於結構上注重的領域不同，降低 data schema 的約束能力，NoSQL 就更以 OOP 的物件觀念來處理資料了。最大的特徵就是，NoSQL 幾乎都有原生地而 key-value 儲存的結構，而且 key-value 的資料操作表現，大概都有 O(1) 層級的水準，也就是說不論資料的量體有多大，即使背後已經被分配到不同的 node 儲存，K/V 的操作大都能維持在很一至的效能表現，這也是 RDBMS 不擅長的領域。





也因為有這些本質上的差異，所以我才會想寫這篇。如果你抱著 " RDBMS / NoSQL 哪個比較好? " 的心態來看這篇的話，那我沒有答案的。在我眼裡這完全是兩個世界。你該體會的是你要處理的是什麼性質的資料，你該用哪種比較合適才對。如果你真的不知道該怎麼區分，我給你一個簡單的原則:

1. 認清你要解決的問題是什麼? 如果不知道的話，你就挑出你最難的那幾個就好。從這最難的地方來決定你的 storage 技術。其他次要的問題再用別的技巧來彌補。
1. 如果規模夠大，而你又必須兼顧幾個互相衝突的需求，這就考驗你的技術能力了。你該做的不是二選一，而是要適度的組合幾種不同性質的技巧，發揮出不同技術之間互補的能力才是。

(1) 講的其實就是 "取捨"，你能取捨才能做出決策；(2) 講的就是架構能力，你架構能力要夠水準，組合不同性質技術才會表現出每種技術的優點... (弄得不好的話只會表現出每種技術的缺點... Orz)。如果兩者無法兼顧的話，那代表你現在面對的已經是超出你能力範圍的問題了，你該做的應該是先想辦法讓自己升級一下。

> 題外話: 每次當有人跟我說專案的金三角 (成本、品質、時程) 無法同時兼顧的說法，我心裡都不是很認同。對於同樣的 "人" 來說，這理論是成立的，因為每個人的能力都有它的極限。但是更有能力的人，也許可以讓這金三角的極限往上推進啊! 組隊玩過線上遊戲的大概都懂我在說啥... 當你等級不夠的話你隊伍裡面一定要有 坦 + 補 + 攻 才能推倒 BOSS ... 但是當你等級夠的話，一個人就能用輾的輾過去...。如果你面臨你認為 "無解" 的問題，那麼，想辦法讓自己升級吧! 不然就是想辦法預防，讓問題還不是問題的時候就解決他。



技術的特色，我先很簡單的點到這裡就好 (也許對大部分的人來說，這些有講跟沒講一樣)。實際的案例跟技術特色，我就在後面的 case study 再提吧! 後面我就直接針對微服務化的場景常見的 database 問題來說明。





# 難題 1: 資料一致姓與交易處理





# 難題 2: 舊資料封存




# 難題 3: 異動紀錄與快照的管理問題




# 難題 4: Cache 的命中率與資料正確性的平衡














如果 RDBMS 完完全全都能解決你的問題，那你不用往下看了，你的情況應該是適用 RDBMS 的。

因此，後面的探討，我就專注在哪些是 NoSQL 適合的場景了。




# NoSQL 適用的場景



# 為何雲端時代 / 微服務化的場景，特別容易看到 NoSQL 的應用?

// 反正都已經切割獨立的資料庫了，都沒辦法 join, 也都透過 API 存取資料, 也都必須面對分散式交易問題
// 這時 RDBMS 已經跟 NoSQL 沒有太大差別
// 何不用看看 NoSQL DB?


# 使用 NoSQL 你必須具備的能力


# 物件導向的應用: 抽象化介面

// object: interface & state
// interface -> API + microservice
// state -> database








------------------------

Q: 切割 DB 的關鍵: 如何不依賴 SQL ?  從 SQ "L" 降級為 AP "I"，你做好準備了沒?
A: 切割 DB 的前提是你要能限縮查詢資料的方式；你必須很熟悉 data structure, 才能設計精準到位的 API 操作，不需透過 schema + query language
A: 舉例: 安全機制的基礎 (認證 + 授權) 的設計 (Role Based Security Control) 如何避開 schema, 只靠 API ?



Q: 如何切割 DB ? 一個服務一個 DB, 那 table join 怎麼解決?
A: GraphQL? KV access? Report -> BQ like

Q: 切割 DB 後，資料同步問題?
A: CQRS, Event Driven, PUB/SUB

Q: 分散式交易怎麼半?
A: 2PC, Saga

Q: API 如何應付 Query? CRUD service?
A: API 應該只針對 "單一" 物件的改變。應以 state machine 為主來設計 API, 而非 CRUD 來設計。Query 應該另外開發，複雜的報表應該由 data 角度來處理

Q: 正規化?
A: 應思考如何安全的做好反正規劃

Q: 多資料庫，資料同時存在多份，後端異動該怎麼半?
A: CQRS + Replay

Q: 如何轉移?
A: 架好新的，逐步轉移。參考先前的文章 / 演講: 
https://columns.chicken-house.net/2016/10/03/microservice2/
https://columns.chicken-house.net/2017/04/15/microservice8-case-study/
https://columns.chicken-house.net/2017/07/11/microservice8-case-study-p3/
https://www.facebook.com/watch/?v=545139382528011

