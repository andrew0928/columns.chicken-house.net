# 微服務架構 - 從狀態圖來驅動 API 的設計

## 摘要提示
- 狀態機驅動: 以有限狀態機（FSM）為核心，把狀態、動作、事件、授權一次到位地描繪在同一張圖上。
- API 一致性: 藉由事前在 FSM 圖上檢視各面向，確保命名、邏輯與存取規則高度一致。
- 充血模型取向: 捨棄單純 CRUD 的「貧血模型」，改用動作導向 API 以收斂商業邏輯。
- FSM 對應程式碼: 將狀態與轉移條列化，透過 enum、service method 與 state machine 查表實作。
- 事件設計: 先處理「狀態改變」類事件，再補上動作完成後的 Hook，保持層次分明。
- 授權角色: 在動作上標註可執行角色，並可直接映射至 RBAC、OAuth2 Scope 或 API Gateway。
- 快速驗證: 以「地圖」思維走案例路徑，立即找出缺狀態、少動作或角色錯配等問題。
- AOP 與框架: 透過 ASP.NET Core Middleware、Attribute 或第三方 state machine 套件簡化程式碼。
- 會員系統案例: 以註冊、啟用、鎖定等流程示範如何由需求一路推導到最終 API。
- 安全設計: 設計階段即考慮安全管控，比事後補洞有效且降低系統維護成本。

## 全文重點
作者以「會員生命週期」為範例，示範如何用有限狀態機驅動微服務 API 設計。首先界定「好 API」需具備結構清晰、一致且易於預測的特性；其次指出貧血模型僅能處理 CRUD，難以掌握業務意圖，因而選擇充血模型並以「狀態＋動作」為設計軸線。文章步驟如下：  
1. 列出核心狀態，避免將單純屬性誤當狀態；2. 條列動作並繪製 FSM，藉由查表或轉移清單建立 state machine；3. 由狀態轉移自動推導事件，再補上動作層級的 Hook；4. 為每個動作標示可執行角色，讓設計直接對應 RBAC/OAuth2；5. 補齊不影響狀態的輔助動作與事件；6. 以程式碼驗證 FSM 是否能正確阻擋非法呼叫。  
整體示範涵蓋 enum、service class、lock 保護、事件觸發及授權檢查，並說明可利用 AOP、ASP.NET Core Attribute 或 API Management 快速落地。作者強調，將狀態、動作、事件與授權集中在 FSM 設計，可在早期即暴露設計缺陷並保持 API 穩定；而良好的設計也能自然對接主流框架與標準，減少日後維運與安全風險。

## 段落重點
### 何謂「理想」的 API 設計?
從架構師觀點說明評估 API 品質的三層次：結構設計、規格符合度與服務可靠度；點出藉 FSM 把狀態與動作一致化，才能避免 CRUD 式 API 在邏輯與安全上失控，並引入會員範例作為貫穿全文的題材。

### 第一步，找出所有的狀態
解析需求後先盤點「絕對必要」的狀態，避免把屬性誤升級；列出 Created/Activated/Deactivated/Archived 等生命週期節點及對應動作，繪出初版 FSM，並以 enum 與 service method 做一一映射。

### 第二步，FSM 對應到程式碼的結構
介紹查表法與轉移清單兩種實作策略，使用泛型 StateMachineBase 統一查詢介面；示範如何在 service method 內先檢查 FSM，再以 lock 確保狀態轉移原子性，並透過事件機制釋出領域事件。

### 第三步，列出事件清單
將「狀態改變」自動觸發的事件（如 OnMemberActivated）與「動作完成」觸發的 Hook（如 OnMemberRegisterCompleted）分層管理；透過修正狀態命名與動作分類，確保事件語意精確且不重覆。

### 第四步，在動作上標示角色
把 USER、STAFF 等角色直接標註在動作旁，先於設計階段決定權限邊界；並展示三種落地方式：ASP.NET Core Authorize Attribute、分離 Endpoint 以及 API Management Subscription/OAuth2 Scope 映射。

### 第五步，補上其他動作、事件與角色
待主結構收斂後，補齊不影響狀態的動作（如 ValidateEmail）與相關事件；同樣在 FSM 上加註狀態檢查與授權需求，使程序骨架完整且易於自動化產生模板。

### 第六步，案例驗證
以程式碼示範從 START 走到 Register→Activate→Lock→Remove 的結果，證明 FSM 能正確允許或阻擋呼叫；並說明若改用 AOP 或 Middleware，可進一步將驗證與授權邏輯抽離，程式更簡潔。

### 結語
作者將「程式＝資料結構＋演算法」延伸為「服務＝狀態＋動作」，強調好工具不保證好作品，唯有先掌握結構與設計思維，才能寫出穩定、易用又安全的 API；並鼓勵讀者用 FSM 做快速驗證，將概念落實於實作。