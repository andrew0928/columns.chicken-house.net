# 微服務架構設計 ‑ Event Sourcing

## 摘要提示
- Event Sourcing: 以「事件」取代傳統 CRUD，紀錄不可變的時序資料來保留完整歷程。  
- CQRS: 與 Event Sourcing 搭配，分離 Command 與 Query，使寫入序列化、查詢最佳化。  
- Cloud Native: 從硬體可靠度轉向軟體自癒設計，強調可水平擴充與最終一致性。  
- 儲存策略: 事件只新增不更新，需以 Key-Value / NoSQL 及 Aggregation View 提高查詢效率。  
- 交易場景: 銀行存摺、跨系統對帳等需重播事件或追溯歷程的金融應用最適合。  
- 延遲處理: 「校正回歸」示範資料收集延遲與即時統計衝突時的回填機制。  
- 架構成本: 儲存量、運算量與開發門檻皆上升，須評估規模與商業價值。  
- Cloud vs On-Prem: 過了規模臨界點後才需採用事件導向與流式處理。  
- 系統邊界: 定義資料發生時間與收到時間，並設計多種 View 供不同決策使用。  
- 例外流程: 設置延遲上限與關帳機制，逾期事件須走人工或特殊補件流程。  

## 全文重點
作者以近期專案經驗切入，說明 Event Sourcing 早在 2000 年代即被提出，其核心是「儲存事件而非結果」，讓系統能在任何時間點重建狀態。事件序列具有僅增不改的特性，因此寫入模式從 CRUD 簡化為 CR，而刪除僅以封存方式處理；為配合大量附加型資料，前端寫入需與 CQRS 結合，在 Command 階段先序列化事件，讓資料庫專職追加，查詢端則透過獨立的 Aggregation View 快速取得最終狀態。  
作者以銀行存摺為類比，說明完整事件帶來的可追溯性：若計息出錯，只要修正演算法並重播事件，即可算出正確餘額，對照單純記錄餘額再加旁路 Log 的做法，事件天生就是「來源資料」，可直接重計。  
接著論及 Cloud Native 思維的變革：當系統規模達到「硬體故障不可避免」的數量級，與其倚賴高階設備，不如在軟體層允許失敗並自動恢復；資料儲存採多副本，計算則把 Query 帶到資料所在位置（MapReduce），以克服 I/O 瓶頸。微服務與 Cloud Native 是同一枚硬幣的兩面，強調切割邊界、去中心化與最終一致性。Event Sourcing 便是 Cloud Native 眾多 Pattern 之一，在流式處理鏈上於「事件到達當下」即完成複寫與衍生計算，換取 O(1) 的存取複雜度與線性伸縮能力。  
作者列舉 Message Queue、Streaming Processing、CQRS、DDD、NoSQL 等前置知識，並以改寫的銀行帳戶服務示例說明：所有交易進入 Message Queue，後端 Consumer 依序寫入 Event Store，再由 Stream Processor 更新餘額快照、報表 View 或搜尋索引。如此能同時滿足 ACID 不可行時的跨服務一致性要求（可再透過 Saga 編排），也能隨時重播事件到任一時間點。  
最後以近期「校正回歸」疫情數據事件切題，點出即時需求與資料延遲的衝突：線上交易秒級上報，但門市需隔日盤點；公衛檢體需多日檢驗。解法是在架構層明確標示「資料發生時間」與「收到時間」，並分割三種 View：即時、隔日統計、歷史修正通知。系統還要設定可容忍的最大延遲（如 5 天），超出則走例外流程。掌握 Event Sourcing + CQRS，便能優雅處理日益普遍的時間維度難題。  

## 段落重點

### 簡介：什麼是 Event Sourcing
說明事件溯源的定義與來源，強調「存異動不存結果」，資料庫由 CRUD 轉為追加式 CR；搭配 CQRS 在寫入階段先序列化事件，查詢端以聚合快照避免頻繁重播。以銀行存摺類比優勢：保留順序、可重算、僅新增不修改，同時揭示儲存成本及開發門檻的缺點。

### 雲端時代的架構觀念 — Cloud Native
回顧 Google 早期因硬體故障率與資料規模推動的設計轉型：多副本儲存、MapReduce 就地計算、K8s 自癒調度。闡述 Cloud Native 側重可水平擴充與最終一致性，微服務只是邊界劃分方法；Event Sourcing 正屬於 Cloud Native 思維下的典型模式，能以 O(1) 操作換取更高的可伸縮上限。

### Event Sourcing 應用案例
列舉導入所需元件：Message Queue、Streaming、CQRS、DDD、NoSQL。以銀行帳戶服務為例：交易進入 Queue，Consumer 寫入 Event Store，Stream Processor 更新餘額與報表 View，必要時透過 Saga 完成分散式交易；展示事件重播、錯帳修正及最終一致性的實際收益。

### 校正回歸：資料處理時效性的衝突
以疫情統計及實體門市延遲上傳為例，解析「即時需求」與「資料延遲」的矛盾；提出三層 View（即時、隔日、修正）與延遲上限設計，說明如何用 Event Sourcing + CQRS 優雅吸收時間差，同時滿足決策及營運需求，並強調透明告知修正比追求完美即時更重要。

