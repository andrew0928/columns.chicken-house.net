# [設計案例] 「授權碼」如何實作? #1, 需求與問題

## 摘要提示
- 問題導向思維: 不只談 How To，更強調 Why 與架構選擇，聚焦以授權碼解決商業問題。
- 安裝型佈署情境: 系統裝在客戶資料中心，網路不保證可連外，授權仍需離線生效。
- 授權碼定位: 一段字串/號碼決定功能啟用與期限，影響安全不影響功能本身。
- 多方角色與風險: 原廠、客戶、系統整合商並存，需防懂設定與程式的技術人員未授權啟用。
- API Key 控制: 雲端服務僅憑 API Key 判斷可用功能，需可被授權與停用。
- 授權期限控管: 在封閉網路中仍須依合約到期自動失效，換新授權才可續用。
- 安全強度要求: 對稱/非對稱與數位簽章等強健機制，避免無鑰突破。
- 易於擴充: 架構需可擴充新授權項目，讓開發者快速沿用。
- DX 概念導入: 與 UX 類比，重視開發者體驗，API 不只要能運作，更要好用。
- 系列化探討: 本文為系列首篇，後續涵蓋序列化、數位簽章與金鑰管理。

## 全文重點
本文以實務案例探討「授權碼」與 API Key 的設計與實作，著重問題定義與架構思維，而非單一技術細節。作者開發的商用系統採 Install-Based 佈署，服務部署在不同客戶的資料中心，常見無法穩定連網的情境，要求授權機制在離線環境仍可準確控制功能啟用、API 調用與授權期限。因為介面人員包含原廠、客戶 IT 與系統整合商，需防範懂設定與程式的技術人員逾權啟用功能，故授權碼必須能獨立於程式碼，並具備足夠強度的安全設計。

具體需求包含五點：網站授權須由原廠核發並可透過設定啟用但不可被私自開啟；API Key 必須由雲端服務單憑該憑證決定可用功能；授權須支援期限控管，在封閉網路也能自動到期；安全強度需達業界標準，避免無鑰突破；架構需有良好擴充性以支援未來新授權項目。作者指出，若理解對稱/非對稱加解密與數位簽章的目標與原理，問題已解決一半；另一半在於良好實作與封裝，亦即 DX（Developer Experience）。與 UX 類比，DX 強調 API 與開發介面的好用度與一致性，讓開發者快速、安全地整合授權能力。本文為系列首篇，後續將逐步說明授權碼的序列化格式、數位簽章驗證，以及金鑰管理與保護實務，目標是在不破壞既有功能的前提下，建立兼具安全性、可維運性與可擴充性的授權架構。

## 段落重點
### 開場與寫作動機：從 Why 出發的設計案例
作者觀察技術社群多談「如何做」而少談「為何這樣做」，因此以授權碼為題，分享從問題定義、技術選擇到完整實作的思考過程。強調軟體/系統架構師的價值在於用正確技術解決商業問題，而非只在語法層面打轉。安全機制平時不影響功能，常被忽略，直到出事才檢討；且處理安全需求若缺乏結構思維，易寫成難維護的「義大利麵條」式程式碼。本文意在提供一個清晰的架構範例，協助讀者理解授權的設計面與實作細節，並鋪陳系列文章的脈絡。

### 系列文章索引與延伸閱讀
本文列出本系列的後續主題：授權碼序列化、數位簽章，以及金鑰保護補篇；並回顧作者先前的設計案例系列（清除 Cache 物件、生命遊戲）以供延伸參考。這些索引說明本系列不只談單點技術，而是以系統化架構方式，逐篇拆解授權機制的各個面向，讓讀者得以循序漸進理解問題空間與解法空間。

### 本文開始：佈署情境與離線授權
以實際佈署圖示說明：不同客戶資料中心的 Service #B、#C 使用同一套系統，雲端的 Service #A 針對各客戶核發不同功能授權。然而現場網路可能無法連外，甚至 Service #A 也被移入內網，導致無法即時回原廠驗證。這要求授權與 API 控制機制必須在離線環境照常運作，且仍能準確限制功能與期限。授權碼因此成為承載授權內容、可由目標系統獨立驗證與執行的關鍵。

### 五項核心需求：授權、API Key、期限、安全與擴充
1) 網站授權：同套程式在不同客戶上透過設定啟用授權，但需防系統整合商或技術人員未授權開啟功能，故授權必須具備不可偽造與可驗證性；2) API Key：雲端服務需僅憑 API Key 決定功能開放，且需可由原廠核發與撤銷；3) 授權期限：離線亦須自動依合約到期失效，換新授權方可續用；4) 安全強度：面對熟悉架構的工程師，需採業界可靠演算法與金鑰機制，無鑰不可突破；5) 擴充性：架構需可輕易新增授權項目，讓開發者快速沿用既有保護機制。

### 技術原則與 DX：超越可用，追求好用
作者指出，理解對稱/非對稱加解密與數位簽章各自解決的問題，是處理授權安全的一半；另一半是良好的實作與封裝，亦即 DX（Developer Experience）。DX 如同 UX，但面向開發者：API 不僅要能工作，還要容易理解、正確使用、可測試、可維護。透過良好的物件導向封裝、清晰的 API 設計與語言特性運用（文中以 C# 為例），能將複雜的安全流程變成穩定且直觀的開發介面，降低誤用風險並提升生產力。

### 結語與預告：走向序列化與簽章
本文完成問題定義與需求盤點，確立授權碼在離線、多方角色、強安全與可擴充情境中的角色。後續文章將依序探討：授權碼的序列化格式（如何承載與解析授權資訊）、數位簽章（如何驗證真偽與防竄改），以及金鑰管理（如何保護與輪替金鑰）。並附上 DX 相關參考資料，鼓勵讀者以開發者體驗為導向，打造兼具安全與效率的授權架構。

## 資訊整理

### 知識架構圖
1. 前置知識
- 基本資安觀念：認證、授權、機密性、完整性、不可否認
- 密碼學基礎：對稱/非對稱加解密、雜湊、數位簽章、金鑰配對與輪替
- 服務架構與部署：On-prem/Install-based 與雲端混合佈署、內外網限制
- API 基礎：API Key/Token 的用途與差異、服務間呼叫
- OOP 與程式設計：抽象化、封裝、可擴充設計、設定管理

2. 核心概念
- 授權碼（License）機制：以一段字串/檔案啟用功能與期限控制
- API Key 機制：服務間呼叫的識別與授權範圍控制
- 離線/封閉網路授權：無法即時連雲端時仍可驗證與到期
- 安全強度與金鑰：以標準演算法與妥善金鑰管理抵禦內部技術人員繞過
- DX（Developer Experience）：為開發者設計好用、可維護、可擴充的授權框架
關係：授權碼與 API Key 都依賴標準密碼學與金鑰管理；離線場景要求序列化與數位簽章確保完整性與真偽；良好 DX 使授權能力以一致接口被系統各模組重用與擴充。

3. 技術依賴
- 序列化/反序列化：授權資料模型 → 可攜字串/檔案
- 數位簽章與驗章：原廠私鑰簽發、部署端公鑰驗證
- 對稱/非對稱加解密：保密與驗真分工；必要時結合避免洩露授權內容
- 金鑰管理：私鑰保護、輪替、授權更新流程、信任錨分發
- 設定與模組化設計：以設定啟用功能，但受驗章/驗簽保護避免被任意開啟
- 服務間安全傳輸：API Key 攜帶與校驗（可結合簽名、時間戳、權限範圍）

4. 應用場景
- 企業安裝版系統（多客戶、各自資料中心）功能與期限授權
- 封閉/不穩定網路或完全離線的內網部署
- SI 夥伴參與安裝/客製但無法擅自開啟未授權功能
- 雲—地混合：雲端服務按 API Key 控制客戶可用功能面
- 合約到期自動停用、續約更換授權碼的運維流程

### 學習路徑建議
1. 入門者路徑
- 了解認證/授權與 API Key 的基本角色與差異
- 學會對稱/非對稱加密、雜湊、數位簽章的概念與適用情境
- 熟悉設定檔與環境變數管理、基本序列化（JSON/PEM）
- 讀範例：離線驗證的簡單授權碼驗章流程

2. 進階者路徑
- 設計授權資料模型（功能清單、期限、客戶識別、指紋綁定等）
- 實作簽章與驗章、金鑰輪替、信任鍊/公鑰分發策略
- 為 API Key 增加作用範圍（scope）、到期、重放防護（nonce/時間戳）
- 打造具擴充性的 DX：策略模式/工廠/裝飾器等封裝授權檢查

3. 實戰路徑
- 建立原廠簽發服務：產生授權碼、簽章與審計記錄
- 在服務端整合授權中介層：啟動時驗章、執行時按功能旗標守門
- 部署流程：公鑰下發、授權匯入、監控到期、續約更換
- 壓測與紅隊測試：嘗試繞過設定、偽造授權、竄改功能旗標

### 關鍵要點清單
- 問題定義與需求分解: 釐清功能授權、API Key、離線、到期、擴充與強度需求 (優先級: 高)
- 授權資料模型: 包含客戶 ID、功能列表、版本/期限、可選硬體綁定等欄位設計 (優先級: 高)
- 序列化策略: 授權資料以可攜格式（如 JSON）封裝並考量可讀/不可讀與長度 (優先級: 中)
- 數位簽章/驗章: 用私鑰簽發、部署端以公鑰驗證確保真偽與完整性 (優先級: 高)
- 加密與簽章分工: 機密性用加密、真偽/完整性用簽章，避免濫用 (優先級: 高)
- 金鑰管理: 私鑰保護、輪替策略、公鑰分發與信任錨管理 (優先級: 高)
- API Key 設計: 含身份、權限範圍、有效期、簽名/時間戳/nonce 防重放 (優先級: 高)
- 離線驗證流程: 無外網仍可驗章與到期判斷，避免與伺服器時鐘繞過 (優先級: 高)
- 設定與守門點: 功能旗標以程式守門檢查，不因修改設定檔而生效 (優先級: 高)
- DX 設計: 簡潔 API/中介層、清楚錯誤訊息、可測試、易擴充新授權項 (優先級: 中)
- 擴充性與相容性: 新增授權項目不破壞舊客戶；版本化授權格式 (優先級: 中)
- 佈署與營運流程: 授權發放、安裝、更換、審計與到期提醒 (優先級: 中)
- 防竄改與偵測: 對授權碼、設定檔、二進位加驗證與完整性檢查 (優先級: 中)
- 風險模型與威脅對手: 假設內部懂技術的人嘗試繞過，設計對抗手段 (優先級: 高)
- 測試策略: 單元/整合/安全/離線/時間邊界（到期前後）測試用例 (優先級: 中)