# [設計案例]「授權碼」如何實作？#1 需求與問題 — FAQ

## 問題與答案 (FAQ)

### Q&A 類別 A: 概念理解類

Q1: 什麼是「授權碼」？
- A簡: 授權碼是原廠核發且受簽章保護的字串，用於離線判定可用功能與授權期限。
- A詳: 授權碼是一段承載授權資訊（如可用功能、使用數量與到期日）的資料，通常以序列化格式（如 JSON）儲存並由原廠以非對稱金鑰簽章。被部署在客戶機房的服務（例如 Service B/C）可在離線環境驗證授權碼的真偽與有效期，據以啟閉功能。它不直接影響核心功能設計，但決定功能是否被允許使用，並能在合約到期時自動停用。有效的授權碼應兼具可驗證性、防篡改與易於更新，以支援 Install Based 的佈署情境與多租戶差異化授權。
- 難度: 初級
- 學習階段: 基礎
- 關聯概念: A-Q5, A-Q14, B-Q1

Q2: 什麼是 API KEY？
- A簡: API KEY 是呼叫端識別與授權用的金鑰字串，供服務驗證並決定可用 API 範圍。
- A詳: API KEY 是分配給呼叫者（如 Service B）的識別與授權憑證，多以隨機高熵字串表達，常綁定使用者、應用或環境。被呼叫的服務（如 Service A）於每次請求時驗證 API KEY 的有效性與對應權限，據以允許或拒絕特定 API 與資源存取。在本文情境下，Service A 應僅依 API KEY 即可判定開放的功能集合，以符合封閉網路或斷線場景下的簡單、可靠與可審計性需求。
- 難度: 初級
- 學習階段: 基礎
- 關聯概念: A-Q3, B-Q2, C-Q5

Q3: 授權碼與 API KEY 有何差異？
- A簡: 授權碼管控裝置內功能與期限；API KEY管控服務之間的呼叫與授權範圍。
- A詳: 授權碼主要用於本地功能啟用與期限控管，強調離線可驗證、不可竄改與合約到期自動失效；其授權主體常為部署節點或安裝個體。API KEY 則用於服務間通訊時的呼叫端識別與存取控制，強調請求時即時驗證、範圍（scope）判定與審計。兩者可互補：Service B 以授權碼決定本地功能啟用，再以 API KEY 呼叫 Service A 的雲端 API，Service A 僅憑 API KEY 決定開放的端點與資源。
- 難度: 初級
- 學習階段: 基礎
- 關聯概念: A-Q1, A-Q2, B-Q6

Q4: 為何 Install Based 佈署需要授權機制？
- A簡: 安裝在客戶機房難以長期連外，需離線可驗證的授權以控管功能與期限。
- A詳: Install Based 佈署把系統裝在客戶資料中心，常遇到斷網、隔離網段、嚴格變更流程等環境限制。即使功能完整實作，仍需控管哪些功能可用、期間多久、是否符合合約，以避免未經原廠同意的擴用或不當啟用。離線可驗證的授權碼能在無法即時連回原廠時發揮效用，保障商業模式與合約依循，同時減少在環境受限下的維運成本。
- 難度: 初級
- 學習階段: 基礎
- 關聯概念: A-Q5, A-Q17, B-Q1

Q5: 什麼是離線授權（Offline Licensing）？
- A簡: 無需連線原廠伺服器即可驗證授權真偽與期限的機制與流程。
- A詳: 離線授權透過事先核發、含簽章的授權檔在客戶環境中自我驗證，無需依賴即時線上查詢。其核心是「可驗證的事實」：授權內容被原廠私鑰簽章，部署端用對應公鑰驗證完整性與發行者；並檢查授權的有效期間與機器綁定資訊。此機制適用於封閉網路、臨時斷線或雲端服務也被搬入內網的情境，確保在任何連線狀態下都能正確控管功能。
- 難度: 初級
- 學習階段: 核心
- 關聯概念: B-Q1, B-Q4, C-Q3

Q6: 什麼是 Service Administrator？在授權中扮演什麼角色？
- A簡: 原廠或授權核發者，負責產生、管理、派發與撤銷授權及金鑰。
- A詳: Service Administrator 是授權信任鏈的根，通常是原廠或其授權中心。職責包含定義授權模型、產生與保存私鑰、核發授權碼、分配 API KEY、設定有效期與使用範圍、處理續約與撤銷，並建立審計與金鑰輪替流程。其決策與操作直接影響安全強度、擴充性與維運複雜度，是整體授權與 API 安全治理的關鍵角色。
- 難度: 初級
- 學習階段: 基礎
- 關聯概念: B-Q9, B-Q10, C-Q8

Q7: 客戶 IT、系統整合商（SI）與原廠在授權中的關係？
- A簡: SI與客戶IT能改設定與客製，授權須防未授權啟用並保留可維運性。
- A詳: SI 與客戶 IT 多半具備改設定、部署與客製能力，流程上需能操作配置卻不應繞過授權。因此授權需以「不可竄改且可驗證」為核心，避免僅靠設定檔開關。原廠（Service Administrator）掌握核發與撤銷權；SI/IT 在既定流程中更換授權檔或 API KEY，協助上線與維運。設計上需平衡可操作性與防篡改，並提供清楚的變更與審計軌跡。
- 難度: 初級
- 學習階段: 基礎
- 關聯概念: A-Q16, B-Q8, D-Q6

Q8: 為何資安機制常不影響功能卻至關重要？
- A簡: 安全屬非功能性需求，不改業務流程卻關係到合法使用與風險控管。
- A詳: 加密、簽章、授權檢核通常不改業務功能本身的行為，因此在正常情境難以感知其存在。但一旦缺失，將導致未授權擴用、資料外洩、合約違反等重大後果。良好架構應將安全設為橫切關注點（cross-cutting concern），以中介層或組件化實作，在不干擾功能開發的前提下，確保一致性與可維運性。
- 難度: 初級
- 學習階段: 核心
- 關聯概念: B-Q7, B-Q8, D-Q2

Q9: 什麼是 Developer Experience（DX）？
- A簡: 以開發者為使用者的體驗設計，重視易用、可維護與整合流暢。
- A詳: DX 是以開發者為對象的使用者體驗，涵蓋 API 的可讀性、錯誤回饋、範例、文件、套件化程度與整合成本。良好 DX 能降低學習曲線、避免誤用、提升擴充效率。對安全與授權議題，DX 意味著在保證安全強度的同時，提供直觀介面與清楚邏輯，使開發者容易「做對」，而非被迫繞過機制。
- 難度: 初級
- 學習階段: 基礎
- 關聯概念: A-Q10, B-Q7, C-Q9

Q10: 為何 DX 對授權與 API 設計特別重要？
- A簡: 好的DX讓安全機制易用不易錯，降低繞過機制與錯誤實作風險。
- A詳: 授權與 API 安全常被視為「麻煩」；若介面晦澀、文件不足，開發者易採取捷徑（硬編碼、關閉檢查）。DX 將安全封裝為易理解的抽象（如 LicenseProvider、FeatureToggle、AuthMiddleware），提供清晰錯誤、範例與工具，讓正確使用成本更低於錯誤做法，進而提升整體安全與維運品質。
- 難度: 初級
- 學習階段: 核心
- 關聯概念: B-Q7, C-Q4, C-Q9

Q11: 什麼是對稱式加解密？
- A簡: 使用同一把金鑰加解密，速度快，適合資料保密但不適合公開驗證。
- A詳: 對稱式加解密（如 AES）以同一金鑰進行加密與解密，計算效率高、適合大量資料保密。但在授權情境，若用對稱密鑰簽授權，驗證端須持有密鑰，導致任何持鑰者皆可偽造授權，不符合「公開驗證、私密簽發」的需求。因此對稱密鑰多用於「保密傳輸或存放」，不單獨用於授權完整性驗證。
- 難度: 初級
- 學習階段: 核心
- 關聯概念: A-Q12, B-Q5, C-Q8

Q12: 什麼是非對稱式（公私鑰）加解密？
- A簡: 以私鑰簽名、公鑰驗證；或公鑰加密、私鑰解密，適合可公開驗證場景。
- A詳: 非對稱密碼學（如 RSA、ECDSA）使用成對金鑰。常見於授權簽章：原廠以私鑰簽署授權，部署端以公鑰驗證，達成「任何人可驗證、只有私鑰持有者能簽發」。也可用於密鑰交換。此模式符合離線授權對不可否認與防偽的需求，是授權碼完整性與來源驗證的關鍵。
- 難度: 初級
- 學習階段: 核心
- 關聯概念: A-Q13, B-Q4, C-Q2

Q13: 加密與數位簽章差在哪裡？
- A簡: 加密保密內容；簽章驗證來源與完整性，不一定保密。
- A詳: 加密的目標是讓未授權者看不懂內容，側重機密性；數位簽章則透過不可逆雜湊與私鑰計算，提供「完整性」與「來源真偽」保證，任何人可用公鑰驗證。授權碼通常需被讀取以判斷功能，因此多採「明文+簽章」而非加密；若授權內含敏感資料，再搭配加密保護機密性。
- 難度: 初級
- 學習階段: 核心
- 關聯概念: B-Q3, B-Q4, C-Q2

Q14: 什麼是授權期限（License Term）與其強制性？
- A簡: 授權需含到期日並在到期即停用，續約後更換新授權恢復。
- A詳: 授權期限將服務合約時間落實到系統層。授權檔應包含「簽發日、起始日、到期日」，系統在啟動與運行時檢查並於到期停用相關功能，提供明確訊息與導引續約。到期後接受新授權即可恢復，避免依賴線上查詢或手動開關，確保合約遵循與可預期運維。
- 難度: 初級
- 學習階段: 核心
- 關聯概念: B-Q10, C-Q7, D-Q4

Q15: 什麼是「安全強度」？如何衡量？
- A簡: 指演算法與實作對抗攻擊的難度，含金鑰長度、實作與流程。
- A詳: 安全強度涵蓋演算法安全（如 RSA/ECDSA 標準、金鑰長度）、實作安全（抗時序/邊道攻擊、正確填充）、流程安全（金鑰保護、輪替、審計）、與威脅模型符合度。衡量方法包含使用業界標準、遵循最佳實務、定期測試與審計，而非自行發明加密。目標是讓即使熟悉架構的工程師，沒有金鑰也無法繞過。
- 難度: 中級
- 學習階段: 核心
- 關聯概念: B-Q9, C-Q8, D-Q7

Q16: 什麼是可擴充的授權架構？
- A簡: 能輕鬆新增授權項目與服務，開發者沿用同一基礎元件擴展。
- A詳: 可擴充架構把授權視為平台能力：有穩定的授權模型（claims/feature flags）、簽章驗證、提供統一 API（如 ILicenseProvider、IFeatureGate）給應用程式。新增功能僅需定義新授權項與檢查點，避免散落邏輯。此設計降低開發成本與誤用，維持一致 DX 與安全強度。
- 難度: 中級
- 學習階段: 核心
- 關聯概念: B-Q7, B-Q11, C-Q9

Q17: 為何不應依賴隨時可連外的網路來授權？
- A簡: 客戶機房常受限網路；離線授權更可靠、可預期、可維運。
- A詳: 真實環境中常有隔離網段、變更排程、臨時斷線、雲服務遭內移等情境。若強依賴即時線上驗證，將導致不穩定、難以運維與使用體驗不佳。離線可驗證的授權把脈絡轉為「憑證學」問題，讓系統在任何連線狀態都可判斷授權，僅在續約或異動時需要人工更換。
- 難度: 初級
- 學習階段: 基礎
- 關聯概念: A-Q5, B-Q1, C-Q7

Q18: Install Based 與雲端服務授權的主要差異？
- A簡: Install Based重離線與防篡改；雲端重即時驗證與集中撤銷。
- A詳: Install Based 需在客戶環境自我驗證與執行授權，強調簽章、防篡改、機器綁定與簡易更換。雲端可集中管理與即時撤銷，偏重線上清單、動態範圍與速率限制。兩者可融合：本地以授權碼控功能，對外以 API KEY 控呼叫，形成分層授權。
- 難度: 中級
- 學習階段: 核心
- 關聯概念: A-Q3, B-Q6, C-Q5

---

### Q&A 類別 B: 技術原理類

Q1: 離線授權驗證如何運作？
- A簡: 以私鑰簽授權，部署端用公鑰驗證與檢查期限/綁定資訊。
- A詳: 技術原理：授權內容（功能清單、期限、綁定）先雜湊，再以私鑰簽章；部署端持公鑰驗證簽章。關鍵流程：1. 讀取授權檔；2. 驗證簽章與版本；3. 檢查有效期與綁定（如主機指紋）；4. 產生授權宣告（claims）。核心組件：授權模型（LicenseModel）、簽章服務（SignatureService）、驗證器（LicenseValidator）、特性開關（FeatureGate）。此法確保來源與完整性，支援無網路環境下的正確判斷。
- 難度: 中級
- 學習階段: 核心
- 關聯概念: A-Q5, A-Q12, B-Q4

Q2: Service A 的 API KEY 驗證流程為何？
- A簡: 檢查API KEY存在、有效、綁定範圍，失敗即拒絕請求並記錄審計。
- A詳: 技術原理：以高熵隨機鍵作識別，搭配存放權限範圍（scopes）。流程：1. 從標頭/查詢取 KEY；2. 比對存放（快取/DB）；3. 檢查狀態（啟用/撤銷）、到期、來源限制；4. 注入呼叫者身分與範圍；5. 授權策略比對端點需求。核心組件：金鑰存放（KeyStore）、驗證中介（AuthMiddleware）、授權策略（PolicyProvider）、審計記錄。此設計讓 Service A 僅憑 KEY 即能決定可用 API。
- 難度: 中級
- 學習階段: 核心
- 關聯概念: A-Q2, A-Q3, C-Q5

Q3: 授權檔如何利用加密與簽章確保安全？
- A簡: 以簽章防篡改與驗證來源，必要時再加密保護敏感欄位。
- A詳: 原理：簽章提供完整性與不可否認；加密提供機密性。流程：1. 建立授權內容；2. 使用私鑰簽章；3. 若含敏感資料（如客戶識別），再用對稱密鑰加密欄位；4. 發佈檔案。驗證端先驗證簽章，再視需要解密。組件：簽章器、欄位加密器、金鑰管理、版本控制。優先確保簽章，避免僅用對稱加密導致驗證端可偽造。
- 難度: 中級
- 學習階段: 核心
- 關聯概念: A-Q13, B-Q4, C-Q2

Q4: 數位簽章在授權完整性保護的機制是什麼？
- A簡: 將授權內容雜湊後以私鑰簽名，驗證端用公鑰檢查是否被改。
- A詳: 原理：授權 JSON 做雜湊，私鑰對雜湊值簽名，形成不可偽造的簽章。流程：1. 授權中心簽發；2. 客戶端載入授權與簽章；3. 以公鑰驗證；4. 驗證失敗即拒用。組件：雜湊函數（SHA-256+）、簽章演算法（RSA/ECDSA）、驗證器、錯誤處理與審計。此機制確保任何位元差異都可被偵測，滿足防篡改需求。
- 難度: 初級
- 學習階段: 核心
- 關聯概念: A-Q12, A-Q13, C-Q3

Q5: 對稱與非對稱在此架構的典型分工？
- A簡: 非對稱用於簽章與公開驗證；對稱用於必要的欄位機密保護。
- A詳: 分工模式：1. 授權完整性與來源驗證採非對稱簽章（私簽公驗）；2. 若授權含敏感欄位（如商業條款），以對稱加密保護；3. API KEY 則以高熵隨機與雜湊存放。流程：簽章為必要；加密視敏感性加上。組件：RSA/ECDSA、AES、金鑰管理、欄位層級保護器。這樣既能離線公開驗證，又避免敏感資訊外洩。
- 難度: 中級
- 學習階段: 核心
- 關聯概念: A-Q11, A-Q12, B-Q3

Q6: A/B/C 與授權的高層架構如何設計？
- A簡: B/C本地以授權碼控功能；A以API KEY控外呼，兩者分層互補。
- A詳: 架構：Service B/C 安裝於客戶機房，啟動載入授權檔，驗證簽章與期限後產生 feature claims；Service A 為雲或內網服務，收到來自 B 的請求時以 API KEY 驗證與授權範圍。流程：本地授權決定功能可用性；跨服務以 KEY 控制呼叫權限。組件：LicenseProvider、FeatureGate、AuthMiddleware、KeyStore、AuditLog。此分層能兼顧離線與線上場景。
- 難度: 中級
- 學習階段: 核心
- 關聯概念: A-Q3, B-Q1, B-Q2

Q7: 如何設計以授權驅動的功能開關（Feature Toggle）？
- A簡: 將授權項映射為程式內的特性旗標，統一入口檢查與啟閉。
- A詳: 原理：授權檔中的功能清單轉為程式 claims，經由 FeatureGate 查詢。流程：1. 啟動時載入授權，轉換為 in-memory claims；2. 中介或屬性在進入點檢查；3. UI/流程依旗標隱顯與封鎖。組件：ILicenseProvider、IFeatureGate、屬性標註（如 [RequiresFeature("X")])、錯誤回饋與遙測。集中檢查避免散落判斷，提升 DX 與一致性。
- 難度: 中級
- 學習階段: 核心
- 關聯概念: A-Q16, C-Q4, D-Q2

Q8: 面對能改設定的工程師，如何強化防篡改？
- A簡: 使用簽章檢驗、二進位封裝、只讀權限與審計，避免單靠設定。
- A詳: 原理：將授權由「可編輯設定」轉為「受簽章證據」。流程：1. 授權以簽章保護；2. 在程式啟動即驗證；3. 封裝關鍵邏輯於程式碼或受信元件；4. 將授權檔設為只讀路徑；5. 變更需審計。組件：簽章驗證器、檔案 ACL、完整性檢查、審計紀錄。如此即使工程師能調整設定，仍無法繞過簽章與檢查點。
- 難度: 中級
- 學習階段: 核心
- 關聯概念: A-Q7, B-Q4, D-Q6

Q9: 金鑰管理的設計要點與信任鏈？
- A簡: 私鑰嚴格保護與輪替；公鑰廣布驗證；全程可審計與版本控管。
- A詳: 原理：私鑰用於簽章，是信任根，需 HSM/密碼器或安全服務保護；公鑰供部署端驗證。流程：1. 生成金鑰對；2. 公鑰隨版本散佈；3. 私鑰在安全環境簽發；4. 定期輪替與撤銷；5. 版本相容與過渡期支援。組件：Key Vault/HSM、密鑰輪替流程、信任清單、審計。良好金鑰管理是安全強度關鍵。
- 難度: 高級
- 學習階段: 進階
- 關聯概念: A-Q15, C-Q8, D-Q7

Q10: 合約到期與更換授權的執行流程？
- A簡: 到期自動停用；續約核發新授權，安全更換並即時生效。
- A詳: 流程：1. 系統定期檢查到期日；2. 近到期提前告警；3. 到期停用標的功能與提示；4. 續約後原廠簽發新授權；5. 維運依流程更換並由檔案監聽熱載入；6. 審計紀錄變更。組件：到期檢查器、告警器、FileWatcher、原子替換與回滾、審計。確保使用不中斷與合約遵循。
- 難度: 中級
- 學習階段: 核心
- 關聯概念: A-Q14, C-Q7, D-Q4

Q11: 新授權項目上線的擴充流程與組件？
- A簡: 定義新claim、更新驗證器與特性標註，無痛擴展與版本共存。
- A詳: 流程：1. 在授權模型新增項；2. 授權中心支援簽發；3. 客戶端驗證器支援新欄位與預設行為（向後相容）；4. 以特性/策略在進入點檢查；5. 文件與 SDK 更新；6. A/B 測試與回滾。組件：LicenseModel、Validator、FeatureGate、策略提供者。確保開發者僅需關注業務新增點，沿用既有安全底座。
- 難度: 中級
- 學習階段: 核心
- 關聯概念: A-Q16, B-Q7, C-Q9

Q12: 在封閉網路下的威脅模型與風險評估？
- A簡: 內部工程師可見系統，威脅含檔案篡改、鑰洩漏、時鐘攻擊等。
- A詳: 威脅：能讀寫設定的工程師、SI；可嘗試修改授權檔、回滾時鐘、攔截金鑰、旁路檢查。緩解：簽章防篡改、只讀權限、時間來源與安全時鐘、最小暴露、金鑰分離保護、審計與告警。評估：以攻擊面分析與風險矩陣，並以演練檢證。封閉網路降低外部威脅，但提升內部對手能力評估的必要性。
- 難度: 高級
- 學習階段: 進階
- 關聯概念: A-Q15, D-Q9, D-Q10

---

### Q&A 類別 C: 實作應用類

Q1: 如何設計授權檔的資料結構？
- A簡: 採JSON含版本、客戶ID、功能清單、期限與簽章欄位，便於擴充。
- A詳: 具體步驟：1. 定義JSON schema：version、customerId、issuedAt、notBefore、notAfter、features（陣列/物件）、bindings（主機指紋）。2. 預留ext欄位便於擴充。3. 將資料序列化並簽章存放於signature欄。範例結構：
  {
    "version":1,"customerId":"ACME",
    "notBefore":"2025-01-01","notAfter":"2025-12-31",
    "features":{"report":true,"users":50},
    "bindings":{"machineId":"ABC123"},
    "signature":"<base64>"
  }
注意事項：避免把敏感密鑰放入；若需保密特定欄位，再做欄位層級加密；加入版本以支援未來演進；搭配檔案ACL限制寫入。
- 難度: 初級
- 學習階段: 基礎
- 關聯概念: B-Q3, C-Q2, C-Q3

Q2: 如何用RSA私鑰簽發授權檔（C#示例）？
- A簡: 對授權JSON做SHA256雜湊，使用RSA私鑰簽名並填入signature欄位。
- A詳: 步驟：1. 用 RSA 2048+ 生成金鑰對；2. 準備授權JSON（不含signature）；3. 計算SHA256；4. 使用RSACryptoServiceProvider/RSACng SignData；5. Base64輸出。示例：
  var data = Encoding.UTF8.GetBytes(licenseJsonWithoutSig);
  var sig = rsa.SignData(data, HashAlgorithmName.SHA256, RSASignaturePadding.Pkcs1);
  license.signature = Convert.ToBase64String(sig);
注意：私鑰僅在安全環境；簽名前確保序列化順序一致；保留版本與演算法欄位；簽發行為全程審計。
- 難度: 中級
- 學習階段: 核心
- 關聯概念: A-Q12, B-Q4, C-Q3

Q3: 如何在Service B啟動時離線驗證授權（C#示例）？
- A簡: 載入授權JSON，取出signature，用公鑰對原文驗證，檢查期限與綁定。
- A詳: 步驟：1. 讀檔並解析；2. 取出signature並暫置清空；3. 對剩餘JSON計算SHA256；4. 用公鑰VerifyData；5. 檢查notBefore/notAfter與machineId；6. 生成claims放入記憶體。示例：
  var data = Encoding.UTF8.GetBytes(licenseJsonWithoutSig);
  var ok = rsa.VerifyData(data, Convert.FromBase64String(sig),
           HashAlgorithmName.SHA256, RSASignaturePadding.Pkcs1);
  if(!ok) throw new SecurityException("Invalid license");
注意：處理時區與時鐘漂移；驗證失敗拒啟動或以最小模式運作；記錄審計不可含敏感內容。
- 難度: 中級
- 學習階段: 核心
- 關聯概念: B-Q1, B-Q4, D-Q1

Q4: 如何以授權驅動功能開關（C#屬性範例）？
- A簡: 將功能對應為claims，透過屬性/中介在進入點統一檢查並回饋。
- A詳: 步驟：1. 設計IFeatureGate接口；2. 啟動時把license.features載入為claims；3. 建立RequiresFeature屬性在Controller/Handler檢查。範例：
  if(!featureGate.Enabled("report"))
      return Forbid("License feature 'report' required");
注意：避免散落if判斷；UI亦依旗標隱顯；錯誤訊息友善且不洩漏內部細節；集中遙測判斷缺失熱點，改善DX。
- 難度: 中級
- 學習階段: 核心
- 關聯概念: B-Q7, D-Q2, A-Q10

Q5: 如何在Service A實作API KEY驗證（中介層示例）？
- A簡: 中介層取出KEY比對KeyStore，注入範圍，失敗回401/403並審計。
- A詳: 步驟：1. 於中介層讀取標頭X-API-Key；2. 查詢KeyStore（快取優先）；3. 驗證狀態/到期/來源限制；4. 將scopes注入HttpContext；5. 授權策略檢查端點需求。範例：
  var key = req.Headers["X-API-Key"];
  var rec = await keyStore.FindAsync(key);
  if(rec == null || rec.Revoked) return 401;
  context.Items["Scopes"] = rec.Scopes;
注意：速率限制與審計；KEY只以雜湊儲存；支援金鑰輪替（多把有效）；清楚錯誤回應碼。
- 難度: 中級
- 學習階段: 核心
- 關聯概念: B-Q2, D-Q3, D-Q7

Q6: 如何安全地載入授權檔（路徑與權限）？
- A簡: 放置於受控路徑、唯讀權限、環境變數指定，避免硬編碼與覆寫。
- A詳: 步驟：1. 使用環境變數或設定指向授權路徑；2. 設定檔案ACL僅允許服務帳戶讀取；3. 啟動時檢查權限與雜湊；4. 拒絕相對路徑與外部可寫目錄；5. 寫入審計更換紀錄。最佳實務：原子替換（寫暫檔→驗證→rename）、備份前版、監控異常變更速率；避免把檔案放在web root或容器映像內。
- 難度: 初級
- 學習階段: 基礎
- 關聯概念: B-Q8, C-Q7, D-Q5

Q7: 如何實作授權熱更新與輪替不中斷？
- A簡: 利用檔案監聽重載，新檔先驗證後原子替換，失敗即回滾。
- A詳: 步驟：1. 啟用FileSystemWatcher監控授權路徑；2. 監測到變更時讀取新檔；3. 驗證簽章與期限；4. 替換記憶體中的claims；5. 記錄審計。注意：去抖動、多事件合併；驗證失敗不覆蓋；維持舊版一段時間；暴露健康狀態供監控。此設計支援續約無中斷並降低維運負擔。
- 難度: 中級
- 學習階段: 核心
- 關聯概念: B-Q10, D-Q7, D-Q4

Q8: 私鑰與公鑰如何安全管理與散佈？
- A簡: 私鑰留在受保護端簽章；公鑰隨版本散佈驗證並支援輪替。
- A詳: 步驟：1. 私鑰放置於HSM/雲端Key Vault，授權服務透過受控API簽名；2. 公鑰內嵌於應用或配置於只讀路徑；3. 設計keyId與版本欄位，支援多把公鑰；4. 執行定期輪替與撤銷；5. 全程審計。最佳實務：禁止私鑰出現於源碼、容器或部署包；以最小權限原則管理存取；定期演練鑰遺失應變。
- 難度: 高級
- 學習階段: 進階
- 關聯概念: B-Q9, A-Q15, D-Q10

Q9: 如何抽象化授權提供者，支援多來源？
- A簡: 設計ILicenseProvider介面，實作檔案、API、KMS等來源可熱插拔。
- A詳: 步驟：1. 定義ILicenseProvider.Load()/Watch()；2. 基本實作FileLicenseProvider；3. 擴充HttpLicenseProvider（離線不適用時禁用）；4. 支援雲KMS簽章驗證；5. DI註冊與設定驅動選擇。注意：統一回傳LicenseModel，集中驗證器；保持回溯相容；良好錯誤與遙測。提升DX並為未來遷移/混合部署預留彈性。
- 難度: 中級
- 學習階段: 核心
- 關聯概念: A-Q16, B-Q11, C-Q7

Q10: 如何記錄授權與API授權的審計與日誌？
- A簡: 記錄驗證結果、使用端、範圍與異常，避免洩漏金鑰與敏感內容。
- A詳: 步驟：1. 為授權驗證建立審計事件（成功/失敗、原因、指紋、版本）；2. API KEY 異常回應統一事件碼；3. 建立安全日誌管道（集中、不可否認）；4. 設閾值告警（連續失敗、到期臨近）；5. 定期稽核報表。注意：切勿輸出完整授權檔或KEY；僅記錄雜湊與keyId；符合隱私規範。
- 難度: 中級
- 學習階段: 核心
- 關聯概念: B-Q2, D-Q1, D-Q3

---

### Q&A 類別 D: 問題解決類

Q1: 驗證授權失敗（Invalid signature）怎麼辦？
- A簡: 檢查公鑰版本、序列化一致性、檔案是否被改與時間欄位。
- A詳: 症狀：啟動或重載時拋出簽章無效，功能被停用。可能原因：公鑰不匹配（未隨版本更新）、授權被編輯或傳輸損壞、序列化順序差異、Base64破損、notBefore尚未生效。解法：比對keyId與公鑰版本；重新取授權；確保簽名時與驗證時序列化一致；校正時鐘；檢查傳輸/換行。預防：版本與金鑰發佈流程、原子替換、加驗雜湊。
- 難度: 中級
- 學習階段: 核心
- 關聯概念: C-Q3, B-Q4, C-Q10

Q2: 發現未授權功能被啟用，如何診斷？
- A簡: 檢查是否繞過統一檢查點、硬編碼開關或測試後門未移除。
- A詳: 症狀：未授權功能可被使用。原因：程式碼散落if判斷、未使用FeatureGate、開發測試後門、舊版快取未清或授權檔被替換。解法：全域搜尋入口點，強制使用屬性/中介層；移除硬編碼；清快取；審查授權檔與審計軌跡。預防：靜態檢查規則、程式碼審查清單、整合測試覆蓋授權情境。
- 難度: 中級
- 學習階段: 核心
- 關聯概念: B-Q7, C-Q4, C-Q10

Q3: 有效API KEY卻回403/401，如何排查？
- A簡: 核對傳遞位置、KeyStore狀態、範圍匹配與來源限制。
- A詳: 症狀：帶正確KEY仍被拒。原因：Header/Query位置錯、大小寫或空白、Key被撤銷或過期、scope不符端點需求、IP/Referer限制、時鐘漂移導致到期判斷錯誤。解法：開啟診斷日誌（不含敏感值）、比對KeyId與scope、檢查策略配置、驗證來源限制與時間。預防：一致化中介層、清楚錯誤碼與指引、定期KEY健康檢查。
- 難度: 初級
- 學習階段: 基礎
- 關聯概念: B-Q2, C-Q5, C-Q10

Q4: 授權到期後功能未停用的原因？
- A簡: 遺漏到期檢查、時間來源不準、快取未更新或容錯邏輯過寬。
- A詳: 症狀：到期仍可使用。原因：僅啟動時檢查、未定期驗證；系統時鐘落後；記憶體claims未刷新；熱更新失敗被忽略；誤把錯誤視為允許。解法：加入週期檢查器；校正NTP；監聽檔案變更並原子替換；調整錯誤處理為拒絕預設。預防：健康檢查曝露授權狀態；告警到期臨近；自動化測試涵蓋到期行為。
- 難度: 中級
- 學習階段: 核心
- 關聯概念: A-Q14, C-Q7, D-Q9

Q5: 封閉環境讀不到授權檔，怎麼處理？
- A簡: 檢查路徑與權限、環境變數設定、檔案完整性與容器掛載。
- A詳: 症狀：啟動找不到授權或IO例外。原因：路徑錯誤、容器未掛載卷、服務帳戶無讀權、檔案被安全軟體鎖定、編碼/格式錯誤。解法：用診斷輸出實際路徑；確認ACL；在容器宣告volume並唯讀掛載；驗證JSON與編碼；重試與退避策略。預防：部署檢查清單、啟動前自檢、基礎建設模板化配置。
- 難度: 初級
- 學習階段: 基礎
- 關聯概念: C-Q6, C-Q7, C-Q10

Q6: SI修改設定仍能開啟功能，如何防範？
- A簡: 將開關改為授權claims，強制經簽章驗證；設定僅影響外觀。
- A詳: 症狀：改設定可啟用付費功能。原因：把業務開關留在設定檔，未綁定授權。解法：將功能判斷改為FeatureGate，來源為受簽章的授權claims；UI/設定僅調整非授權層參數；移除後門。預防：架構規約與靜態分析禁用硬開關；審計設定變更；權限最小化與只讀掛載。
- 難度: 中級
- 學習階段: 核心
- 關聯概念: B-Q8, C-Q4, A-Q7

Q7: 金鑰輪替後驗證失敗，如何安全復原？
- A簡: 啟用金鑰並行期間，隨附新舊公鑰；逐步切換並監控回報。
- A詳: 症狀：更換公鑰後舊授權無法驗證。原因：未提供兼容的keyId與多公鑰支援、發佈次序錯誤。解法：採「先佈後換」：先更新客戶端以支援新keyId和公鑰，再用新私鑰簽發；提供並行期；監控失敗率；必要時回滾。預防：版本流程、金鑰治理文件、演練輪替。
- 難度: 高級
- 學習階段: 進階
- 關聯概念: B-Q9, C-Q8, C-Q7

Q8: 授權檢查造成效能問題怎麼優化？
- A簡: 啟動時驗證與快取claims，熱更新；避免每次I/O與重複驗簽。
- A詳: 症狀：請求延遲升高。原因：每請求讀檔、驗簽或重序列化。解法：1. 啟動或變更時一次性驗證；2. 以記憶體快取持有claims；3. 採讀寫鎖保護；4. 僅在檔案變更時重建；5. 最小化每請求成本（布林與整數比對）。預防：效能測試、遙測監控延遲、避免在熱路徑做昂貴加解密。
- 難度: 中級
- 學習階段: 核心
- 關聯概念: C-Q3, C-Q7, B-Q7

Q9: 時鐘漂移導致期限判斷錯誤如何處理？
- A簡: 使用可信時間來源、容忍小幅漂移、記錄與告警異常變化。
- A詳: 症狀：未到期被判過期或尚未生效。原因：NTP不同步、虛擬化遷移、手動調時。解法：同步可信NTP；以UTC計時；實作小容忍窗（如±5分鐘）；記錄時間跳變並告警；避免以系統時間作安全臆測。預防：時鐘健康檢查、封閉網段內部NTP、審計手動改時。
- 難度: 中級
- 學習階段: 核心
- 關聯概念: A-Q14, B-Q12, D-Q4

Q10: 公鑰外洩該怎麼辦？
- A簡: 公鑰可公開驗證；私鑰才是關鍵。確認無私鑰洩漏並滾動keyId。
- A詳: 症狀：公鑰被外界取得。影響：公鑰用於驗證，公開無妨；不影響簽發安全。行動：確認私鑰未洩漏；稽核存取；必要時更新公鑰版本與信任清單；加強發佈完整性。若是私鑰洩漏：立刻撤銷、停用舊keyId、重新簽發授權、快速佈署新公鑰、全面審計。預防：HSM/Key Vault、最小權限、分離簽發環境、定期演練。
- 難度: 高級
- 學習階段: 進階
- 關聯概念: C-Q8, B-Q9, D-Q7

---

### 學習路徑索引
- 初學者：建議先學習哪 15 題
    - A-Q1: 什麼是「授權碼」？
    - A-Q2: 什麼是 API KEY？
    - A-Q3: 授權碼與 API KEY 有何差異？
    - A-Q4: 為何 Install Based 佈署需要授權機制？
    - A-Q5: 什麼是離線授權（Offline Licensing）？
    - A-Q6: 什麼是 Service Administrator？在授權中扮演什麼角色？
    - A-Q7: 客戶 IT、系統整合商（SI）與原廠在授權中的關係？
    - A-Q8: 為何資安機制常不影響功能卻至關重要？
    - A-Q9: 什麼是 Developer Experience（DX）？
    - A-Q10: 為何 DX 對授權與 API 設計特別重要？
    - A-Q11: 什麼是對稱式加解密？
    - A-Q12: 什麼是非對稱式（公私鑰）加解密？
    - A-Q13: 加密與數位簽章差在哪裡？
    - B-Q4: 數位簽章在授權完整性保護的機制是什麼？
    - B-Q1: 離線授權驗證如何運作？

- 中級者：建議學習哪 20 題
    - A-Q14: 什麼是授權期限（License Term）與其強制性？
    - A-Q15: 什麼是「安全強度」？如何衡量？
    - A-Q16: 什麼是可擴充的授權架構？
    - A-Q17: 為何不應依賴隨時可連外的網路來授權？
    - A-Q18: Install Based 與雲端服務授權的主要差異？
    - B-Q2: Service A 的 API KEY 驗證流程為何？
    - B-Q3: 授權檔如何利用加密與簽章確保安全？
    - B-Q5: 對稱與非對稱在此架構的典型分工？
    - B-Q6: A/B/C 與授權的高層架構如何設計？
    - B-Q7: 如何設計以授權驅動的功能開關（Feature Toggle）？
    - B-Q8: 面對能改設定的工程師，如何強化防篡改？
    - B-Q10: 合約到期與更換授權的執行流程？
    - B-Q11: 新授權項目上線的擴充流程與組件？
    - C-Q1: 如何設計授權檔的資料結構？
    - C-Q3: 如何在Service B啟動時離線驗證授權（C#示例）？
    - C-Q4: 如何以授權驅動功能開關（C#屬性範例）？
    - C-Q5: 如何在Service A實作API KEY驗證（中介層示例）？
    - C-Q6: 如何安全地載入授權檔（路徑與權限）？
    - D-Q3: 有效API KEY卻回403/401，如何排查？
    - D-Q4: 授權到期後功能未停用的原因？

- 高級者：建議關注哪 15 題
    - A-Q15: 什麼是「安全強度」？如何衡量？
    - B-Q9: 金鑰管理的設計要點與信任鏈？
    - B-Q12: 在封閉網路下的威脅模型與風險評估？
    - C-Q2: 如何用RSA私鑰簽發授權檔（C#示例）？
    - C-Q7: 如何實作授權熱更新與輪替不中斷？
    - C-Q8: 私鑰與公鑰如何安全管理與散佈？
    - C-Q9: 如何抽象化授權提供者，支援多來源？
    - C-Q10: 如何記錄授權與API授權的審計與日誌？
    - D-Q1: 驗證授權失敗（Invalid signature）怎麼辦？
    - D-Q2: 發現未授權功能被啟用，如何診斷？
    - D-Q6: SI修改設定仍能開啟功能，如何防範？
    - D-Q7: 金鑰輪替後驗證失敗，如何安全復原？
    - D-Q8: 授權檢查造成效能問題怎麼優化？
    - D-Q9: 時鐘漂移導致期限判斷錯誤如何處理？
    - D-Q10: 公鑰外洩該怎麼辦？