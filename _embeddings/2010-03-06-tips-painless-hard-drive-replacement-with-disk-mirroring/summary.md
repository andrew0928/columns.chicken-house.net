# [Tips] 用 磁碟鏡像 無痛更換硬碟

## 摘要提示
- 升級動機: 將 RAID1 的兩顆 750GB 升級為 1.5TB，同時維持網站、資料庫與共享資料夾服務不中斷。
- 傳統方案缺點: 直接複製需長時間停機，使用 Clone 工具對 AF 硬碟有對齊與效能問題。
- 解法核心: 善用 Windows Server 動態磁碟的鏡像 (Mirror) 與 Extend Volume 無痛轉移與擴容。
- 不中斷服務: 除了加裝新碟需關機外，鏡像重同步與擴容期間服務皆可運作。
- 操作步驟: 新碟上機 → 建鏡像 → 等待 Resync → 中斷鏡像 → Extend Volume 擴大分割區。
- 適用情境: 同一台機器、同一資料夾/磁區搬遷與容量升級，且可使用動態磁碟。
- 效益亮點: 無需變更服務設定，減少人工作業與風險，流程簡單防呆。
- 系統相容性: 鏡像僅 Windows Server 支援；桌面版僅支援部分磁碟管理功能。
- 版本限制: Extend Volume 需 Windows Server 2008+；2003 僅有 Span，體驗較差。
- 取捨提醒: 動態磁碟在他系統或第三方工具的相容性較差，跨 OS 使用需評估。

## 全文重點
作者分享在 Windows Server 環境下，利用動態磁碟的鏡像功能與 Extend Volume 達成「幾乎不中斷服務」的硬碟升級方法。原環境為兩顆 750GB 的 RAID1，承載網站、資料庫與共享資料夾等服務。一般做法如直接複製檔案會需長時間停機，或以 True Image/Ghost 做 Disk Clone 也得停機，且遇到 Advanced Format 硬碟還有對齊與效能調校問題，麻煩且具風險。於是作者改以內建的 Mirror set 達成資料「在線」複製：先關機裝上新硬碟，開機後把舊碟分割區與新碟建立鏡像，等待系統自動 Resync 完成，期間各項服務持續運作；完成後中斷鏡像，使新碟獨立承載資料，再以 Extend Volume 將新碟未配置空間併入既有分割區，完成擴容。整體流程中，只有加裝硬碟需關機，其餘資料同步與擴容皆可在服務不中斷的狀態下完成，包含 SQL DB、IIS、甚至 pagefile 都可持續運作。

此法的優點是操作簡單、設定不需變更、風險小且時間可控；但也有幾點限制：其一，需使用動態磁碟，對於他系統（如 Linux）或部分第三方磁碟管理工具的相容性較差；其二，鏡像功能僅 Windows Server 支援，桌面版（2000 Pro/XP/Vista/Win7）無法完成相同流程；其三，Extend Volume 與良好體驗需 Windows Server 2008 以上版本，2003 雖可用 Span 合併容量，但邏輯呈現較不直觀。總結而言，若環境允許使用動態磁碟與 Windows Server 的鏡像/延伸功能，這是一條「無腦、防呆、低停機」的硬碟升級途徑；作者也邀請讀者分享更佳作法作為互補。

## 段落重點
### 動機與背景：RAID1 容量升級的無痛訴求
作者維運的 Server 以兩顆 750GB 組成 RAID1，承載網站、資料庫與分享資料夾等關鍵服務，欲升級至兩顆 1.5TB。考量到服務不中斷與設定不變更的需求，尋求能在最小停機時間內完成資料搬遷與擴容的方法。核心目標是降低人工作業、避免重建分享與調整各種服務設定，同時要維持系統在資料轉移過程中的穩定運作。

### 傳統方案評估：直接複製與 Disk Clone 的侷限
兩條常見路徑被評估後否決。其一是「硬上」：關機裝新碟、停服務、手動複製、重建分享與設定，停機時間長且繁瑣；其二是使用 True Image/Ghost 等 clone 工具：通常需停機，在 750GB 容量下耗時不短，且面對 Advanced Format 硬碟會碰上對齊與效能問題，後續還要校正。綜合成本、風險與服務可用性，這些方法不符合「懶且挑」的目標。

### 解法選擇：Windows Server 鏡像 + Extend Volume
基於 Windows Server 內建的動態磁碟鏡像特性，作者選擇先以鏡像把資料「在線」同步到新碟，再打破鏡像，最後以 Extend Volume 把剩餘空間併入現有分割區。此法的關鍵優勢是：除裝新碟需短暫關機，之後的資料同步與擴容可在服務持續運作下完成；而且應用程式與服務設定完全不需調整，對 DBA/網站服務來說極為友善。整體被形容為「無腦且防呆」。

### 實作流程：五步完成轉移與擴容
步驟概略如下：1) 確認原磁碟與分割區狀態；2) 關機裝上新硬碟，開機後可見新碟未配置空間；3) 將舊碟分割區與新碟建立鏡像，等待 Resync 完成，此時服務不中斷；4) 鏡像完成後中斷鏡像，讓新碟承載資料；5) 以 Extend Volume 將新碟的未配置空間併入既有分割區，完成擴大。整個過程除了上機步驟外，均可在系統對外服務狀態下進行，最大限度降低停機影響。

### 成果與優點：服務持續、設定零變更
此法的成效在於：D 槽全程可用，SQL 資料庫、IIS 網站、pagefile 在同步與擴容期間皆能正常運行；資料轉移不需另行規劃維護窗，對使用者感知最小；原有服務設定、共用、權限配置無須重建，避免人為操作錯誤；整體步驟以 GUI 完成，降低技術門檻。對需要在同一台機器上做容量升級且無法長時間停機的場景，性價比極高。

### 限制與風險：動態磁碟與版本相依
三個主要限制需預先評估：1) 動態磁碟相容性：跨 OS（如 Linux）或部分第三方磁碟管理工具可能不支援，未來異動路線需納入考量；2) 僅 Windows Server 支援鏡像：桌面版 Windows（2000/XP/Vista/Win7）無法採用同流程；3) 版本差異：Extend Volume 建議在 Windows Server 2008 以上使用；2003 雖可用 Span 併容量，但管理與呈現較不直觀。若環境不符，需另擬替代方案。

### 結語：小品分享與社群交流
作者以實務經驗示範一條低風險、低停機的硬碟升級法，核心在於善用系統內建功能達成「無痛」轉移與擴容。雖然受限於動態磁碟與版本相依，但在符合條件的 Windows Server 環境中相當實用。歡迎社群提供更佳或可補強相容性的替代作法，彼此交流。

## 資訊整理

### 知識架構圖
1. 前置知識：
   - 基本磁碟與分割區概念（Basic vs Dynamic Disk、Volume 與 Partition 差異）
   - RAID1/鏡像原理與 Windows 軟體鏡像（Mirror set）的運作
   - Windows Server 磁碟管理（Disk Management）、Extend Volume 的限制
   - 服務不中斷遷移的風險控管（備份、回復、服務相依）
   - Advanced Format（4K 扇區）與對齊/效能議題的基本概念

2. 核心概念：
   - 軟體鏡像（Mirror）做為「線上複製」機制：在服務不中斷下同步資料到新碟
   - 中斷鏡像（Break Mirror）與主動切換：在同步完成後把新碟獨立成可用磁碟
   - 延伸磁區（Extend Volume）：將新碟剩餘空間合併到既有卷以擴容
   - 動態磁碟（Dynamic Disk）需求：Windows 軟體鏡像的前提與相容性影響
   - 可用性與效能取捨：同步期間服務可用但 I/O 可能變慢

   關係：動態磁碟是建立鏡像的前提；建立鏡像達成線上資料複製；Resync 完成後可 Break Mirror；最後用 Extend Volume 擴容，整體達到「低中斷升級硬碟」。

3. 技術依賴：
   - Windows Server 版本能力：Mirror（軟體 RAID1）需 Windows Server；Extend Volume 完整體驗建議 2008+
   - Disk Management/磁碟管理工具或等價的 diskpart/PowerShell
   - 磁碟熱插拔/機器硬體條件（若無熱插拔，需短暫關機安裝硬碟）
   - Advanced Format 對齊與韌體/驅動支援（避免克隆後對齊錯誤）

4. 應用場景：
   - 擴充容量：用更大容量硬碟替換原碟並合併空間
   - 硬碟汰換或健康風險預防性更換：於不中斷狀況下轉移服務
   - 避免傳統 Clone 工具停機時間過長或 AF 對齊調整問題
   - 維持線上服務（IIS、SQL Server、檔案分享、Pagefile）連續性

### 學習路徑建議
1. 入門者路徑：
   - 了解 Basic/Dynamic Disk 與 RAID1 鏡像概念
   - 在虛擬機練習：新增第二顆虛擬磁碟、建立 Mirror、觀察 Resync、Break Mirror、Extend Volume
   - 學會使用 Disk Management 基本操作與查看事件記錄

2. 進階者路徑：
   - 使用 diskpart 或 PowerShell（Storage 模組）完成同樣流程並腳本化
   - 監控與調校：觀察 Resync/重建期間的 I/O 影響與服務效能
   - 理解 Advanced Format 對齊、叢集大小與對效能的影響；規劃對齊驗證
   - 熟悉不同 Windows 版本對 Mirror/Extend 的支援差異與限制

3. 實戰路徑：
   - 制定標準作業流程（SOP）：備份/驗證、停機點（僅裝碟）、鏡像建立與監控、Break、Extend、驗證
   - 設定維運監控：事件檢視、磁碟健康（SMART）、服務可用性檢查（IIS/SQL）
   - 風險控管：預備回復方案（保留舊碟、回退步驟）、維護視窗與溝通
   - 於測試環境彩排；在生產上執行並留存紀錄與度量（中斷時間、效能影響）

### 關鍵要點清單
- 用鏡像做線上遷移: 以 Windows Server 軟體鏡像把資料同步到新碟，過程中服務可持續運作（優先級: 高）
- 動態磁碟必要性: 建立軟體鏡像需將磁碟轉為 Dynamic，帶來跨系統相容性考量（優先級: 高）
- Break Mirror 時機: 在 Resync 完成後中斷鏡像，將新碟成為獨立卷繼續承載服務（優先級: 高）
- Extend Volume 擴容: 使用 Extend Volume 合併新碟剩餘空間，完成容量升級（優先級: 高）
- 停機只限裝碟: 實務上僅在實體安裝新硬碟時需短暫關機（無熱插拔時），其餘步驟可線上執行（優先級: 高）
- 效能影響與監控: 鏡像同步期間 I/O 壓力增加，需監控 SQL/IIS 等關鍵服務效能（優先級: 中）
- 版本與功能限制: Mirror 僅 Windows Server 支援，Extend Volume 在 2008+ 體驗較完整（優先級: 高）
- 相容性風險: Dynamic Disk 在部分 Linux/第三方工具下不相容，跨平台需事前驗證（優先級: 中）
- Advanced Format 注意: 4K AF 磁碟用傳統 Clone 可能有對齊與效能問題，鏡像法可降低風險（優先級: 中）
- 備份與回復計畫: 雖為低中斷流程，仍需完整備份與可驗證的回復方案（優先級: 高）
- 驗證與健康檢查: 完成後檢查卷一致性、服務狀態、事件記錄與 SMART 健康（優先級: 中）
- 工具替代與自動化: 以 diskpart/PowerShell 腳本化，提升可重複性與可追溯性（優先級: 中）
- Span vs Extend 差異: 舊版僅 Span 容量相加但分割視覺化不同，雖可用但可維運性較差（優先級: 低）
- RAID1 與軟體鏡像定位: 與硬體 RAID1 概念類似，但由 OS 管理，需考量主機負載（優先級: 中）
- 回退策略: 保留舊碟於鏡像/切換後的一段觀察期，確保可快速回復（優先級: 高）