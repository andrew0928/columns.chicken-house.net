# FlickrProxy #1 - Overview

## 摘要提示
- 開發動機: 因小型自架站頻寬有限、相片流量昂貴，催生以伺服端代理方式外掛至雲端的想法。
- 現有方案問題: 客戶端外掛在發文時就綁定圖片來源與帳號，缺乏後續調整與遷移彈性。
- 偏好伺服端解法: 以透明 Proxy 思維在伺服端動態處理資源搬移與導向，避免被特定服務或帳號綁死。
- 技術基礎: 以 ASP.NET HttpHandler 搭配 Flickr API，沿用作者先前開發理念與經驗。
- 運作流程: 讀取圖檔請求時檢查是否已上傳；未上傳則依規則決定直傳或上傳後改導至 Flickr。
- 與 WLW 外掛比較: 效能不如發文即處理，但換得更高的彈性與後續維運可控性。
- 資料主權: 保留站內完整檔案與內容，降低資料分散於多平台的備份與還原成本。
- POC 驗證: 以 Google News 頁面資源轉存與改寫為範例，證明技術路徑可行。
- 架構目標: 整合既有多個 HttpHandler，統一為可擴充的 provider 架構。
- 延伸藍圖: 照片轉 Flickr、影片嘗試轉 YouTube（含 RTSP 導向）、ZIP 虛擬成資料夾並評估轉 SkyDrive。

## 全文重點
作者從自架站的頻寬瓶頸與相片流量壓力出發，反思主流的客戶端外掛（如 Live Writer 的 Flickr 插件）雖能在發文階段一次完成上傳、連結與 HTML 片段產生，但也在同時鎖定了資源來源與帳號，導致後續難以批次遷移舊內容、替換服務或脫離特定寫作工具。為此，作者提出以伺服端為核心、透明運作的 Proxy 解法：在網站服務請求階段動態判斷圖檔是否需要與是否已上傳至 Flickr，若無需求則直接回應原圖；若符合策略則自動上傳並將瀏覽請求改導到 Flickr 的圖片網址。此作法雖在效能上不如發文即處理的外掛，但提供了更高的彈性與可逆性，尤其能讓網站保有完整的本地檔案與內容，降低資料分散各雲端服務後的備份與還原難度。

在技術上，作者延續過去以 ASP.NET HttpHandler 開發的經驗，計畫整合既有處理器並以 provider 模式統一擴充點，透過 Flickr API 落實圖片代理上傳與導向。作者也完成一個概念驗證（POC），在範例頁面中將所有圖片資源以相同機制轉存至另一目錄並改寫請求，證明流程可行。展望上，作者希望擴大到多媒體與壓縮檔：照片走 Flickr、影片嘗試轉接至 YouTube（目前已能從 HTTP 自動導到 RTSP）、ZIP 檔則以虛擬資料夾呈現並探索自動轉存至 Microsoft SkyDrive 等雲端。整體而言，FlickrProxy 的價值在於以伺服端、透明、可替換的架構，解耦內容與特定平台或工具，讓站長在效率與彈性間取得更符合長期維運的平衡。

## 段落重點
### 動手寫程式的起點：小型自架站的頻寬痛點
作者與朋友討論攝影內容上傳與展示的實務痛點，指出自架 ADSL 小站的瓶頸在於上傳頻寬有限。對於高圖量的部落格，單純把圖片放在自己的主機上會造成載入緩慢與頻寬壓力。雖然像 Live Writer 的 Flickr 插件等工具可把圖片傳到雲端以分擔頻寬，但這種「發文即綁定」的模型，會讓站長在後續維運上受限於當下的選擇，一旦帳號、服務或工具環境變動，早期內容便難以平滑遷移或統一調整。這促使作者開始思考一個在不干擾內容產製流程的前提下，仍可動態把流量導到外部服務、又保留站內資料主權的做法。

### 客戶端外掛的限制與伺服端透明 Proxy 的優勢
傳統外掛的流程是在作者端完成所有動作：上傳至 Flickr、取得連結、生成 HTML 片段、再貼回文章。問題在於這會把每張圖的來源、連結、帳號在貼文的瞬間固定，難以回頭替換。作者偏好的方案是伺服端處理、且越透明越好——例如以 Proxy 方式攔截圖片請求、依規則判斷是否需要上雲，並在不需改動文章原始碼的情況下完成上傳與導向。伺服端解法的核心價值在於「延後決策」與「集中控制」：不必在內容產製當下決定最終托管地，能根據流量、政策或成本在日後調整；同時，也不把作者鎖在某個服務或帳號上。缺點是效能開銷與實作複雜度高於客戶端外掛，但對重視可替換性與長期維運的站長而言，這筆成本是可以接受的。

### FlickrProxy 的運作構想、效能取捨與資料主權
FlickrProxy 的基本流程是：當用戶端請求一張圖片時，HttpHandler 先檢查這張圖是否已經在 Flickr 上有對應檔；若未上傳且策略判定不需要外移，則直接由站點回應原圖；若符合外移策略，則在當次請求中完成上傳，並把回應導向至 Flickr 圖片網址。如此一來，使用者在閱讀文章時，圖片來源可能會在首次請求後「無縫」改為外部服務。與 WLW + Flickr 插件相比，這種做法把工作推遲到瀏覽階段，犧牲了些許首次請求效能，但換來了高度彈性：可隨時關閉或更換供應商、替換帳號、或回退到本地服務。同時，站內仍保留完整檔案，避免內容散落在多個平台導致備份、還原與合規成本升高。

### 既有經驗、POC 驗證與未來擴充藍圖
作者過去已開發多個 ASP.NET HttpHandler，這次計畫將它們整合為統一的 provider 架構，以便針對不同媒體型別接入不同外部服務。作者也完成 POC，示範把 Google News 頁面的圖檔資源抓下並改寫路徑至另一目錄，證實攔截、轉存與導向流程可行。未來藍圖包含：照片自動轉 Flickr；影片嘗試轉接到 YouTube，目前階段能從 HTTP 自動導至 RTSP，顯示影音場景的技術難度更高；ZIP 壓縮檔先以虛擬資料夾方式呈現，再評估是否能自動轉存至 Microsoft SkyDrive 等雲端儲存服務。總結來說，FlickrProxy 的目標不僅是解決圖片頻寬問題，而是建立一套可延展至多媒體與檔案型別、以伺服端為核心的可替換與可觀察的資源代理框架，後續將持續分享實作細節與進展。

## 資訊整理

### 知識架構圖
1. 前置知識：
   - HTTP 基礎（Request/Response、Redirect、狀態碼）
   - ASP.NET Pipeline 與 HttpHandler
   - 第三方 API 使用（Flickr API 基礎、認證機制）
   - 網站部署與頻寬概念（自架站的瓶頸與資源外移）
   - 基本網路偵錯工具（如 Fiddler 抓封包）

2. 核心概念：
   - 服務端透明代理（Server-side Transparent Proxy）：在瀏覽時於伺服器端動態處理媒體導流
   - 執行期決策與重導（Runtime Decision & Redirect）：判斷檔案是否需上傳並以 3xx 轉向至外部服務
   - 解耦與可替換性（Decoupling）：不綁定特定外掛、帳號或單一雲端服務
   - Provider 架構：以統一介面整合不同媒體與外部服務（Flickr/YouTube/SkyDrive 等）
   - 彈性與效能的取捨：以彈性與可維運性換取部分效能

3. 技術依賴：
   - ASP.NET HttpHandler 依賴 .NET/ASP.NET Pipeline
   - Flickr API/YouTube API/SkyDrive API 依賴各自的認證與上傳端點
   - 重新導向依賴 HTTP 3xx 與正確的資源 URL 映射
   - Provider 介面依賴抽象化設計（介面/依賴注入）以支援替換
   - 網路偵錯與記錄依賴日誌與抓包工具（Fiddler）

4. 應用場景：
   - 自架 ADSL/頻寬受限的小型網站將媒體流量外移
   - 舊有文章不需重編輯即可逐步導流至外部圖床/影音平台
   - 快速更換外部媒體服務供應商（帳號或平台切換）
   - 需要保留完整本地檔案以利備份/還原的網站
   - 異質媒體的統一代理（圖片→Flickr、影片→YouTube、檔案→雲端儲存）

### 學習路徑建議
1. 入門者路徑：
   - 學會 HTTP 基礎與 3xx Redirect 概念
   - 了解 ASP.NET HttpHandler 的建立與註冊
   - 熟悉 Flickr API 的基本呼叫與認證流程
   - 以簡單圖片代理範例實作並用 Fiddler 驗證請求流程

2. 進階者路徑：
   - 設計 Provider 介面，將圖片、影片、檔案處理模組化
   - 實作上傳判斷邏輯（快取/標記/檔名映射）與失敗回退機制
   - 加入設定化（關閉/切換服務、金鑰管理）與日誌監控
   - 最佳化效能（快取頭、條件式請求、非同步上傳）

3. 實戰路徑：
   - 建立 FlickrProvider 實作：本地檔 → 檢查 → 上傳 → 取得外鏈 → 301/302
   - 將既有網站圖片路徑導入代理端點，灰度上線並觀測流量
   - 擴充 VideoProvider（YouTube）與 FileProvider（SkyDrive/OneDrive）
   - 以自動化測試與壓測驗證效能、可靠度與回退策略

### 關鍵要點清單
- Server-side Proxy 思維：在伺服器端透明處理媒體外移，減少對用戶端工具依賴（優先級: 高）
- 執行期動態決策：於瀏覽時判斷是否上傳並決定回應策略（優先級: 高）
- HTTP Redirect 正確使用：用 301/302 將請求導至外部媒體 URL（優先級: 高）
- ASP.NET HttpHandler：作為請求攔截與回應的核心擴充點（優先級: 高）
- Flickr API 整合：實作上傳、取得外鏈與錯誤處理（優先級: 高）
- Provider 架構設計：用介面抽象外部服務，支援可插拔與替換（優先級: 高）
- 本地與雲端雙保存：保留完整本地檔案以利備份與還原（優先級: 中）
- 與 WLW 外掛的取捨：放棄發文時一次到位，換取更高的彈性（優先級: 中）
- 效能與快取策略：非同步處理、快取控制、減少重複上傳（優先級: 中）
- 身分與金鑰管理：安全儲存 API Key/Token，支援多帳號切換（優先級: 高）
- 錯誤回退與降級：上傳失敗時能改為本地回傳或延遲重試（優先級: 高）
- 媒體類型擴充：圖片→Flickr、影片→YouTube、檔案→SkyDrive（優先級: 中）
- 路徑與映射規則：本地檔名與外部資源 URL 的一致性與可追蹤性（優先級: 中）
- 監控與追蹤：以日誌與 Fiddler 分析請求流程與故障（優先級: 中）
- 部署與灰度：逐步導入代理端點，觀察影響後再全面切換（優先級: 低）