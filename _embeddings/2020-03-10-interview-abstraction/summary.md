# 架構面試題 #4 ─ 抽象化設計：折扣規則的設計機制

## 摘要提示
- 抽象化思考: 隱藏細節、提取重點，靠介面統一行為是架構師必備能力。  
- 折扣痛點: 超商 DM 規則五花八門，傳統歸納法難以面對未知需求。  
- 購物車核心: 結帳流程只在乎最終折抵金額，計算細節應被隔離。  
- RuleBase 介面: Process(CartContext)→Discount[]，以多型封裝各式折扣。  
- Tags 設計: 給商品貼標籤即可描述「指定商品」「配對商品」等條件。  
- POS 結帳: 依序執行 Rules，累計折抵，主流程零改動即可擴充新規則。  
- 進階排除: ExclusiveTag 與商品狀態標記，處理折扣互斥與疊加。  
- OOP 三權杖: 封裝+繼承+多型支撐抽象化，亦映射微服務介面切割。  
- 實戰示例: 依序加入買 N 折、滿額折、加價購、配對套餐等規則皆成功。  
- PR 回饋: 多種實作展示標準化與彈性取捨，驗證抽象化設計的可行性。

## 全文重點
作者以「折扣機制」為例說明抽象化思考的重要。先列出各種讓開發者頭痛的超市、便利商店折扣：買 X 件省 Y 元、第二件五折、買一送一、鮮食＋飲料套餐等，指出若只用歸納法與旗標設定，面對日後新花樣維護成本極高。  
解法是先界定購物車真正關心的事：「哪些商品觸發了哪些折扣？總共抵多少？」將計算細節抽離到統一的 RuleBase 介面；每種折扣繼承此抽象類別，只需實作 Process 並回傳 Discount 清單。POS 結帳時按順序執行 Rules，收集所有 Discount，再用「原價總和－折抵總和」得到付款金額，因而不論新折扣如何變化都無須動到主程式。  
為了描述「指定商品」與「商品組合」，商品類別加上 Tags；Rule 只要以標籤篩選即可。不重複的標籤讓開發者免於修改結構即能支持新條件。文中示範買六串衛生紙折 100、雞湯塊第二件半價、同商品加 10 元多一件、任兩箱 88 折等多種規則，並證明新增類別＋加入 Rules 清單即可立即生效。  
進階再處理「配對套餐」與「折扣互斥」。前者透過雙標籤與組合價表實作；後者在 Rule 增加 ExclusiveTag，結帳時若商品已被標記為獨佔折扣便跳過後續計算，或用 AbandonDiscount/IsDiscounted 等旗標達成。  
文章最後收錄讀者 PR，多數維持介面不變就解決問題，也展示 proxy、優先權、旗標枚舉等不同取捨。作者總結：抽象化＋OOP 能顯著降低系統複雜度，讓文件、測試與維護同步簡化，是從程式技巧邁向架構視野的關鍵。

## 段落重點
### 問題: 折扣機制到底有多難搞?
作者羅列超市與便利商店折扣 DM，顯示規則多變又彼此細微不同，若以 if/else 或旗標硬寫易失控，並點出會員價、點數抵扣等更棘手的延伸需求。

### 抽象化: 隱藏細節、提取重點
引述運算思維定義，強調抽象化目的在於讓主系統僅依重點運作、細節可替換；界線即為 interface，設計良好介面後工程問題便迎刃而解。

### OOP 三大權杖: 封裝、繼承、多型
回顧 OOP 核心，封裝用來隱藏細節以實現抽象化；繼承抽取共通行為；多型讓不同實例以一致方式被呼叫，三者合力支撐靈活架構。

### 思考: 將折扣機制抽象化
確立購物車只需「原價、折扣列表、最終金額」三步驟；決定用 RuleBase.Process 取得 Discount 集合，主流程不再碰觸任何計算細節。

### 案例實作: 模擬實際的訂單計算
從零開始建 Product、Discount、CartContext、POS 與 RuleBase，先實作任兩箱 88 折，證明新增一個類別即可運作；之後加滿千折百仍無須改動主程式。

### 大亂鬥 - 挑戰更多折扣規則
示範同時啟用六種折扣並加入標籤系統處理指定商品與價格排序，使複雜購物清單順利算出 1929.5 元，展現架構可擴充性。

### 進階挑戰 - 配對折扣 & 折扣排除
以套餐價與互斥折扣為例，透過 Combo 規則資料表及 ExclusiveTag/IsDiscounted 標記解決，同時討論標準化與彈性的平衡。

### 解決方案: 來自讀者朋友的 PR
分析多位讀者代碼：有人用 SpecialOffer、Queue 及 flags，有人以 Proxy 組合 Rule，有人加入 Priority 排序；比較不同方法優缺點與取捨。

### 總結: 寫在最後
作者重申抽象化是撰寫與重構的共同核心，良好介面讓複雜需求簡化為可維護的程式；OOP 精神仍是微服務與介面設計的基石，呼籲工程師在技巧之外更要培養架構視野。