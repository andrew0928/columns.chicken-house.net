# 該如何學好「寫程式」 #5：善用 TRACE / ASSERT

## 摘要提示
- TRACE: 利用與一般輸出分離的除錯訊息通道，在需要時統一開關以觀察程式行為。  
- ASSERT: 透過布林斷言於執行期強迫驗證假設，偵測非預期狀況並中斷程式。  
- DEBUG/RELEASE 雙版本: 以同一份程式碼編譯出兩種版本，開發期啟用 TRACE/ASSERT，發布版關閉。  
- 參數驗證: 先檢查輸入是否符合 API 合約，錯誤即以 ASSERT 揪出開發 BUG 而非丟給使用者。  
- 傳回值保護: 在函式結尾以 ASSERT 確認結果落於合法範圍，避免邏輯逸出。  
- 驗算技巧: 以「安全但慢」與「最佳化但複雜」兩套算法對照運算，任何差異即提示潛藏錯誤。  
- 單元測試關聯: ASSERT 的精神延伸為自動化測試框架，將被動偵錯升級為主動覆蓋。  
- 思維轉換: 把 TRACE/ASSERT 當作「煞車」而非累贅，提高對程式正確性的信心並加速開發。  

## 全文重點
作者以《Writing Solid Code》中強調的「同一份程式碼同時維護 DEBUG 與 RELEASE 版本」為起點，說明 TRACE 與 ASSERT 在日常開發中的核心價值。TRACE 專司輸出除錯訊息，ASSERT 則用於在執行期主動驗證開發者的假設；一旦條件為假即立刻令程式進入除錯器或中止，以最小代價顯露 BUG。本篇以計算測驗成績的 C# 範例示範：先以 ASSERT 確認兩個傳入 XmlElement 不為 null 且子節點數量相同，再在迴圈完畢後檢查 totalScore 必須介於 0 與滿分之間。凡與契約不符即屬「程式錯誤」，必須在開發階段立即修正，而非於執行期彈出訊息干擾使用者。  
接著作者區分「BUG」與「執行期錯誤」：使用者輸入錯資料屬正常情境，應撰寫例外處理流程；違反 API 合約則屬 BUG，應交由 ASSERT 捕捉。此策略要求針對不同受眾 (開發者 / 使用者) 提供不同回應，亦因此需在發佈時關閉所有 ASSERT。  
為處理複雜效能最佳化帶來的不確定性，作者推崇「驗算」：在 DEBUG 模式下同時以簡單安全與高速複雜兩種算法運算並比較結果，差異立刻透過 ASSERT 報警。此手法與單元測試精神相通，後者更將 ASSERT 系統化為可重複執行的測試案例。作者以「汽車裝煞車才能開得更快」譬喻 ASSERT 與 UNIT TEST 的價值：它們看似拖慢速度，實則提高開發信心，使程式能在可靠基礎上衝刺。  
文章最後提醒，寫出穩定程式的首要關鍵是態度──隨時思考如何減少 BUG，並善用工具迫使問題現形。唯有踏出「可靠」這一步，才有餘裕追求「漂亮」的程式結構，為後續探討的主題埋下伏筆。  

## 段落重點
### 引言與 TRACE / ASSERT 回顧  
作者承接前一篇，先重述 TRACE 與 ASSERT 的歷史與用途：前者將除錯訊息獨立輸出以便集中管理；後者於執行期驗證布林條件，違反即中斷程式。引用《Writing Solid Code》核心觀念——透過維護 DEBUG/RELEASE 雙版本，讓錯誤「自動浮現」而非隱沒。強調開發者需主動減少 BUG，而 TRACE/ASSERT 是最基本也最有效的手段。  

### ASSERT 案例：計分函式示範  
以多選題計算成績的範例說明如何在程式入口與出口放置 ASSERT。入口處確認 XmlElement 不為 null 且子節點數量對稱；流程中逐項比對答案並累計得分；出口處保證 totalScore 落於 0 至題目滿分的區間。這些斷言相當於「宣告」函式合約，任何違反即視為開發 BUG。透過 ASSERT，問題能在第一時間於除錯器中被攔截，避免錯誤持續擴散。  

### 分辨 BUG 與執行期錯誤、切換 DEBUG / RELEASE  
作者提醒勿把 ASSERT 當成例外處理：使用者輸入錯誤屬執行期情境，應以正常流程回報；ASSERT 只抓開發者違反契約的錯誤。為避免 ASSERT 打斷正式環境，需透過編譯條件在 RELEASE 版本關閉所有 TRACE/ASSERT。當用戶回報難以重現的問題時，再發 DEBUG 版重新打開眼線，BUG 便能快速定位。  

### 驗算與單元測試哲學  
為避免高效能但複雜的演算法產生隱性錯誤，作者示範「驗算」技巧：在 DEBUG 模式下讓「安全但慢」與「最佳化但快」兩套演算法同時計算並以 ASSERT 比對；一旦結果不符即代表至少有一邊出錯。此概念延伸至單元測試框架，將散落程式中的 ASSERT 提煉為獨立測試案例並自動化執行。作者引用 Kent 的「煞車讓車開更快」來解釋：測試與 ASSERT 並非阻力，而是速度的保證。  

### 結語與後續展望  
經由 TRACE/ASSERT 的案例，作者總結：穩定程式源於開發者的心態與習慣，唯有時刻思考錯誤處理、積極布建斷言，方能讓 BUG 無所遁形。當可靠性獲得保障，下一步才是追求程式架構的「美感」。文章預告後續將探討如何擬定程式結構與分析問題，以寫出既穩又漂亮的程式碼，邀讀者拭目以待。