# Canon G9 害我沒睡好... 相片自動轉正的問題

## 摘要提示
- 自動轉正落差: 相簿中直拍照片有的能自動旋轉 90 度、有的卻無法，造成觀看不便。  
- 相機偵測原理: Canon 近年機種透過水銀開關或類似感測器，把機身朝向寫入 EXIF 的 Orientation 欄位。  
- 機種差異: G9 拍攝的檔案「有機會」正確，家中 IXUS55 幾乎都不轉，顯示韌體與硬體偵測差異。  
- 程式懷疑: 作者自寫 WPF 縮圖程式只針對 RAW Codec 已轉正的影像，對 JPG 未額外處理導致錯誤。  
- EXIF 追查: 讀取 /ifd/{ushort=274} 或 /app1/{ushort=0}/{ushort=274} 得到 0x01、0x06、0x08 等值判定方向。  
- 180 度盲區: Canon 僅對左、右 90 度提供資訊，180 度旋轉完全未標示。  
- 真實需求: 自拍、兒童亂拍等場景常會把相機倒置，缺乏 180 度偵測影響觀感。  
- 解決方法: 於程式端讀取 Orientation 標籤並額外對 JPG 套用 RotateTransform，手動補足缺失。  
- WPF 實作: 透過 TransformGroup 同步完成縮放及旋轉，再以 JpegBitmapEncoder 輸出。  
- 心得: 花掉半夜時間驗證，證實並非程式錯而是相機偵測機制有限，工程師精神驅動問題終結。  

## 全文重點
作者在整理 Canon G9 與家人 IXUS55 拍攝的照片時，發現部份直式影像能在電腦自動旋轉 90 度呈現，另一部份卻保持橫向必須歪頭觀看。直覺認為 Canon 具備方向感測器，應於 EXIF 寫入 Orientation 標記，因此展開排查。首先用 WPF 自寫的縮圖程式檢視，RAW 檔經 Canon RAW Codec 解碼後可正常轉正，而兩台相機直接輸出的 JPG 仍錯位。  
作者以除錯器讀取 EXIF，分別用 /ifd/{ushort=274} 與 /app1/{ushort=0}/{ushort=274} 取值，拍攝四種方向得到 0x01、0x08、0x01、0x06；查文件得知 6 與 8 對應右轉 90 與左轉 90，1 表示無旋轉，但 180 度理應為 3，卻持續得到 1。實際再到相機回播並按 DISPLAY 查資訊，發現倒置的照片相機本身也沒偵測到方向。  
結論是 Canon 僅偵測 90 度左右旋，而 180 度倒拍完全不處理，造成程式讀值後無法得知需旋轉 180。雖然一般拍照少用倒置，但自拍按鍵、孩童持機等場合仍會出現。作者最終在程式碼加入 Orientation 判斷：值為 6、8、3 時分別對應 90、270、180，再以 TransformGroup 疊加 ScaleTransform 與 RotateTransform，一次完成縮放與旋轉並輸出 JPEG，成功補救缺陷。過程耗去數小時，但也驗證了問題根源與 .NET 圖像處理技巧。  

## 段落重點
### 問題起因與現象
作者瀏覽相簿時發現同樣直拍的照片有的自動轉正、有的仍橫放，必須歪頭觀看。檢視 G9 與 IXUS55 拍攝影像，部分可正確旋轉（左轉或右轉 90°），部分則失敗，疑惑相機方向偵測是否不一致。此狀況在相機螢幕回播時似乎正常，進入電腦後才暴露問題，引發深入追查動機。

### 相機偵測機制與機種差異
Canon 相機從 G2 之後理應內建方向感測器，將機身姿態寫入 EXIF Orientation。理論上任何支援 EXIF 的軟體皆可參考該欄位完成自動旋轉。然而實測顯示 G9 拍攝資料「有機會」正確轉向，家用 IXUS55 幾乎完全失效；說明不同系列在硬體偵測靈敏度或韌體處理上存在差異。

### 先懷疑自寫縮圖程式
作者所有照片皆以自製 WPF 程式批量縮圖入庫，懷疑工具未正確解析 Orientation。檢測後發現 RAW 檔 (.CR2) 經 Canon RAW Codec 轉譯已被自動旋轉，JPEG 直出則維持原始方向，暗示程式端確實少做一步。因而決定用 Debugger 直接讀 EXIF 資料進行驗證。

### EXIF Orientation 讀值實驗
作者拍攝四種方向的樣張，於程式中分別以 /ifd/{ushort=274}（CR2）與 /app1/{ushort=0}/{ushort=274}（JPG）取值。得到 0x01、0x08、0x01、0x06；其中 6 表右轉 90°、8 表左轉 90°皆合理，1 為「無旋轉」。理論上倒置應取得 3（Rotate180），但結果仍為 1，顯示相機沒標示 180 度；RAW Codec 之所以可轉正，是在解碼過程自動補旋憑藉內部邏輯，而 JPEG 要靠外部程式補救。

### 180 度盲區與真實場景
為進一步確認，作者直接在相機回播時連按 DISPLAY 檢查資訊，發現倒置照片亦未被相機識別旋轉。推論 Canon 僅偵測左右 90°，對上下倒置完全忽略。此限制在一般拍攝較不顯眼，但右手自拍按不到快門或孩子亂拍時相機常被倒拿，導致實際需求仍然存在。

### 程式修補與心得
確定根因後，作者於 WPF 程式加入 Orientation 解析：6→Rotate90、8→Rotate270、3→Rotate180；並透過 TransformGroup 同步加入 ScaleTransform 及 RotateTransform，再以 JpegBitmapEncoder 輸出。此步驟讓 JPEG 檔也能自動正向顯示，補足 Canon 在 180 度偵測上的缺陷。雖耗費半夜時間，但過程驗證了 EXIF 分析實務與 .NET 圖像處理技巧，亦提醒開發者不能完全依賴相機端的方向標記。