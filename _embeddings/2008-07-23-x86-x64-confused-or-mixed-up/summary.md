# x86? x64? 傻傻分不清楚…

## 摘要提示
- 平台轉移經驗談: 作者敘述自己從 32 位元跨到 64 位元時踩到的雷與心得。
- WOW64 相容機制: 介紹 64 位元 Windows 以 WOW64 在 User Mode 提供 32 位元相容層的原理與限制。
- COM 元件困境: 若 COM 僅提供單一位元版本，會導致 .NET 或 Script 程式必須「選邊站」。
- System 目錄分家: 64 位元系統會出現 Program Files 與 System32/SysWOW64 等雙目錄現象。
- ANY CPU 的陷阱: .NET 編譯為 AnyCPU 雖能自動對應，但碰到非托管或 COM 相依就可能在執行期出錯。
- 第三方驅動缺席: Canon RAW Codec、JET/ODBC 等皆未推出 64 位元版，造成應用受限。
- 工具雙版本安裝: Media Encoder 需分別安裝 x86 / x64，否則腳本呼叫會找不到元件。
- In-Process 限制: 同一個 Process 不能同時載入 x86 與 x64 模組，跨位元呼叫勢必要改架構。
- 拆分執行檔: 最後解決方式是把功能切成多支 EXE，各自以合適位元版本執行並併行運算。
- 經驗總結: 32→64 轉移不只重編譯，還得檢查所有相依項與部署細節，否則踩雷連連。

## 全文重點
本文為作者在工作與興趣中，從 x86 轉向 x64 環境時的親身筆記與碎念。雖然 .NET 的 AnyCPU 讓大部分託管程式碼可無痛跨平台，但只要專案牽涉 COM、原生驅動或腳本，就會遇到位元版本不一致的麻煩。作者回顧 16→32 位元與 32→64 位元兩次演進差異，說明 64 位元 Windows 透過 WOW64 在使用者模式提供 32 位元相容層，但同一個 Process 仍只能有單一位元的模組。系統目錄與 Registry 也因此分家，Program Files 與 System32 皆各有 x86 對應版本，若安裝或呼叫錯誤，就會發生「找不到元件」的執行期錯誤。

文中舉出的實際案例包括：1) ASP/VB 專案因 JET、ODBC 缺乏 64 位元版被迫回到 32 位元模式；2) .NET 包裝的 CDO SMTP 在 64 位元環境執行期才拋錯；3) 使用 Canon RAW Codec 的 WPF Image 處理器只能在 32 位元下工作；4) Media Encoder 9 必須分別安裝 x86 與 x64，否則 Script 呼叫 CSCRIPT + WMEnc.vbs 時會遺失元件。作者最終的解法是將原本緊耦合的功能拆成多個獨立 EXE，讓需要 Canon Codec 的模組維持 x86，其餘運算量大的工作則改用 x64，藉此在四核心 CPU 上吃滿 80% 運算力。文章最後感嘆：平台轉移看似簡單，實際上關卡重重，唯有徹底盤點相依元件、掌握系統目錄與 Process 邊界，才能避免在 x64 世界裡「傻傻分不清楚」。

## 段落重點
### 16 位元到 32 位元 v.s. 32 位元到 64 位元
作者先回憶 DOS 與 Windows 3.1 時代的 16 位元程式，只是寫寫俄羅斯方塊、貪吃蛇等玩具，並未面臨大規模遷移。真正需要轉移的是後來從 32 位元 Windows NT 家族跨向 64 位元。16→32 主要靠 v86 mode 與 wowexec 在單一 Process 裝載 16 位元程式；而 32→64 則由 WOW64 在 User Mode 提供相容層，但強制「同一個 Process 只能有單一位元」的規則，這為 COM 與 in-process 元件帶來限制。同時，系統檔案與 Registry 被虛擬成兩套，Program Files 與 System32 皆分別對應 x86/x64 版本，為安裝與開發帶來新的部署挑戰。

### x64 + WOW
說明 WOW64 的運作方式：當 32 位元程式在 64 位元系統啟動時，系統會轉入 SysWOW64 目錄並載入對應的 32 位元 DLL，確保 API 呼叫能被重導向。這對純原生程式通常無感，但若使用 COM 或需和 64 位元 DLL 互動，就會因「Process 位元數不可混用」而爆炸。作者舉例 CDO SMTP 元件只有 32 位元 DLL，AnyCPU 編譯的 .NET 程式在 64 位元 CLR 下執行時，直到 Runtime 透過 COM 啟動 CDO 才噴錯；還有 Canon RAW Codec 僅有 x86 版本，導致整個 WPF 影像流程被迫回退 32 位元。這些經驗提醒開發者：只要專案碰到 COM、Driver、Codec，就不能單憑 AnyCPU 便自信跨平台。

### 同時使用 x86 only COM / x64 only COM
此段描述作者處理 Media Encoder 與影像轉檔工作流時的撞牆史。家人常拍 AVI，需要腳本呼叫 Media Encoder 轉檔；但 Media Encoder 9 在 64 位元系統裡並未自動安裝雙版本，必須手動各裝一套。即使裝妥，x86 程式仍無法啟動 x64 COM 來處理工作，反之亦然。作者嘗試讓 32 位元 CSCRIPT 結合 WMEnc.vbs 呼叫 64 位元 COM，結果卡在 100% 進度條無法結束。最後妥協的策略是把原先單一流程拆分成多支 EXE：需要 Canon Codec 的步驟保持 x86，其餘計算密集且不依賴特定 Codec 的步驟改寫成 x64。透過多 Process 并行，既解決了位元衝突，也充分利用四核心 CPU。在這場 x86/x64 大亂鬥後，作者體悟到：面對混合位元的既有生態，重構流程與部署往往比重編譯更實際。