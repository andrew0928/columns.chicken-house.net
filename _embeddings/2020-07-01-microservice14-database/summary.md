# 微服務架構設計 - 資料庫的選擇, RDBMS or NOSQL?

## 摘要提示
- 架構思維優先: RDBMS 與 NoSQL 不該用二選一比較，應先釐清商業問題與整體解法，再決定技術組合。
- 技術本質差異: RDBMS 抽象化「表格資料＋索引/查詢」，NoSQL 抽象化「物件/文件狀態＋K/V 操作」。
- 水平擴展挑戰: 微服務強調水平擴展，RDBMS 在擴展與分散式交易上有先天限制。
- 一致性與交易: 雲端與微服務下交易跨服務/資料庫，需以 Saga、2PC、事件驅動等思路處理一致性。
- 整合而非替換: 面對互斥需求時，善用 RDBMS＋NoSQL 的優勢互補，而非單邊押注。
- 資料治理升級: 微服務導入後，開發門檻下降，資料治理（一致性、封存、快照、快取）成為新門檻。
- API 優先於查詢: 切割資料庫的前提是將「查詢語言」降級為「API 設計」，限制查詢自由度以換取邊界清晰。
- OOP 對應資料: 將物件的介面對應 API、狀態對應資料庫，提升資料/服務對齊能力。
- NoSQL 適用性: 適合高併發 K/V、不可變或多版本資料、巨大封存量、讀多寫少之情境。
- 能力前置條件: 採用 NoSQL 需具備資料結構選型、事件/CQRS、反正規化、報表管道與快取一致性治理能力。

## 全文重點
文章核心觀點是：在微服務架構下，選擇 RDBMS 或 NoSQL 不是二元取捨，而是建立在問題釐清與架構設計上的技術組合。當雲原生、容器與平台成熟後，真正的門檻從開發轉向資料治理：一致性、交易、封存、版本/快照與快取準確性等。作者強調，技術選型需先理解資料本質與系統邊界，再評估交易模式、查詢型態與擴展需求，最後才在同類產品中比較功能與成本。

RDBMS 的本質是將表格資料與索引查詢抽象化到極致，透過正規化、索引與 SQL 取得高彈性的查詢能力與交易處理；但在水平擴展與跨服務的分散式交易上受到限制。NoSQL 的本質則是以物件/文件為中心，弱化 schema 約束、原生支援 K/V 高速操作與分片，易於水平擴展與對應 OOP 的狀態管理，但在複雜查詢、交易與一致性上需要以架構手段補齊。

作者主張「整合」而非「替換」：就像 SSD 與 HDD 的組合以系統設計換取整體效能/成本平衡，RDBMS 與 NoSQL 也可在同一解決方案中互補。例如以 RDBMS 承擔複雜查詢與強一致交易，以 NoSQL 承擔高併發鍵值存取、不可變資料、事件流與快照；再以事件驅動、CQRS、Saga、快取策略等將資料在不同儲存中協調同步。

微服務切割的關鍵，是將「查詢語言」降級為「API」；透過明確的服務邊界、有限且精準的資料結構操作（需要對資料結構與演算法有把握），避免跨服務 join 的需求。查詢需求應拆離 CRUD，以讀模型、報表資料管道（如 BigQuery 類型）滿足，背後以事件或 ETL 餵數據；寫入則遵循以狀態機為主的 API 設計，非單純 CRUD。

文章最後指出，雲端與微服務場景特別容易採用 NoSQL，因為一旦資料散布在多個服務，各自獨立資料庫、以 API 存取且無法 join，RDBMS 的優勢（跨表查詢、單庫交易）被弱化；此時 NoSQL 的擴展、K/V 效能與文件導向更貼切。但要採用 NoSQL，團隊需補齊事件/CQRS、反正規化、報表管道、分散式交易與快取一致性等能力，否則只會放大各技術缺點而非優勢。

## 段落重點
### 前言: 我用什麼樣的經歷來談這議題?
作者以自身從電機到資工、深入 OOP 與 DBMS 理論，歷經 XML Database/OODBMS 類型實作、企業系統轉型雲端電商、角色由 CTO 轉架構師、長期寫作與分享的背景，說明其在資料庫選型與架構議題上的觀點來源。強調架構能力來自跨領域平衡（商業/開發/基礎設施）與持續打底的基礎知識（作業系統、資料結構、演算法、分散式系統、交易理論、OOP 抽象）。過往同時面對 RDBMS 與 XML DB 的「共存設計」經驗，迫使他界定兩者邊界與適用性，這種「整合視角」正是本文要傳達的核心。作者也點出：工具門檻降低後，真正的難題浮現為資料治理與分散式一致性，這需要經驗與理論並重。最終目標是讓讀者理解：選型是結果，前提是問題定義、服務邊界、交易策略與資料形態的辨識。

### RDBMS / NoSQL 的技術特色
RDBMS 被視為將表格資料與索引/查詢抽象到極致的系統：正規化避免重複、以關聯維持一致、靠索引與 SQL 拿到彈性查詢與批次操作，交易控制是強項。但抽象化也隔離了應用對底層資料結構的控制，在雲端與巨量場景，最佳化往往需推到應用與資料產生端，單靠 RDBMS 遇到擴展天花板。NoSQL 則將焦點放在物件/文件狀態，弱化 schema 約束、以 JSON/XML 等結構化文件為主、原生 K/V 操作達到近 O(1) 的穩定效能與分片擴展，對應 OOP 更自然；但在複雜查詢、交易與一致性上需外部機制補足。作者強調兩者不是對立而是互補：RDBMS 善於查詢與強一致、NoSQL 善於水平擴展與物件狀態管理。選擇順序應為：先定義最難的需求與解法，再決定儲存技術組合，而非從產品清單反推架構。

### 難題 1: 資料一致性與交易處理
微服務將單一業務交易拆散到多服務/多資料庫，傳統單庫 ACID 難以直接套用，分散式交易躍升為首要難題。作者指出可行策略：以 Saga（編排或編舞）管理跨服務長交易，設計補償動作而非鎖定資源；2PC 僅在少數需要強一致的關鍵交易採用；更普遍的是事件驅動與最終一致，藉由事件溯源、重播（replay）、CQRS 將寫入與讀取解耦，縮小一致性窗口；對資料模型進行反正規化，降低跨邊界讀取依賴。關鍵在於先界定哪裡需要強一致（小範圍、可承受延遲）、哪裡接受最終一致（搭配冪等與重試機制）。配套還包含：Idempotency、去重、超時與死信隊列、可觀測性以追蹤交易鏈路。沒有正確的交易設計，再強的資料庫也無法彌補。

### 難題 2: 舊資料封存
成長型系統會堆積大量低頻存取的歷史資料，若全部留在主庫，會拖慢備援、索引與維護。封存策略可分層：熱資料留在主庫（可能 RDBMS/NoSQL 視場景），溫資料放在可查詢的倉儲（如雲端資料倉庫），冷資料轉物件儲存（低成本、長週期）並保留可重建索引或快照的能力。以事件溯源的系統可將歷史事件封存，同時定期產生快照以縮短重建時間；非事件系統可用時間分區、分表或移轉到歸檔庫。查詢層則以多層資料來源聚合，對外提供一致 API，不讓客戶端感知資料熱度差異。重點是封存流與回補流的可觀測與再處理能力，確保合規與成本平衡。

### 難題 3: 異動紀錄與快照的管理問題
審計與回溯需求要求保留異動軌跡（誰在何時做了什麼）以及可快速回到某狀態的能力。一般策略有兩類：事件溯源（以 append-only 的事件流為真相，狀態可由事件重播得到）與快照（定期保存狀態全量影像，縮短重建時間）。對於不可變或多版本資料，可採參照計數＋寫入時複製（Copy-on-Write），類似 Git 的物件圖結構，節省存儲並支援任意版本比對。RDBMS 可用審計表/CDC，NoSQL 可用版本欄位/時間戳或分集合存放。設計上需考慮：版本鏈管理、索引與查找路徑、快照頻率與大小、重建時間上限、與讀模型同步策略，以及在報表/查詢層的可視化與權限控制。

### 難題 4: Cache 的命中率與資料正確性的平衡
在高讀取場景，快取是關鍵，但需在命中率與正確性間權衡。常見策略：基於鍵的精準失效（事件驅動失效而非 TTL 亂槍打鳥）、寫穿/寫回/寫旁路依需求選擇；對不可變資料可用長 Cache-Control 並透過版本鍵控制；對使用者狀態採用分段快取與部分合併；以事件通知或 Pub/Sub 廣播失效；為讀多寫少的查詢設置只讀副本或預計算讀模型。跨資料庫的快取一致性需透過統一事件源頭與冪等處理來保證。快取不是資料庫，需清晰定義來源真相與回源策略，並以可觀測性監控命中率、延遲與錯誤率。

### NoSQL 適用的場景
NoSQL 尤其適合：高併發 K/V 查詢、巨大且結構多變的文件資料、不可變/多版本資料（易於長快取與版本切換）、事件流與時間序列、社交/推薦等需要水平分片的業務、以及需要快速外掛讀模型或反正規化副本的情境。典型案例還包含：大規模封存（便於分桶與生命周期管理）、API 對單一聚合根的狀態操作（狀態機導向），或服務間以事件同步建立讀副本。搭配 RDBMS 可形成混合解：RDBMS 負責強一致交易與複雜查詢，NoSQL 負責高併發讀寫與分片擴展，兩者以事件與同步機制銜接。

### 為何雲端時代 / 微服務化的場景，特別容易看到 NoSQL 的應用?
微服務將資料切到服務邊界，天然失去跨服務 join 能力；資料以 API 存取而非共享資料庫；跨服務交易轉為事件或 Saga；查詢需求轉為讀模型或數據倉庫。這些改變削弱了 RDBMS 的「單庫強查詢/強交易」優勢，反而凸顯 NoSQL 的水平擴展、K/V 效能與文件導向好處。既然都已切割為 API 與獨立資料庫，RDBMS 與 NoSQL 在使用方式上趨同（皆需以架構治理一致性與查詢），因而更應開放心態評估 NoSQL 作為整體解的組件之一。

### 使用 NoSQL 你必須具備的能力
採用 NoSQL 的前提能力包括：精準的資料結構與索引設計（理解時間複雜度與訪問路徑）；事件驅動、Pub/Sub、CDC 與 CQRS 的落地能力；反正規化與多副本同步的治理（含重播與補償）；將查詢從 CRUD 拆出、建置報表/數倉/搜尋等讀通道；快取一致性策略與可觀測性；以及權責清楚的 API 設計（以狀態機為中心，而非僅 CRUD）。同時需能在同一域中協調多種儲存技術，讓各自優勢互補，避免把每種技術的缺點疊加。

### 物件導向的應用: 抽象化介面
作者以 OOP 對齊微服務：物件＝介面＋狀態。介面對應服務 API 與協議，狀態對應資料庫與持久化。要切割資料庫，必須將「查詢語言」降級為「API」，也就是以有限、可預期的資料訪問路徑服務化，避免跨邊界自由組合查詢。API 設計應以狀態機驅動單一聚合的變化，複雜查詢另闢讀模型與報表通道。安全模型也應以 API 層實作（角色/權限校驗），避免將授權耦合於資料庫 schema。當介面與狀態清晰對齊，服務邊界、資料一致性與擴展策略才能同步運作，RDBMS 與 NoSQL 的組合也才能穩定落地。

## 資訊整理

### 知識架構圖
1. 前置知識：學習本主題前需要掌握什麼？
- 資料結構與演算法基礎（索引、B-Tree、雜湊、時間複雜度）
- 資料庫基礎（RDBMS 的正規化/索引/交易、NoSQL 的 K/V 與文件模型）
- 分散式系統概念（CAP、ACID/BASE、分散式交易、事件驅動）
- 物件導向（物件的狀態與行為、抽象化、介面設計）
- 微服務基本觀念（服務邊界、API First、去耦合、獨立資料庫）
- 雲端平台與容器編排的基本操作（但重點在資料治理）

2. 核心概念：本文的 3-5 個核心概念及其關係
- RDBMS 與 NoSQL 的本質差異：表格查詢與交易的極致抽象 vs 物件/文件狀態的抽象與 K/V O(1) 訪問
- 架構先於技術選型：先定義解決方案與服務邊界，再選資料儲存技術（常為混用與整合）
- 分散式一致性與交易策略：從單庫交易轉為跨服務的 Saga/事件驅動/CQRS
- 查詢與整合方式轉換：從 SQL Join 改為 API/GraphQL/事件同步與報表管線
- 資料治理專題：封存、不可變資料、版本化（COW、ref-count）、快取命中率與正確性平衡

3. 技術依賴：相關技術之間的依賴關係
- 服務邊界與 API 設計 → 決定資料庫切割 → 決定一致性與同步機制（Saga/CQRS/Event）
- 資料模型（正規化/反正規化） → 決定查詢路徑（SQL/索引/GraphQL/專用讀庫） → 影響快取策略
- 事件驅動與 Pub/Sub → 支撐多庫同步、讀寫分離、報表/搜尋索引建置
- 不可變資料與版本化 → 提升快取命中與回放能力 → 支持審計與時間點查詢
- 雲端/容器 → 提供水平擴展 → 促使從單庫 ACID 轉向整體架構的最終一致

4. 應用場景：適用於哪些實際場景？
- 高流量電商/雲端服務：需要水平擴展、事件驅動、混用 RDBMS+NoSQL
- 大量封存/冷資料歸檔：以成本導向的存放，搭配可回放的事件或報表倉儲
- 不可變資料與內容分發：藉由不可變 Key 改善快取命中與 CDN 策略
- 多版本資料管理：以 reference counting + copy-on-write 管理歷史版本（類 Git/SVN）
- 微服務拆分：每服務獨立資料庫、以 API 組合查詢、報表走離線/專用管線
- 查詢複雜報表：以 BigQuery 類型的分析庫或離線批次資料湖處理

### 學習路徑建議
1. 入門者路徑：零基礎如何開始？
- 了解 RDBMS 與 NoSQL 的核心差異、索引與 K/V 的時間複雜度
- 學會基本 SQL 與正規化、與文件/鍵值模型的對照
- 以小型專案實作：一個服務一個資料庫＋簡單 API（API First）
- 認識基本交易與一致性概念（ACID/BASE、CAP）

2. 進階者路徑：已有基礎如何深化？
- 實作 CQRS：寫入走命令模型、讀取走查詢模型（獨立讀庫）
- 實作 Saga 或 Outbox + 事件驅動，處理跨服務一致性
- 學會反正規化策略與資料冗餘的安全用法（含資料同步與回放）
- 規劃封存、不可變資料鍵設計、版本化（COW）與審計追蹤
- 設計以狀態機為中心的 API（避免單純 CRUD）

3. 實戰路徑：如何應用到實際專案？
- 在單一域中混用 RDBMS（交易/查詢）＋NoSQL（快取/KV/文件）
- 以 Pub/Sub 建立資料同步與報表 ETL，提供 GraphQL 或 API 聚合層
- 為查詢與報表建立專用資料管線（如 BQ 類分析庫）
- 針對不可變資料導入強快取策略，對可變資料設計失效/回源策略
- 建立資料治理規範：版本化、封存週期、事件回放流程與觀測性

### 關鍵要點清單
- RDBMS 的本質: 表格查詢與交易的極致抽象（索引/SQL/ACID） (優先級: 高)
- NoSQL 的本質: 物件/文件狀態抽象與 K/V O(1) 存取（弱 schema、易擴展） (優先級: 高)
- 架構先於選型: 先定服務邊界與資料流，再決定單一或混用資料庫 (優先級: 高)
- 水平擴展與一致性: 從單庫交易轉為 Saga/事件驅動的最終一致 (優先級: 高)
- API 取代 Join: 切庫後以 API/GraphQL/讀庫組合查詢，避免跨庫 Join (優先級: 高)
- CQRS 與事件回放: 讀寫分離、資料同步、報表/搜尋索引建置的基石 (優先級: 高)
- 反正規化策略: 為讀效能與可用性刻意冗餘，並用事件維持一致 (優先級: 高)
- 快取與正確性平衡: 以不可變鍵提升命中率，為可變資料設計失效策略 (優先級: 中)
- 封存策略: 大量冷資料轉低成本存放，需可回放/查驗（合規/成本） (優先級: 中)
- 多版本與 COW: 以 copy-on-write + 參照計數管理歷史版本與審計 (優先級: 中)
- API 設計以狀態機為中心: 以狀態轉移定義介面，而非單純 CRUD (優先級: 中)
- 安全與授權脫離 Schema: 以 API 層設計 RBAC/ABAC，避免查詢綁死資料表 (優先級: 中)
- 報表與分析專用管線: 以 Pub/Sub + ETL 到分析庫（如 BQ 類），不壓主交易庫 (優先級: 中)
- 指標與觀測: 針對事件延遲、不同步、重放進度、快取命中率設監控 (優先級: 中)
- 技術整合思維: 面臨互斥需求時採用 RDBMS+NoSQL 混合並以架構治理 (優先級: 高)