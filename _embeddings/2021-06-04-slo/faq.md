# [架構師的修練] #2, SLO ‑ 如何確保服務水準?

# 問答集 (FAQ, frequently asked questions and answers)

## Q: 什麼是 SLA、SLO 與 SLI？三者關係如何區分？
SLA (Service Level Agreement) 是服務提供者對客戶的正式合約與賠償條款；  
SLO (Service Level Objective) 是內部訂下的服務水準目標，例如「99% 的請求 300 ms 內完成」；  
SLI (Service Level Indicator) 則是用來衡量 SLO 是否達成的具體指標，如 P99 回應時間、Queue length 等。  
先定義 SLO，再拆成可監控的 SLI，才能對外簽 SLA。

## Q: 非同步系統要如何量化並監控「5 秒內送出驗證簡訊」的 SLO？
將 5 秒拆成三段可量測時間：  
A. 前端準備時間 (發要求 → 推入 MQ)  
B. 佇列等待時間 (訊息在 MQ 排隊)  
C1. Worker 處理時間 (取出 → 送達簡訊商)  
再加上佇列長度 D。  
程式在四個節點 (t1~t4) 打點並把 (A,B,C1,D) 透過 Metrics API 推送到監控系統，即可即時判斷 `A+B+C1 ≤ 5 s` 是否成立，紅黃綠燈化呈現並發警報。

## Q: 發現驗證簡訊經常逾時時，應如何排查與改善？
1. 先觀察 SLI：若 B 與 D 同時偏高，代表 MQ 塞車。  
2. 直覺做法是 scale-out Worker，但可能讓行銷簡訊也跟著受惠、成本暴增。  
3. 依瓶頸與優先級分流：將「驗證」與「行銷」簡訊拆成兩條獨立 MQ 與 Worker，各自調整資源，讓高優先訊息先被處理。

## Q: 為何單純加機器（scale-out）不一定是最佳方案？
擴充 Worker 會同時加速所有訊息，行銷簡訊量遠大於驗證簡訊時，成本大幅上升卻只對關鍵 SLO 有有限幫助。分流架構能把資源精準花在刀口上，達到同樣 SLO、降低長期雲端費用。

## Q: 如何運用限制理論 (TOC) 找出瓶頸並設計對策？
1. 識別瓶頸 (Drum) — 觀察哪一步前方的 Buffer 庫存（MQ 長度）持續堆積。  
2. 充分利用瓶頸 — 讓高價值訊息先佔用瓶頸資源。  
3. 設置 Buffer (Protection) — 確保瓶頸不停工。  
4. 拉繩 (Rope) — 當 Buffer 過高時，從源頭限流或切換替代流程。  
對策1：訊息分流；對策2：當預估延遲 > 允許值時自動通知前端暫停或切換方案。

## Q: 若長時間無法滿足 SLO，系統可採取哪些自動化應變？
計算「預計等待時間 = Queue length ÷ 處理速率」，若超過 30 s (使用者可忍受上限) 則：  
1. 由監控觸發 Feature Toggle，暫停新驗證簡訊入口或改用電話撥號等替代流程。  
2. 或讓前端透過 API 取得即時延遲值，自行顯示「稍後再試」。

## Q: 在確保 SLO 的同時，如何衡量與控制成本？
將運算資源換算成統一單位 (如 1 core+2 GB RAM·hour)。  
監控 SLI 與「資源單位」一起呈現，繪出 SLO 與 Cost 曲線。  
找出「SLO 需求區間」與「成本可接受區間」的交集；若 SLO 固定，目標就轉成用架構/效能優化 (如 Process Pool) 把成本壓到允許範圍內。

## Q: 什麼是局部最佳化與全局最佳化的衝突？該如何避免？
例子：交易後處理 Worker 被誤認為瓶頸而大量 scale-out，結果共用的 Database 真正成為新瓶頸，影響前台交易。  
解法：  
1. 監控跨服務關鍵資源 (DB) 指標，把它也視為瓶頸。  
2. 若無法立即擴充 DB，對交易後處理加 Rate Limiter，主動「降速」讓資源留給更重要的交易路徑，維持整體服務水準。