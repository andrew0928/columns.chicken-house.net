# [設計案例] 授權碼 如何實作? #3 (補) - 金鑰的保護

## 摘要提示
- Private Key 保護: 授權碼可信度取決於原廠私鑰是否被妥善保存、避免外洩。  
- Public Key 散布: 客戶端必須取得正確公鑰才能驗證授權碼。  
- 掉包風險: 攻擊者可自製金鑰並調包公鑰，繞過授權驗證。  
- 內嵌公鑰: 若控制硬體/作業系統，可將公鑰寫入系統避免被替換。  
- 主機範例: 遊戲主機依賴 TPM 與數位簽章判斷正版光碟。  
- CA 可信鏈: 透過第三方憑證機構發行/查詢公鑰，降低掉包可能。  
- 自建 CA: 需維運基礎設施並確保使用者全在信任網域內。  
- 線上驗證: 以更新包、定期回連機制強迫比對原廠簽章。  
- Windows/KMS 案例: 微軟以網路啟用與 KMS 伺服器管控大量授權。  
- 關鍵在金鑰管理: 程式再安全，也須透過正規流程管理金鑰，才能真正防護。  

## 全文重點
本篇為「授權碼實作」系列第 3 篇補充，聚焦於「金鑰保護」。前文已證明透過數位簽章可可靠驗證授權碼，但演算法皆屬公開，真正的安全取決於私鑰與公鑰的管理。  
原廠利用私鑰簽發授權碼，並將公鑰發放給客戶端進行驗證；若私鑰外洩，任何人即可偽造授權碼，若公鑰被替換，客戶端也會信任假授權碼。實務上常見的攻擊是合作夥伴或維運商調包公鑰：自己重生一對金鑰，簽出假授權碼，再把自己的公鑰塞給客戶。  
為防範此類風險，作者提出三條路：  
1. 直接將公鑰嵌入產品，並藉硬體或 OS 保護（如家用遊戲主機與 TPM），在無網路環境亦可驗證。  
2. 交由公正第三方 CA 發行憑證。客戶驗證時向 CA 下載原廠公鑰，類似 DNS 的名稱解析機制。此法最正統，但需付憑證費用，或自建 CA 並承擔維運成本。  
3. 透過線上驗證或維護合約等手段，強迫系統定期回到原廠伺服器比對，藉此檢出錯誤的公鑰；微軟 Windows 啟用與 KMS 即屬此範例。  
作者強調，金鑰管理是一切安全的根本；應評估成本、維運與威脅模型，選擇最適合的方案。後續系列文章將再探討 API 等應用。  

## 段落重點
### 金鑰管理與潛在威脅
文章先回顧數位簽章在授權碼中的角色：原廠以私鑰簽章、客戶以公鑰驗證。若私鑰外洩或公鑰被替換，安全即失守。作者舉「合作廠商掉包公鑰」的場景說明，攻擊者無需取得私鑰，只要自製一對金鑰並將公鑰送達客戶，就能簽出任意授權碼而不被發現。此處點出系統設計常忽略的弱點：公鑰真偽。  

### 預先在系統內埋好 PUBLIC KEY
若產品環境可完全控制，最簡單辦法是把公鑰寫死在韌體或作業系統，並配合硬體安全模組防止竄改。遊戲主機是典型案例：在啟動任何遊戲前，主機 OS 先用內建公鑰驗證光碟或程式的簽章；TPM 等硬體確保金鑰不可被替換。破解者往往透過韌體漏洞關閉或繞過驗證程序才能執行盜版。這種方式安全性高，但只適用於封閉且可控的裝置。  

### 透過 CA 發行 PUBLIC KEY
若無法封閉環境，可借助憑證授權中心（CA）。CA 先驗證申請者身分並簽發憑證，其中包含申請者的公鑰與識別資訊。客戶端可透過標準協定向 CA 取得並信任該公鑰，避免中間人掉包。CA 架構類似 DNS：除非攻擊者能控制全球 CA，否則難以偽造。採用公有 CA 需支付年費；若自行架設私有 CA，則需確保所有客戶皆在信任鏈內，且要負擔維運、備援與安全監控成本。  

### 透過其他手段強制連回原廠驗證
在預算或基礎設施有限時，可結合線上服務與維護流程：  
1. 將功能更新、修補程式封裝成需簽章的升級包，只有持正確公鑰者才能安裝。  
2. 強制裝置定期連回原廠伺服器，比對授權與公鑰狀態；若檢測失敗即限制功能。  
3. 透過實體媒介或維護合約手動發放金鑰。  
微軟 Windows 的線上啟用與大型授權用的 KMS 是典型案例：終端機需定期向 KMS 伺服器或 Microsoft 伺服器驗證，以確保使用者未更換為非法金鑰。此類方案可降低掉包風險，但需持續營運伺服器並處理離線場景。  

### 結語
作者總結，程式碼層面的加密與簽章只是安全基礎；真正決定系統強韌度的是金鑰管理策略。建議依資源與威脅模型選用「嵌入公鑰」、「使用 CA」、「線上驗證」或混合方式，並留意營運成本與使用者體驗。系列文章後續將延伸至 API 等實務應用。