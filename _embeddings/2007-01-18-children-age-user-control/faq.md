# 皮哥皮妹的年齡 user control ...

## 問題與答案 (FAQ)

### Q&A 類別 A: 概念理解類

A-Q1: 什麼是「年齡 User Control」？
- A簡: 一個 ASP.NET 使用者控制項，輸入生日與樣式字串，正確計算並顯示幾年幾個月（可擴充天）。
- A詳: 年齡 User Control 是一個可重用的 ASP.NET WebForms 使用者控制項（.ascx），透過屬性設定生日（Birthday）與輸出樣式（Pattern），在伺服端依格里曆規則精確計算年齡，避免以天數/月份簡單相除造成的誤差。它將年、月（可選天）分解輸出，並支援自訂字串格式與在地化，適合個人部落格、個人檔案頁顯示、企業內部人資系統等情境。
- 難度: 初級
- 學習階段: 基礎
- 關聯概念: A-Q2, A-Q3, B-Q1, B-Q5, C-Q2

A-Q2: 為什麼需要專門的年齡控制項？
- A簡: 兼顧正確性與重用性，避免每次手算複雜曆法，減少重複程式與錯誤。
- A詳: 年齡計算牽涉不同月份天數與潤年規則，若以天數/30 或 /365 粗略換算，誤差會累積，導致幾個月與幾天錯置。封裝為控制項可一次正確實作並重複使用，減少每頁面重寫邏輯，並可統一處理時區、在地化、例外狀況與快取等非功能性需求，使顯示穩定一致且更易維護。
- 難度: 初級
- 學習階段: 基礎
- 關聯概念: A-Q3, A-Q8, B-Q1, B-Q9

A-Q3: 年齡計算的難點是什麼？
- A簡: 月份天數不一與潤年規則，導致以天數換算月數/年數會失真。
- A詳: 真實年齡是曆法意義下的年、月、日差，而非單純時間長度。每月天數不同（28~31），潤年二月為29天，且有「四年一潤、百年不潤、四百年又潤」的規則。若用「總天數/365」取年，再以餘數/30 取月，會因月份長短與潤年被平均而產生誤差，出現「月數錯誤、天數完全不對」的情形。
- 難度: 初級
- 學習階段: 基礎
- 關聯概念: A-Q4, A-Q8, B-Q4, B-Q9

A-Q4: 格里曆（Gregorian）潤年規則是什麼？
- A簡: 四年一潤，整百年不潤，四百年再潤；如2000潤、1900不潤。
- A詳: 格里曆的潤年規則為：年份可被4整除且不可被100整除時為潤年；若可被400整除則仍為潤年。此法修正了儒略曆的誤差，使平均年長接近太陽回歸年。實作時可用 .NET 的 DateTime.IsLeapYear(year) 或 System.Globalization.GregorianCalendar 判斷，避免自行實作出錯。
- 難度: 初級
- 學習階段: 基礎
- 關聯概念: B-Q3, B-Q4, D-Q4

A-Q5: 使用者控制項（User Control）與自訂伺服器控制項有何差異？
- A簡: User Control 是 .ascx 可視化片段，開發快；伺服器控制項為組件級 .dll，可重用性與設計時支援更強。
- A詳: User Control（.ascx）以頁面片段組合、含標記與程式碼後置，開發速度快、部署簡單（複製檔案即可）。自訂伺服器控制項（.dll）屬組件級，無 .ascx 標記、僅程式碼，設計時體驗、屬性編輯、跨專案重用更佳。年齡控制項若主要用於站內展示，選擇 .ascx 較敏捷；若需封裝發佈給多站台使用，伺服器控制項更合適。
- 難度: 中級
- 學習階段: 基礎
- 關聯概念: B-Q11, C-Q1, C-Q8

A-Q6: Pattern（樣式）屬性是什麼？為何用 {0}、{1} 佔位？
- A簡: 顯示格式模板。以 {0} 表年、{1} 表月（{2} 可表日）供 String.Format 注入。
- A詳: Pattern 是輸出樣式字串，內含格式佔位符，如「阿扁當總統已經 {0} 年 {1} 個月了」。控制項先計算出年、月（與日），再用 String.Format(Pattern, years, months, days) 將數值代入，達到完全自訂語句、語序與語言的目的。此設計使控制項邏輯與顯示分離，利於在地化與重用。
- 難度: 初級
- 學習階段: 基礎
- 關聯概念: B-Q5, C-Q2, D-Q2

A-Q7: 正確計算年齡需要哪些輸入條件？
- A簡: 生日（或起始日）、「現在」時間（含時區）、採用的曆法與取整規則。
- A詳: 核心輸入包含：出生日期或起始日期（Birthday）、參考時間（通常為伺服器現在或指定 TargetDate）、時區設定（TimeZoneInfo）、所採曆法（多為格里曆）、以及取整邏輯（向下取整為整年整月）。視需求可加輸出單位（日、小時）、語言文化（Culture）與格式 Pattern。
- 難度: 初級
- 學習階段: 基礎
- 關聯概念: B-Q1, B-Q7, C-Q4

A-Q8: 為什麼不能用「總天數/365、餘數/30」計算年齡？
- A簡: 因月長與潤年不均，平均除法會扭曲年/月，導致結果失真。
- A詳: 「除365、除30」是以平均年長與月長近似真實曆法。真實世界月長不等（28~31），潤年還會多一天。平均化會把長月「分攤」給短月，造成月數偏大或偏小；再將餘數當天數更會錯上加錯。正確作法應用曆法加法：先沿生日逐年 AddYears，不能再加時回退一步，再逐月 AddMonths，最後剩餘為天。
- 難度: 初級
- 學習階段: 基礎
- 關聯概念: A-Q3, B-Q4, D-Q1

A-Q9: 年齡資訊的核心價值是什麼？
- A簡: 以人類曆法語意呈現時間差，讓資訊易懂、可比較、具溝通力。
- A詳: 年齡的價值在於用「年、月、日」三個自然單位表達時間距離，符合人類認知。用戶能快速理解「幾歲幾個月」，比起「一萬兩千天」更有語意。對內容網站、個人檔案、紀念事件等場景，這樣的呈現提升可讀性與參與感，且有助於一致性與國際化。
- 難度: 初級
- 學習階段: 基礎
- 關聯概念: A-Q6, A-Q10, C-Q2

A-Q10: 「年齡」與「時間間隔」有何差異？
- A簡: 年齡是曆法差（年/月/日按日曆累加），時間間隔是連續時間長度。
- A詳: 時間間隔（TimeSpan）度量的是連續時間（秒、分、時、天），不考慮月長差異；年齡則是曆法語意上的差值，需按日曆逐年、逐月累計，確保每一步不超過目標日期。兩者在短期接近，在跨月跨年的情況差異明顯。實作年齡應採曆法加法，而非僅用 TimeSpan 換算。
- 難度: 中級
- 學習階段: 基礎
- 關聯概念: B-Q9, B-Q10, D-Q1

A-Q11: 為什麼要用 AddYears/AddMonths 的「曆法加法」？
- A簡: 可精準對齊日曆邊界，確保不跨越目標日期，避免月長差與潤年誤差。
- A詳: 曆法加法先從生日起每次加1年，直到再加會超過當前日期為止；接著以同法加月；剩餘部分即為天。這種做法尊重每個月實際天數與潤年規則，且保證「年、月」部分都不會超出目標日，邏輯等同人類直覺計算，是顯示年齡的正確方法。
- 難度: 中級
- 學習階段: 核心
- 關聯概念: B-Q4, B-Q10, D-Q1

A-Q12: 為什麼時區會影響年齡顯示？
- A簡: 跨時區時「現在」日期可能不同，導致邊界日（生日當天）判定差異。
- A詳: 年齡通常以「今天」對齊日期計算。若伺服器在 UTC、使用者在 UTC+8，當地已跨日、伺服器未跨日時，年齡可能差一日甚至影響月/年的進位。解法是以使用者目標時區轉換「現在」日時再計算，或將比較僅使用日期部分（忽略時間），並清晰定義基準時區。
- 難度: 中級
- 學習階段: 核心
- 關聯概念: B-Q7, D-Q5, D-Q8

A-Q13: 在地化（i18n/l10n）對年齡顯示有何影響？
- A簡: 語序、量詞、複數與數字格式會不同，需用 Pattern 與資源檔支援。
- A詳: 不同語言對年與月的語序、詞綴與複數規則不同（如英文 years/months），中文有「個月」量詞。採用 Pattern 讓語句結構可自訂，配合資源檔（.resx）按 Culture 載入不同樣式。數字格式、數字系統（阿拉伯/本地數字）也需文化感知，確保全球一致體驗。
- 難度: 中級
- 學習階段: 核心
- 關聯概念: B-Q14, C-Q7, D-Q10

A-Q14: 格里曆與農曆（陰曆）有何差異？本控制項採何者？
- A簡: 格里曆是太陽曆、全球主流；農曆含閏月更複雜。本控制項採格里曆。
- A詳: 格里曆依太陽回歸年制定，透過潤年校正；農曆以月相為基礎，透過閏月與複雜換算維持與季節對齊。本文控制項與示範採格里曆（.NET 預設），若需計算農曆年齡，需引入對應曆法與換算規則，並重新定義年月日邏輯。
- 難度: 中級
- 學習階段: 核心
- 關聯概念: B-Q22, C-Q3

A-Q15: 年齡計算是否包含當天？邊界如何定義？
- A簡: 通常採「不超過當前日期」為原則，向下取整，不含未滿的月/年。
- A詳: 年齡的「完成」語意要求每一單位（年、月）都已滿。實作上以生日起累加，直到再加就會超過今天為止；因此未滿的月或年不進位。當天若正好滿月/滿年，會在該日進位。此策略相當於對年、月逐次向下取整。
- 難度: 中級
- 學習階段: 核心
- 關聯概念: A-Q11, B-Q10, D-Q5

A-Q16: 年齡取整用「無條件進位、四捨五入或無條件捨去」？
- A簡: 年齡應無條件捨去（floor），確保不超過目標日期的人類語意。
- A詳: 四捨五入或進位會使未滿之月/年提前顯示，不符合年齡常識。年齡的本質是「已完成」的年/月數，因此以向下取整（floor）對齊曆法累加法。這也解釋了為何需用 AddYears/AddMonths 逐步檢查不超過當前日期。
- 難度: 中級
- 學習階段: 核心
- 關聯概念: A-Q11, B-Q4

A-Q17: Birthday 字串應採用何種格式較穩妥？
- A簡: 採用不含文化歧義的 yyyy/MM/dd 或 ISO 8601（yyyy-MM-dd）。
- A詳: 日期字串解析受文化影響（如 05/04/2000 在某文化是 5月4日，在另一文化是 4月5日）。建議在標記屬性採 yyyy/MM/dd 或 ISO 8601 yyyy-MM-dd，或直接在程式設定 DateTime。若需多文化輸入，應明確指定 CultureInfo 與格式字串。
- 難度: 初級
- 學習階段: 核心
- 關聯概念: D-Q3, C-Q2

A-Q18: 是否能輸出「天」或更多單位？
- A簡: 可擴充 {2} 輸出天數，甚至小時分鐘；需調整計算與 Pattern。
- A詳: 在完成年與月的累加後，剩餘差距以天數呈現最自然。控制項可將 days 作為第三參數，Pattern 使用 {2} 顯示。若需小時/分鐘，可對剩餘部分再以時間間隔拆解，但應明確定義顯示策略，避免雜訊過多。
- 難度: 中級
- 學習階段: 核心
- 關聯概念: B-Q10, C-Q3

A-Q19: 如何在部落格文章中顯示年齡？
- A簡: 在頁面註冊控制項，標記放入 <CH:Age ... /> 並設定 Birthday、Pattern。
- A詳: 於頁面頂端用 Register 指示詞註冊 .ascx，於內容中插入控制項標記並指定 Birthday 與 Pattern，例如：<CH:Age runat="server" Birthday="2000/05/20" Pattern="阿扁當總統已經 {0} 年 {1} 個月了" />。渲染時控制項計算並輸出格式化結果，適合放在頁面側欄或標題區。
- 難度: 初級
- 學習階段: 核心
- 關聯概念: C-Q2, C-Q8

A-Q20: 伺服端計算與用戶端（JavaScript）計算有何差異？
- A簡: 伺服端較一致可控；用戶端可即時更新但受時區/瀏覽器影響。
- A詳: 伺服端計算可統一邏輯、文化與時區，輸出靜態結果；利於 SEO 與快取。用戶端計算可做即時更新（如動態倒數），但受瀏覽器、使用者時區與本地時間正確性影響。可採伺服端為主、用戶端增強的漸進式策略。
- 難度: 中級
- 學習階段: 進階
- 關聯概念: B-Q7, C-Q10, D-Q8

A-Q21: 何時需要重算年齡？可否快取？
- A簡: 以天為粒度即可；每天失效重算，避免同日重複計算。
- A詳: 年齡在日界內通常不變（若顯示到「日」）。可快取到午夜（依目標時區）失效，降低伺服器負載。若只顯示年/月，則可在每月「對應日期」重算。快取可用記憶體快取、OutputCache 或自訂字典搭配失效策略。
- 難度: 中級
- 學習階段: 進階
- 關聯概念: B-Q12, C-Q6, D-Q7

A-Q22: 若輸入的是未來日期，該如何處理？
- A簡: 建議輸出 0 年 0 月 0 天或顯示提示，不要拋未處理例外。
- A詳: 未來日期代表事件尚未發生。策略包括：顯示 0、0、0；顯示「尚未到期」訊息；或允許顯示負值但需標記方向。預設以不拋錯為佳，並提供屬性控制行為。也應避免顯示負年齡造成混淆。
- 難度: 中級
- 學習階段: 進階
- 關聯概念: D-Q6, B-Q8

A-Q23: 2月29日出生者的年齡如何計算？
- A簡: 以曆法累加時遇非潤年，2/29 加年會落在 2/28 或 3/01；需明確定義。
- A詳: 常見策略有兩種：法律/人類慣例多採 2/28 視為滿年；也有採 3/01。實作中先用 AddYears 計算年數，再檢查「生日加年」是否超出目標日期；.NET 的 AddYears 對 2/29 會落在 2/28。需在說明文件中說明，並可提供選項。
- 難度: 高級
- 學習階段: 進階
- 關聯概念: B-Q4, B-Q13, D-Q4

A-Q24: 什麼是 Community Server？為何關聯？
- A簡: 一套部落格/論壇平台。文中控制項部署於其部落格頁面顯示年齡。
- A詳: Community Server 是早期常見的 .NET 社群平台，提供部落格、相簿等功能。文中作者將年齡控制項嵌入部落格模板左上角，顯示小朋友年紀，示範了控制項在實際 CMS/社群平台中的使用與部署。
- 難度: 初級
- 學習階段: 進階
- 關聯概念: C-Q8, B-Q24

A-Q25: 為什麼寫成元件而非每篇文章手打年齡數字？
- A簡: 自動化、避免手動維護與誤差，頁面重用一致，樂趣與客製化加分。
- A詳: 手動輸入不僅易錯，還需持續更新。控制項將重複邏輯自動化，隨時間自動更新結果，並透過 Pattern 彈性客製句型，替網站帶來一致且獨特的呈現。一次投入，長期回收。
- 難度: 初級
- 學習階段: 進階
- 關聯概念: A-Q2, C-Q1, C-Q2

### Q&A 類別 B: 技術原理類

B-Q1: 年齡控制項的正確計算流程為何？
- A簡: 先加年到不超過今天，再加月至不超過，剩餘為天；最後格式化輸出。
- A詳: 技術原理說明：採曆法累加，尊重月長與潤年。關鍵步驟或流程：1) 取基準日期（轉換至目標時區，僅取日期部分）；2) years=0，while birthday.AddYears(years+1)<=today: years++；3) months=0，while birthday.AddYears(years).AddMonths(months+1)<=today: months++；4) days = (today - birthday.AddYears(years).AddMonths(months)).Days；5) String.Format(Pattern, years, months, days)。核心組件介紹：System.DateTime、AddYears/AddMonths、String.Format。
- 難度: 中級
- 學習階段: 核心
- 關聯概念: A-Q11, B-Q4, B-Q10, C-Q1

B-Q2: 控制項在 ASP.NET 的生命週期如何運作？何時計算最合適？
- A簡: 在 PreRender 前完成計算與繫結，Render 時輸出字串最穩妥。
- A詳: 技術原理說明：ASP.NET WebForms 生命週期包含 Init、Load、PreRender、Render。關鍵步驟或流程：在 Load 讀取屬性與狀態，於 PreRender 完成年齡計算並設定內部 Literal.Text，確保畫面呈現前資料已就緒。核心組件介紹：UserControl、Page 生命週期事件、Literal 控制項（或覆寫 Render）。
- 難度: 中級
- 學習階段: 核心
- 關聯概念: B-Q11, C-Q1, C-Q2

B-Q3: 潤年判斷機制如何實作？
- A簡: 使用 DateTime.IsLeapYear(year) 或 GregorianCalendar.IsLeapYear。
- A詳: 技術原理說明：.NET 已內建格里曆潤年判斷，避免自寫規則出錯。關鍵步驟或流程：於計算過程不必手動判斷，只要使用 AddYears/AddMonths，它會代入正確月長；必要時可用 DateTime.DaysInMonth(year, month) 查詢。核心組件介紹：System.DateTime、System.Globalization.GregorianCalendar。
- 難度: 初級
- 學習階段: 核心
- 關聯概念: A-Q4, B-Q4, D-Q4

B-Q4: 為何用 AddYears/AddMonths 比直接用 TimeSpan 更正確？
- A簡: 前者遵循曆法邊界，後者僅連續時間，無法處理變動月長。
- A詳: 技術原理說明：TimeSpan 以固定天/秒表達時長，不含曆法資訊。AddYears/AddMonths 由日期系統計算，正確處理月底與潤年。關鍵步驟或流程：以生日為基點迭代累加年、月；每步檢查是否超過今天。核心組件介紹：DateTime.AddYears/AddMonths、DateTime.DaysInMonth、比較運算。
- 難度: 中級
- 學習階段: 核心
- 關聯概念: A-Q8, B-Q1, B-Q10

B-Q5: Pattern 格式化的機制是什麼？
- A簡: 以 String.Format 注入計算結果，維持顯示與邏輯分離。
- A詳: 技術原理說明：Pattern 是一個複合格式字串，由 {0}、{1}、{2} 等佔位符構成。關鍵步驟或流程：計算出 years、months、days 後，執行 String.Format(pattern, years, months, days) 取得輸出。核心組件介紹：System.String.Format、IFormatProvider（可選文化特定格式）、資源檔。
- 難度: 初級
- 學習階段: 核心
- 關聯概念: A-Q6, D-Q2, C-Q7

B-Q6: 控制項屬性如何解析與驗證？
- A簡: 將 Birthday 字串解析為 DateTime，驗證格式、未來日期與邏輯。
- A詳: 技術原理說明：公開 Birthday、Pattern 等屬性，於 set 時或 PreRender 解析與檢查。關鍵步驟或流程：TryParseExact 解析多種安全格式；若失敗則記錄錯誤或套用預設；檢查未來日期策略。核心組件介紹：DateTime.TryParseExact、CultureInfo、Nullable<DateTime>。
- 難度: 中級
- 學習階段: 核心
- 關聯概念: A-Q17, D-Q3, D-Q6

B-Q7: 時區處理的技術路徑是什麼？
- A簡: 以 DateTimeOffset 與 TimeZoneInfo 轉換，統一以目標時區計算日期。
- A詳: 技術原理說明：將「現在」轉成使用者目標時區，僅取日期部分進行比較。關鍵步驟或流程：取得伺服器現在 UTCNow；用 TimeZoneInfo.ConvertTime 轉成目標時區；today = local.Date；生日若無時區則視為該時區日期。核心組件介紹：DateTimeOffset、TimeZoneInfo、.Date 屬性。
- 難度: 中級
- 學習階段: 核心
- 關聯概念: A-Q12, C-Q4, D-Q8

B-Q8: 例外處理與容錯要點？
- A簡: 捕捉解析與格式化例外，提供預設輸出或明確錯訊，避免中斷頁面。
- A詳: 技術原理說明：Birthday 解析錯、Pattern 佔位數錯會拋例外。關鍵步驟或流程：TryParse 失敗時使用降級顯示或顯示可讀錯誤；String.Format 用參數數量檢查；記錄日誌以利追蹤。核心組件介紹：try/catch、FormatException、ILogger/Trace、健康檢查。
- 難度: 中級
- 學習階段: 核心
- 關聯概念: D-Q2, D-Q3, D-Q9

B-Q9: 為何「TimeSpan 除法」會造成誤差？如何比較？
- A簡: TimeSpan 忽略月長差與潤年，平均化近似導致月/天錯位。
- A詳: 技術原理說明：TimeSpan.TotalDays/365 得到的是平均年；餘數/30 是平均月。關鍵步驟或流程：比較兩法：A) TimeSpan 近似；B) AddYears/AddMonths。以跨多個不同月長的測試可見差異。核心組件介紹：TimeSpan、DateTime、單元測試框架。
- 難度: 中級
- 學習階段: 核心
- 關聯概念: A-Q10, B-Q4, B-Q13

B-Q10: 年、月、日的單位分解算法細節？
- A簡: 基於生日逐年、逐月累加，最後用日期差取天。
- A詳: 技術原理說明：以 Birthday 為起點，分兩段累加保證不越界。關鍵步驟或流程：基點 = Birthday；迭代年直到超過 today 為止；再從基點加月；最後 days = (today - 基點).Days。核心組件介紹：DateTime.AddYears/AddMonths、DateTime.Subtract、Days 屬性。
- 難度: 中級
- 學習階段: 核心
- 關聯概念: B-Q1, A-Q11, C-Q3

B-Q11: 年齡控制項的技術架構如何設計？
- A簡: 屬性＋計算服務＋輸出元件，分離邏輯與表示，利測試與重用。
- A詳: 技術原理說明：採分層設計。關鍵步驟或流程：UI（.ascx）僅含容器/Literal；邏輯層封裝 AgeCalculator（注入曆法與時區）；最終輸出透過 Pattern 格式化並指派至 Literal。核心組件介紹：UserControl、AgeCalculator 類別、Literal、資源檔、依賴注入（可選）。
- 難度: 中級
- 學習階段: 核心
- 關聯概念: C-Q1, C-Q7, B-Q15

B-Q12: 快取機制如何設計才有效？
- A簡: 以日為失效單位，鍵包含生日與時區；午夜自動失效。
- A詳: 技術原理說明：年齡在當日內不變。關鍵步驟或流程：建立快取鍵（Birthday|TimeZone|Pattern|Culture）；查快取命中則直接輸出；未命中計算並放入，設定到期時間為下一個午夜（目標時區）。核心組件介紹：MemoryCache、OutputCache、CacheItemPolicy（絕對到期）。
- 難度: 中級
- 學習階段: 核心
- 關聯概念: A-Q21, C-Q6, D-Q7

B-Q13: 試寫單元測試應涵蓋哪些邊界條件？
- A簡: 月底、潤年、2/29、跨年跨月、未來日、不同時區。
- A詳: 技術原理說明：以範例驅動驗證曆法邏輯。關鍵步驟或流程：安排測試集：1/31→2/28、2/28→3/31、2/29 出生跨非潤年、12/31→1/01、未來日期輸出策略、UTC 與 UTC+8 差一天案例。核心組件介紹：NUnit/MSTest/xUnit、Parameterized Tests、Assert。
- 難度: 中級
- 學習階段: 核心
- 關聯概念: A-Q23, D-Q4, C-Q5

B-Q14: 在地化與資源管理如何落地？
- A簡: 將 Pattern 與字串置於 .resx，依 Culture 自動載入。
- A詳: 技術原理說明：以資源檔管理多語系字串。關鍵步驟或流程：建立 AgeControl.resx 與 AgeControl.zh-TW.resx 等；控制項讀取 ResourceManager 取得 Pattern 預設；也允許標記覆寫。核心組件介紹：ResourceManager、UICulture/Culture、Thread.CurrentUICulture。
- 難度: 中級
- 學習階段: 核心
- 關聯概念: A-Q13, C-Q7, D-Q10

B-Q15: 效能考量與最佳化有哪些？
- A簡: 日期計算成本低，重點在快取、避免重複解析、減少文化轉換。
- A詳: 技術原理說明：計算輕量，但在高併發下重複計算仍可優化。關鍵步驟或流程：快取結果至午夜；Birthday 解析結果緩存；避免每次重建 CultureInfo；Pattern 檢查在設定時完成。核心組件介紹：MemoryCache、Lazy<T>、靜態 CultureInfo 實例。
- 難度: 中級
- 學習階段: 進階
- 關聯概念: B-Q12, C-Q6, D-Q7

B-Q16: 安全性需要注意什麼？
- A簡: 避免將未驗證字串輸出為 HTML，處理例外資訊不暴露內部細節。
- A詳: 技術原理說明：控制項可能出現在公開頁面。關鍵步驟或流程：輸出時 HTML Encode 使用者提供的 Pattern（如允許外部設定時）；捕捉例外訊息避免將堆疊曝露；日誌注意隱私。核心組件介紹：HttpUtility.HtmlEncode、try/catch、日誌遮罩。
- 難度: 中級
- 學習階段: 進階
- 關聯概念: D-Q9, D-Q10

B-Q17: 如何設計可擴充輸出更多單位（天、小時）？
- A簡: 分層提供元件化分解結果，Pattern 可接更多參數。
- A詳: 技術原理說明：將計算拆為「分解器」輸出 Year/Month/Day/TimeSpan。關鍵步驟或流程：AgeResult{Years,Months,Days,Remaining}；Pattern 使用 String.Format 支援 {2}{3}；或提供 IFormattable。核心組件介紹：DTO、擴充方法、IFormattable。
- 難度: 中級
- 學習階段: 進階
- 關聯概念: A-Q18, C-Q3

B-Q18: ViewState 與 ControlState 該如何使用？
- A簡: 少量屬性可用 ViewState 保存；必要資訊可放 ControlState 確保不被關閉。
- A詳: 技術原理說明：WebForms 以 ViewState 保留跨回傳狀態。關鍵步驟或流程：將 Birthday、Pattern 等序列化進 ViewState；若網站可能關閉 ViewState，可覆寫 SaveControlState/LoadControlState 保存關鍵屬性。核心組件介紹：ViewState 字典、ControlState API。
- 難度: 高級
- 學習階段: 進階
- 關聯概念: B-Q2, C-Q1

B-Q19: Render 流程與輸出方式怎麼選？
- A簡: 以 Literal 內嵌輸出最簡單；或覆寫 Render 更彈性。
- A詳: 技術原理說明：UserControl 可在樹中包含 Literal/Text 或自訂渲染。關鍵步驟或流程：PreRender 設定 Literal.Text；或覆寫 Render(HtmlTextWriter) 直接輸出字串。核心組件介紹：Literal、HtmlTextWriter、Render 方法。
- 難度: 中級
- 學習階段: 進階
- 關聯概念: B-Q2, C-Q1

B-Q20: 設計時（Design-time）與執行時行為如何處理？
- A簡: 設計時提供預覽或樣本文字；執行時計算真實年齡。
- A詳: 技術原理說明：設計時環境不可取得動態日期。關鍵步驟或流程：偵測設計時（Site!=null 或 DesignMode），顯示「樣本：X 年 Y 月」以利設計畫面排版；執行時計算真實結果。核心組件介紹：Control.Site、DesignMode 屬性。
- 難度: 中級
- 學習階段: 進階
- 關聯概念: C-Q1, C-Q2

B-Q21: 如何與資料繫結控制項整合？
- A簡: 暴露 Birthday 為可繫結屬性，支援 Eval 綁定資料來源欄位。
- A詳: 技術原理說明：WebForms 可用 <%# Eval("BirthDate") %> 綁定。關鍵步驟或流程：在 .ascx 將 Birthday 屬性標示 [Bindable(true)]；於 DataBinding 事件解析值；搭配模板控制項（Repeater/GridView）重複顯示。核心組件介紹：DataBinding、BindableAttribute、Eval。
- 難度: 中級
- 學習階段: 進階
- 關聯概念: C-Q1, C-Q2

B-Q22: 若要支援其他曆法（如農曆）應怎麼做？
- A簡: 抽象曆法介面，實作對應加年加月與日期換算。
- A詳: 技術原理說明：將曆法依賴抽象為 ICalendar 介面。關鍵步驟或流程：定義 ICalendar.AddYears/AddMonths/Normalize；提供 GregorianCalendarAdapter 與 LunarCalendarAdapter；Pattern 仍由文化決定。核心組件介紹：System.Globalization.Calendar、多型、介面。
- 難度: 高級
- 學習階段: 進階
- 關聯概念: A-Q14, C-Q3

B-Q23: 如何與 JavaScript 協作達到即時更新？
- A簡: 初始由伺服端渲染，前端接管用生日與當地時間定時重算。
- A詳: 技術原理說明：伺服端負責首屏正確性，前端增強即時性。關鍵步驟或流程：輸出 data-birthday 與已算好的結果；JS 讀取屬性並每分鐘或每日刷新；時區以使用者本地 Date。核心組件介紹：data-* 屬性、Intl.DateTimeFormat（可選）、setInterval。
- 難度: 中級
- 學習階段: 進階
- 關聯概念: A-Q20, C-Q10, D-Q8

B-Q24: 在 Community Server 中整合的注意點？
- A簡: 依平台支援的自訂控制項方式註冊 .ascx，留意虛擬路徑與快取。
- A詳: 技術原理說明：CMS 模板可能有自訂目錄與快取。關鍵步驟或流程：將 .ascx 放入允許的控制項目錄；用 Register 指示詞註冊；檢查 MasterPage 區域；遵守平台頁面快取規則（必要時設為可變區塊）。核心組件介紹：MasterPage、控件區域、OutputCache。
- 難度: 中級
- 學習階段: 進階
- 關聯概念: A-Q24, C-Q8, D-Q9

B-Q25: 失敗時的容錯與降級策略是什麼？
- A簡: 顯示回退字串或隱藏控制項，同時記錄日誌，避免破壞頁面。
- A詳: 技術原理說明：以使用者體驗為優先。關鍵步驟或流程：捕捉任何計算/格式化例外；若 Pattern 缺失使用預設；生日缺失顯示「—」或隱藏；寫入日誌。核心組件介紹：Fallback Pattern、ILogger、Feature Flag。
- 難度: 初級
- 學習階段: 進階
- 關聯概念: B-Q8, D-Q2, D-Q3

### Q&A 類別 C: 實作應用類（10題）

C-Q1: 如何實作基礎版 Age.ascx 控制項？
- A簡: 建 .ascx＋Literal，後置定義屬性與計算流程，於 PreRender 設 Text。
- A詳: 具體實作步驟：1) 建立 Age.ascx，放置 Literal Id="lit"; 2) Age.ascx.cs 定義 public DateTime Birthday {get;set;} public string Pattern {get;set;}；3) PreRender 計算年、月、日並 String.Format 設定 lit.Text。關鍵程式碼片段或設定：years/months/days 使用 AddYears/AddMonths；Pattern 預設為 "{0} 年 {1} 個月"。注意事項與最佳實踐：屬性驗證、例外處理、以日期而非時間比較。
- 難度: 中級
- 學習階段: 核心
- 關聯概念: B-Q1, B-Q2, B-Q11

C-Q2: 如何在頁面中註冊並使用 <CH:Age>？
- A簡: 用 Register 指示詞註冊 .ascx，標記中放入控制項並設定屬性。
- A詳: 具體實作步驟：1) 頁首加入：<%@ Register TagPrefix="CH" TagName="Age" Src="~/Controls/Age.ascx" %>; 2) 於頁面插入：<CH:Age runat="server" Birthday="2000/05/20" Pattern="阿扁當總統已經 {0} 年 {1} 個月了" />。關鍵程式碼片段或設定：確保虛擬路徑正確。注意事項與最佳實踐：Birthday 格式採 yyyy/MM/dd；Pattern 與參數數量一致。
- 難度: 初級
- 學習階段: 基礎
- 關聯概念: A-Q19, B-Q2, D-Q9

C-Q3: 如何擴充輸出天數（{2}）？
- A簡: 計算剩餘天數並將 days 作為第三參數帶入 Pattern。
- A詳: 具體實作步驟：完成年與月累加後，var base = birthday.AddYears(y).AddMonths(m); var d = (today - base).Days; 最後 String.Format(pattern, y, m, d)。關鍵程式碼片段或設定：Pattern 如 "{0} 年 {1} 個月 {2} 天"。注意事項與最佳實踐：新增單元測試覆蓋月底/潤年。
- 難度: 中級
- 學習階段: 核心
- 關聯概念: A-Q18, B-Q10, B-Q13

C-Q4: 如何處理時區（以使用者所在區為準）？
- A簡: 用 TimeZoneInfo 將 UTC 轉使用者時區，僅取 Date 參與計算。
- A詳: 具體實作步驟：1) 取得使用者時區 Id；2) var nowUtc = DateTimeOffset.UtcNow; var tzNow = TimeZoneInfo.ConvertTime(nowUtc, tz); var today = tzNow.Date; 3) 以 today 計算年齡。關鍵程式碼片段或設定：TimeZoneInfo.FindSystemTimeZoneById。注意事項與最佳實踐：DST 切換日用 Date 避免時刻陷阱。
- 難度: 中級
- 學習階段: 核心
- 關聯概念: A-Q12, B-Q7, D-Q8

C-Q5: 如何為 2/29 出生者撰寫測試與實作處理？
- A簡: 測試非潤年對齊 2/28 或 3/01；實作明確選定策略並覆蓋。
- A詳: 具體實作步驟：撰寫測試：Birthday=2000-02-29，Target=2001-02-28 預期滿1歲；Target=2001-03-01 亦應滿1歲。關鍵程式碼片段或設定：使用 AddYears 使 2/29→2/28（.NET 預設）。注意事項與最佳實踐：在文件與設定中揭露該策略，避免歧義。
- 難度: 中級
- 學習階段: 核心
- 關聯概念: A-Q23, B-Q13, D-Q4

C-Q6: 如何加入每日失效的快取？
- A簡: 快取輸出字串，設定到期為下一個午夜（目標時區）。
- A詳: 具體實作步驟：計算 nextMidnight= today.AddDays(1); 使用 MemoryCache.Set(key, value, nextMidnight); 渲染前先查 cache。關鍵程式碼片段或設定：key 包含 Birthday|TimeZone|Pattern|Culture。注意事項與最佳實踐：避免快取污染（Pattern 變更須更新鍵）。
- 難度: 中級
- 學習階段: 核心
- 關聯概念: B-Q12, A-Q21, D-Q7

C-Q7: 如何本地化 Pattern 與數字格式？
- A簡: 將 Pattern 放入資源檔，依 Culture 載入，必要時自訂數字格式。
- A詳: 具體實作步驟：建立 AgeControl.resx 與地區化版本；於控制項讀取 ResourceManager.GetString("Pattern")；允許標記覆寫。關鍵程式碼片段或設定：Thread.CurrentUICulture 決定資源選取。注意事項與最佳實踐：中文需「個月」量詞；英文處理複數（year/years）。
- 難度: 中級
- 學習階段: 核心
- 關聯概念: B-Q14, A-Q13, D-Q10

C-Q8: 如何部署到 Community Server 或類似 CMS？
- A簡: 將 .ascx 放至允許目錄、在主版頁註冊並插入顯示區塊。
- A詳: 具體實作步驟：上傳 Age.ascx 至 Controls 資料夾；在 MasterPage 或 Widget 區註冊與放置；測試路徑。關鍵程式碼片段或設定：<%@ Register ... Src="~/Controls/Age.ascx" %>。注意事項與最佳實踐：遵守平台快取與安全規範，避免在全頁快取區塊內產生動態內容。
- 難度: 中級
- 學習階段: 核心
- 關聯概念: B-Q24, A-Q24, D-Q9

C-Q9: 如何在錯誤時優雅降級顯示？
- A簡: 顯示預設字串或「—」，並寫日誌，避免破壞版面。
- A詳: 具體實作步驟：try/catch 包裹計算與格式化；catch 時 lit.Text = DefaultText 或空白；記錄錯誤詳細（不外露）。關鍵程式碼片段或設定：DefaultText 可經由屬性設定。注意事項與最佳實踐：避免在 UI 顯示例外堆疊。
- 難度: 初級
- 學習階段: 核心
- 關聯概念: B-Q8, B-Q25, D-Q2

C-Q10: 如何加入前端 JavaScript 即時更新？
- A簡: 初始伺服端渲染；輸出 data-birthday；JS 定時計算更新文字。
- A詳: 具體實作步驟：控制項輸出 <span class="age" data-birthday="2000-05-20">6 年 7 個月</span>；前端讀取 data-birthday，以使用者本地時間用同樣邏輯（簡化）重算，設 setInterval 每日0點或每分鐘刷新。關鍵程式碼片段或設定：new Date("2000-05-20")。注意事項與最佳實踐：避免與伺服端衝突，顯示差異時以伺服端為準。
- 難度: 中級
- 學習階段: 進階
- 關聯概念: A-Q20, B-Q23, D-Q8

### Q&A 類別 D: 問題解決類（10題）

D-Q1: 顯示的月份不正確怎麼辦？
- A簡: 可能用了天數除以30/365。改用 AddYears/AddMonths 的曆法加法。
- A詳: 問題症狀描述：顯示月數與實際不符，尤其跨 31/30/28 天的月份。可能原因分析：以 TimeSpan 除以 30/365 近似，忽略月長差與潤年。解決步驟：改為以生日為基底，先累加年，再累加月，最後取天。預防措施：撰寫跨月與潤年單元測試，禁止使用平均換算。
- 難度: 初級
- 學習階段: 核心
- 關聯概念: A-Q8, B-Q4, B-Q10

D-Q2: 發生 FormatException：索引超出參數清單？
- A簡: Pattern 佔位符與傳入參數數量不一致。調整兩者相符。
- A詳: 問題症狀描述：拋出 FormatException。可能原因分析：Pattern 含 {2} 但只傳兩個參數，或佔位索引錯誤。解決步驟：檢查 Pattern，確保與傳入 years、months、days 對齊；或改 Pattern 為僅有 {0}{1}。預防措施：設定 Pattern 時即檢查；提供設計時驗證與預覽。
- 難度: 初級
- 學習階段: 核心
- 關聯概念: A-Q6, B-Q5, B-Q8

D-Q3: 生日字串無法解析（文化造成）怎麼辦？
- A簡: 明確使用標準格式或指定 Culture，改用 TryParseExact。
- A詳: 問題症狀描述：不同伺服器/部署後生日解析錯誤。可能原因分析：文化差異（MM/dd 與 dd/MM）。解決步驟：改採 yyyy-MM-dd 或 yyyy/MM/dd；在程式使用 DateTime.TryParseExact 指定多個允許格式與 CultureInfo.InvariantCulture。預防措施：文件規範輸入格式；加上格式驗證。
- 難度: 初級
- 學習階段: 核心
- 關聯概念: A-Q17, B-Q6

D-Q4: 2/29 出生者年齡在非潤年顯示異常？
- A簡: 明確採用 AddYears 策略（2/29 → 2/28），並撰寫對應測試。
- A詳: 問題症狀描述：遇非潤年進位邏輯混亂。可能原因分析：自行計算未定義策略或錯誤對齊日。解決步驟：統一使用 DateTime.AddYears 與 DaysInMonth；文件說明策略；補齊單元測試。預防措施：邊界條件測試覆蓋、避免手寫規則。
- 難度: 中級
- 學習階段: 核心
- 關聯概念: A-Q23, B-Q3, C-Q5

D-Q5: 為何同一天內年齡忽然多一個月/一年？
- A簡: 以時間（時刻）比較而非日期；或時區換日造成邊界錯。
- A詳: 問題症狀描述：在生日當天的某時刻才進位。可能原因分析：使用 DateTime.Now（含時分秒）比較；時區導致跨日。解決步驟：僅使用 Date 部分比較；「今天」以目標時區 Date 為準。預防措施：規範使用 .Date；時區統一轉換。
- 難度: 中級
- 學習階段: 核心
- 關聯概念: A-Q12, B-Q7, A-Q15

D-Q6: 輸入未來生日導致顯示負數或例外？
- A簡: 定義策略（顯示 0 或提示），捕捉並處理負差距情況。
- A詳: 問題症狀描述：顯示負年齡或拋例外。可能原因分析：未處理未來日期。解決步驟：若 today < birthday，回傳 0/0/0 或顯示「尚未到期」；禁止負值。預防措施：屬性設定加入檢查與單元測試覆蓋。
- 難度: 初級
- 學習階段: 核心
- 關聯概念: A-Q22, B-Q8

D-Q7: 效能不佳：高流量頁面每次都重算？
- A簡: 導入每日快取（至午夜），避免重複解析與計算。
- A詳: 問題症狀描述：CPU 占用升高。可能原因分析：每請求均計算與格式化。解決步驟：以 MemoryCache 快取輸出至下一個午夜（依時區）；重複使用已解析的 Birthday；財務級監控命中率。預防措施：OutputCache（若適用）、壓測與監控。
- 難度: 中級
- 學習階段: 核心
- 關聯概念: A-Q21, B-Q12, C-Q6

D-Q8: 不同使用者看到的年齡不同？
- A簡: 時區或前端即時計算造成差異；統一以伺服端為準或指定時區。
- A詳: 問題症狀描述：跨區用戶年齡差一天。可能原因分析：以本地時間計算、DST、前端更新邏輯不同。解決步驟：伺服端統一計算並標示所用時區；前端顯示不覆蓋伺服端結果或採同一時區。預防措施：設定用戶時區偏好；文件化基準。
- 難度: 中級
- 學習階段: 核心
- 關聯概念: A-Q12, B-Q7, C-Q10

D-Q9: 控制項在 CMS/Community Server 中不顯示？
- A簡: 檢查註冊、虛擬路徑與安全設定；確認區塊允許自訂控件。
- A詳: 問題症狀描述：頁面無輸出或錯誤。可能原因分析：未註冊 .ascx、路徑錯、放置於不可用區域、快取覆蓋。解決步驟：確認 Register 指示詞；調整 Src 路徑；放置於支援自訂的版位；停用該區塊快取測試。預防措施：依平台指引部署、建立檢查清單。
- 難度: 初級
- 學習階段: 核心
- 關聯概念: B-Q24, C-Q8

D-Q10: 中文顯示亂碼或在地化不正確？
- A簡: 設定正確編碼與 Culture/UICulture，Pattern 走資源檔。
- A詳: 問題症狀描述：中文亂碼或語句不合語法。可能原因分析：編碼非 UTF-8、資源檔遺漏、Culture 設錯。解決步驟：web.config 設 UTF-8；設定 Thread.CurrentUICulture；以資源檔管理 Pattern。預防措施：CI 檢查資源完整性；頁面標頭指定 meta charset。
- 難度: 初級
- 學習階段: 核心
- 關聯概念: B-Q14, C-Q7

### 學習路徑索引
- 初學者：建議先學習哪 15 題
    - A-Q1: 什麼是「年齡 User Control」？
    - A-Q2: 為什麼需要專門的年齡控制項？
    - A-Q3: 年齡計算的難點是什麼？
    - A-Q4: 格里曆（Gregorian）潤年規則是什麼？
    - A-Q6: Pattern（樣式）屬性是什麼？為何用 {0}、{1} 佔位？
    - A-Q7: 正確計算年齡需要哪些輸入條件？
    - A-Q8: 為什麼不能用「總天數/365、餘數/30」計算年齡？
    - A-Q9: 年齡資訊的核心價值是什麼？
    - A-Q10: 「年齡」與「時間間隔」有何差異？
    - A-Q17: Birthday 字串應採用何種格式較穩妥？
    - B-Q1: 年齡控制項的正確計算流程為何？
    - B-Q3: 潤年判斷機制如何實作？
    - B-Q5: Pattern 格式化的機制是什麼？
    - C-Q2: 如何在頁面中註冊並使用 <CH:Age>？
    - D-Q1: 顯示的月份不正確怎麼辦？

- 中級者：建議學習哪 20 題
    - A-Q11: 為什麼要用 AddYears/AddMonths 的「曆法加法」？
    - A-Q12: 為什麼時區會影響年齡顯示？
    - A-Q13: 在地化（i18n/l10n）對年齡顯示有何影響？
    - A-Q15: 年齡計算是否包含當天？邊界如何定義？
    - A-Q18: 是否能輸出「天」或更多單位？
    - A-Q19: 如何在部落格文章中顯示年齡？
    - A-Q21: 何時需要重算年齡？可否快取？
    - B-Q2: 控制項在 ASP.NET 的生命週期如何運作？何時計算最合適？
    - B-Q4: 為何用 AddYears/AddMonths 比直接用 TimeSpan 更正確？
    - B-Q6: 控制項屬性如何解析與驗證？
    - B-Q7: 時區處理的技術路徑是什麼？
    - B-Q10: 年、月、日的單位分解算法細節？
    - B-Q12: 快取機制如何設計才有效？
    - B-Q13: 試寫單元測試應涵蓋哪些邊界條件？
    - B-Q14: 在地化與資源管理如何落地？
    - B-Q15: 效能考量與最佳化有哪些？
    - C-Q1: 如何實作基礎版 Age.ascx 控制項？
    - C-Q3: 如何擴充輸出天數（{2}）？
    - C-Q4: 如何處理時區（以使用者所在區為準）？
    - D-Q3: 生日字串無法解析（文化造成）怎麼辦？

- 高級者：建議關注哪 15 題
    - A-Q20: 伺服端計算與用戶端（JavaScript）計算有何差異？
    - A-Q22: 若輸入的是未來日期，該如何處理？
    - A-Q23: 2月29日出生者的年齡如何計算？
    - B-Q16: 安全性需要注意什麼？
    - B-Q17: 如何設計可擴充輸出更多單位（天、小時）？
    - B-Q18: ViewState 與 ControlState 該如何使用？
    - B-Q19: Render 流程與輸出方式怎麼選？
    - B-Q20: 設計時（Design-time）與執行時行為如何處理？
    - B-Q21: 如何與資料繫結控制項整合？
    - B-Q22: 若要支援其他曆法（如農曆）應怎麼做？
    - B-Q23: 如何與 JavaScript 協作達到即時更新？
    - B-Q24: 在 Community Server 中整合的注意點？
    - B-Q25: 失敗時的容錯與降級策略是什麼？
    - C-Q6: 如何加入每日失效的快取？
    - D-Q8: 不同使用者看到的年齡不同？