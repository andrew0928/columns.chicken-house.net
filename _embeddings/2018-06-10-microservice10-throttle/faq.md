# 微服務基礎建設: 斷路器 #1, 服務負載的控制

# 問答集 (FAQ, frequently asked questions and answers)

## Q: 什麼是「服務量」(Service Throughput)？  
「服務量」就是單位時間內系統實際處理的工作量，例如每秒完成的訂單數、每分鐘處理的訊息數、每小時出貨件數等。本質上就是「單位時間 × 處理件數」的度量值，唯有先能量化並持續量測它，後續才有機會做預測、告警與控制。

## Q: 為什麼在談斷路器之前要先做服務量管控？  
斷路器(circuit breaker)的目的，是在服務即將或已經超載時「快速切斷」請求以保護整體系統。若沒有準確的服務量資料，就無法知道何時進入危險區，更談不上預先啟動斷路器或自動擴充。服務量管控相當於在電器上先標示「安全電流」，斷路器則是當電流超標時負責斷電的那一段。

## Q: 服務量管控跟斷路器究竟有什麼關聯？  
服務量管控提供「量化且可監控」的負荷指標，斷路器則依這些指標來決定是否對某服務暫停接受新請求、快速回錯或降級服務。沒有前者，後者只能憑錯誤率或逾時等被動訊號行動，往往已經太晚。  

## Q: 「如果要限制某 API 一分鐘最多呼叫 60 次」設計上需先回答哪兩個核心問題？  
1. 如何定義與實作流量計算方式：要用固定視窗、滑動視窗、漏桶還是令牌桶？演算法要能在分散式環境運行。  
2. 當流量超標時如何處理：直接拒絕？降級？排隊等待？或透過斷路器暫停服務？  

## Q: 只靠 API Gateway 或 NGINX 既有的 rate-limiting 功能就夠了嗎？  
不一定。當商業邏輯改成「每種類別商品每小時最多出貨 1,000 件」或「匝道每小時限 5,000 人次」時，這些需求往往超出通用 Gateway 的能力，開發人員仍需理解並能自行實作或擴充流量控制機制。

## Q: 架構師的價值是什麼？  
架構師的核心價值在於「跨 Dev 與 Ops」評估並導入最合適的解決方案：包含挑選現成的基礎建設、框架，或在沒有現成方案時帶領團隊自行開發「新的輪子」來解決問題，而非僅侷限在 CI/CD 流程。

## Q: CounterThrottle (固定視窗計數) 的主要缺陷是什麼？  
它在時間視窗切換的邊界會產生瞬間爆量：例如 5 秒視窗內配額 2,500 次，若在 0.1 秒內就把配額用完，剩餘 4.9 秒所有請求都會被拒絕，造成實際流量極不平穩，只適合最基本的限流或計費場景。

## Q: StatisticEngineThrottle (滑動視窗統計) 比 CounterThrottle 改善了哪裡？  
滑動視窗把「0–5 秒、1–6 秒…」區段連續平滑化，減少視窗邊界爆量問題，使實際流量較平穩；但本質仍是計數器機制，對突發流量的吸收能力有限。

## Q: Leaky Bucket 漏桶演算法的優點與缺點各是什麼？  
優點:  
1. 用固定速率「漏水」處理請求，讓後端負載呈現穩定水平線。  
2. 桶子(佇列)可吸收短暫尖峰，並提供「最大等待時間 = time window」的 SLA 指標。  
缺點:  
1. 高峰期間請求會被排隊而延遲執行，time window 越大延遲越久。  
2. 即使後端還有餘力，也只能用固定速率處理，可能使資源利用率降低。  

## Q: Token Bucket 令牌桶與 Leaky Bucket 有何差異？  
Token Bucket 先以固定速率往桶子加入令牌，請求只有拿到令牌才能被立即執行；因此：  
• 它允許在桶子有足夠令牌時出現短暫爆量，對後端資源利用較高。  
• 一旦令牌用罄，就需等待重新填滿(time window)，吸收下一波尖峰。  
• 不會產生排隊延遲，請求被接受後可立即處理。  

## Q: 如何利用漏桶/令牌桶的統計數據進行自動擴充(Scale-out)？  
可監控「Fail Requests」或桶子長度(剩餘令牌)等指標：  
1. 短時間內 Fail Requests 明顯增加 → 代表現有處理能力不足，可自動增加 worker 或服務實例。  
2. 擴充後處理速率調高，例如每個 worker 100 RPS，從 5 個增至 6 個即從 500 RPS 提升到 600 RPS，保持 time window 不變。  

## Q: 為何作者認為「掌握服務量」比「事後啟動斷路器」更關鍵？  
若能即時量測並預測服務量，系統可以在問題真正發生前：  
• 提前擴充(capacity planning)、動態調配資源；  
• 只對次要服務或客戶限流，保障關鍵交易；  
• 更精準地設定或打開斷路器，避免雪崩效應。  
這比等到錯誤率飆高或逾時才動作來得主動且安全。