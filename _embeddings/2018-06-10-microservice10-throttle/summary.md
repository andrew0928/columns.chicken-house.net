# 微服務基礎建設: 斷路器 #1, 服務負載的控制

## 摘要提示
- 服務量管控: 斷路器啟動前必須先量化並控制單位時間內的服務承載量。
- 面試與能力: 架構師須具備自行評估、實作或選型限流機制的能力，不能只依賴現成解決方案。
- Time Window問題: 只用固定時間窗口計數易在邊界產生尖峰，導致限制無效。
- Counter演算法: 最直覺的累計計數法，易受尖峰干擾，平滑度不足。
- 統計引擎: 透過滑動視窗統計改善Counter的斷層，但仍屬改良版。
- Leaky Bucket: 以固定出水速率及有限緩衝吸收尖峰，能保護後端但增加等待延遲。
- Token Bucket: 先行發放令牌預留處理能力，可在可控範圍內直接消化尖峰。
- 量測與視覺化: 文章提供Console+Excel方式輸出CSV，快速觀察各演算法效果。
- DevOps思維: 微服務治理需要開發與運維整合，限流、斷路器、服務發現等須協同設計。
- SLA 與 QoS: 透過標籤與限流策略，可為不同客戶或服務組提供差異化等級保證。

## 全文重點
本文為「微服務斷路器系列」首篇，聚焦在斷路器運作前提——「服務量控制」。作者先說明微服務治理的核心在於協調多服務行為，開發者若只依賴基礎架構而不了解限流原理，當需求變形就容易失控。文章以面試題為場景，引導讀者思考如何在程式層自訂服務量限制，並提供一組C#範本 `ThrottleBase` 讓讀者自行實作 `ProcessRequest`。  
接著作者介紹並比較四種常見限流演算法：  
1. Counter（固定窗口計數）：在指定時間窗內累加請求，超限即拒絕；實作簡單但邊界尖峰可能瞬間耗盡額度。  
2. 滑動統計（Statistic Engine）：利用滑動視窗平均值平滑統計，改善Counter邊界問題，仍屬計數型改良。  
3. Leaky Bucket（漏桶）：把請求當水倒入有限容量桶，固定速率漏出；能吸收尖峰並保護後端，但成功受理後可能延遲執行。  
4. Token Bucket（令牌桶）：後端按固定速率生成令牌存桶，收到請求須消耗令牌才能執行；兼具吸收尖峰與即時處理能力，利用率高。  
作者藉由多執行緒產生基準流量、尖峰流量及離峰空檔，將四種演算法跑出的統計數據輸出為CSV，再以Excel圖表觀察 `Success/Fail/Executed` 與 `AverageExecuteTime` 曲線，說明各演算法優缺點。  
文章最後強調：  
• 斷路器不應等到錯誤率升高後才觸發，若能掌握服務量就能預先分流、擴容或分級服務，避免雪崩。  
• 架構師須能跨開發與運維，結合服務發現、限流、斷路器、健康檢查與組態管理，打造可觀測、可自動調節的微服務平台。  
• 透過標籤化服務與差異化限流，亦可實作 QoS / SLA 策略。本文奠定後續斷路器、動態調度等進階主題的基礎。

## 段落重點
### 微服務の斷路器
闡述微服務雪崩效應：當某服務超載導致回應變慢，其他服務持續重試將放大問題。斷路器的目標是在負荷臨界前切斷呼叫，但前提是對「服務量」有準確量測；僅挑框架而不了解流量特性，難以真正保護系統。

### 如何定義「服務量」？
服務量即「單位時間內可處理的量」。應先決定計算規則：固定窗口累積、平均速率或其他。定義明確才能在程式邏輯中判斷是否受理請求，並配合斷路器或自動擴容。核心挑戰在於：計量方式、超限回應策略、分散式可行性。

### 題目: 抽象化的 ThrottleBase 類別
作者提出面試練習：繼承 `ThrottleBase`，實作 `ProcessRequest`。只要能判斷可否受理並在適當時機執行委派即可。並附上Console測試程式，產生基準流量、尖峰流量與離峰空檔，再輸出CSV便於視覺化分析。

### 解法 1, CounterThrottle
最直覺方式：在固定Time Window內累加計數，超限拒絕。優點是簡單，缺點是窗口邊界會形成尖峰，導致瞬時流量遠高於額定值。Time Window縮短可改善但運算成本變高，仍難保護後端。

### 解法 1.5, StatisticEngineThrottle
以滑動視窗統計平均值取代固定窗口，讓時間邊界更平滑，減少瞬時尖峰。但本質仍是計數式限流，對突發流量的吸收能力有限，屬於對CounterThrottle的改良版。

### 解法 2, Leaky Bucket
把請求放入有限容量桶，再以固定速率漏出並執行。優點：後端處理速率穩定、可吸收一定尖峰；缺點：請求可能在桶中等待，延遲上限受Time Window影響。適合需要保證最大等待時間的場景。

### 解法 3, Token Bucket
後端定期產生令牌，請求須消耗令牌才能被立即處理。相對Leaky Bucket可在保證吸收尖峰的同時即時執行，不增加排隊延遲；但需適當設計令牌填充速率與桶容量，以免令牌短缺導致拒絕率升高。

### 總結
作者總結各演算法優缺點並重申：要在災難發生前預防雪崩，需先精準掌握服務量並選用合適限流策略；再結合斷路器、自動擴容與服務分級，才能達到微服務的高可靠、高彈性與高可觀測性。限流機制並非僅靠現成工具即可萬事俱備，開發與運維團隊須具備自行評估與實作的能力。