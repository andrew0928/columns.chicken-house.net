---
source_file: "docs/_posts/2021/2021-06-04-slo.md"
generated_date: "2025-08-03 16:30:00 +0800"
version: "1.1"
tools:
  - github_copilot
  - claude_sonnet_3_5
model: "claude-3-5-sonnet-20241022"
---

# [架構師的修練] #2, SLO - 如何確保服務水準? - 生成內容

## Metadata

### 原始 Metadata
```yaml
layout: post
title: "[架構師的修練] #2, SLO - 如何確保服務水準? "
categories:
- "系列文章: 架構師的修練"
- "系列文章: 微服務架構"
tags: ["系列文章", "架構師的修練", "架構師觀點", "刻意練習", "SLO", "microservices"]
published: true
comments_disqus: false
comments_facebook: false
comments_gitalk: true
redirect_from:
logo: /wp-content/images/2021-06-04-slo/logo.png
```

### 自動識別關鍵字
keywords:
  primary:
    - SLO (Service Level Objective)
    - SLA (Service Level Agreement) 
    - SLI (Service Level Indicator)
    - 服務水準保證
    - 非同步系統
    - 分散式系統
    - 限制理論
    - DevOps
    - 微服務架構
    - 系統監控
  secondary:
    - Message Queue
    - 效能監控
    - 容量規劃
    - 瓶頸管理
    - 成本控制
    - 架構設計
    - 簡訊發送
    - 驗證碼服務
    - 量化指標
    - 回饋循環

### 技術堆疊分析
tech_stack:
  languages:
    - C#
    - .NET
  frameworks:
    - ASP.NET
    - .NET Framework
    - Message Queue
  tools:
    - Azure Functions
    - AWS Lambda
    - Docker
    - Container
    - RabbitMQ
    - 監控系統
  platforms:
    - Azure
    - AWS
    - Cloud Infrastructure
    - Windows Container
  concepts:
    - 限制理論 (Theory of Constraints)
    - DevOps
    - FaaS (Function as a Service)
    - 非同步處理
    - 水平擴展

### 參考資源
references:
  internal_links:
    - /2021/03/01/practice-01/
    - /2020/02/09/process-pool/
  external_links:
    - https://www.atlassian.com/incident-management/kpis/sla-vs-slo-vs-sli
    - https://azure.microsoft.com/zh-tw/services/functions/
    - https://aws.amazon.com/tw/lambda/
    - https://zh.wikipedia.org/wiki/%E6%9C%8D%E5%8A%A1%E7%BA%A7%E5%88%AB%E7%9B%AE%E6%A0%87
    - https://dotnetconf2020.study4.tw/
    - https://www.facebook.com/91apptech/posts/179657560398381
  mentioned_tools:
    - 91APP TechDay
    - .NET Conf 2020
    - Study4.TW
    - 限制理論
    - Process Pool

### 內容特性
content_metrics:
  word_count: 15000
  reading_time: "60 分鐘"
  difficulty_level: "高級"
  content_type: "技術實戰案例"

## 摘要 (Summaries)

### 文章摘要 (Article Summary)
作者以實際的簡訊發送系統為案例，詳細說明了如何在分散式系統中建立和維護服務水準保證 (SLO)。文章從 SLA/SLO/SLI 的基本概念出發，透過驗證簡訊發送的真實場景，展示了當系統面臨效能瓶頸時，如何運用限制理論和 DevOps 原則來系統性地解決問題。作者強調了量化監控的重要性，提出了完整的監控指標體系，包括回應時間、佇列長度、處理速度等關鍵指標。文章深入探討了分流策略、成本控制、容量規劃等實務解決方案，並說明如何在滿足服務水準的前提下控制營運成本。作者特別強調了跨領域知識整合的重要性，展示了技術能力、管理知識和架構思維如何結合起來解決複雜的系統問題，為架構師提供了完整的問題解決方法論和實務指導。

### 關鍵要點 (Key Points)
- SLO 必須從開發第一天就明確定義並建立量化監控機制
- 運用限制理論識別系統瓶頸並制定對應的改善策略
- 建立完整的 DevOps 回饋循環，持續監控和改善服務品質
- 透過分流設計優先處理高價值任務，提升整體系統效率
- 整合技術架構、成本控制和業務需求的平衡決策能力

### 段落摘要 (Section Summaries)

1. **開始前先想一想: 要解決的問題是什麼?**：作者以負責非同步任務執行系統的經驗為背景，說明了在 Cloud 環境下如何面對大量任務處理的挑戰。以外部訊息發送 (推播、簡訊、email) 為具體案例，當一天需要處理上百萬則通知且需在指定時間內完成時，產品經理和技術主管必須面對的核心問題。作者強調單純把程式寫好和效能調教並不足夠，必須結合 Cloud Infrastructure 知識和管理技巧，才能真正解決複雜的系統問題。

2. **何謂服務水準? 該如何量化與量測?**：作者詳細說明了 SLA/SLO/SLI 的概念差異和實務應用。以「99% 的 request 都必須在 300 msec 內完成回應」為例，說明如何定義 SLO 並建立對應的監控機制。介紹了燈號系統的概念，將監控指標分為綠燈 (150ms 以下)、黃燈 (150-200ms) 和紅燈 (200ms 以上) 三個等級，讓維運團隊能快速判斷系統狀況。強調了建立 DevOps 回饋循環的重要性，透過持續監控、分析和改善來提升系統品質。

3. **Case Study: 驗證簡訊的發送**：以真實的驗證簡訊發送案例說明 SLO 實作過程。驗證簡訊必須在 5 秒內發送出去，且有 5 分鐘的時效限制。當系統同時處理驗證簡訊和行銷簡訊時，大量行銷簡訊會導致 Message Queue 堆積，影響驗證簡訊的及時性。作者展示了從單一架構到分流架構的演進過程，說明如何透過系統分離來解決不同優先級任務的競爭問題。

4. **從開發的第一天就弄清楚 SLO**：作者強調必須從系統設計初期就明確定義 SLO，並建立對應的量化指標。以 5 秒的簡訊發送時間為例，將整個流程拆解為多個可測量的階段：前台處理時間 (A)、Message Queue 等待時間 (B)、Worker 處理時間 (C1)。透過在關鍵時間點記錄時間戳，開發團隊可以清楚掌握每個階段的效能表現，並利用監控服務來統計、顯示和警報。

5. **將限制理論套用到系統身上**：作者引入限制理論的概念，說明如何系統性地識別和處理系統瓶頸。當 Worker 成為瓶頸時，Message Queue 的 Queue Length 會增加，這成為重要的觀察指標。提出兩個對策：對策1 是分流處理，讓瓶頸優先處理高價值任務；對策2 是建立 "繩子" 機制，當系統超載時主動通知前端系統採取備案措施。透過公式「預計發送延遲時間 = Queue Length / 發送速率」來預測系統狀況。

6. **如果長時間無法滿足 SLO?**：當系統持續超載且無法在預期時間內處理任務時，作者提出了主動管理策略。由於驗證簡訊有時效性 (5 分鐘失效，用戶 30 秒後會放棄)，系統必須能預測處理延遲並主動通知前端。當延遲超過用戶忍耐極限時，前端可以採用替代方案 (如電話驗證) 或提示用戶稍後再試，避免資源浪費在無效的任務上。

7. **成本管控與 SLO 的平衡**：作者分享了如何整合成本監控到 SLO 管理中。由於雲端服務的費用通常是落後指標，團隊採用相對單位 (如 1 core + 2GB RAM + 1 hour 為 1 單位) 來即時監控成本變化。提出了三個角色分工：Infrastructure 團隊負責降低維持 SLO 所需的成本、Development 團隊負責應用程式設計和功能改善、Operation 團隊負責平衡 SLO 和成本的日常決策。

8. **多個任務競爭有限的資源(瓶頸)**：討論了更複雜的場景，當有限資源成為多個生產線的共同瓶頸時，如何進行資源分配和優先級管理。不同於單純追求速度的 SLO，有時更重要的是控制某些任務的處理速度，確保資源能保留給更重要的任務使用。這需要更精密的排程和資源管理策略，平衡不同任務的重要性和資源需求。

9. **知識連結的力量**：作者總結了整篇文章的核心思想，強調這不是單純的技術問題，而是需要整合多個領域知識的綜合性挑戰。要解決服務品質問題，需要結合基礎科學經驗、專案管理能力和工作管理經驗。作者鼓勵工程師不要只追求技術能力，應該累積不同領域的能力，透過知識連結來解決複雜問題，這正是架構師的核心價值所在。

## 問答集 (Q&A Pairs)

### Q1: SLA、SLO、SLI 三者有什麼區別？
Q: SLA、SLO、SLI 這三個概念有什麼不同？它們在系統運維中扮演什麼角色？
A: SLI (Service Level Indicator) 是服務水準指標，用來量測系統表現的具體指標；SLO (Service Level Objective) 是服務水準目標，定義了期待達成的服務水準；SLA (Service Level Agreement) 是服務水準協議，是與使用者達成的合約，包含未達標準時的處置和賠償條款。例如「99% 的 request 在 300ms 內回應」是 SLO，而實際的回應時間測量是 SLI，SLA 則是當未達成 SLO 時的賠償方案。

### Q2: 如何量化和監控系統的服務水準？
Q: 如何建立有效的監控機制來掌握系統的服務水準？
A: 首先要將 SLO 拆解為可測量的具體指標，在系統的關鍵節點記錄時間戳。以簡訊發送為例，可以記錄 (1) 收到 request、(2) 送進 message queue、(3) 從 queue 取出、(4) 完成發送等時間點，計算各階段耗時。建立燈號系統進行分級監控，使用成熟的監控服務收集數據，設定警報機制在指標異常時通知維運人員。

### Q3: 什麼是限制理論？如何應用在系統架構上？
Q: 限制理論如何幫助識別和解決系統瓶頸問題？
A: 限制理論認為系統的產能受限於最慢的環節（瓶頸），要提升整體效能就要專注改善瓶頸。在系統中，可以透過觀察 Message Queue 的 Queue Length 來識別瓶頸位置。解決方法包括：1) 讓瓶頸專注處理高價值任務（分流）；2) 建立「繩子」機制，當瓶頸超載時通知前端系統調整策略，避免無效工作堆積。

### Q4: 如何設計分流架構來處理不同優先級的任務？
Q: 當系統需要同時處理不同重要性的任務時，如何設計架構？
A: 從源頭就按照 SLO 要求將任務分開處理，使用獨立的 message queue 和 worker 來處理不同優先級的任務。例如將驗證簡訊和行銷簡訊分成兩套獨立架構，只針對 SLO 要求較高的驗證簡訊擴大 worker 數量。這樣高優先級任務不會被低優先級任務影響，能確保重要服務的品質。

### Q5: 如何預測系統處理延遲並採取主動措施？
Q: 當系統可能無法滿足 SLO 時，如何提前預警和處理？
A: 透過公式「預計發送延遲時間 = Queue Length / 發送速率」來預測延遲。需要掌握三個關鍵數據：實際處理速度、目前排隊訊息數量、任務的有效期限。當預測延遲超過用戶忍耐極限或任務有效期時，系統應主動通知前端採取備案措施，如改用其他驗證方式或提示用戶稍後再試，避免資源浪費在無效任務上。

### Q6: 如何在雲端環境中監控和控制成本？
Q: 在 Cloud 環境下如何整合成本管控到 SLO 管理中？
A: 由於雲端費用通常是落後指標，可以使用相對單位來即時監控成本變化，例如將「1 core + 2GB RAM + 1 hour」定義為 1 個成本單位。規範所有 worker 使用一致的規格，用應用程式啟動時間替代真正的基礎設施開關機時間。雖然會有誤差，但能提供及時的成本趨勢資訊，幫助維運團隊做出平衡 SLO 和成本的決策。

### Q7: 如何建立有效的 DevOps 回饋循環？
Q: 如何透過監控回饋來持續改善系統品質？
A: 建立「監控→分析→改善→驗證」的循環流程。設定明確的監控指標和警報條件，當指標出現異常時立即分析原因並採取改善措施。改善後重新評估效果，確認是否達到預期目標。定期檢討指標是否合理，根據市場變化調整 SLO 要求。透過持續的回饋循環，系統會不斷進化和改善。

### Q8: 架構師如何整合不同領域的知識來解決問題？
Q: 解決複雜的系統問題需要哪些跨領域的能力？
A: 需要整合技術能力、管理知識和架構思維。技術能力包括系統設計、效能優化、監控實作；管理知識包括資源分配、成本控制、團隊協作；架構思維包括全局視野、決策平衡、風險評估。例如 DevOps 背後是組織協作問題，SLO 是績效管理概念的應用。架構師的價值在於能夠連結這些不同領域的知識，找出最適合的解決方案。

### Q9: 如何在系統設計初期就考慮運維需求？
Q: 什麼是 Design For Operation？如何在設計階段就考慮監控和維運？
A: 從開發第一天就明確定義 SLO，並在系統設計中預先考慮監控需求。在關鍵節點埋設監控探針，確保所有重要指標都能被追蹤。設計時考慮如何拆解複雜指標為可觀測的簡單指標，建立間接或替代的監控方式。善用成熟的監控系統和 metrics API，讓監控成為系統的原生功能而非事後補強。

### Q10: 如何平衡服務品質和營運成本？
Q: 在追求高服務水準的同時，如何控制系統的營運成本？
A: 建立 SLO 和成本的關係圖，了解不同服務水準對應的資源需求。透過效能測試確定改善 SLO 所需的成本增加，例如從 5 秒改善到 1 秒需要多少倍的資源。找出業務可接受的 SLO 和成本範圍，在交集區域內尋找最佳解決方案。透過架構優化（如 process pool）來降低達成特定 SLO 所需的成本，讓技術改善產生明確的商業價值。

## 解決方案 (Solutions)

### P1: 系統效能瓶頸識別與解決
Problem: 當系統面臨效能瓶頸時，如何系統性地識別問題並制定解決策略
Root Cause: 缺乏量化的監控指標和系統性的分析方法，無法準確定位瓶頸位置
Solution:
- 建立完整的監控體系，在系統關鍵節點埋設時間戳記錄
- 運用限制理論識別真正的瓶頸資源
- 觀察 Message Queue Length 等緩衝區指標來判斷瓶頸位置
- 制定分流策略，讓瓶頸資源優先處理高價值任務
- 建立「繩子」機制，在超載時主動通知前端系統調整策略

Example:
```
監控指標設計：
{A} = 前台處理時間 = {送進 queue 時間} - {收到 request 時間}
{B} = Queue 等待時間 = {從 queue 取出時間} - {送進 queue 時間}  
{C} = Worker 處理時間 = {完成處理時間} - {從 queue 取出時間}
總回應時間 = {A} + {B} + {C} < SLO 目標時間
```

### P2: 服務水準保證 (SLO) 的建立與維護
Problem: 如何從概念階段就建立明確的 SLO 定義並持續監控維護
Root Cause: SLO 定義模糊，缺乏量化指標和有效的監控機制
Solution:
- 從開發第一天就明確定義 SLO，例如「99% 的 request 在 300ms 內回應」
- 將 SLO 拆解為可測量的 SLI (Service Level Indicator)
- 建立燈號系統：綠燈(安全)、黃燈(注意)、紅燈(警告)
- 設置自動化監控和警報機制
- 建立 DevOps 回饋循環，持續改善

Example:
```yaml
SLO_Definition:
  target: "驗證簡訊 5 秒內發送完成"
  indicators:
    - frontend_processing_time: < 1 sec
    - queue_waiting_time: < 2 sec  
    - worker_processing_time: < 2 sec
  monitoring:
    green_light: < 3 sec
    yellow_light: 3-4 sec
    red_light: > 4 sec
```

### P3: 不同優先級任務的資源分配
Problem: 當系統需要同時處理不同重要性的任務時，低優先級任務會影響高優先級任務的執行
Root Cause: 所有任務共用相同的處理資源，缺乏優先級區分機制
Solution:
- 從源頭按照 SLO 要求分離不同優先級的任務
- 設計獨立的 message queue 和 worker 架構
- 針對高 SLO 要求的任務配置更多資源
- 實施分流策略，確保重要任務不受影響
- 建立資源動態調整機制

Example:
```
分流架構設計：
高優先級路徑: [前端] → [驗證簡訊 Queue] → [專用 Workers]
低優先級路徑: [前端] → [行銷簡訊 Queue] → [共用 Workers]

資源配置：
- 驗證簡訊：5x Workers, 高規格 Queue
- 行銷簡訊：2x Workers, 標準規格 Queue
```

### P4: 系統超載時的主動管理策略
Problem: 當系統持續超載無法滿足 SLO 時，如何避免資源浪費並維持核心服務
Root Cause: 系統缺乏預測能力，無法在超載時採取主動措施
Solution:
- 建立延遲預測機制：預計延遲 = Queue Length / 處理速率
- 設定任務有效期限和用戶忍耐極限閾值
- 當預測延遲超過閾值時，主動通知前端系統
- 提供備案機制，如替代驗證方式或延後處理
- 避免無效任務繼續占用系統資源

Example:
```csharp
// 延遲預測與主動管理
public class OverloadManager 
{
    public bool ShouldRejectNewTask(int queueLength, int processingRate, int timeoutThreshold)
    {
        var predictedDelay = queueLength / processingRate;
        return predictedDelay > timeoutThreshold;
    }
    
    public string GetAlternativeAction(TaskType taskType)
    {
        return taskType switch 
        {
            TaskType.SmsVerification => "使用電話驗證替代方案",
            TaskType.EmailNotification => "安排批次處理",
            _ => "請稍後再試"
        };
    }
}
```

### P5: 成本控制與 SLO 平衡
Problem: 如何在滿足服務水準要求的同時控制雲端運算成本
Root Cause: 缺乏即時的成本監控機制，無法在 SLO 和成本之間找到平衡點
Solution:
- 建立相對成本單位制，即時監控成本變化
- 建立 SLO-成本關係圖，了解改善成本
- 透過架構優化降低達成特定 SLO 的資源需求
- 實施三層分工：基礎設施優化、應用程式改善、運維決策
- 定期評估和調整 SLO 目標與成本預算

Example:
```yaml
Cost_Control_Strategy:
  relative_unit: "1 core + 2GB RAM + 1 hour = 1 unit"
  slo_cost_mapping:
    "5_sec_slo": 2 units
    "3_sec_slo": 5 units  
    "1_sec_slo": 15 units
  optimization_targets:
    infrastructure: "降低單位成本"
    development: "改善應用效率"
    operations: "平衡 SLO 與成本"
```

### P6: DevOps 回饋循環的建立
Problem: 如何建立有效的監控回饋機制來持續改善系統品質
Root Cause: 缺乏系統性的回饋循環，改善措施無法有效驗證和持續
Solution:
- 建立「監控→分析→改善→驗證」的完整循環
- 設定自動化的監控和警報系統
- 定期檢討和調整監控指標
- 建立改善措施的效果追蹤機制
- 培養持續改善的團隊文化

Example:
```
DevOps 循環實施：
1. 監控：實時收集 SLI 數據
2. 分析：識別趨勢和異常模式
3. 改善：制定和執行改善方案
4. 驗證：評估改善效果
5. 調整：根據結果調整策略
6. 重複：持續執行循環
```

## 版本異動紀錄

### v1.1 (2025-08-03)
- 依據 embedding-structure.instructions.md v1.1 規範建立
- 採用第三人稱敘述方式撰寫摘要
- 加入生成工具和模型資訊

### v1.0 (2025-08-03)
- 初始版本
