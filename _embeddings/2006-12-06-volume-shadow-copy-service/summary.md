# Volume Shadow Copy Service ...

## 摘要提示
- VSS 定義: Windows 2003 提供的底層快照服務，透過 copy-on-write 方式保留檔案狀態
- Copy-on-write 機制: 先標記再延後複製，更新時才複製原資料，快照建立極快速
- Provider 架構: VSS 支援軟硬體提供者，供 SQL、Exchange、備份軟體擴充進階功能
- 內建功能概覽: 可於磁碟內容啟用 Shadow Copy，透過網路芳鄰檢視與還原歷史版本
- 實務需求差距: 需要真正複製、避免鎖檔衝突、可隨時執行且能寫批次檔
- 解決思路: 先作快照、從快照來源進行備份、完成後刪除快照
- 關鍵工具: vssadmin 建立/刪除快照；以 UNC 路徑直接讀取快照內容
- UNC 快照路徑: 使用 @GMT-時間戳 的特殊路徑讀取特定時間點資料
- 範例命令: RAR.exe 直接對快照路徑打包，避開鎖檔與更新中的檔案
- 版本限制: 完整作法適用 Windows Server 2003，XP 不完整，期望 Vista 類似支援

## 全文重點
本文介紹 Windows Server 2003 的 Volume Shadow Copy Service（VSS），強調其非傳統備份機制，而是在檔案系統下方以 copy-on-write 方式提供即時快照。其特點是快照建立極快，建立時僅標記狀態，直到資料被修改才複製原始區塊，讓系統能即時保留某一時刻的檔案視圖。VSS 具備 provider 架構，讓如 SQL Server 2005、Exchange 2007、System Center Data Protection Manager 2006 等解決方案在其上實作資料庫快照、完整備份與複寫等進階能力。

在一般用戶端上，Windows 2003 內建功能可於磁碟內容啟用 Shadow Copy，並在網路芳鄰的分享資料夾中檢視與還原歷史版本。然而作者實務上需要的是更可靠且可隨時觸發的「實體複製」備份，並要避免因檔案鎖定或更新中導致備份不一致。為此，作者設計流程為：備份前先建立快照，之後所有備份從快照讀取，完成後刪除快照。如此即使原始資料在備份時仍在變動，也不影響備份的一致性。

要將流程自動化為批次檔，關鍵在兩點：一是用 vssadmin.exe 以命令列建立與刪除快照；二是掌握 VSS 對外提供快照的 UNC 路徑格式，以 @GMT-時間戳記指向特定快照時間點。作者示範以 RAR.exe 直接從該快照路徑打包複製，例如 RAR.exe a -r c:\backup.rar \\nest\Home\@GMT-2006.11.28-23.00.01，藉此避開鎖檔問題與中斷應用程式的需求。文末指出此作法在 Windows XP 上支援不完整，現階段以 Windows Server 2003 為主，並好奇 Vista 是否具備可用的對應功能。

## 段落重點
### 服務簡介與時效性
作者開場點出 Windows Server 2003 的 VSS 雖非全新，但實用性高。VSS 位於檔案系統以下層級，能為儲存裝置建立時間點快照，與傳統備份不同，採用 copy-on-write 機制保存某一時刻的資料視圖，便於隨時回溯檔案內容。此定位讓 VSS 更像是一種即時一致性的資料視圖提供者，而非完整資料複製的備份工具。

### Copy-on-write 機制與效能
VSS 的快照建立極快，達到 0.x 秒等級，建立時僅對當前資料狀態做標記，不立即複製資料。只有當已納入快照的資料即將被更新時，系統才先將原始資料複製到快照儲存區，再對現況進行更新。此流程確保快照對應時間點的資料不被後續變動破壞，並大幅降低建立快照時的 I/O 與時間成本。

### Provider 架構與生態整合
VSS 提供可插拔的 provider 架構，允許第三方或硬體廠商實作更高效或具特定功能的快照機制。微軟自家應用如 SQL Server 2005 可在資料庫層面提供快照功能，Exchange 2007 也藉由 VSS 實現更完整的備份與複寫；Data Protection Manager 2006 以及其他備份軟體亦能受惠，整體形成生態系統的進階資料保護能力。

### 內建使用方式與基本操作
在 Windows 2003 中，使用者可於磁碟內容頁啟用 Shadow Copy，排程定期建立快照。完成後，透過網路芳鄰瀏覽分享資料夾時，會出現額外選項，可檢視歷史版本與還原特定時間的檔案。這對一般使用情境（如不小心覆寫、需要回復舊版）相當便利，但仍屬於系統內建、排程導向的被動使用方式。

### 現實需求與限制差距
作者的需求超越內建功能：需要將資料實際複製出去（而非僅保留快照指標）、在備份過程中避免檔案鎖定或正在更新造成的不一致、並能隨時執行（非只能依排程），最好可寫成批次檔自動化。這揭示了 VSS 作為快照與一致性來源的價值，但仍須搭配外部工具實現真正的備份產物。

### 解決方案設計與流程
提出的解法採三步驟：一是開始備份前先建立快照，固化當前檔案狀態；二是備份作業一律從快照讀取資料，避免鎖檔與寫入競爭，確保一致性；三是備份後可刪除快照（或保留）。此模式將快照作為「穩定讀取來源」，讓備份工具可無縫運作，而不需強迫停止服務或關閉應用程式。

### 自動化關鍵與命令列工具
為了用批次檔一次完成，關鍵有二：使用 vssadmin.exe 以命令列建立與刪除快照；以及利用 VSS 對外暴露的 UNC 路徑直接讀取快照內容。VSS 會以 @GMT-YYYY.MM.DD-HH.MM.SS 的時間戳標示特定快照點，並可由本機或網路透過 UNC 路徑存取，將快照視為唯讀的穩定來源，供各種備份工具串接。

### 快照 UNC 路徑與備份範例
快照可透過類似 \\localhost\d$\@GMT-2006.11.28-23.00.01 的路徑直接讀取。若要備份 \\nest\Home 的歷史版本，只需在路徑後附上對應的 @GMT 標記。作者示範以 RAR.exe 進行壓縮備份：RAR.exe a -r c:\backup.rar \\nest\Home\@GMT-2006.11.28-23.00.01。此方式等同對穩定的歷史視圖打包，不受現況檔案鎖定或更新干擾。

### 實作成效與經驗回饋
找到命令列建立/刪除快照與存取快照的 UNC 路徑兩大關鍵後，長期備份痛點迎刃而解：不再因檔案鎖定或需關閉程式而受阻，備份流程更順暢。這種做法讓快照成為備份的一致性隔離層，再交由壓縮或複製工具產生實際備份件，兼顧效率與可靠性。

### 版本適用性與期望
文末指出 Windows XP 的 VSS 支援不完整，無法如同 Windows Server 2003 般全面應用上述流程；目前解法以 2003 為主。作者並好奇後續的 Windows Vista 是否會提供可用的等效能力，作為日常端點環境的延伸支援，以便廣泛複製此工作流。

## 資訊整理

### 知識架構圖
1. 前置知識：
   - 檔案系統與備份基礎（備份 vs 快照的差異）
   - Windows 伺服器與網路分享（UNC 路徑、權限、管理分享如 C$/D$）
   - 命令列操作與批次檔
   - 鎖檔/一致性概念（應用程式運行時檔案狀態）

2. 核心概念：
   - VSS（Volume Shadow Copy Service）：在檔案系統層以下提供的快照機制
   - Copy-on-Write：快照建立幾乎即時，後續在資料變更時才拷貝舊塊保存
   - Provider/Writers 架構：系統/應用可透過 VSS 提供一致性快照（如 SQL/Exchange/DPM）
   - 快照存取方式：透過 UNC 路徑的 @GMT-時間戳 直接讀取快照內容
   - 快照輔助備份流程：先拍快照，再從快照讀取進行備份，避免鎖檔與變更衝突

3. 技術依賴：
   - 作業系統支援：Windows Server 2003 提供完整 VSS 功能（XP 不完整，Vista 未知）
   - VSS 服務與 vssadmin 工具（建立/刪除/列出快照）
   - 應用程式 Writers/Providers（SQL Server 2005、Exchange 2007、DPM 2006 等）
   - 儲存空間：快照以變更量佔用空間（非完整複本）

4. 應用場景：
   - 進行檔案/資料夾備份時避免檔案被鎖或內容變動
   - 使用者自助還原「之前版本」的檔案
   - 對資料庫/郵件系統進行一致性快照（配合應用 Writers）
   - 以批次/腳本方式自動化備份作業與排程

### 學習路徑建議
1. 入門者路徑：
   - 了解備份與快照差異、Copy-on-Write 是什麼
   - 在 Windows Server 2003 啟用 Shadow Copies，於磁碟內容中手動建立快照
   - 透過網路芳鄰/「之前版本」功能檢視與還原檔案

2. 進階者路徑：
   - 學會使用 vssadmin 建立/刪除/列出快照
   - 熟悉 @GMT-YYYY.MM.DD-HH.MM.SS 的 UNC 存取方式
   - 以批次檔整合壓縮/複製工具（如 RAR.exe、Robocopy）從快照讀取資料
   - 設計保留策略與磁碟空間監控，避免快照佔滿空間

3. 實戰路徑：
   - 實作流程：建立快照 → 從快照路徑備份 → 驗證備份 → 刪除快照
   - 規劃排程（排程器）與失敗重試、記錄與警示
   - 若涉及應用資料（SQL/Exchange），整合對應的 VSS Writer 以確保一致性
   - 定期演練還原，驗證 RPO/RTO 與權限/存取可行性

### 關鍵要點清單
- Copy-on-Write 機制：快照建立即時，僅在資料變更時保留舊資料塊（優先級: 高）
- 快照 vs 備份：快照非真正複本，備份需將資料另行複製到其他儲存（優先級: 高）
- VSS 架構與 Providers/Writers：允許由系統或應用進行一致性快照（優先級: 高）
- 快照建立速度：建立在 0.x 秒等級，對線上服務影響低（優先級: 中）
- vssadmin 使用：命令列建立/刪除/列出快照的核心工具（優先級: 高）
- 快照 UNC 存取：使用 @GMT-時間戳的路徑直接讀取快照內容（優先級: 高）
- 批次備份流程：先拍快照、從快照讀、完成後刪快照以避免鎖檔（優先級: 高）
- GUI 之前版本：透過網路芳鄰/檔案屬性檢視與還原過去版本（優先級: 中）
- 與應用整合：SQL Server 2005、Exchange 2007、DPM 2006 等可受惠 VSS（優先級: 中）
- 儲存空間管理：快照會隨變更成長，需規劃上限與清理（優先級: 中）
- 一致性與鎖定：對活躍資料建議使用應用 Writer 以確保交易一致性（優先級: 高）
- 權限與安全：存取 \\host\d$ 等管理分享需管理員權限（優先級: 中）
- 平台限制：Windows XP 的 VSS 不完整，文中方法以 Server 2003 為主（優先級: 高）
- 備份工具選擇：可用 RAR.exe、Robocopy、XCopy 等從快照讀取（優先級: 中）
- 快照生命週期：完成備份後評估是否保留或刪除快照，避免累積風險（優先級: 中）