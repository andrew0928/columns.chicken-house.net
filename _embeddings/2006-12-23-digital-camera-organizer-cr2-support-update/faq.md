# 歸檔工具更新 - .CR2 Supported

## 問題與答案 (FAQ)

### Q&A 類別 A: 概念理解類

A-Q1: 什麼是 .CR2？
- A簡: .CR2 是 Canon DSLR 的 RAW 檔格式，保留感光元件原始資料，動態範圍大、後製彈性高。
- A詳: .CR2（Canon Raw Version 2）是 Canon 數位單眼常見的 RAW 格式，直接儲存感光元件的線性原始資料與豐富的拍攝中繼資料。它不進行相機內部壓縮與色彩調整，保留更大寬容度與編輯空間，適合後製需求高的攝影與工作流程，例如專業修片、色彩管理與影像檔案歸檔。
- 難度: 初級
- 學習階段: 基礎
- 關聯概念: A-Q2, A-Q3, B-Q6

A-Q2: 什麼是 RAW 檔？
- A簡: RAW 是相機原始感光資料，未經相機銳化與壓縮，保留完整資訊供後製。
- A詳: RAW 檔是相機感光元件的原始輸出，尚未套用白平衡、銳利化或壓縮等處理。與 JPG 不同，RAW 提供更廣動態範圍、更高位元深度與更多調整空間，能在後製時精準控制曝光、色溫與色調曲線，因此成為專業攝影與影像管理中，保存母檔與長期歸檔的理想格式。
- 難度: 初級
- 學習階段: 基礎
- 關聯概念: A-Q1, A-Q3, A-Q5

A-Q3: RAW 與 JPG 的差異？
- A簡: RAW 保留原始資料與高寬容度；JPG 經壓縮與處理，體積小、相容性佳，後製彈性較低。
- A詳: RAW 含完整原始資料與高位元深度，具備最大後製彈性，但體積大且須專用解碼器。JPG 則是相機內部完成白平衡、銳利化與壓縮後的成品影像，檔案小且易分享，但後製調整空間有限。工作流程中常用 RAW 作母檔歸檔、JPG 作快速檢視與交付。
- 難度: 初級
- 學習階段: 基礎
- 關聯概念: A-Q2, A-Q8, A-Q9

A-Q4: 什麼是 .THM 縮圖檔？
- A簡: .THM 通常是相機產生的縮圖與中繼資料檔，供快速預覽與提供 EXIF 來源。
- A詳: 在部分相機與舊世代 RAW 流程中，拍攝 RAW 會伴隨 .THM（thumbnail）檔作為預覽與中繼資料容器。THM 多為小尺寸 JPEG，內含 EXIF 可供後續轉檔或歸檔使用。文中指出 .CR2 案例未附 THM，導致轉出 JPG 無完整 EXIF，影響後續管理與檢索。
- 難度: 初級
- 學習階段: 基礎
- 關聯概念: A-Q5, A-Q7, B-Q7

A-Q5: EXIF 是什麼？為何重要？
- A簡: EXIF 為影像中繼資料，記錄相機參數、時間與裝置資訊，利於檢索與管理。
- A詳: EXIF（Exchangeable Image File Format）儲存拍攝資訊如曝光、ISO、鏡頭、相機型號、時間與有時包含縮圖。在歸檔與資產管理中，EXIF 是分類、搜尋、比對與追蹤來源的基礎。若轉檔流程未保留完整 EXIF，將不利後續的管理、索引與問題追溯。
- 難度: 初級
- 學習階段: 基礎
- 關聯概念: A-Q4, A-Q7, B-Q11

A-Q6: 為什麼需要支援 .CR2？
- A簡: .CR2 為常見 Canon RAW 格式，支援能改善相容性並滿足專業歸檔需求。
- A詳: 支援 .CR2 代表工具能直接處理 Canon DSLR 的主流 RAW 格式，擴大實務相容性。文中作者取得 20D 的樣本檔驗證後，確認 Microsoft 封裝的 RAW wrapper 可用，意味流程可共用既有架構，降低開發維護成本，提升用戶在歸檔與轉檔上的效率與覆蓋率。
- 難度: 初級
- 學習階段: 核心
- 關聯概念: B-Q6, C-Q1, C-Q5

A-Q7: 文中 .CR2 無 .THM 造成什麼影響？
- A簡: 轉出的 JPG 無完整 EXIF；若僅靠轉檔流程，將損失關鍵中繼資料。
- A詳: 作者發現 .CR2 案例未附帶 .THM，導致原本以 THM 為 EXIF 來源的轉檔流程失效。結果是 RAW→JPG 的產物缺少完整 EXIF（尤其 MakerNotes），不利歸檔、檢索與追蹤。這促使策略改變：避開無意義的轉檔，直接使用相機同時儲存的原尺寸 JPG。
- 難度: 初級
- 學習階段: 核心
- 關聯概念: A-Q4, A-Q5, A-Q9

A-Q8: 高階相機另存原尺寸 JPG 的意義？
- A簡: 省去離線轉檔時間，兼顧即時交付與保留 RAW 後製彈性。
- A詳: 高階相機提供 RAW+JPG 選項，能同時產生原尺寸 JPG 成品與 RAW 母檔。實務上，JPG 可立即用於預覽、分享或初步交付；RAW 作為最高品質來源，保留後製彈性。此模式讓外部工具不必重複進行 RAW→JPG 轉檔，縮短流程並避免 EXIF 損失。
- 難度: 初級
- 學習階段: 核心
- 關聯概念: A-Q3, A-Q9, B-Q8

A-Q9: 為什麼作者決定不做 .CR2→.JPG 轉檔？
- A簡: 相機已產出原圖大小 JPG，且無 THM 導致 EXIF 不完整，轉檔價值低。
- A詳: 在 .CR2 未帶 THM 的情況下，工具無法完整帶出 EXIF；同時 Canon DSLR 可直接儲存原尺寸 JPG，滿足檢閱與交付。綜合成本、品質與價值，維持 RAW 母檔與相機出 JPG 的策略更合理，因此作者選擇省略 .CR2 的離線轉檔工作。
- 難度: 初級
- 學習階段: 核心
- 關聯概念: A-Q7, A-Q8, B-Q7

A-Q10: 文中的 Microsoft 包裝（wrapper）是什麼？
- A簡: Microsoft 提供的 RAW 影像處理封裝，統一 API，讓不同 RAW 格式一致解碼。
- A詳: 作者使用 Microsoft 提供的 RAW 影像處理函式庫（文中稱 wrapper），其介面一致，能「通通都吃」多種 RAW 格式，簡化多格式支援。這種封裝屏蔽底層編解碼差異，提高開發一致性與維護性，但相依於外部編解碼器的支援範圍與穩定性。
- 難度: 中級
- 學習階段: 核心
- 關聯概念: B-Q6, B-Q17, D-Q1

A-Q11: 什麼是 MediaFiler？
- A簡: MediaFiler 是工具內專責處理特定媒體檔案的元件或處理器。
- A詳: MediaFiler 可視為策略物件，負責辨識、處理與轉換特定副檔名的影像或媒體檔。它們透過屬性標註副檔名，並由工廠模式在執行期指派適當處理器，達到鬆耦合、可擴充與易於加入新格式支援的目標。
- 難度: 中級
- 學習階段: 核心
- 關聯概念: A-Q12, B-Q1, B-Q3

A-Q12: 什麼是 MediaFilerFileExtensionAttribute？
- A簡: 一個用於宣告 MediaFiler 可處理哪些副檔名的屬性標註。
- A詳: MediaFilerFileExtensionAttribute 用於把處理器與副檔名關聯起來。文中更新後，該屬性可用逗號指定多個副檔名，一個 MediaFiler 能同時承擔多種格式，簡化型別數量與維護成本，並配合工廠模式動態選用。
- 難度: 中級
- 學習階段: 核心
- 關聯概念: A-Q13, B-Q2, C-Q2

A-Q13: 為什麼需要多副檔名支援？
- A簡: 降低處理器類別數量，讓同質流程覆蓋多格式，提高擴充效率。
- A詳: 多數 RAW 格式在處理流程上類似，差異集中在解碼器層。支援多副檔名能讓一個 MediaFiler 共用流程（掃描、分類、搬移、命名），只在解碼器或設定上分流，減少重複程式碼並加快新格式接入。
- 難度: 中級
- 學習階段: 核心
- 關聯概念: A-Q12, B-Q4, C-Q3

A-Q14: 工廠模式（Factory Pattern）在此扮演什麼角色？
- A簡: 依副檔名動態建立對應 MediaFiler，解耦呼叫端與具體類別。
- A詳: 工廠模式將「如何選擇處理器」封裝起來，呼叫端僅提供副檔名，工廠依屬性標註映射回傳正確 MediaFiler。文中 Create() 更動支援一對多，讓單一處理器可服務多副檔名，提升彈性與相容性。
- 難度: 中級
- 學習階段: 核心
- 關聯概念: B-Q3, C-Q3, D-Q5

A-Q15: Create() 改動的核心價值是什麼？
- A簡: 讓一個 MediaFiler 可處理多個副檔名，減少類別與配置複雜度。
- A詳: 將屬性改為可宣告多副檔名後，Create() 的選擇邏輯需能解析逗號清單並建立映射。其價值在於用較少處理器型別覆蓋更多格式，降低維護成本，並簡化配置與測試。
- 難度: 中級
- 學習階段: 核心
- 關聯概念: A-Q12, A-Q14, B-Q4

A-Q16: 什麼是 pattern.cr2 設定？
- A簡: 為 .CR2 新增的配置區段，用於控制命名、分類或輸出行為。
- A詳: 文中指出為支援新副檔名，設定檔新增 pattern.cr2。此類 pattern 通常用於定義檔名模板與目錄規劃（例如依日期、相機型號），或控制行為（是否轉檔）。藉此使新增格式的工作流與既有格式一致可控。
- 難度: 中級
- 學習階段: 核心
- 關聯概念: B-Q5, C-Q4, D-Q4

A-Q17: 為什麼 .CR2 常見情境下不附 .THM？
- A簡: 文中案例顯示 .CR2 未伴隨 .THM，應為設計取向改以內嵌預覽。
- A詳: 與早期部分 RAW 流程不同，許多新世代 RAW 格式將預覽圖與中繼資料內嵌於 RAW，而非旁掛 .THM。文中觀察到 .CR2 未附 THM，顯示工具需調整策略，避免依賴 THM 來源來補 EXIF。
- 難度: 中級
- 學習階段: 核心
- 關聯概念: A-Q4, B-Q7, D-Q2

A-Q18: 相機內預覽與電腦解碼差異？
- A簡: 相機多以內嵌 JPEG 預覽；電腦則用編解碼器重建 RAW 成像。
- A詳: 相機的預覽常取用 RAW 內嵌的 JPEG，並套用相機風格設定，因此即便 RAW 本體特殊，預覽仍正常。電腦端需依 RAW 編解碼器解譯原始資料，若編解碼器不支援或遇到邊界情況，可能失敗或顯示異常，產生體驗落差。
- 難度: 中級
- 學習階段: 核心
- 關聯概念: B-Q10, D-Q1, D-Q10

A-Q19: 什麼是樣本檔（sample file）在開發中的價值？
- A簡: 驗證相容性、覆蓋邊界情境，確保功能與穩定性。
- A詳: 實際樣本檔能驗證不同機種、不同設定下的行為，避免僅靠規格推論導致缺陷。文中作者透過 20D 拍攝的樣本檔測試 .CR2 支援，確認 wrapper 相容並調整流程，以資料驅動的方式完善功能。
- 難度: 初級
- 學習階段: 基礎
- 關聯概念: B-Q19, C-Q9, D-Q1

A-Q20: 5D 與 20D 在文中的角色？
- A簡: 啟發與驗證來源；5D 啟發需求，20D 提供樣本檔測試。
- A詳: 使用者詢問 5D 的 .CR2 支援引發需求；公司同事 20D 提供樣本檔，讓作者能在真實資料上驗證 wrapper 與流程。兩者在需求與驗證鏈上相輔相成。
- 難度: 初級
- 學習階段: 基礎
- 關聯概念: A-Q6, A-Q19, B-Q19

A-Q21: 什麼是外接閃光燈（外閃）？
- A簡: 安裝於相機熱靴的獨立閃燈，亮度高、可控性強。
- A詳: 外閃具備較高輸出、可調反光與閃光模式，支援 TTL 測光與離機引閃。文中提及外閃未及回電導致未觸發，造成 RAW 曝光嚴重不足，進而讓某些解碼器在電腦端解碼失敗。
- 難度: 初級
- 學習階段: 基礎
- 關聯概念: A-Q18, D-Q10, B-Q20

A-Q22: 為何外閃未回電可能影響 RAW 解碼？
- A簡: 邊界拍攝狀態寫入異常或極端曝光，可能觸發解碼器 bug。
- A詳: 外閃未觸發時，EXIF/廠商註記與曝光分佈可能處於少見組合（例如極低訊雜比、閃燈欄位矛盾），致使部分編解碼器無法穩健處理。相機內預覽仍正常，因其使用內嵌 JPEG 與相機邏輯解讀，不等同電腦端的原始解碼。
- 難度: 中級
- 學習階段: 進階
- 關聯概念: A-Q18, D-Q1, D-Q10

A-Q23: 為何 EXIF 對歸檔特別重要？
- A簡: EXIF 是自動命名、分類、搜尋與審計的基礎資料來源。
- A詳: 歸檔工具多依 EXIF 擷取日期、相機、鏡頭等資訊生成檔名與目錄結構，並支援條件式篩選與回溯。若轉檔或搬移過程遺失 EXIF（例如 .CR2 無 THM），將降低資料可用性與後續追蹤能力。
- 難度: 初級
- 學習階段: 核心
- 關聯概念: A-Q5, B-Q11, D-Q2

A-Q24: 什麼是「wrapper」與原生 API 的差異？
- A簡: wrapper 封裝異質 API，提供一致接口；原生 API 各異需各自適配。
- A詳: 原生 RAW 解碼 API 各家相機、各版本差異大。wrapper 層把差異封裝，讓呼叫端以一致模式操作（開檔、解碼、取中繼資料），降低學習成本與耦合。但相依於 wrapper 與底層編解碼可用性。
- 難度: 中級
- 學習階段: 核心
- 關聯概念: A-Q10, B-Q6, B-Q17

A-Q25: 副檔名大小寫與偵測有何影響？
- A簡: 實務常採大小寫不敏感比對，避免 .CR2/.cr2 判斷不一致。
- A詳: 檔案系統與使用者習慣導致大小寫不一。工廠映射與屬性解析應統一正規化（如轉小寫），確保 .CR2、.Cr2、.cr2 均能匹配，避免處理器選擇失誤與例外。
- 難度: 初級
- 學習階段: 核心
- 關聯概念: B-Q4, C-Q3, D-Q3

A-Q26: 支援 .CR2 對使用者的核心價值？
- A簡: 直接納管 Canon RAW，降低轉檔負擔，提升歸檔效率與品質。
- A詳: 使用者可在同一工具內處理 Canon RAW，沿用既有流程（命名、分類、搬移）。若相機同時存 JPG，可省去轉檔並保留完整 EXIF，兼顧效率與資料完整性。
- 難度: 初級
- 學習階段: 核心
- 關聯概念: A-Q6, A-Q9, B-Q8

A-Q27: 什麼是「不理它」的策略思考？
- A簡: 權衡效益與成本，對低價值工作（轉檔）選擇不做。
- A詳: 當相機已提供原尺寸 JPG，且無 THM 導致 EXIF 不完整時，額外轉檔既耗時又無法提升品質。選擇「不轉」把資源用在更有價值的改進，如多副檔名支援與配置優化，是務實決策。
- 難度: 初級
- 學習階段: 核心
- 關聯概念: A-Q9, B-Q8, D-Q7

A-Q28: 測試覆蓋與相機機種有何關聯？
- A簡: RAW 依機種/韌體差異大，須跨機種樣本檔驗證相容性。
- A詳: 不同機身與韌體可能產生細節差異（色矩陣、MakerNotes）。因此需以多機種、多情境樣本檔測試，避免僅對單一機種最佳化。文中以 20D 驗證 .CR2，對其他機種仍需補強測試。
- 難度: 中級
- 學習階段: 進階
- 關聯概念: B-Q19, C-Q9, D-Q1

A-Q29: 為何轉出 JPG 會喪失完整 EXIF？
- A簡: 流程依賴 THM 作 EXIF 來源，.CR2 無 THM 導致資訊無法完整帶出。
- A詳: 若轉檔管線原本從 THM 讀取 EXIF 並寫入輸出 JPG，當 .CR2 未附 THM 就會缺乏完整中繼資料（尤其 MakerNotes 與相機私有欄位），造成輸出 JPG EXIF 殘缺。需改以 RAW 內嵌中繼資料或調整策略。
- 難度: 中級
- 學習階段: 核心
- 關聯概念: A-Q7, B-Q7, D-Q2

A-Q30: RAW 的 sidecar 與內嵌預覽差異？
- A簡: sidecar（如 THM）是獨立檔；內嵌預覽存於 RAW 中，外部檔案更少。
- A詳: sidecar 模式把縮圖與中繼資料存成外掛檔案，易於讀取與替換；內嵌預覽則將 JPEG 與資料置於 RAW 內，簡化檔案數量但需解包讀取。工具策略需因應兩者差異設計 EXIF 與預覽取得流程。
- 難度: 中級
- 學習階段: 進階
- 關聯概念: A-Q4, A-Q17, B-Q10


### Q&A 類別 B: 技術原理類

B-Q1: 歸檔工具整體如何運作？
- A簡: 以副檔名選擇 MediaFiler，透過 wrapper 解碼與擷取 EXIF，依設定命名與搬移。
- A詳: 
  - 原理: 策略物件（MediaFiler）處理特定格式；工廠依副檔名派發；wrapper 統一解碼。
  - 步驟: 掃描→判型→解碼/擷取 EXIF→命名/搬移→記錄。
  - 組件: MediaFiler、Factory Create()、RAW wrapper、設定（pattern.*）、日誌。
- 難度: 中級
- 學習階段: 核心
- 關聯概念: A-Q11, A-Q14, B-Q5

B-Q2: MediaFilerFileExtensionAttribute 的運作原理？
- A簡: 以屬性標註可處理的副檔名，執行期由反射讀取建立映射。
- A詳:
  - 原理: 類別屬性攜帶副檔名清單，中介層以反射建表。
  - 步驟: 啟動時掃描組件→讀取屬性→正規化副檔名→建立字典。
  - 組件: Attribute 類別、反射、字典快取、大小寫正規化。
- 難度: 中級
- 學習階段: 核心
- 關聯概念: A-Q12, A-Q25, C-Q2

B-Q3: 工廠 Create() 如何選擇處理器？
- A簡: 以副檔名查映射表，回傳對應 MediaFiler 實例，支援一對多映射。
- A詳:
  - 原理: 依副檔名鍵查詢，回傳對應型別或預設處理器。
  - 步驟: 正規化副檔名→字典查找→反射建構→回傳。
  - 組件: Create()、型別工廠、預設路徑、例外處理。
- 難度: 中級
- 學習階段: 核心
- 關聯概念: A-Q14, A-Q15, C-Q3

B-Q4: 多副檔名對應的機制與流程？
- A簡: 解析逗號清單，為每個副檔名建立到單一處理器的映射。
- A詳:
  - 原理: 一個處理器覆蓋多格式，減少重複。
  - 步驟: 屬性值 split(',')→trim→toLower→for each 建表。
  - 組件: 屬性解析器、字典、多映射註冊。
- 難度: 中級
- 學習階段: 核心
- 關聯概念: A-Q13, A-Q25, C-Q2

B-Q5: pattern.cr2 設定如何被載入？
- A簡: 由配置管理模組讀取 pattern.cr2 區段並套用命名/搬移規則。
- A詳:
  - 原理: 以鍵（pattern.cr2）讀取對應規則，覆蓋預設。
  - 步驟: 讀取設定→驗證鍵值→合併預設→供 MediaFiler 使用。
  - 組件: 設定存取器、驗證器、規則引擎。
- 難度: 中級
- 學習階段: 核心
- 關聯概念: A-Q16, C-Q4, D-Q4

B-Q6: 使用 Microsoft RAW wrapper 的流程？
- A簡: 透過統一 API 開啟 RAW、擷取影像與中繼資料，失敗時拋例外。
- A詳:
  - 原理: wrapper 封裝底層編解碼器，提供一致存取。
  - 步驟: 開檔→解碼預覽/全圖→讀取 EXIF→輸出或供後續處理。
  - 組件: wrapper API、編解碼器、例外處理與日誌。
- 難度: 中級
- 學習階段: 核心
- 關聯概念: A-Q10, D-Q1, C-Q5

B-Q7: .CR2 無 .THM 時 EXIF 如何處理？
- A簡: 若流程依賴 THM，應改由 RAW 內嵌中繼資料或跳過轉檔。
- A詳:
  - 原理: EXIF 來源可為 THM、RAW 內嵌或相機生成 JPG。
  - 步驟: 檢查 THM→若無則讀 RAW 中繼→嘗試寫入 JPG；若不完整則改策略。
  - 組件: 中繼資料讀寫器、RAW 解析器、策略開關。
- 難度: 中級
- 學習階段: 核心
- 關聯概念: A-Q7, A-Q29, C-Q6

B-Q8: 為何 RAW+JPG 能取代離線轉檔？
- A簡: 直接利用相機出 JPG，避免重複解碼並確保 EXIF 完整與效率。
- A詳:
  - 原理: 相機已完成成像與 EXIF 嵌入。
  - 步驟: 偵測 RAW+JPG 配對→以 JPG 作交付/預覽→RAW 僅歸檔。
  - 組件: 配對器、策略控制（是否轉檔）、搬移器。
- 難度: 初級
- 學習階段: 核心
- 關聯概念: A-Q8, A-Q9, C-Q7

B-Q9: 解碼錯誤的例外處理機制？
- A簡: 捕捉例外、記錄上下文、降級使用內嵌預覽或略過，避免流程中斷。
- A詳:
  - 原理: 以失敗可控、可回復為目標設計。
  - 步驟: try/catch→標記失敗→嘗試內嵌 JPEG→記錄與告警。
  - 組件: 例外攔截器、預覽抽取器、日誌/告警。
- 難度: 中級
- 學習階段: 核心
- 關聯概念: D-Q1, C-Q8, A-Q18

B-Q10: 相機預覽 vs PC 解碼的生成機制？
- A簡: 相機用內嵌 JPEG；PC 需 RAW 解碼。兩者路徑不同，故結果不同。
- A詳:
  - 原理: 內嵌預覽與原始解碼的處理鏈不同。
  - 步驟: 相機：讀內嵌→顯示；PC：解 RAW→色彩矩陣→出圖。
  - 組件: 內嵌 JPEG、RAW 編解碼器、色彩管理。
- 難度: 中級
- 學習階段: 核心
- 關聯概念: A-Q18, D-Q10, B-Q6

B-Q11: EXIF 複製的技術步驟是什麼？
- A簡: 讀取來源 EXIF，合併對應欄位，寫入目標 JPG 頭部。
- A詳:
  - 原理: EXIF 為 TIFF/IFD 結構，需對應欄位寫入。
  - 步驟: 解析來源→欄位映射→寫入 IFD→驗證。
  - 組件: 中繼資料讀寫庫、欄位對應表、驗證器。
- 難度: 高級
- 學習階段: 進階
- 關聯概念: A-Q5, A-Q29, C-Q6

B-Q12: 檔案掃描與分類流程如何設計？
- A簡: 遍歷來源，依副檔名分類與去重，交由工廠派發處理。
- A詳:
  - 原理: 流水線化提高吞吐與穩定。
  - 步驟: 列舉→過濾→正規化→派發→回寫結果。
  - 組件: 掃描器、分類器、工廠、結果匯報。
- 難度: 初級
- 學習階段: 核心
- 關聯概念: B-Q1, A-Q25, C-Q1

B-Q13: 版本相容性與編解碼器差異如何處理？
- A簡: 以 wrapper 抽象差異，偵測編解碼器版本並提供替代路徑。
- A詳:
  - 原理: 外掛解碼器能力不一致。
  - 步驟: 啟動偵測→功能探測→能力標記→流程分支。
  - 組件: 能力探測器、策略引擎、降級機制。
- 難度: 高級
- 學習階段: 進階
- 關聯概念: D-Q1, C-Q10, B-Q6

B-Q14: 屬性標註與反射載入的流程？
- A簡: 啟動時反射掃描含屬性類型，建立副檔名到處理器的映射表。
- A詳:
  - 原理: 中央註冊提升查找效率。
  - 步驟: 掃描組件→讀屬性值→建表→快取。
  - 組件: 反射器、屬性解析器、快取。
- 難度: 中級
- 學習階段: 核心
- 關聯概念: B-Q2, B-Q3, C-Q3

B-Q15: pattern.cr2 的語意與應用？
- A簡: 控制 CR2 的命名與搬移規則，保障與其他格式一致的行為。
- A詳:
  - 原理: 以格式特定的鍵覆蓋預設規則。
  - 步驟: 讀取鍵→解譯模板→套用重命名/搬移→驗證衝突。
  - 組件: 模板引擎、路徑規劃器、衝突解決器。
- 難度: 中級
- 學習階段: 核心
- 關聯概念: A-Q16, C-Q4, D-Q6

B-Q16: 多平台與大小寫處理策略？
- A簡: 正規化副檔名，避免大小寫差異造成處理器選擇錯誤。
- A詳:
  - 原理: 檔案系統行為差異需在程式層中統一。
  - 步驟: 讀取→ToLowerInvariant→文化無關比對→映射。
  - 組件: 正規化器、比對器、單元測試。
- 難度: 初級
- 學習階段: 核心
- 關聯概念: A-Q25, C-Q3, D-Q3

B-Q17: wrapper 與外部 RAW codec 的關係？
- A簡: wrapper 提供統一介面，底層實際工作由各家 RAW codec 完成。
- A詳:
  - 原理: wrapper 將外部 codec 的差異統一。
  - 步驟: 探測可用 codec→選擇合適者→包裝回傳資料。
  - 組件: wrapper、外部 codec、能力探測。
- 難度: 中級
- 學習階段: 進階
- 關聯概念: A-Q24, B-Q13, D-Q1

B-Q18: 效能與記憶體的設計原則？
- A簡: 優先用預覽、串流處理、避免整張解碼，控管記憶體尖峰。
- A詳:
  - 原理: I/O 與解碼昂貴，需分層與懶加載。
  - 步驟: 先嘗試內嵌預覽→需要時才全幅解碼→釋放資源。
  - 組件: 預覽抽取器、串流解碼、資源管理器。
- 難度: 高級
- 學習階段: 進階
- 關聯概念: C-Q8, D-Q7, D-Q8

B-Q19: 測試資料的建置原理？
- A簡: 以多機種、多光況、多錯誤邊界建立測試集驗證穩健性。
- A詳:
  - 原理: 多樣性測試提高可靠度。
  - 步驟: 收集樣本→標註期望→自動化比較→回歸測試。
  - 組件: 測試資料庫、比對器、CI 流程。
- 難度: 中級
- 學習階段: 進階
- 關聯概念: A-Q19, C-Q9, D-Q1

B-Q20: 外閃未觸發導致解碼例外的可能機制？
- A簡: 極端曝光與閃燈相關標記組合，暴露 codec 邊界漏洞。
- A詳:
  - 原理: 廠商私有欄位與極端數值觸發錯誤路徑。
  - 步驟: 讀取 EXIF→解析閃燈/曝光→進入未覆蓋分支→例外。
  - 組件: RAW codec、EXIF 解析器、錯誤處理弱點。
- 難度: 高級
- 學習階段: 進階
- 關聯概念: A-Q22, D-Q10, B-Q9


### Q&A 類別 C: 實作應用類（10題）

C-Q1: 如何在 .NET 專案新增對 .CR2 的支援？
- A簡: 更新副檔名屬性、工廠映射與 pattern.cr2 設定，並以樣本檔驗證。
- A詳:
  - 實作步驟: 
    1) 在 MediaFiler 上標註 ".cr2"；
    2) 工廠 Create() 支援多副檔名；
    3) 新增 pattern.cr2；
    4) 以 20D/5D 樣本測試。
  - 關鍵程式碼: 在處理器類別加屬性 [MediaFilerFileExtension(".cr2")]; 工廠字典加入對應。
  - 注意事項: 正規化大小寫、缺 THM 流程調整、例外處理完善。
- 難度: 中級
- 學習階段: 核心
- 關聯概念: B-Q1, B-Q5, C-Q5

C-Q2: 如何實作 MediaFilerFileExtensionAttribute 支援多副檔名？
- A簡: 屬性接受逗號清單並在啟動解析為多個映射鍵。
- A詳:
  - 實作步驟:
    1) 屬性建構子接收 string；
    2) Split(',') 正規化；
    3) 公開 IEnumerable<string>。
  - 關鍵程式碼:
    ```
    [AttributeUsage(AttributeTargets.Class)]
    class MediaFilerFileExtensionAttribute: Attribute {
      public string[] Exts { get; }
      public MediaFilerFileExtensionAttribute(string exts) =>
        Exts = exts.Split(',').Select(s=>s.Trim().ToLowerInvariant()).ToArray();
    }
    ```
  - 注意事項: 避免重複鍵，加入驗證與日誌。
- 難度: 中級
- 學習階段: 核心
- 關聯概念: B-Q2, B-Q4, C-Q3

C-Q3: 如何改寫 Factory Create() 支援一對多映射？
- A簡: 建立副檔名→處理器型別字典，啟動時以反射填表。
- A詳:
  - 實作步驟:
    1) 啟動時掃描含屬性類型；
    2) 對每副檔名註冊同一型別；
    3) Create() 依字典回傳實例。
  - 關鍵程式碼:
    ```
    foreach (var t in types)
      foreach (var e in attr.Exts) map[e]=t;
    ```
  - 注意事項: 大小寫、衝突處理、預設處理器退回。
- 難度: 中級
- 學習階段: 核心
- 關聯概念: B-Q3, B-Q14, A-Q25

C-Q4: 如何讀取 pattern.cr2 並應用命名規則？
- A簡: 從設定檔載入 pattern.cr2，套用至 CR2 檔的命名與搬移。
- A詳:
  - 實作步驟:
    1) 讀取設定鍵 "pattern.cr2"；
    2) 解析模板（如 {date}_{model}）；
    3) 生成目標路徑。
  - 關鍵設定:
    ```
    <appSettings>
      <add key="pattern.cr2" value="{date:yyyyMMdd}_{camera}_{seq}" />
    </appSettings>
    ```
  - 注意事項: 字元合法性、衝突處理、時區與文化設定。
- 難度: 初級
- 學習階段: 核心
- 關聯概念: B-Q5, B-Q15, D-Q6

C-Q5: 如何整合 Microsoft RAW wrapper 進行解碼？
- A簡: 以統一 API 開檔、取預覽或全圖，失敗時捕捉例外並降級。
- A詳:
  - 實作步驟:
    1) 開啟 RAW；
    2) 優先取內嵌預覽；
    3) 需全幅再解碼；
    4) 擷取 EXIF。
  - 關鍵程式碼（概念）:
    ```
    using (var r = Raw.Open(path)) {
      var meta = r.GetMetadata();
      var preview = r.GetPreview() ?? r.DecodeFull();
    }
    ```
  - 注意事項: 編解碼器安裝偵測、記憶體釋放、例外日誌。
- 難度: 中級
- 學習階段: 核心
- 關聯概念: B-Q6, D-Q1, C-Q8

C-Q6: CR2 無 THM 時，如何處理 EXIF？
- A簡: 直接讀 RAW 內嵌中繼資料，映射必要欄位寫入輸出 JPG。
- A詳:
  - 實作步驟:
    1) 檢查是否存在 THM；
    2) 若無，讀 RAW EXIF；
    3) 映射常用欄位（拍攝時間、曝光、鏡頭等）；
    4) 寫入 JPG。
  - 關鍵程式碼（概念）:
    ```
    var exif = raw.GetExif();
    Jpeg.WriteExif(output, exif.Filter(neededTags));
    ```
  - 注意事項: MakerNotes 相容性、欄位欠缺時的容錯策略。
- 難度: 高級
- 學習階段: 進階
- 關聯概念: B-Q7, B-Q11, D-Q2

C-Q7: 如何設定遇到 CR2 時不自動轉 JPG？
- A簡: 以設定旗標關閉 CR2 轉檔，改用相機出 JPG 配對。
- A詳:
  - 實作步驟:
    1) 新增設定 convert.cr2=false；
    2) 流程判斷副檔名與旗標；
    3) 若 false，跳過轉檔與 EXIF 寫入。
  - 關鍵設定:
    ```
    <add key="convert.cr2" value="false" />
    ```
  - 注意事項: RAW+JPG 配對規則、避免重複搬移。
- 難度: 初級
- 學習階段: 核心
- 關聯概念: B-Q8, D-Q2, D-Q6

C-Q8: 如何加上錯誤處理避免解碼例外中斷？
- A簡: 加入 try/catch、降級策略與日誌，確保流程可續行。
- A詳:
  - 實作步驟:
    1) 外層 try/catch；
    2) 例外時嘗試讀內嵌預覽；
    3) 標記檔案狀態並告警；
    4) 繼續處理其他檔。
  - 關鍵程式碼:
    ```
    try { ... } catch (Exception ex) { TryPreview(); Log(ex); continue; }
    ```
  - 注意事項: 不吞例外、提供重試與人工介入出口。
- 難度: 中級
- 學習階段: 核心
- 關聯概念: B-Q9, D-Q1, D-Q10

C-Q9: 如何撰寫自動化測試涵蓋 5D、20D、G2 案例？
- A簡: 建立多機種樣本集與邊界情境，比對輸出與日誌以驗證。
- A詳:
  - 實作步驟:
    1) 收集含 RAW+JPG、無 THM、外閃未觸發案例；
    2) 定義期望輸出（命名、EXIF）；
    3) CI 中執行比對與回歸。
  - 關鍵程式碼（概念）:
    ```
    AssertExifEquals(expected, actual);
    AssertPathPattern(pattern, outputPath);
    ```
  - 注意事項: 法規與授權、資料匿名化。
- 難度: 中級
- 學習階段: 進階
- 關聯概念: B-Q19, D-Q1, A-Q28

C-Q10: 如何在 UI/CLI 提示使用者安裝缺少的 RAW codec？
- A簡: 啟動時檢測能力，缺失則顯示提示與下載指引。
- A詳:
  - 實作步驟:
    1) 探測 wrapper 能力；
    2) 若缺少，提示型號與必要 codec；
    3) 提供連結或說明。
  - 關鍵程式碼（概念）:
    ```
    if (!Raw.Supports(".cr2")) ShowCodecGuide("Canon RAW Codec");
    ```
  - 注意事項: 適配不同 OS、離線情境的替代方案。
- 難度: 初級
- 學習階段: 核心
- 關聯概念: B-Q13, D-Q1, D-Q9


### Q&A 類別 D: 問題解決類（10題）

D-Q1: Microsoft RAW Viewer/Library 無法解碼某些 RAW，怎麼辦？
- A簡: 更新編解碼器、改用內嵌預覽或替代解碼，記錄例外並上報。
- A詳:
  - 症狀: 檔案在相機可預覽，但 PC 解碼拋例外。
  - 可能原因: 編解碼器不支援/有 bug、極端曝光、MakerNotes 差異。
  - 解決步驟: 更新 codec→嘗試內嵌預覽→替代解碼器→回退策略。
  - 預防: 增加樣本測試、能力探測與降級機制。
- 難度: 中級
- 學習階段: 核心
- 關聯概念: B-Q6, B-Q9, A-Q18

D-Q2: CR2 沒有 THM，轉出 JPG 沒 EXIF，如何解決？
- A簡: 從 RAW 讀取 EXIF 寫回 JPG，或改採相機出 JPG，關閉轉檔。
- A詳:
  - 症狀: 轉檔後 JPG 中繼資料不完整。
  - 可能原因: 流程依賴 THM 作 EXIF 來源。
  - 解決步驟: 讀 RAW EXIF→欄位映射→寫入 JPG；或設定不轉檔用相機 JPG。
  - 預防: 設計 EXIF 來源多路徑與檢查。
- 難度: 中級
- 學習階段: 核心
- 關聯概念: B-Q7, C-Q6, C-Q7

D-Q3: 多副檔名屬性未生效，無法選到正確處理器？
- A簡: 檢查屬性解析、大小寫正規化與啟動反射註冊流程。
- A詳:
  - 症狀: .CR2 未被對應的 MediaFiler 接手。
  - 可能原因: 屬性未正確 split/trim、大小寫未正規化、未註冊。
  - 解決步驟: 修正屬性解析→加入 ToLower→檢查啟動註冊。
  - 預防: 單元測試涵蓋大小寫與多副檔名。
- 難度: 初級
- 學習階段: 基礎
- 關聯概念: B-Q2, B-Q4, C-Q3

D-Q4: pattern.cr2 未被載入，命名規則沒生效？
- A簡: 檢查設定鍵、區段讀取與預設覆蓋邏輯，加入日誌。
- A詳:
  - 症狀: CR2 檔命名仍用預設。
  - 可能原因: 設定鍵錯拼、權限/路徑、未覆蓋預設。
  - 解決步驟: 校對鍵名→驗證載入順序→加入缺鍵告警。
  - 預防: 啟動自檢與範本設定檔。
- 難度: 初級
- 學習階段: 基礎
- 關聯概念: B-Q5, C-Q4, B-Q15

D-Q5: Create() 回傳錯誤處理器，如何診斷？
- A簡: 檢查映射表建立、衝突解析與預設處理器退回。
- A詳:
  - 症狀: 副檔名對應到非預期處理器。
  - 可能原因: 重複註冊、後寫覆蓋、未處理衝突。
  - 解決步驟: 增加衝突檢測→明確優先序→修正註冊順序。
  - 預防: 在 CI 中驗證映射表快照。
- 難度: 中級
- 學習階段: 核心
- 關聯概念: B-Q3, C-Q3, B-Q14

D-Q6: 轉檔後檔名/子目錄錯誤，怎麼排除？
- A簡: 檢查 pattern 模板、占位符解析與非法字元過濾。
- A詳:
  - 症狀: 檔名不符預期或路徑建立失敗。
  - 可能原因: 模板錯誤、占位符無值、非法字元未處理。
  - 解決步驟: 校正模板→提供預設值→清理不合法字元。
  - 預防: 模板測試與乾跑（dry-run）。
- 難度: 初級
- 學習階段: 基礎
- 關聯概念: B-Q15, C-Q4, A-Q23

D-Q7: 解碼效能不佳或批次時間過長？
- A簡: 先用預覽、分批/平行處理、避免不必要轉檔與 I/O。
- A詳:
  - 症狀: 批次耗時、CPU/IO 飆高。
  - 可能原因: 全幅解碼過多、同步 I/O、未使用 RAW+JPG。
  - 解決步驟: 用預覽→平行與節流→關閉 CR2 轉檔→快取。
  - 預防: 效能監測與門檻告警。
- 難度: 中級
- 學習階段: 核心
- 關聯概念: B-Q18, C-Q7, C-Q8

D-Q8: 記憶體占用過高導致崩潰？
- A簡: 串流解碼、釋放資源、限制並行度，避免同時載入多大圖。
- A詳:
  - 症狀: 大批 RAW 造成記憶體峰值過高。
  - 可能原因: 一次載入多張全幅、資源未釋放。
  - 解決步驟: 預覽優先→限制併發→確保 Dispose→64 位元。
  - 預防: 壓力測試與資源監控。
- 難度: 中級
- 學習階段: 進階
- 關聯概念: B-Q18, C-Q8, D-Q7

D-Q9: 色偏或曝光顯示異常，如何處理？
- A簡: 校驗色彩管理、嘗試替代解碼與 ICC，對照相機 JPG。
- A詳:
  - 症狀: PC 顯示與相機預覽差異大。
  - 可能原因: 編解碼器算法、ICC 缺失、曲線套用差異。
  - 解決步驟: 套用正確 ICC→嘗試他牌解碼→以相機 JPG 校正。
  - 預防: 一致的色彩流程與螢幕校色。
- 難度: 中級
- 學習階段: 進階
- 關聯概念: B-Q10, C-Q10, A-Q8

D-Q10: 外閃未回電導致 RAW 無法解碼，怎麼辦？
- A簡: 更新 codec、改用內嵌預覽/相機 JPG、回報問題並保留樣本。
- A詳:
  - 症狀: 外閃未觸發影像在 PC 端解碼拋例外。
  - 可能原因: codec 對極端曝光/閃燈欄位處理漏洞。
  - 解決步驟: 更新 codec→取內嵌預覽或用相機 JPG→上報與隔離。
  - 預防: 測試涵蓋極端案例、例外降級策略常備。
- 難度: 中級
- 學習階段: 進階
- 關聯概念: A-Q22, B-Q9, A-Q18


### 學習路徑索引

- 初學者：建議先學習哪 15 題
    - A-Q1: 什麼是 .CR2？
    - A-Q2: 什麼是 RAW 檔？
    - A-Q3: RAW 與 JPG 的差異？
    - A-Q4: 什麼是 .THM 縮圖檔？
    - A-Q5: EXIF 是什麼？為何重要？
    - A-Q6: 為什麼需要支援 .CR2？
    - A-Q7: 文中 .CR2 無 .THM 造成什麼影響？
    - A-Q8: 高階相機另存原尺寸 JPG 的意義？
    - A-Q9: 為什麼作者決定不做 .CR2→.JPG 轉檔？
    - B-Q1: 歸檔工具整體如何運作？
    - B-Q6: 使用 Microsoft RAW wrapper 的流程？
    - B-Q8: 為何 RAW+JPG 能取代離線轉檔？
    - C-Q1: 如何在 .NET 專案新增對 .CR2 的支援？
    - C-Q7: 如何設定遇到 CR2 時不自動轉 JPG？
    - D-Q2: CR2 沒有 THM，轉出 JPG 沒 EXIF，如何解決？

- 中級者：建議學習哪 20 題
    - A-Q10: 文中的 Microsoft 包裝（wrapper）是什麼？
    - A-Q11: 什麼是 MediaFiler？
    - A-Q12: 什麼是 MediaFilerFileExtensionAttribute？
    - A-Q13: 為什麼需要多副檔名支援？
    - A-Q14: 工廠模式在此扮演什麼角色？
    - A-Q15: Create() 改動的核心價值是什麼？
    - A-Q16: 什麼是 pattern.cr2 設定？
    - A-Q18: 相機內預覽與電腦解碼差異？
    - B-Q2: MediaFilerFileExtensionAttribute 的運作原理？
    - B-Q3: 工廠 Create() 如何選擇處理器？
    - B-Q4: 多副檔名對應的機制與流程？
    - B-Q5: pattern.cr2 設定如何被載入？
    - B-Q7: .CR2 無 .THM 時 EXIF 如何處理？
    - B-Q9: 解碼錯誤的例外處理機制？
    - B-Q10: 相機預覽 vs PC 解碼的生成機制？
    - C-Q2: 如何實作多副檔名屬性？
    - C-Q3: 如何改寫 Factory Create()？
    - C-Q5: 如何整合 Microsoft RAW wrapper？
    - D-Q1: 無法解碼某些 RAW，怎麼辦？
    - D-Q4: pattern.cr2 未被載入，命名規則沒生效？

- 高級者：建議關注哪 15 題
    - A-Q22: 為何外閃未回電可能影響 RAW 解碼？
    - A-Q28: 測試覆蓋與相機機種有何關聯？
    - A-Q29: 為何轉出 JPG 會喪失完整 EXIF？
    - A-Q30: RAW 的 sidecar 與內嵌預覽差異？
    - B-Q11: EXIF 複製的技術步驟是什麼？
    - B-Q13: 版本相容性與編解碼器差異如何處理？
    - B-Q17: wrapper 與外部 RAW codec 的關係？
    - B-Q18: 效能與記憶體的設計原則？
    - B-Q19: 測試資料的建置原理？
    - B-Q20: 外閃未觸發導致解碼例外的可能機制？
    - C-Q6: CR2 無 THM 時，如何處理 EXIF？
    - C-Q8: 如何加上錯誤處理避免解碼例外中斷？
    - C-Q9: 如何撰寫覆蓋 5D/20D/G2 的自動化測試？
    - D-Q7: 解碼效能不佳或批次時間過長？
    - D-Q10: 外閃未回電導致 RAW 無法解碼，怎麼辦？