# 微服務架構 #4, 如何強化微服務的安全性? API Token / JWT 的應用

## 摘要提示
- 微服務安全: 微服務去中心化易受攻擊，必須以正確的安全架構與演算法確保服務間信任。  
- 數位簽章: 以 RSA 私鑰簽章、公開金鑰驗章，確保資料來源真實且內容未被竄改。  
- API Token: 將業務資訊封裝為 TokenData，再以簽章產生不可竄改的 Session Token。  
- 土炮實作: 透過 100 行 C# 程式碼 (TokenData / TokenHelper) 完成簽章、驗章與序列化。  
- Replay Attack: 在 Token 中加入使用者 IP／Device ID 等綁定資訊，可有效阻斷重放攻擊。  
- JWT 標準: 採用 RFC 定義的 header＋payload＋signature 格式，跨語言套件完整支援。  
- 軟體啟用: 以 Token 作為序號封裝授權資訊並簽章，可簡化正版驗證流程。  
- 分散式授權: 服務彼此以 SiteToken／ServiceToken 驗證身分與權限，降低溝通成本。  
- 私鑰管理: 一切安全性建立於私鑰不外流，發行及驗證流程皆繞此核心建構。  
- 實務心得: 架構師需理解原理再選用框架，避免「只會呼叫函式庫」卻無法應變。

## 全文重點
本文以作者在線上讀書會分享的內容為基礎，說明在微服務架構下如何以 API Token / JWT 強化服務間安全。首先指出微服務將單一系統拆成多個獨立服務，若沒有妥善的辨識與授權機制，系統容易在服務呼叫與網際網路傳遞過程中被竄改或冒用。作者借鏡實體世界「車票防偽」的概念，導入密碼學中的 RSA 數位簽章：利用私鑰對資料 Hash 加密產生簽章，驗證端以公開金鑰解密、重新計算 Hash 並比對，一旦一致即可確認資料未被動手腳且確實出自持有私鑰者。

接著以 C# 範例示範「土炮」API Token：設計 TokenData 作為可序列化的業務資料模型，再以 TokenHelper 進行 BSON 序列化、簽章（SignData）與驗章（VerifyData）。使用情境為 A 服務（AUTH）在使用者通過驗證後產生 Session Token，內含 ExpireDate、ClientID、權限標記等資訊並簽章；B 服務收到呼叫時僅需以公開金鑰驗章及檢查過期，即可信任此 Token 而免去即時與 A 溝通的開銷。

針對 Replay Attack，作者建議在 Token 內加入與裝置綁定的欄位（如 UserHostAddress、Device ID），使即便攻擊者竊得 Token 也因無法偽造綁定資訊而被拒。若需要更標準、跨語言的實作，推薦採用 JWT（Json Web Token）——其標準化的 header、payload、signature 結構以及豐富的函式庫讓各語言皆能輕鬆處理簽章與驗章。

最後提供兩個延伸案例：1) 將簽章 Token 用作桌面或雲端軟體的啟用序號，並配合程式碼簽章防止反組譯繞過；2) 於雲端分散式系統中發行 SiteToken 與 ServiceToken，分別驗證服務端身分與服務存取權限，藉此建立可擴充且去中心化的信任網。

本文強調：在微服務或任何分散式環境中，安全機制須奠基於嚴謹的密碼學理論；理解原理後再套用框架（如 JWT）才能設計出既安全又具彈性的系統。

## 段落重點
### 前言與背景
作者回顧自身「土炮」經驗，指出年代交替造成工程師多半只會使用現成框架而忽略原理；微服務要求高正確性的架構設計，因此必須重新思考服務鑑別與資料傳遞的安全性。這篇文章即從自身 POC 與讀書會分享出發，探討 API Token／JWT 的實務應用。

### API Token 原理說明
闡述微服務跨域呼叫所面臨的信任難題，以「7-11 買票、車站驗票」比喻資料需自帶「防偽標籤」。透過 RSA 私鑰簽章、公開金鑰驗章機制，讓 B 服務不須與 A 服務即時溝通也可驗明正身。重點在於：1) 先對資料做 Hash；2) 私鑰加密 Hash 生成簽章；3) 將簽章與原始資料一併傳遞；4) 接收端公開金鑰解密並比對 Hash。

### API Token 要解決的難題
說明網路環境不可信、Client 端易被攔截，若無防護可能在付款服務與下單服務間造成重大損失。安全目標是保證資料來源可驗證、內容不可被竄改，同時避免高延遲的即時查詢。

### RSA 數位簽章
詳細介紹 RSA 三大特性以及 Hash 技巧，搭配流程圖說明如何產生與驗證數位簽章。強調 Hash 碰撞極低使竄改難以成功，並以步驟分解讓讀者易於理解。

### API Token 實作 (土炮版)
提供 C# 範例：TokenData 抽象類別定義通用欄位與 IsValidate 方法；SessionToken 擴充業務欄位；TokenHelper 進行 BSON 序列化、SignData 及 VerifyData。示範 AUTH 服務發行 SessionToken，API 服務驗證後依標記決定功能層級，並展示如何透過 Swagger 在 Azure API Apps 上測試。

### 阻擋 Replay Attack
說明攻擊者可能竊得有效 Token 反覆使用，解法是在 Token 內加入 IP／DeviceID 等獨特資訊並在驗章後比對，或縮短有效期限，使重放攻擊難以成立。此方法成本低且能大幅提升安全層級。

### JWT (Json Web Token)
介紹 JWT 的 RFC 格式（header、payload、signature）及跨平台函式庫支援，強調若需正式上線或多語言互通應使用 JWT；而土炮實作則有助於深入理解原理。附官網資源供進一步學習。

### 延伸應用
#### 軟體的啟用序號
將授權資訊封裝為 Token 並簽章，用戶端以公開金鑰驗章後啟用授權功能；若再配合程式碼簽章，可防止反組譯修改驗證邏輯。
#### 雲端分散式的系統驗證
對每個服務發 SiteToken（身分）與每條服務呼叫發 ServiceToken（授權），服務端驗章即可判斷呼叫合法性，省去集中式驗證瓶頸並阻絕私服。

### Q & A
釐清「私鑰加密 / 公鑰解密」與「公鑰加密 / 私鑰解密」並無對錯，依場景選用；舉三種通信情境說明不同組合的適用性，說明 Token 場景以私鑰簽章最恰當。

### 結論
微服務去中心化使安全更複雜，唯有基於成熟的密碼學與標準框架（如 JWT），才能建立可靠且可維護的信任模型；架構師應深刻理解原理再決定實作或套件，避免安全機制淪為黑箱。