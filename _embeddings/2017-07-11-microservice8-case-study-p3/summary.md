# 架構師觀點 ─ 轉移到微服務架構的經驗分享 (Part 3)

## 摘要提示
- 基礎建設: 微服務真正的難度在於基礎建設，缺少 API Gateway、Service Discovery、Message Queue 與集中日誌，效益便無從談起。  
- 漸進式導入: 小型或新創專案不宜一次到位，應先保持單體架構健康，待瓶頸出現再逐步拆分與擴充基礎設施。  
- API Gateway: 統一管控安全、認證、快取與 API 聚合，前端僅需一次呼叫即可取得內部多服務資料。  
- Service Discovery: 服務啟動即註冊、心跳維護與主動健康檢查，結合負載平衡決定流量去向。  
- 通訊模式: 同步 RPC、非同步訊息與事件驅動並存，可靠度與維護性仰賴 Message Queue／Bus。  
- 交易一致性: 以訊息中介與二階段提交 (2PC) 確保分散式服務最終一致，避免單體資料庫鎖定。  
- 集中日誌: 以「事件」為索引彙總跨服務 Log，才能快速回溯問題。  
- 技術選型: NGINX、Kong、Consul、etcd、RabbitMQ、Kafka、MSMQ…皆為可落地的成熟方案。  
- DevOps 流程: 持續交付、快速部署與監控能力是微服務可維運的前提條件。  
- 成功關鍵: 基礎建設穩固度幾乎決定微服務成敗，架構師需評估成本、維運量與團隊能力。  

## 全文重點
本文延續前兩篇關於微服務規劃與切割案例的討論，聚焦於「微服務應運行在什麼樣的基礎建設上」。作者指出，微服務把應用程式拆小、責任單一化後，複雜度轉移到服務間協作；若沒有對應的基礎設施，系統維護將比傳統單體更艱難。  
四大必備元件包括：  
1. API Gateway─位於邊界，負責安全、認證、快取與多 API 聚合，並可成為集中式認證點。  
2. Service Discovery─維護服務清單，提供註冊、心跳、健康檢查及與負載平衡整合，協助 API Gateway 或 LB 動態找到可用節點。  
3. Communication / Event System─整合同步與非同步通訊模式，以 Message Queue／Bus 實踐 pub/sub、routing、RPC 及事件機制，並以 2PC 等方法確保跨服務交易一致。  
4. 集中日誌─跨服務追蹤事件流程，支援即時排障。  

文章強調，微服務導入需符合兩大前提：團隊具備 DevOps 流程，以及能建置並維運上述基礎設施。作者建議以漸進式重構取代一次切分，並列舉 NGINX 電子書和多項開源／雲端方案作為落地參考。最後提醒，基礎設施的可靠與整合度決定微服務能否成功，不宜在地基不穩時貿然轉型。  

## 段落重點
### 微服務需要那些基礎建設?
微服務拆小服務卻增加整體複雜度，維運焦點轉向服務間協作。作者認為企業在切入前應評估團隊流程與環境能力，若規模不足不宜貿然採用。四大核心設施—API Gateway、Service Discovery、Communication/Event System、集中日誌—就像人體器官，缺任何一項都會影響穩定性。採用漸進式策略：先保持單體架構的良好可維護性，遇到成長瓶頸再同步擴充基礎設施與微服務。

### API Gateway
API Gateway 位於客戶端與多個後端服務之間，負責安全控管、認證授權、輸出快取及 API 聚合。以購物 APP 為例，若前端需分別呼叫訂單、評價、庫存等多支 API，效能與維護皆不佳；透過 Gateway 聚合只需一次呼叫即可回傳整合資料，並隔離內部服務位置與版本。Gateway 亦可統一處理跨服務的認證邏輯，降低每個服務重複實作的風險。實作可採 Kong、Azure API Management 或自行開發。

### Service Discovery
Service Discovery 解決「服務在哪裡」的問題。每個服務啟動時向 Registry 註冊，定期送心跳並在停機時取消註冊；Registry 亦可主動呼叫健康檢查 API 以提高準確性。Load Balancer 可動態查詢 Registry 並將流量導向存活且負載較低的節點。DNS、etcd、ZooKeeper、Consul 皆能擔任 Registry 角色，也可配合專用 Client 自動註冊／取回組態，降低維運成本與錯誤率。

### Async & Sync Communication / Event System
微服務內部通訊涵蓋同步 REST/RPC、非同步訊息及事件驅動三大類，核心是可靠且具路由能力的 Message Queue／Bus。非同步場景允許前端快速返回、後端排程處理；同步雙向可用兩個 Queue 深化可靠度；事件機制則將 N×M 關係簡化為 N+M 的 pub/sub。文章以分散式付款案例示範，利用 Broker 與 2PC 實現銀行與遊戲點數服務的一致性。推薦 RabbitMQ、Kafka，或在需求簡單時使用 Redis Queue、MSMQ。

### 後記
作者總結，微服務成功與否取決於基礎建設是否穩固、團隊是否有能力部署與維運。市面已有眾多成熟解決方案，架構師應在預算、效能與人員技能可承受範圍內挑選最佳組合。下一篇文章將進一步探討微服務的部署策略與落地實務。