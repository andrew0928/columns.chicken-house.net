# [分散式系統 #1] Idempotency Key 的原理與實作 - 能安全 Retry 的 API 設計

# 問答集 (FAQ, frequently asked questions and answers)

## Q: 在分散式系統中，為什麼需要設計可安全重試（Retry）的 API？
網路連線具有不穩定性，請求有可能在「伺服器已經執行完動作」但「客戶端尚未收到結果」時就中斷。若無法判斷先前的請求是否成功，使用者可能會選擇再呼叫一次同一支 API，進而造成重覆扣款或重覆執行的風險。因此，必須設計可安全重試的 API 來應對網路失敗與訊息遺失的情況。

## Q: 文章中的「扣款 100 元」案例透露了什麼風險，為何直接重發請求並不可行？
若首次呼叫已在伺服器端成功扣款，但回應尚未傳回就斷線，客戶端仍認為呼叫失敗。若此時直接重發同一請求，可能導致第二次扣款，造成額外損失。這說明了在不可靠網路下，不帶任何保護機制直接重試可能導致嚴重的副作用。

## Q: 文章提出了哪些機制來避免因重試而產生副作用？
作者接下來將介紹：
1. 「Idempotent Safe」的 API 設計——讓同一請求即使被重送多次，也只會產生一次效果。
2. 「Idempotency Key」額外保護機制——客戶端在每次動作中加入唯一鍵，伺服器端透過該鍵判斷並忽略重覆請求，確保操作至多執行一次。