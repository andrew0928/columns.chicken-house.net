# [設計案例] 授權碼 如何實作? #3, 數位簽章

## 摘要提示
- 數位簽章: 利用公開演算法與私鑰簽名，驗證授權碼真偽與完整性。  
- 非對稱加密: 採 RSA 公私鑰對，讓任何人可驗證而只有原廠能簽名。  
- 哈希驗證: 先對資料做 Hash 再簽章，確保內容未被竄改。  
- 金鑰管理: 私鑰應存放於 OS Key Container，公鑰可公開散布。  
- RSACryptoServiceProvider: .NET 內建類別，提供 SignData/VerifyData 與 XML 匯入匯出。  
- TokenHelper: 自訂工具類，負責序列化、簽章、驗證與快取公鑰。  
- 授權碼格式: 將資料與簽章以 Base64 分段封裝，啟動時先驗簽再執行。  
- ASP.NET MVC 整合: 於 Startup.Configure 初始化並驗證授權，失敗立即終止網站。  
- 安全警示: 切勿自創「土炮」加密，應使用經驗證的演算法並妥善保護私鑰。  
- 應用情境: 數位簽章可支援一對多、一對一通訊及文件來源鑑別。  

## 全文重點
本文延續「授權碼如何實作」系列，聚焦於以 RSA 數位簽章確保授權檔案來源與完整性的技術與實務。作者首先說明密碼學的核心概念：安全應建立在公開演算法與私有金鑰之上，而非仰賴「沒人知道」的暗黑程式。以 RSA 為例，一組金鑰分為只能自家保管的 Private key 與可公開發佈的 Public key；若以私鑰對資料雜湊值簽名，任何人皆可用對應公鑰驗證資料是否未被修改，並確認簽署者身分。  
實務面，作者以 .NET 的 RSACryptoServiceProvider 示範，透過 FromXmlString 匯入金鑰 XML，便能呼叫 SignData 產生簽章與 VerifyData 進行驗證。金鑰 XML 分包含私鑰與僅含公鑰兩種版本，私鑰段落需嚴格保護，否則攻擊者即可偽造任何授權檔。  
在程式架構上，作者實作 TokenHelper 類別：  
1. 先以 BSON/JSON 序列化授權物件成二進位陣列。  
2. 以目前網站的私鑰對該陣列進行 SignData，得到簽章。  
3. 將原始資料與簽章各自 Base64 編碼，以分隔符串聯成最終授權字串。  

解碼流程則反向操作：拆分字串、還原資料、以授權內宣告的 SiteID 找出公鑰驗證簽章，並呼叫 Token 內部的 IsValidate 進行業務規則檢查(日期、功能等)。若驗證或商業邏輯任一失敗，即丟出自訂例外。  
最後作者示範如何在 ASP.NET MVC5 專案中於 Startup.Configure 初始化 TokenHelper：從 appsettings.json 讀入私鑰、站台公鑰清單與授權字串；若 DecodeToken 發生 TokenNotSecureException 或 TokenNotValidateException，網站將在路由建立前被中止，達到「未授權不啟動」的效果。  
全文重申兩個重點：一、加密演算法與金鑰管理不可混為一談，演算法公開且經社群驗證才安全；二、私鑰保護是數位簽章成敗關鍵，若私鑰外洩，一切保障形同虛設。作者亦將完整程式碼釋出於 GitHub，供讀者進一步研習。  

## 段落重點
### 數位簽章原理說明
作者以「資料的封條」為題，說明數位簽章的角色等同紙本簽名：保證發信人身分並防止內容被竄改。文中區分對稱式與非對稱式加密，並選擇 RSA 做範例。透過私鑰簽名、公鑰驗證機制，讀者可在不安全通道中確定資料出自原廠且未被修改。作者同時舉「模仿遊戲」Enigma、「一對一安全通訊」與「文件來源鑑別」三種場景，加深讀者對非對稱加密與數位簽章應用的理解。  

### 數位簽章 + 授權碼實作
本段落聚焦於實務程式碼。作者首先說明金鑰應存於 Key Container，但示範專案為方便改以 XML 檔案暫存。TokenHelper.Init 讀入站台私鑰並快取各站公鑰；EncodeToken 將授權物件序列化、簽名並打包為字串；DecodeToken 解析字串、驗證簽章與業務邏輯。文中列出完整 C# 片段，並展示含私鑰與僅含公鑰兩份 XML 範例，提醒讀者分別之處即為機敏資訊。  

### ASP.NET MVC5 啟動時檢查授權碼
最後作者示範如何把授權驗證整合至 ASP.NET MVC5。於 appsettings.json 新增 License 區段，存放 TokenData、SiteID、SitePrivateKey 與公鑰清單；在 Startup.Configure 讀取設定，呼叫 TokenHelper.Init 與 DecodeToken。若授權合法，網站正常啟動；若過期、被竄改或簽章不符，則拋出自訂例外，中斷所有後續流程並顯示 MVC Error 頁。作者亦附上成功畫面與三種失敗截圖，證明機制可確實阻擋未授權執行。  

