# Canon CR2 → JPEG 速度加倍…該換 Core2 Quad 了嗎？

## 摘要提示
- Canon Codec: 原生解碼器在同一個 process 內無法重入，限制了多執行緒的效能發揮。  
- 多進程拆分: 把轉檔工作分拆成兩個獨立程序，可避開 Codec 的鎖定機制。  
- CPU 利用率: 在雙核心 E6300 上同時跑兩個轉檔程序，CPU 佔用率拉升到約 80%。  
- 速度翻倍: 單張轉 70 秒不變，但 70 秒內可完成兩張，平均效能提高一倍。  
- ThreadPool 局限: 即使用 ThreadPool 把其它工作塞滿，最後仍卡在 .CR2→.JPG 的單一瓶頸。  
- IPC 顧慮: 多進程帶來參數傳遞、回傳值與檔案解析等 IPC 難題，但相對轉檔時間仍值得。  
- 歸檔程式重構: 轉檔邏輯被抽成獨立 .exe，由主程式控制同時啟動兩份進程。  
- 檔案/Arguments 策略: 透過檔案路徑與命令列引數簡化跨程序溝通。  
- 整體評估: 耗時集中在 Codec，額外啟動程序幾乎不佔運算資源，投資報酬率高。  
- 升級誘因: 成功驗證後，作者開始認真考慮升級至四核心 Q9450。

## 全文重點
作者一直在開發一套大量相片歸檔工具，主要瓶頸出在 Canon RAW 檔（.CR2）轉 JPEG 的階段。即便他使用 ThreadPool 把所有可並行的工作包裝成多執行緒，整體速度仍受制於 Canon Codec 的「不可重入」特性──在同一個 process 裡最多只允許一條執行緒存取解碼器，因此 CPU 其他核心常處於閒置狀態。為了突破此限制，他嘗試將單一轉檔任務抽成獨立可執行檔，並讓主程式同時啟動兩個轉檔程序，各自處理一份 .CR2 檔案。實驗結果顯示：雙核心 E6300 的 CPU 使用率由原本五成左右提升到八成，單張照片仍需 70 秒，但 70 秒內能完成兩張，平均效能直接翻倍。

在正式導入前，他評估了多進程帶來的 IPC 成本：參數傳遞只能靠檔案或 command-line arguments；執行結果也得透過檔案或回傳碼讀取；還要為字串解析、錯誤處理編寫額外程式碼。儘管麻煩，但與轉檔所耗的龐大時間相比，這些開銷僅屬一次性，而且不佔 CPU，完全可以接受。最後他把轉檔邏輯抽成獨立 .exe，由歸檔主程式排程同時維持兩個轉檔工作；整體測試證明方案有效，真實工作負載下理論上可再向四核心擴充。於是，作者開始認真考慮升級至 Core2 Quad（Q9450），讓程式一次跑四個轉檔程序，以發揮硬體最大效益。

## 段落重點
### 1. 效能瓶頸與多執行緒無解
作者發現歸檔程式雖然將所有可並行的工作拆成 ThreadPool 工作項，卻依舊被 .CR2→.JPG 這一步拖慢；主因是 Canon Codec 在同一個 process 內不可重複進入，導致只剩一條執行緒真正解碼，其他核心閒置，整體效能被 codec 鎖住。

### 2. 拆分 Process 的概念驗證
他靈機一動：如果 Canon Codec 的鎖定只在單一 process 內生效，將轉檔工作分拆為兩個獨立程序或許能同時使用兩顆 CPU。基於此假設，他快速用現有的 LIB 做出測試執行檔，同時跑兩份轉檔，結果 CPU 使用率立刻飆到 80%，而單個任務執行時間並未惡化，初步驗證方案可行。

### 3. 歸檔程式重構與速度翻倍
驗證通過後，他把原本內嵌在歸檔程式裡的轉檔邏輯抽成獨立 .exe，並讓主程式保持兩份轉檔程序併行。實測下，每張照片仍需 70 秒轉換，但 70 秒就能完成兩張，平均效能整整快了一倍，也代表只要核心數再增加，理論上還能線性擴充。

### 4. IPC 難題與升級考量
先前遲遲不想走多進程路線，主因是 IPC 麻煩：啟動額外程序、命令列參數解析、輸出結果回收都需手動處理。然而這些動作不耗大量運算，且成本固定，與一張圖 70 秒、一次百張的工作量相比微不足道。既然雙核心已獲明顯提升，作者自然開始動念要買四核心 Q9450，讓新架構一次跑四個轉檔程序，進一步榨乾硬體效能。

