# RUN!PC 精選文章 - 生產線模式的多執行緒應用

# 問答集 (FAQ, frequently asked questions and answers)

## Q: 什麼是「生產線／Pipeline」模式的多執行緒應用？
「生產線」模式是一種把一連串具相依性的工作拆成多個階段（Stage），每個階段由專屬執行緒負責，並用佇列當作輸送帶傳遞「半成品」。透過各階段在時間上的重疊，可以讓原本必須嚴格順序執行的工作仍能同時利用多核心 CPU，提高整體效能。

## Q: 在「縮圖後再壓成 ZIP」的範例中，不使用多執行緒與使用生產線模式的效能差異有多大？
在同一部 Q9300 四核心的 Vista x64 測試機上：  
‧ 單執行緒版本：耗時 251.4 秒、CPU 使用率約 27%。  
‧ 兩階段 Pipeline 版本：耗時 163.7 秒、CPU 使用率約 43%。  
生產線模式將總時間縮短至原來的約 65%，效能提升約 1.5 倍。

## Q: 為什麼採用生產線模式後效能沒有如想像中直接快一倍？
因為兩個階段的執行時間不平衡：縮圖（Stage 1）比壓縮 ZIP（Stage 2）慢。Stage 2 經常處於閒置狀態（約 400 ms 才等到下一個工作），導致整體速度被較慢的階段綁住。

## Q: 如何解決生產線中某一階段成為瓶頸的問題？
常見做法有兩種：  
1. 再把該階段切成更小的步驟；  
2. 為該階段增加執行緒數。  
文章示範在 Stage 1 另外加一條執行緒，讓縮圖工作並行，結果總時間再降至 98.8 秒，CPU 使用率提升到 75~78%。

## Q: 能不能改用 ThreadPool 來加速第一階段？
可以，但要避免「加速過頭」。如果第一階段佔用過多執行緒或 CPU 核心，反而可能把資源搶走，讓後續階段跟不上，或因為過多的排程開銷而降低整體效能。

## Q: 把工作切成越多階段一定越快嗎？
不一定。  
1. 階段越多，生產線啟動與收尾時的「空轉成本」越高，必須以足夠大的工作量來攤平。  
2. 每個階段通常對應一條執行緒；若同時活躍的執行緒超過 CPU 核心數，持續的 context switch 反而可能拖慢效能。設計時必須在階段數、執行緒數與實際 CPU 資源之間取得平衡。