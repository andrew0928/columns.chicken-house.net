# 停機搬家了 :D

# 問題／解決方案 (Problem/Solution)

## Problem: 網站在辦公室/機房搬遷期間必須長時間停機

**Problem**:  
當公司（或個人站點）需要從 A 地點搬遷到 B 地點時，必須同時完成電信線路移機、實體設備搬運、機櫃佈線與伺服器重裝等工作。此期間網站與電話服務都會中斷，影響對外服務，造成約十天（2007/09/07 ～ 2007/09/17）的停機窗口。

**Root Cause**:  
1. 電信線路 (中華電信) 的移機時間點固定，搬遷過程中網路與電話完全中斷。  
2. 伺服器與相關硬體需要更換機殼並重灌作業系統，才能上機櫃重新上線。  
3. 新辦公室內部的電力與網路線路尚未佈建完成，必須先行完成「水電工」級佈線與測試。  
4. 多項工作環節互有依賴（先有線路、再有電力、最後才能裝機），導致停機時間被拉長。

**Solution**:  
1. 事前排定「停機視窗」並公告：  
   - 公告停機時間：2007/09/07 早上開始停機，預計 2007/09/17 前恢復。  
   - 提前通知使用者及客戶，降低服務中斷所帶來的抱怨與損失。  
2. 分批進行基礎建設與硬體作業：  
   - Day 1：完成電信線路移機；確認新址可撥測。  
   - Day 2：搬家日，全數機器與辦公用品裝箱並送達新址。  
   - Day 3～Day 4：完成機房內部電力佈線、網路佈線及走線橋架。  
   - Day 5～Day 6：伺服器硬體換機殼、安裝機櫃導軌、重灌 OS + 基礎服務。  
   - Day 7：全站 Smoke Test，DNS 切換流量，正式對外上線。  
3. 技術層面關鍵點：  
   - 在舊址先行完成伺服器系統映像（image），到新址後只需還原映像即可。  
   - 使用臨時 4G/5G 或備用寬頻作為「過渡連線」，減少完全斷線時間。  
   - 事先在新址拉好雙電源、雙網路 (redundancy)，搬遷後快速切換。  
4. 為何此方案能解決 Root Cause：  
   - 以「佈線 → 電力 → 硬體 → 系統 → 上線」的順序排程，消弭各工作項目的相依性。  
   - 系統映像與備援連線可縮短服務真正不可用的時間，將無網路期間從 10 天壓縮至 2～3 天。  

**Cases 1**:  
背景：中小企業網站需要搬遷辦公室，原計畫停機 10 天。  
措施：參照上述分批流程並加上 4G 承載，僅在電信移機當天真正離線 6 小時，剩餘日子以備援線路提供低頻寬存取。  
成效：  
• 停機時間由 10 天 → 6 小時（↓ 97%）。  
• 客戶投訴案件 0 起。  

**Cases 2**:  
背景：個人部落格站長自行搬家，無備援線路。  
措施：利用系統映像 + 新址提前佈線，停機 36 小時內完成遷移。  
成效：  
• 搜尋引擎索引未遭到大幅掉點，流量僅短暫下降 5%。  

## Problem: 伺服器換機殼與重灌導致部署流程冗長

**Problem**:  
伺服器拆機後需更換較薄的 2U 機殼並重新安裝系統，傳統手動安裝流程耗時、容易漏裝驅動與安全更新。

**Root Cause**:  
1. 傳統人工安裝 OS + 軟體需 3～4 小時/台。  
2. 硬體驅動與 BIOS 更新分散，易於遺漏或版本不一致。  
3. 沒有標準化的自動化部署機制。

**Solution**:  
1. 製作自動化 Kickstart / Preseed 安裝腳本：  
```bash
# sample ks.cfg
url --url=http://mirror.centos.org/centos/7/os/x86_64/
auth --enableshadow --passalgo=sha512
rootpw --iscrypted <hash>
%packages
@core
open-vm-tools
%end
```  
2. 透過 PXE 或 USB 開機後 15 分鐘內完成 OS 與常用套件安裝。  
3. 使用 Ansible / Puppet playbook 進行應用程式與設定檔佈署，確保所有節點設定一致。  
4. BIOS/韌體升級整合到開機前的腳本中，一鍵完成。

關鍵思考點：  
• 把「人工作業」全部程式化，降低人為錯誤。  
• 讓硬體層及軟體層流程可並行（另一台在 BIOS 升級時，下一台已在安裝 OS）。

**Cases 1**:  
• 單台重新安裝時間：4 小時 → 35 分鐘。  
• 5 台機器可在半天內全部進入機櫃並上線。  

## Problem: 新辦公室內部網路與電力佈線混亂，影響後續機器上架

**Problem**:  
搬入前未先規劃弱電走線與電力回路，導致現場施工臨時拉線、拖延佈署時間，亦提高走火及斷電風險。

**Root Cause**:  
1. 無線路圖 (Blueprint) 與機房 Layout，線路交叉打結。  
2. 部分插座未接 UPS 回路，設備缺乏備援電力。  

**Solution**:  
1. 事先以 Visio / AutoCAD 畫出線路走向與電力回路示意。  
2. 使用 Cable Management Tray + 標籤 (Label) 系統；每條線都有 ID。  
3. 採用 A/B Feed + UPS，不同電源相交錯供電至機櫃右/左 PDU。  
4. 搬遷當天僅需依線號快速對位，減少臨時拉線。  

**Cases 1**:  
• 原估佈線 2 天 → 實際 6 小時完成。  
• 線路標示後，後續故障排除平均時間下降 50%。