# (TBD) 權限管理機制的設計

## 摘要提示
- 向量資料庫授權困境: 目前主流 Vector DB 不支援 record-level 權限，需以 tags + filter 彌補。
- 檢索安全需求: 文件本身與搜尋結果片段都必須避免洩漏未授權資訊。
- 索引 VS 個人化: 為了 100 ms 內回應而大量預處理，易與「因人過濾」的安全需求衝突。
- RBAC 降維思維: 以角色與分類取代人×文件的組合，可將 50 萬筆權限對映縮成 100 筆。
- Tags 作為通用索引鍵: 任何資料庫皆易於對「有限標籤」建立索引，因此能低成本過濾。
- RAG 實務: Microsoft Kernel Memory 官方文件示範用 UserID Tag 與多條件 Filter 做授權。
- 標註位置選擇: 標籤可貼在資料、使用者或操作上，執行查詢時動態組合。
- ABAC / PBAC 演進: 以屬性或政策描述更複雜情境，最終仍要落回可索引標籤。
- 設計核心原則: 「先降級成有限標籤，再談資料庫 Schema」是安全又高效的關鍵。
- 敏感資料防漏: 嚴謹過濾機制可避免因摘要或提示詞把個資、機密洩露到 UI 或 LLM。

## 全文重點
本文以在 .NET Conf 分享 RAG 經驗為引，探討「檢索服務中的權限管理」設計思路。向量資料庫天生講求高效相似度查詢，但普遍缺乏 record-level ACL；若直接把機密文件餵給索引，很容易在搜尋結果或 LLM 回答中外洩。為同時滿足效能與安全，需要在「資料生成階段」就貼上語意簡單、數量有限的標籤，讓執行期僅靠 tags + filter 就能把未授權文件排除。

文章先勾勒業務需求：上萬份文件、不同部門與角色、甚至指定使用者才能閱讀；更要求搜尋清單、摘要與向量檢索結果都不能含未授權內容。接著作者分析為何傳統關聯式、NoSQL 乃至 Vector DB 都難以隨查詢者身分動態過濾，核心原因是大量離線索引與統計工作無法預知「誰」會查詢。

解法在於「降維與貼標」。以最常見的 RBAC 為例，將 100 人 × 5000 文件的 50 萬種權限狀態，壓縮成五個角色 × 二十個分類的百筆設定，再把角色寫進使用者表、分類寫進文件表，查詢時根據登入者角色動態加入 category filter；對 NoSQL / Vector DB 亦同，只要把角色可見的分類列表放進 RAM 或程式碼，再用帶索引的 tags 過濾即可。

作者進一步提到 ABAC（Attribute-Based Access Control）與 PBAC（Policy-Based Access Control），它們讓授權能參考時間、地點、作業型態等更細的屬性或政策，但最後仍須映射到「可索引的有限標籤」才能落地於檢索服務。文末以 「在資料上貼標」「在人或操作上貼標」「查詢時如何組合標籤」三步驟總結，並以 Microsoft Kernel Memory 的安全篩選範例示範完整流程，說明只要設計得當，RAG 與企業機密文件並非天然衝突。

## 段落重點
### 1. 需求
作者描述企業在文件檢索上的安全要求：數以萬計的文件需依部門、角色甚至個別使用者設權，且搜尋結果任何片段都不能洩漏未授權內容。然而搜尋與相似度演算法依賴大量預處理才能在 100 ms 內回傳，這與「因人而異」的安全訴求天然衝突。若不了解底層索引與權限模型，很難設計出符合 Relational、NoSQL 甚至 Vector Database 的 Schema。文章目的即是解析授權原理並以 Microsoft Kernel Memory 的 RAG 案例示範可行做法。

### 2. 個人授權
本節討論「以使用者為中心」設定權限的直覺做法：直接為每份文件列出可讀取的使用者清單。雖然概念簡單，但在人數與文件數均爆量的情境下馬上失控；例如 100 人 × 5000 文件需紀錄 50 萬筆布林對映，不僅儲存成本高，更新與維運也災難。此節為引子，說明必須引入「抽象化角色」把複雜度降維，為後續 RBAC 舖路。

### 2. 最常見的授權模型：RBAC
作者詳細說明 RBAC 如何透過「角色」與「分類」兩層抽象，把巨量的個別授權壓縮成可管理的百筆設定。實作上，人員資料表新增 Role 欄位，文件資料表新增 Category；再建一張小型對映表紀錄 (Role × Category) 是否可讀。查詢時系統已知當下使用者角色，只需把允許的 Category 列表加進 where 條件，或在 NoSQL / Vector Query 裡加上 tags filter，即可高效排除未授權文件，且因標籤種類有限能輕易建立索引。

### 3. ABAC
ABAC 引入「屬性」概念，允許依使用者屬性、資源屬性與環境屬性動態決策，例如「境外登入只能看公開文件」「九點後禁止下載」。雖靈活度高，實作時仍須在資料產生期把可索引的屬性標籤寫入資源，或把使用者屬性轉成查詢時的 filter；否則將落入執行期逐筆比對的效能陷阱。此節強調：不論屬性多豐富，最終仍要回歸「有限且可索引的標籤」。

### 4. PBAC
PBAC 進一步把授權規則寫成可版本化、可審計的政策文件，如 OPA/Rego、AWS IAM Policy。好處是集中管理與治理，但對檢索服務而言，政策執行結果終究要轉成「哪些標籤允許被取用」。因此實務會在查詢發生前先跑一次政策引擎，把結果快取成可插入 Vector DB 的 filters，兼顧治理與效能。

### 5. 降級成 Tag 的操作
作者歸納三步驟讓任意授權模型落地於檢索系統。

#### 5-1. 在「資料」上貼標
針對文件或向量片段，在寫入索引時就附上 Category、敏感等級等標籤，確保後續查詢能據此過濾。

#### 5-2. 在「人」或「操作」上貼標
使用者登入後映射出角色、屬性或政策結果，轉成同樣格式的標籤或允許列表，並快取於記憶體。

#### 5-3. 查詢當下要用什麼標籤過濾
實際執行檢索（不論 SQL、NoSQL、Vector）時，把步驟 5-2 的允許標籤塞進 filter 條件，即可在 100 ms 內擋掉所有未授權文件；若再配合 Microsoft Kernel Memory 的 Tag-Filter 實作，即可將 RAG 與企業資料安全無縫整合。

