# 權限管理機制的設計（以 RAG/向量檢索為例）

## 問題與答案 (FAQ)

### Q&A 類別 A: 概念理解類

Q1: 什麼是授權機制？
- A簡: 授權機制是判定誰能對資源做什麼的規則與流程集合，確保最小必要權限並避免資料外洩。
- A詳: 授權機制（Authorization）是系統在認證使用者身份後，決定其對特定資源可執行操作範圍的集合，包括讀取、修改、刪除等。其特點是可配置、可審計、可擴充，常見模型有 RBAC、ABAC、PBAC 等。於文件檢索與 RAG 情境中，授權機制確保召回、重排與生成各階段都不會暴露未授權內容，實踐最小權限原則與合規需求。
- 難度: 初級
- 學習階段: 基礎
- 關聯概念: A-Q2, A-Q7, A-Q10, B-Q11

Q2: 為什麼搜尋與檢索需要授權？
- A簡: 搜尋結果易外顯內容片段，若未控管權限，將在召回、摘要、清單中洩漏敏感資訊。
- A詳: 搜尋與檢索會在索引與查詢時暴露文件標題、摘要、片段與相關性線索。當結果需依人而異（個人化或部門、角色限制）時，若無授權約束，未授權的敏感內容可能透過清單、snippet 或生成摘要洩露。特別在 RAG 與向量檢索，語義相似召回可能跨越顯性分類，因此需在召回前注入權限過濾，並在重排與生成階段再加一層防線。
- 難度: 初級
- 學習階段: 基礎
- 關聯概念: A-Q3, A-Q6, B-Q11, D-Q1

Q3: 什麼是記錄層級授權（Record-level Permission）？
- A簡: 對單筆資料或文件逐一決定可見性，細緻但實作與維護成本高。
- A詳: 記錄層級授權是對每筆資料（如每份文件、每個段落）分別設定可讀/可改權限的控制方式。其優點是最細緻、符合嚴格合規；缺點是設定組合爆炸、索引難優化、查詢成本高。向量檢索多不原生支援此級別，因此需以標籤化與過濾策略間接達成等效效果。
- 難度: 初級
- 學習階段: 核心
- 關聯概念: A-Q4, B-Q5, C-Q4

Q4: 為何多數向量資料庫不提供記錄層級權限？
- A簡: 向量庫優化相似度檢索與吞吐，內建 ACL 會犧牲索引結構與查詢效率。
- A詳: 向量資料庫（如 Azure AI Search 向量索引、Qdrant、Pinecone）專注高維向量索引與近似最近鄰查詢。若內建記錄層級 ACL，需在向量索引內維持大量細粒度條件，破壞緊湊索引與快取效果，導致查詢延時與成本上升。因此普遍做法是用 metadata/tags 標註，於查詢前套用 filter，兼顧安全與效能。
- 難度: 初級
- 學習階段: 核心
- 關聯概念: A-Q5, B-Q3, B-Q14

Q5: 什麼是標籤（tags）與過濾（filters）？
- A簡: 標籤是元資料鍵值；過濾是以邏輯條件選出符合標籤的記錄。
- A詳: 標籤是附著於資料或請求的結構化元資料，如 role=R1、catalog=C05、tenant=T1、owner=U123。過濾則是在查詢時依標籤條件（如 AND/OR/NOT、in、range）限制可被檢索的集合。此模式易索引、易快取、可組合，適合將複雜授權降維為有限枚舉的標籤組合，以低成本實作個別化可見性。
- 難度: 初級
- 學習階段: 基礎
- 關聯概念: A-Q12, B-Q2, B-Q8

Q6: 標籤過濾在 RAG 中的核心價值是什麼？
- A簡: 在召回前縮小可見集合，避免未授權內容進入重排與生成流程。
- A詳: RAG 的風險在於「先看後控」，若未於召回階段就限制可見集合，即使後續重排/生成過濾，也可能因候選曝光與快取留下風險。以標籤過濾於召回前注入條件（role、tenant、category、personal_allow），能確保後續所有階段僅處理被允許的候選，降低洩漏面積，並降低重排與生成的負荷與延時。
- 難度: 中級
- 學習階段: 核心
- 關聯概念: B-Q11, C-Q7, D-Q1

Q7: 什麼是 RBAC（Role-Based Access Control）？
- A簡: 以角色授權，使用者繫結角色，角色繫結資源操作，簡化管理。
- A詳: RBAC 將授權抽象為角色集合：使用者→角色→資源/操作。優點是可大幅降維，適合穩定職能分工；缺點是對例外需求與細部差異支持有限。於檢索場景，常以角色×分類矩陣產生可見標籤清單，再在查詢時注入 filters，提高效能並便於審計。
- 難度: 初級
- 學習階段: 基礎
- 關聯概念: A-Q10, B-Q5, C-Q4

Q8: 什麼是 ABAC（Attribute-Based Access Control）？
- A簡: 以屬性為基礎的授權：人、資源、環境屬性經政策評估決定。
- A詳: ABAC 使用者屬性（部門、資歷）、資源屬性（分類、敏感等級）、環境屬性（時間、地點、裝置）等作為決策輸入，經政策引擎計算許可/拒絕。優點是表達力強、彈性高；缺點是政策複雜度與維運成本高。可透過屬性預映射為標籤集合，於查詢注入 filters 達成可擴充安全。
- 難度: 中級
- 學習階段: 核心
- 關聯概念: A-Q10, B-Q6, D-Q4

Q9: 什麼是 PBAC（Policy-Based Access Control）？
- A簡: 以政策語言撰寫規則，由決策點動態評估授權結果。
- A詳: PBAC 強調用標準化政策語言（如 OPA/Rego、XACML）表達規則，將決策與服務解耦。請求攜帶上下文，送至政策決策點（PDP）計算許可，結果由策略執行點（PEP）強制。適合複雜、多域、合規高要求場景。可將結果投影為查詢標籤或 deny 列表，落地到檢索層。
- 難度: 中級
- 學習階段: 進階
- 關聯概念: A-Q10, B-Q7, B-Q8

Q10: RBAC、ABAC、PBAC 的差異與選用時機？
- A簡: RBAC 簡易降維；ABAC 彈性強；PBAC 標準化治理。依複雜度與合規選型。
- A詳: RBAC 適合角色清晰、規則穩定；ABAC 適合需依情境動態決策；PBAC 適合跨系統治理、需審計與標準語言。實務常見混合：RBAC 為主、ABAC 屬性微調、PBAC 作整體治理與審核。三者最終可降維為 tags+filters 注入檢索層，統一實施。
- 難度: 中級
- 學習階段: 核心
- 關聯概念: A-Q7, A-Q8, A-Q9, B-Q5

Q11: 何謂個人授權（使用者例外清單）？
- A簡: 在角色外另設白名單/黑名單，細緻調整到人級授權。
- A詳: 個人授權用於對特定使用者增減權限（如臨時專案合作）。可建 user→doc 的 allow/deny 表，或預計算為 per-user tags（如 allow_doc_ids），在查詢時與角色/分類標籤一併過濾。需謹慎快取與失效，避免角色變更後殘留過期授權。
- 難度: 中級
- 學習階段: 核心
- 關聯概念: B-Q10, C-Q5, D-Q6

Q12: 為什麼要將授權「降級」為標籤操作？
- A簡: 標籤具可索引、可快取、可合併特性，能在召回前低成本過濾。
- A詳: 將複雜授權決策（角色、屬性、政策）預先解算為有限標籤集合，查詢時以 filters 套用，可利用索引結構與快取，避免逐筆 ACL 計算。此法將高耦合決策與高吞吐召回解耦，適合向量檢索等高延時敏感場景。關鍵在標籤設計與一致性維護。
- 難度: 中級
- 學習階段: 核心
- 關聯概念: A-Q5, B-Q8, B-Q14

Q13: 資料標籤與使用者標籤有何差異？
- A簡: 資料標籤描述資源屬性；使用者標籤描述請求人屬性或上下文。
- A詳: 資料標籤（document metadata）如分類、租戶、敏感級別；使用者標籤（principal/context）如角色、部門、地點、裝置。授權決策是二者（含環境）之關係判斷，落地時常將使用者標籤經政策投影為允許的資料標籤集合，以便在資料層直接過濾。
- 難度: 初級
- 學習階段: 基礎
- 關聯概念: A-Q8, B-Q6, C-Q1

Q14: 查詢時應用哪些標籤與順序？
- A簡: 先租戶隔離，再角色/分類，最後個人授權與時效，採 deny 優先。
- A詳: 一般順序為：tenant_id 嚴格隔離；依角色展開可見分類/資料標籤；套用個人 allow/deny；再加時效（valid_from/to）與環境限制。策略上 recommend deny overrides，高風險先排除。將結果注入檢索 filters，形成最小可見集合。
- 難度: 中級
- 學習階段: 核心
- 關聯概念: B-Q8, B-Q9, C-Q8

Q15: 在 RAG 中如何避免摘要洩漏？
- A簡: 三級防線：召回前過濾、重排再過濾、生成前後審核與遮蔽。
- A詳: 先在召回加入嚴格 filters，讓候選不含未授權內容；重排時對候選再做 ACL 檢查；生成階段對引用片段逐段驗證，必要時遮蔽（mask/redact）或拒答；回應中避免顯示未授權標題、路徑、統計訊號。可加上禁止跨片段合成策略。
- 難度: 中級
- 學習階段: 進階
- 關聯概念: B-Q11, C-Q7, D-Q9

Q16: 什麼是 Deny overrides 與 Permit overrides 策略？
- A簡: Deny 優先：有任一拒絕則拒絕；Permit 優先：有任一允許則允許。
- A詳: 聚合多條規則時，Deny overrides 將安全置於首位，任何拒絕訊號都導致拒絕；Permit overrides 則偏向可用性，任一允許即通過。安全檢索建議採 Deny overrides，尤其在多來源標籤與多層判斷時，可降低誤授權風險。
- 難度: 中級
- 學習階段: 進階
- 關聯概念: A-Q14, B-Q6, D-Q1

### Q&A 類別 B: 技術原理類

Q1: Microsoft Kernel Memory 的安全過濾如何運作？
- A簡: 以文件貼 user_id 或群組標籤，查詢時注入過濾條件，僅召回授權資料。
- A詳: 原理是以 metadata/tags 為資料建立可過濾欄位，如 user_ids、group_ids、tenant_id、category。應用端在查詢前取得來自授權引擎的允許標籤集合，將其以 filters 注入檢索請求，使近似搜尋只在被允許的子集合進行。關鍵步驟：標籤設計與寫入、授權計算、查詢注入、結果驗證。核心組件：標籤儲存、Policy/ACL 決策器、Filter 注入器。
- 難度: 中級
- 學習階段: 核心
- 關聯概念: A-Q6, C-Q2, C-Q7

Q2: Azure AI Search 的 filter 原理與語法為何？
- A簡: 以 OData 過濾語法對可過濾欄位執行布林與集合運算。
- A詳: Azure AI Search 支援 filterable fields 與 OData filter（eq/ne/and/or/in/any/all），向量查詢可同時帶 filter 限定候選集合。流程：定義可過濾欄位、建立索引、上傳文件含 metadata、查詢時在 vector query 旁帶 $filter。核心組件：索引 schema、Indexers、Search REST/SDK、向量與過濾執行器。
- 難度: 中級
- 學習階段: 核心
- 關聯概念: C-Q3, C-Q7, D-Q2

Q3: Qdrant/Pinecone 的 metadata filter 機制是什麼？
- A簡: 將 metadata 存成鍵值，查詢時用條件樹（AND/OR/NOT、in、range）過濾。
- A詳: Qdrant 使用 payload filters（must/should/must_not），Pinecone 使用 filter JSON 對 metadata 鍵執行集合/範圍匹配。關鍵步驟：定義 payload schema、寫入向量與 metadata、查詢時傳入 filter 物件。核心組件：向量索引、Payload 存儲、Filter 解譯器、近似最近鄰搜尋器。
- 難度: 中級
- 學習階段: 核心
- 關聯概念: C-Q6, B-Q14, D-Q1

Q4: 安全檢索的資料處理管線（ingestion→query）如何設計？
- A簡: 產生與驗證標籤→分塊→嵌入→寫入→查詢前注入 filters→結果再驗證。
- A詳: 流程：原始文件驗證來源→抽取 metadata/分類→貼標（角色、租戶、所有者、時效）→分塊與去重→產生向量嵌入→寫入向量庫與可過濾欄位→建立審計資訊。查詢：認證→決策（RBAC/ABAC/PBAC）→投影為標籤集合→注入 filters→召回→重排→授權再檢→生成與遮蔽→審計記錄。核心：標籤一致性、可重現審計。
- 難度: 中級
- 學習階段: 核心
- 關聯概念: A-Q12, B-Q11, C-Q1

Q5: 如何將 RBAC 降維為標籤資料模型？
- A簡: 以角色×分類矩陣預計算允許分類，文件貼分類標籤，查詢用 in 過濾。
- A詳: 模型：Users(role)、Docs(category)、Perm(role,category)。將 Perm 展開成每使用者允許分類集合 categories_allowed。文件存 tags.catalog=[Cxx]。查詢時注入 filter catalog in categories_allowed。步驟：維護矩陣→同步快取→查詢注入。核心：高選擇性欄位、內存快取、失效策略。
- 難度: 初級
- 學習階段: 核心
- 關聯概念: A-Q7, C-Q4, D-Q3

Q6: ABAC 的屬性評估與決策流程是什麼？
- A簡: 聚合人、資源、環境屬性，政策引擎計算許可，投影成標籤集合。
- A詳: 元件：PIP（屬性提供者）、PDP（決策點）、PEP（執行點）。流程：收集屬性→載入政策→評估（time in range、dept match、risk score）→輸出 Permit/Deny 與可見標籤集合/限制（如敏感等級<=2）。將結果轉為 filters（level<=2 AND catalog in ...）。核心：可解釋、可測試的政策與觀測。
- 難度: 中級
- 學習階段: 進階
- 關聯概念: A-Q8, A-Q14, B-Q8

Q7: PBAC 與政策語言（如 OPA/Rego）的架構怎麼設計？
- A簡: 用 Rego 撰寫規則，服務作為 PDP，API 當 PEP 強制執行決策。
- A詳: 架構：策略庫（GitOps）→OPA/自建 PDP 部署→PEP（API Gateway/應用）攜上下文查詢→PDP 回傳允許與可見標籤→PEP 注入 filters 並強制執行。步驟：政策版本化、單元測試、灰度發佈、審計打點。核心：策略熱更新、延遲容忍、故障降級（fail-closed）。
- 難度: 高級
- 學習階段: 進階
- 關聯概念: A-Q9, B-Q12, D-Q10

Q8: 查詢時的 Filter Injection 中介層如何設計？
- A簡: 介於應用與檢索之間，將決策輸出轉為 filters，統一治理與審計。
- A詳: 中介層負責：認證解析→授權決策→標籤投影→多後端語法轉換（Azure/Qdrant/Pinecone）→可觀測性→回退策略。步驟：抽象 Filter AST、目標庫轉譯、白/黑名單合併、Deny overrides、緩存與失效。核心：一致語意、低延遲、跨供應商可攜性。
- 難度: 高級
- 學習階段: 進階
- 關聯概念: A-Q12, C-Q8, D-Q2

Q9: 多租戶隔離的標籤設計原理是什麼？
- A簡: 以 tenant_id 作強制性過濾鍵，所有資料與查詢皆需包含匹配條件。
- A詳: 租戶隔離優先於其他條件，資料側以 tenant_id 作必填且 filterable；查詢側從 token/請求上下文獲取 tenant_id，Filter Injection 嚴格添加 tenant_id=xxx。可加硬性護欄：跨租戶拒絕、審計、測試用樣本生成器。核心：不可繞過性與預設拒絕。
- 難度: 中級
- 學習階段: 核心
- 關聯概念: A-Q14, C-Q8, D-Q5

Q10: 授權決策緩存與失效機制如何運作？
- A簡: 用短 TTL 與事件失效雙軌，保證新鮮度與效能的平衡。
- A詳: 緩存內容：使用者可見標籤集合、角色展開、個人授權。策略：短 TTL（如 60s）+ 事件驅動失效（角色變更、租戶切換、政策更新）。支援版本號校驗與灰度。核心：強一致於安全相關、最終一致於低風險欄位。
- 難度: 中級
- 學習階段: 進階
- 關聯概念: A-Q11, D-Q6, D-Q8

Q11: 搜尋召回、重排、生成的三級防線是什麼？
- A簡: 召回前過濾、重排再檢、生成遮蔽，層層阻斷未授權資訊外露。
- A詳: 第一道（召回）：以 filters 限縮候選；第二道（重排）：對候選再做 ACL/標籤檢查與權重調整；第三道（生成）：按引用片段校驗權限、遮蔽敏感欄位、拒答策略。核心：最小可見集、Deny overrides、全鏈路審計與測試。
- 難度: 中級
- 學習階段: 核心
- 關聯概念: A-Q15, C-Q7, D-Q9

Q12: 記錄層級稽核與可追蹤性如何設計？
- A簡: 記錄誰在何時用何上下文查了哪份資料與決策依據。
- A詳: 稽核包含：請求 ID、使用者/租戶、時間、決策輸入（標籤/政策版本）、過濾表達式、召回候選清單摘要、最終回應與遮蔽。支持查詢重放與決策重算，保證可重現性。核心：低成本結構化日誌、PII 保護與留存策略。
- 難度: 中級
- 學習階段: 進階
- 關聯概念: B-Q7, C-Q10, D-Q10

Q13: 時效型授權與時間序列標籤如何落實？
- A簡: 用 valid_from/to 或狀態標籤，查詢時套用時間範圍過濾。
- A詳: 文件與授權關係加上生效與失效時間；查詢注入 now between valid_from and valid_to。可配合排程將過期關係標記或清理。核心：時間索引支持與時區一致性、快取失效、審計時間旅行（point-in-time replay）。
- 難度: 中級
- 學習階段: 進階
- 關聯概念: C-Q9, D-Q6, B-Q10

Q14: 效能與成本優化：索引與選擇性如何評估？
- A簡: 提升 filter 選擇性、減少高基數欄位、分離熱欄位與冷欄位。
- A詳: 評估欄位的選擇性（cardinality/selectivity）與查詢頻率，將高選擇性且常用的標籤設為 filterable 並索引；將高基數低選擇性欄位降維或離線處理。可採前綴分區（租戶）、Bloom filter 預判、分檔存儲。核心：正交標籤、避免標籤爆炸。
- 難度: 中級
- 學習階段: 進階
- 關聯概念: B-Q3, D-Q2, D-Q3

### Q&A 類別 C: 實作應用類

Q1: 如何在文件入庫時自動貼標（角色、分類、租戶）？
- A簡: 於抽取階段產生標籤並寫入 metadata，標準化命名與型別，供後續過濾使用。
- A詳: 具體步驟：1) 文件來源驗證；2) 抽取部門/分類/敏感等級；3) 以租戶 ID、分類、擁有者、有效期產生 tags；4) 分塊與去重；5) 產生嵌入與寫入向量庫。程式碼：寫入欄位如 tags.catalog=["C05"], tags.tenant="T1", tags.owner="U123"。注意一致命名、值域控管、索引設定與測試集。
- 難度: 初級
- 學習階段: 基礎
- 關聯概念: B-Q4, A-Q5, A-Q13

Q2: 如何在 .NET 使用 Kernel Memory 設定安全過濾？
- A簡: 查詢前取得允許標籤集合，呼叫檢索 API 時帶入 filter 參數限制候選。
- A詳: 步驟：1) 透過授權服務取得可見標籤（如 categories_allowed、tenant_id）；2) 建立檢索請求（query, topK, filters）；3) 執行召回與後續流程。程式碼片段（概念）：filters: { "tenant":"T1", "catalog": ["C01","C05"], "owner_any_of":["U123"] }。注意：Deny overrides、租戶必帶、審計請求。
- 難度: 中級
- 學習階段: 核心
- 關聯概念: B-Q1, B-Q8, C-Q7

Q3: 如何在 Azure AI Search 建索引與 filter 欄位？
- A簡: 定義 filterable 的 metadata 欄位，載入文件與向量，查詢時以 $filter 套用。
- A詳: 步驟：1) 索引定義：fields 包含 tenant, catalog, owner, valid_from/to 設為 filterable；2) 載入文件與向量欄位；3) 查詢：vector query + $filter="tenant eq 'T1' and catalog in ('C01','C05')"；4) 驗證結果與效能。注意：啟用必要欄位搜尋能力與分析器、避免過多 filterable 高基數欄位。
- 難度: 中級
- 學習階段: 核心
- 關聯概念: B-Q2, D-Q2, D-Q3

Q4: 如何設計 RBAC 對照表並產生查詢條件？
- A簡: 建 Users(role)、Docs(category)、Perm(role,category)，展開為可見分類集合。
- A詳: 步驟：1) 設計三表與唯一鍵；2) 管理後台維護 Perm 矩陣；3) 每次查詢以 role 查 Perm，得 categories_allowed；4) 注入 filters: catalog in categories_allowed；5) 緩存 categories_allowed。程式碼：SELECT category FROM Perm WHERE role=@role。注意：矩陣版本化與審計。
- 難度: 初級
- 學習階段: 核心
- 關聯概念: B-Q5, D-Q6, D-Q3

Q5: 如何支援個人授權（白名單/黑名單）？
- A簡: 增設 UserDocAllow/Deny，查詢時優先套用 deny，再合併 allow 到 filters。
- A詳: 步驟：1) 設計表 UserDocAllow(user,doc)、UserDocDeny(user,doc)；2) 查詢時計算 deny_docs 與 allow_docs；3) 生成 filters：NOT id in deny_docs AND (catalog in ... OR id in allow_docs)；4) 短 TTL 緩存與事件失效。注意：Deny overrides、避免過多 ID 列表造成查詢過長。
- 難度: 中級
- 學習階段: 進階
- 關聯概念: A-Q11, B-Q10, D-Q1

Q6: 如何在 Qdrant/Pinecone 實作 metadata filter？
- A簡: 將租戶、分類、角色等寫入 payload，查詢時提交 JSON 過濾條件。
- A詳: Qdrant 範例（概念）：filter: { must:[{ key:"tenant", match:{ value:"T1"}}, { key:"catalog", values:["C01","C05"]}] }。Pinecone 類似：filter: { tenant:"T1", catalog:{ "$in":["C01","C05"] } }。注意：payload 索引配置、最大過濾條件長度、測試選擇性與效能回歸。
- 難度: 中級
- 學習階段: 核心
- 關聯概念: B-Q3, B-Q14, D-Q2

Q7: 如何避免摘要顯示未授權片段（生成階段 gating）？
- A簡: 對每個引用片段逐段 ACL 檢查，未通過則遮蔽或拒絕回答。
- A詳: 步驟：1) 追蹤檢索返回之片段 ID；2) 在生成前以相同 filters 再檢驗；3) 對敏感欄位做遮蔽（如「***」）；4) 生成後再掃描輸出並比對敏感詞/規則；5) 記錄審計。注意：跨片段合成風險、流式輸出中途校驗、prompt 明確禁止使用未授權片段。
- 難度: 中級
- 學習階段: 進階
- 關聯概念: B-Q11, D-Q9, A-Q15

Q8: 如何實作多租戶隔離與 API 層注入 tenant filter？
- A簡: 從身份票證取得 tenant_id，API 強制注入過濾，不允許客戶端覆蓋。
- A詳: 步驟：1) 身份層發行含 tenant_id 的 token；2) API PEP 解析 token，合成 filters：tenant=...；3) 濾掉客戶端自帶的 tenant 參數，防止混淆/繞過；4) 對所有檢索與補救路徑一致強制。注意：多租戶測試隔離、租戶配額與節流、租戶級審計。
- 難度: 中級
- 學習階段: 核心
- 關聯概念: B-Q9, B-Q8, D-Q5

Q9: 如何導入時效標籤（有效期）與排程清理？
- A簡: 增加 valid_from/to 標籤，查詢注入時間條件，定期標記或清理過期。
- A詳: 步驟：1) schema 新增 valid_from/to；2) 寫入時校驗時區與格式；3) 查詢注入 now>=valid_from AND now<valid_to；4) 排程週期性淘汰過期 allow/deny；5) 稽核保留變更歷史。注意：快取時間漂移、DST、跨區部署時鐘同步。
- 難度: 中級
- 學習階段: 進階
- 關聯概念: B-Q13, D-Q6, B-Q10

Q10: 如何做權限與查詢稽核（Audit log）？
- A簡: 記錄請求上下文、決策輸入輸出、過濾表達與結果摘要，支持重放。
- A詳: 步驟：1) 定義審計結構：request_id、user、tenant、policy_version、filters、候選摘要、回應；2) 在 PEP 與檢索適配器處加打點；3) 儲存到可查詢的日誌庫；4) 提供重放工具依時點還原決策。注意：去識別化、敏感值遮蔽、留存期限與查核流程。
- 難度: 中級
- 學習階段: 進階
- 關聯概念: B-Q12, D-Q10, A-Q2

### Q&A 類別 D: 問題解決類

Q1: 搜尋結果出現未授權文件怎麼辦？
- A簡: 先檢查召回前的 filters 是否注入與生效，再檢驗重排與生成階段護欄。
- A詳: 症狀：清單或摘要含未授權內容。原因：未注入租戶/角色/個人過濾，或 deny 覆蓋失效。解法：1) 開啟審計，確認 filters；2) 驗證資料側標籤正確；3) 重排/生成階段 ACL 檢查；4) 補上 Deny overrides。預防：測試樣本庫、策略門檻、灰度發佈。
- 難度: 初級
- 學習階段: 核心
- 關聯概念: B-Q11, C-Q2, C-Q7

Q2: 加上 filter 後查詢變慢如何優化？
- A簡: 提升選擇性、索引關鍵欄位、精簡過濾條件並快取決策結果。
- A詳: 症狀：延時上升、吞吐下降。原因：高基數欄位過濾、filter 無索引、條件過長。解法：1) 調整 schema（filterable 高選擇性欄位）；2) 合併條件、以集合 in 取代多 OR；3) 緩存可見分類集合；4) 分租戶分片。預防：效能基準、回歸測試、觀測與告警。
- 難度: 中級
- 學習階段: 進階
- 關聯概念: B-Q14, C-Q3, C-Q6

Q3: 標籤爆炸、組合太多如何處理？
- A簡: 以角色/分類降維、採用正交標籤設計、避免高基數直接入索引。
- A詳: 症狀：標籤類別與值數暴增。原因：直接用人或文件 ID 當常用 filter；過度細粒度。解法：1) 將人/文件 ID 轉為分類或群組；2) 個人授權以 ID 列表但控制長度；3) 冷門條件離線處理。預防：標籤治理、命名規範、審核流程。
- 難度: 中級
- 學習階段: 進階
- 關聯概念: B-Q5, B-Q14, C-Q5

Q4: ABAC 規則過多難維護怎麼辦？
- A簡: 政策模組化、屬性治理、單元測試與政策版本管理，必要時回歸 RBAC。
- A詳: 症狀：規則相互衝突、理解成本高。原因：屬性膨脹、缺乏治理。解法：1) 模組化政策、共用函式；2) 限制屬性來源與質量；3) 引入 PBAC 與 GitOps；4) 定期回顧，能 RBAC 的就 RBAC。預防：策略走查、覆蓋率報告、灰度與回滾。
- 難度: 中級
- 學習階段: 進階
- 關聯概念: A-Q8, B-Q6, B-Q7

Q5: 多租戶資料外洩風險如何診斷與防堵？
- A簡: 檢查 tenant 強制過濾、去除客戶端自帶 tenant、全鏈路審計與測試。
- A詳: 症狀：跨租戶看見彼此資料。原因：未注入或被覆蓋的 tenant filter；測試資料混用。解法：1) PEP 強制注入 tenant；2) 拒絕客戶端 tenant 覆寫；3) 加租戶級回歸測試；4) 審計抽查。預防：預設拒絕、分環境資料、假名化樣本。
- 難度: 中級
- 學習階段: 核心
- 關聯概念: B-Q9, C-Q8, B-Q12

Q6: 角色變更後仍看到舊權限內容怎麼辦？
- A簡: 啟用事件驅動快取失效與短 TTL，並檢查政策版本與時效標籤。
- A詳: 症狀：權限更新不即時。原因：緩存過久、失效事件未送達、時效條件錯誤。解法：1) 設定短 TTL；2) 事件總線廣播失效；3) 驗證 valid_from/to；4) 清理過期個人授權。預防：雙軌緩存與監控、回退策略。
- 難度: 初級
- 學習階段: 核心
- 關聯概念: B-Q10, B-Q13, C-Q9

Q7: 嵌入向量導致語義洩漏如何防範？
- A簡: 嚴格召回過濾、片段級權限、遮蔽敏感欄位與最少上下文注入。
- A詳: 症狀：語義相似跨域召回敏感內容。原因：嵌入空間鄰近未授權片段。解法：1) 召回用 filters 限縮；2) 片段貼權限標籤而非僅文件級；3) 敏感欄位預遮蔽；4) 嵌入前去除 PII。預防：定期風險掃描、紅隊測試、prompt 防越權。
- 難度: 中級
- 學習階段: 進階
- 關聯概念: B-Q11, C-Q7, A-Q15

Q8: 快取導致授權判斷過舊如何處理？
- A簡: 使用短 TTL+事件失效，決策帶版本號，過舊時強制重算。
- A詳: 症狀：看到不該看的或看不到該看的。原因：快取不一致或過期未失效。解法：1) 加版本號（policy_version、role_rev）驗證；2) 接入事件總線；3) 熱點使用者不快取或 TTL 更短。預防：一致性指標、壓力測試、SLO 告警。
- 難度: 中級
- 學習階段: 進階
- 關聯概念: B-Q10, C-Q5, D-Q6

Q9: 產生式摘要透露敏感片段如何修補？
- A簡: 引用前 ACL 校驗、輸出審核與遮蔽、拒答策略與回退流程。
- A詳: 症狀：回應中出現敏感字串。原因：生成忽略授權、RAG prompt 缺護欄。解法：1) 對引用片段核對 filters；2) 生成後規則掃描遮蔽；3) 無可用片段則拒答或回退至安全摘要；4) 審計與通報。預防：三級防線、提示工程與測試庫。
- 難度: 中級
- 學習階段: 進階
- 關聯概念: B-Q11, C-Q7, A-Q15

Q10: 稽核缺口導致無法重現授權決策怎麼辦？
- A簡: 補齊請求上下文、政策版本、過濾表達與候選摘要的結構化日誌。
- A詳: 症狀：事故後無法回放。原因：缺乏標準審計欄位。解法：1) 設計統一審計 schema；2) PEP 與檢索層加打點；3) 提供重放工具；4) 建立留存與查核流程。預防：定期演練、審計覆蓋率報表、合規稽核。
- 難度: 中級
- 學習階段: 進階
- 關聯概念: B-Q12, C-Q10, B-Q7

### 學習路徑索引
- 初學者：建議先學習哪 15 題
    - A-Q1: 什麼是授權機制？
    - A-Q2: 為什麼搜尋與檢索需要授權？
    - A-Q3: 什麼是記錄層級授權（Record-level Permission）？
    - A-Q5: 什麼是標籤（tags）與過濾（filters）？
    - A-Q7: 什麼是 RBAC（Role-Based Access Control）？
    - A-Q8: 什麼是 ABAC（Attribute-Based Access Control）？
    - A-Q10: RBAC、ABAC、PBAC 的差異與選用時機？
    - A-Q12: 為什麼要將授權「降級」為標籤操作？
    - A-Q13: 資料標籤與使用者標籤有何差異？
    - A-Q14: 查詢時應用哪些標籤與順序？
    - B-Q4: 安全檢索的資料處理管線（ingestion→query）如何設計？
    - B-Q11: 搜尋召回、重排、生成的三級防線是什麼？
    - C-Q1: 如何在文件入庫時自動貼標（角色、分類、租戶）？
    - C-Q3: 如何在 Azure AI Search 建索引與 filter 欄位？
    - D-Q1: 搜尋結果出現未授權文件怎麼辦？

- 中級者：建議學習哪 20 題
    - A-Q4: 為何多數向量資料庫不提供記錄層級權限？
    - A-Q6: 標籤過濾在 RAG 中的核心價值是什麼？
    - A-Q11: 何謂個人授權（使用者例外清單）？
    - A-Q15: 在 RAG 中如何避免摘要洩漏？
    - B-Q1: Microsoft Kernel Memory 的安全過濾如何運作？
    - B-Q2: Azure AI Search 的 filter 原理與語法為何？
    - B-Q3: Qdrant/Pinecone 的 metadata filter 機制是什麼？
    - B-Q5: 如何將 RBAC 降維為標籤資料模型？
    - B-Q9: 多租戶隔離的標籤設計原理是什麼？
    - B-Q10: 授權決策緩存與失效機制如何運作？
    - B-Q13: 時效型授權與時間序列標籤如何落實？
    - B-Q14: 效能與成本優化：索引與選擇性如何評估？
    - C-Q2: 如何在 .NET 使用 Kernel Memory 設定安全過濾？
    - C-Q4: 如何設計 RBAC 對照表並產生查詢條件？
    - C-Q5: 如何支援個人授權（白名單/黑名單）？
    - C-Q6: 如何在 Qdrant/Pinecone 實作 metadata filter？
    - C-Q7: 如何避免摘要顯示未授權片段（生成階段 gating）？
    - C-Q8: 如何實作多租戶隔離與 API 層注入 tenant filter？
    - D-Q2: 加上 filter 後查詢變慢如何優化？
    - D-Q3: 標籤爆炸、組合太多如何處理？

- 高級者：建議關注哪 15 題
    - A-Q16: 什麼是 Deny overrides 與 Permit overrides 策略？
    - B-Q6: ABAC 的屬性評估與決策流程是什麼？
    - B-Q7: PBAC 與政策語言（如 OPA/Rego）的架構怎麼設計？
    - B-Q8: 查詢時的 Filter Injection 中介層如何設計？
    - B-Q12: 記錄層級稽核與可追蹤性如何設計？
    - C-Q9: 如何導入時效標籤（有效期）與排程清理？
    - C-Q10: 如何做權限與查詢稽核（Audit log）？
    - D-Q4: ABAC 規則過多難維護怎麼辦？
    - D-Q5: 多租戶資料外洩風險如何診斷與防堵？
    - D-Q6: 角色變更後仍看到舊權限內容怎麼辦？
    - D-Q7: 嵌入向量導致語義洩漏如何防範？
    - D-Q8: 快取導致授權判斷過舊如何處理？
    - D-Q9: 產生式摘要透露敏感片段如何修補？
    - D-Q10: 稽核缺口導致無法重現授權決策怎麼辦？
    - B-Q14: 效能與成本優化：索引與選擇性如何評估？